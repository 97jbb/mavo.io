{"version":3,"sources":["expressiontext.js"],"names":["_toConsumableArray","arr","Array","isArray","i","arr2","length","from","$","_","Mavo","DOMExpression","Class","constructor","_this","this","o","arguments","undefined","mavo","template","_arr","_i","prop","node","path","reduce","index","childNodes","item","element","attribute","hooks","run","expression","nodeType","parentNode","children","normalize","getAttribute","trim","firstChild","whitespace","textContent","match","splitText","after","lastChild","insertBefore","parsed","syntax","tokenize","oldValue","value","map","x","Expression","treeBuilt","then","Node","get","closest","selectors","multiple","group","expressions","concat","elements","set","changedBy","evt","every","expr","update","_this2","data","event","env","context","ret","parentEnv","eval","Error","fallback","presentational","join","Primitive","formatNumber","primitive","datatype","output","setValue","static","WeakMap","search","all","filter","et","add","mavoNode","storage","modes","Bliss"],"mappings":"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","file":"mavo.min.js","sourcesContent":["(function($) {\n\nvar _ = Mavo.DOMExpression = $.Class({\n\tconstructor: function(o = {}) {\n\t\tthis.mavo = o.mavo;\n\t\tthis.template = o.template && o.template.template || o.template;\n\n\t\tfor (let prop of [\"item\", \"path\", \"syntax\", \"fallback\", \"attribute\"]) {\n\t\t\tthis[prop] = o[prop] === undefined && this.template? this.template[prop] : o[prop];\n\t\t}\n\n\t\tthis.node = o.node;\n\n\t\tif (!this.node) {\n\t\t\t// No node provided, figure it out from path\n\t\t\tthis.node = this.path.reduce((node, index) => {\n\t\t\t\treturn node.childNodes[index];\n\t\t\t}, this.item.element);\n\t\t}\n\n\t\tthis.element = this.node;\n\t\tthis.attribute = this.attribute || null;\n\n\t\tMavo.hooks.run(\"domexpression-init-start\", this);\n\n\t\tif (!this.expression) { // Still unhandled?\n\t\t\tif (this.node.nodeType === 3) {\n\t\t\t\tthis.element = this.node.parentNode;\n\n\t\t\t\t// If no element siblings make this.node the element, which is more robust\n\t\t\t\t// Same if attribute, there are no attributes on a text node!\n\t\t\t\tif (!this.node.parentNode.children.length || this.attribute) {\n\t\t\t\t\tthis.node = this.element;\n\t\t\t\t\tthis.element.normalize();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (this.attribute) {\n\t\t\t\tthis.expression = this.node.getAttribute(this.attribute).trim();\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Move whitespace outside to prevent it from messing with types\n\t\t\t\tthis.node.normalize();\n\n\t\t\t\tif (this.node.firstChild && this.node.childNodes.length === 1 && this.node.firstChild.nodeType === 3) {\n\t\t\t\t\tvar whitespace = this.node.firstChild.textContent.match(/^\\s*|\\s*$/g);\n\n\t\t\t\t\tif (whitespace[1]) {\n\t\t\t\t\t\tthis.node.firstChild.splitText(this.node.firstChild.textContent.length - whitespace[1].length);\n\t\t\t\t\t\t$.after(this.node.lastChild, this.node);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (whitespace[0]) {\n\t\t\t\t\t\tthis.node.firstChild.splitText(whitespace[0].length);\n\t\t\t\t\t\tthis.node.parentNode.insertBefore(this.node.firstChild, this.node);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tthis.expression = this.node.textContent;\n\t\t\t}\n\n\n\t\t\tthis.parsed = o.template? o.template.parsed : this.syntax.tokenize(this.expression);\n\t\t}\n\n\t\tthis.oldValue = this.value = this.parsed.map(x => x instanceof Mavo.Expression? x.expression : x);\n\n\t\tthis.mavo.treeBuilt.then(() => {\n\t\t\tif (!this.template) {\n\t\t\t\tthis.item = Mavo.Node.get(this.element.closest(Mavo.selectors.multiple + \", \" + Mavo.selectors.group));\n\t\t\t\tthis.item.expressions = [...(this.item.expressions || []), this];\n\t\t\t}\n\n\t\t\tMavo.hooks.run(\"domexpression-init-treebuilt\", this);\n\t\t});\n\n\t\tMavo.hooks.run(\"domexpression-init-end\", this);\n\n\t\t_.elements.set(this.element, [...(_.elements.get(this.element) || []), this]);\n\t},\n\n\tchangedBy: function(evt) {\n\t\treturn !this.parsed.every(expr => !(expr instanceof Mavo.Expression) || !expr.changedBy(evt));\n\t},\n\n\tupdate: function(data = this.data, event) {\n\t\tvar env = {context: this, ret: {}, event};\n\t\tvar parentEnv = env;\n\t\tthis.data = data;\n\n\t\tenv.ret = {};\n\n\t\tMavo.hooks.run(\"domexpression-update-start\", env);\n\n\t\tthis.oldValue = this.value;\n\n\t\tenv.ret.value = this.value = this.parsed.map((expr, i) => {\n\t\t\tif (expr instanceof Mavo.Expression) {\n\t\t\t\tif (expr.changedBy(parentEnv.event)) {\n\t\t\t\t\tvar env = {context: this, expr, parentEnv};\n\n\t\t\t\t\tMavo.hooks.run(\"domexpression-update-beforeeval\", env);\n\n\t\t\t\t\tenv.value = env.expr.eval(data);\n\n\t\t\t\t\tMavo.hooks.run(\"domexpression-update-aftereval\", env);\n\n\t\t\t\t\tif (env.value instanceof Error) {\n\t\t\t\t\t\treturn this.fallback !== undefined? this.fallback : env.expr.expression;\n\t\t\t\t\t}\n\t\t\t\t\tif (env.value === undefined || env.value === null) {\n\t\t\t\t\t\t// Donâ€™t print things like \"undefined\" or \"null\"\n\t\t\t\t\t\treturn \"\";\n\t\t\t\t\t}\n\n\t\t\t\t\treturn env.value;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\treturn this.oldValue[i];\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn expr;\n\t\t});\n\n\t\tif (!this.attribute) {\n\t\t\t// Separate presentational & actual values only apply when content is variable\n\t\t\tenv.ret.presentational = this.value.map(value => {\n\t\t\t\tif (Array.isArray(value)) {\n\t\t\t\t\treturn value.join(\", \");\n\t\t\t\t}\n\n\t\t\t\tif (typeof value == \"number\") {\n\t\t\t\t\treturn Mavo.Primitive.formatNumber(value);\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t});\n\n\t\t\tenv.ret.presentational = env.ret.presentational.length === 1? env.ret.presentational[0] : env.ret.presentational.join(\"\");\n\t\t}\n\n\t\tenv.ret.value = env.ret.value.length === 1? env.ret.value[0] : env.ret.value.join(\"\");\n\n\t\tif (this.primitive && this.parsed.length === 1) {\n\t\t\tif (typeof env.ret.value === \"number\") {\n\t\t\t\tthis.primitive.datatype = \"number\";\n\t\t\t}\n\t\t\telse if (typeof env.ret.value === \"boolean\") {\n\t\t\t\tthis.primitive.datatype = \"boolean\";\n\t\t\t}\n\t\t}\n\n\t\tif (env.ret.presentational === env.ret.value) {\n\t\t\tret = env.ret.value;\n\t\t}\n\n\t\tthis.output(env.ret);\n\n\t\tMavo.hooks.run(\"domexpression-update-end\", env);\n\t},\n\n\toutput: function(value) {\n\t\tif (this.primitive) {\n\t\t\tthis.primitive.value = value;\n\t\t}\n\t\telse {\n\t\t\tvalue = value.presentational || value;\n\t\t\tMavo.Primitive.setValue(this.node, value, {attribute: this.attribute});\n\t\t}\n\t},\n\n\tstatic: {\n\t\telements: new WeakMap(),\n\n\t\t/**\n\t\t * Search for Mavo.DOMExpression object(s) associated with a given element\n\t\t * and optionally an attribute.\n\t\t *\n\t\t * @return If one argument, array of matching DOMExpression objects.\n\t\t *         If two arguments, the matching DOMExpression object or null\n\t\t */\n\t\tsearch: function(element, attribute) {\n\t\t\tvar all = _.elements.get(element) || [];\n\n\t\t\tif (arguments.length > 1) {\n\t\t\t\tif (!all.length) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\treturn all.filter(et => et.attribute === attribute)[0] || null;\n\t\t\t}\n\n\t\t\treturn all;\n\t\t}\n\t}\n});\n\n// Link primitive with its expressionText object\n// We need to do it before its constructor runs, to prevent any editing UI from being generated\nMavo.hooks.add(\"primitive-init-start\", function() {\n\tvar et = Mavo.DOMExpression.search(this.element, this.attribute);\n\n\tif (et && !et.mavoNode) {\n\t\tet.primitive = this;\n\t\tthis.storage = this.storage || \"none\";\n\t\tthis.modes = \"read\";\n\t}\n});\n\n})(Bliss);\n"],"sourceRoot":"/source/"}