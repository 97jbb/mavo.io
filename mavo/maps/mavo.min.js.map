{"version":3,"sources":["node.js"],"names":["_toConsumableArray","arr","Array","isArray","i","arr2","length","from","$","$$","_","Mavo","Node","Class","abstract","constructor","element","mavo","_this","this","options","arguments","undefined","Error","env","context","uid","maxId","all","set","concat","get","template","copies","push","fromTemplate","property","getProperty","type","Group","normalize","store","getAttribute","modes","modeObserver","Observer","records","mode","group","parentGroup","hooks","run","editing","constant","isRoot","name","readable","toLowerCase","data","getData","saved","path","postInit","edit","destroy","o","isDataNull","walkUp","result","deleted","walk","callback","walker","obj","ret","children","_node","call","propagate","done","unbind","_node2","propagated","toJSON","prototype","_len","properties","_key","_iteratorNormalCompletion","_didIteratorError","_iteratorError","_step","_iterator","Symbol","iterator","next","value","err","render","rendering","dataRender","save","dataChanged","action","fire","extend","node","toString","nodeType","live","toggleAttribute","unsavedChanges","classList","toggle","_this2","_mode","sneak","static","WeakMap","create","is","collection","Collection","hasAttribute","id","setAttribute","prioritizePrimitive","nodes","filter","Bliss"],"mappings":"AAAA,YAEA,SAASA,oBAAmBC,GAAO,GAAIC,MAAMC,QAAQF,GAAM,CAAE,IAAK,GAAIG,GAAI,EAAGC,EAAOH,MAAMD,EAAIK,QAASF,EAAIH,EAAIK,OAAQF,IAAOC,EAAKD,GAAKH,EAAIG,EAAM,OAAOC,GAAe,MAAOH,OAAMK,KAAKN,IAF1L,SAAUO,EAAGC,GAEb,GAAIC,GAAIC,KAAKC,KAAOJ,EAAEK,OACrBC,YAAU,EACVC,YAAa,SAAUC,EAASC,GAAoB,GAAAC,GAAAC,KAAdC,EAAcC,UAAAf,QAAA,GAAAgB,SAAAD,UAAA,MAAAA,UAAA,EACnD,KAAKL,IAAYC,EAChB,KAAM,IAAIM,OAAM,uEAGjB,IAAIC,IAAOC,QAASN,KAAMC,QAAAA,EAE1BD,MAAKO,MAAQhB,EAAEiB,MAEfjB,EAAEkB,IAAIC,IAAIb,KAAVc,OAAA9B,mBAAwBU,EAAEkB,IAAIG,IAAIZ,KAAKH,eAAiBG,QAExDA,KAAKH,QAAUA,EACfG,KAAKa,SAAWR,EAAIJ,QAAQY,SAExBb,KAAKa,SAERb,KAAKa,SAASC,OAAOC,KAAKf,MAG1BA,KAAKc,UAGNd,KAAKF,KAAOA,EAEPE,KAAKgB,aAAa,WAAY,OAAQ,WAC1ChB,KAAKiB,SAAW1B,EAAE2B,YAAYrB,GAC9BG,KAAKmB,KAAO3B,KAAK4B,MAAMC,UAAUxB,GACjCG,KAAKsB,MAAQtB,KAAKH,QAAQ0B,aAAa,cACvCvB,KAAKwB,MAAQxB,KAAKH,QAAQ0B,aAAa,YAGxCvB,KAAKyB,aAAe,GAAIjC,MAAKkC,SAAS1B,KAAKH,QAAS,UAAW,SAAA8B,GAC9D5B,EAAK6B,KAAO7B,EAAKF,QAAQ0B,aAAa,WACtCxB,EAAkB,QAAbA,EAAK6B,KAAgB,OAAS;GAGpC5B,KAAK4B,KAAO5B,KAAKwB,OAAS,OAE1BxB,KAAK6B,MAAQ7B,KAAK8B,YAAczB,EAAIJ,QAAQ4B,MAE5CrC,KAAKuC,MAAMC,IAAI,gBAAiB3B,IAGjC4B,GAAIA,WACH,MAAoB,QAAbjC,KAAK4B,MAGbM,GAAIA,YAEH,MAAqB,QAAdlC,KAAKwB,OAGbW,GAAIA,UACH,OAAQnC,KAAKiB,UAGdmB,GAAIA,QACH,MAAO5C,MAAK6C,SAASrC,KAAKiB,UAAYjB,KAAKmB,MAAMmB,eAGlDC,GAAIA,QACH,MAAOvC,MAAKwC,WAGbC,GAAIA,SACH,MAAsB,SAAfzC,KAAKsB,OAGboB,GAAIA,QACH,GAAIA,GAAO1C,KAAK8B,YAAa9B,KAAK8B,YAAYY,OAE9C,OAAO1C,MAAKiB,YAALN,OAAA9B,mBAAmB6D,IAAM1C,KAAKiB,WAAYyB,GAMlDC,SAAU,WACS,QAAd3C,KAAKwB,OACRxB,KAAK4C,QAIPC,QAAS,WACR7C,KAAKyB,aAAaoB,WAGnBL,QAAS,WAAiB,GAARM,GAAQ5C,UAAAf,QAAA,GAAAgB,SAAAD,UAAA,MAAAA,UAAA,EACzB,OAAIF,MAAK+C,WAAWD,GACZ,SAIR9C,MAAKgD,OAAO,SAAAnB,GACX,GAAIA,EAAMkB,WAAWD,GACpB,MAAO,SAKVC,WAAY,SAASD,GACpB,GAAIzC,IACHC,QAASN,KACTC,QAAS6C,EACTG,OAAQjD,KAAKkD,UAAYlD,KAAKyC,OAAqB,KAAXK,EAAExB,MAK3C,OAFA9B,MAAKuC,MAAMC,IAAI,kBAAmB3B,GAE3BA,EAAI4C,QAQZE,KAAM,SAASC,GAAqB,GAAXV,GAAWxC,UAAAf,QAAA,GAAAgB,SAAAD,UAAA,MAAAA,UAAA,GAC/BmD,EAAS,QAATA,GAAUC,EAAKZ;AAClB,GAAIa,GAAMH,EAASE,EAAKZ,EAExB,IAAIa,KAAQ,EACX,IAAK,GAAItE,KAAKqE,GAAIE,SAAU,CAC3B,GAAIC,GAAOH,EAAIE,SAASvE,EAExB,IAAIwE,YAAgBjE,MAAKC,KAAM,CAC9B,GAAI8D,GAAMF,EAAOK,KAAKD,EAAMA,KAAlB9C,OAAA9B,mBAA4B6D,IAAMzD,IAE5C,IAAIsE,KAAQ,EACX,OAAO,GAMX,MAAOA,MAAQ,EAGhB,OAAOF,GAAOrD,KAAM0C,IAGrBM,OAAQ,SAASI,GAGhB,IAFA,GAAIvB,GAAQ7B,KAEL6B,EAAQA,EAAMC,aAAa,CACjC,GAAIyB,GAAMH,EAASvB,EAEnB,IAAY1B,SAARoD,EACH,MAAOA,KAKVX,KAAM,WACL5C,KAAK4B,KAAO,OAEZ5B,KAAK2D,UAAU,QAEfnE,KAAKuC,MAAMC,IAAI,gBAAiBhC,OAGjC4D,KAAM,WACL5D,KAAK4B,KAAO,OACZvC,EAAEwE,OAAO7D,KAAKH,QAAS,cAEvBG,KAAK2D,UAAU,QAEfnE,KAAKuC,MAAMC,IAAI,gBAAiBhC,OAGjC2D,UAAW,SAASP,GACnB,IAAK,GAAInE,KAAKe,MAAKwD,SAAU,CAC5B,GAAIM,GAAO9D,KAAKwD,SAASvE,EAErB6E,aAAgBtE,MAAKC,OACA,kBAAb2D,GACVA,EAASM,KAAKI,EAAMA,GAEZV,IAAYU,IACpBA,EAAKV,QAMTW,YAAa,OAAQ,SAAU,WAE/BC,OAAQxE,KAAKyE,UAAUD,OAEvBhD,aAAc,WACb,GAAIhB,KAAKa,SAAU,CAAA,IAAA,GAAAqD,GAAAhE,UAAAf,OADMgF,EACNpF,MAAAmF,GAAAE,EAAA,EAAAA,EAAAF,EAAAE,IADMD,EACNC,GAAAlE,UAAAkE,EAAA,IAAAC,IAAA,EAAAC,GAAA,EAAAC,EAAApE,MAAA,KAClB,IAAA,GAAAqE,GAAAC,EAAqBN,EAArBO,OAAAC,cAAAN,GAAAG,EAAAC,EAAAG,QAAAhB,MAAAS,GAAA,EAAiC,CAAA,GAAxBpD,GAAwBuD,EAAAK,KAChC7E,MAAKiB,GAAYjB,KAAKa,SAASI,IAFd,MAAA6D,GAAAR,GAAA,EAAAC,EAAAO,EAAA,QAAA;CAAAT,GAAAI,EAAAA,WAAAA,EAAAA,YAAA,QAAA,GAAAH,EAAA,KAAAC,KAMnB,QAASvE,KAAKa,UAGfkE,OAAQ,SAASxC,GAChB/C,KAAKuC,MAAMC,IAAI,oBAAqBhC,MAEpCA,KAAKgF,WAAY,EAEbhF,KAAKiC,SACRjC,KAAK4D,OACL5D,KAAKiF,WAAW1C,GAChBvC,KAAK4C,QAGL5C,KAAKiF,WAAW1C,GAGjBvC,KAAKkF,OAELlF,KAAKgF,WAAY,EAEjBxF,KAAKuC,MAAMC,IAAI,kBAAmBhC,OAGnCmF,YAAa,SAASC,GAAgB,GAARtC,GAAQ5C,UAAAf,QAAA,GAAAgB,SAAAD,UAAA,MAAAA,UAAA,EAChCF,MAAKgF,WACT3F,EAAEgG,KAAKvC,EAAEjD,SAAWG,KAAKH,QAAS,kBAAmBR,EAAEiG,QACtDrE,SAAUjB,KAAKiB,SACfmE,OAAAA,EACAtF,KAAME,KAAKF,KACXyF,KAAMvF,MACJ8C,KAIL0C,SAAU,WACT,MAAA,IAAWxF,KAAKO,IAAhB,KAAwBP,KAAKyF,SAA7B,KAA0CzF,KAAKiB,SAA/C,KAGDyE,MACCpE,MAAO,SAASuD,GACfxF,EAAEsG,gBAAgB3F,KAAKH,QAAS,aAAcgF,IAG/Ce,eAAgB,SAASf,GAOxB,OANIA,GAAW7E,KAAKyC,OAAUzC,KAAKiC,UAClC4C,GAAQ,GAGT7E,KAAKH,QAAQgG,UAAUC,OAAO,qBAAsBjB,GAE7CA,GAGRjD,KAAM,SAAUiD,GAAO,GAAAkB,GAAA/F,IAClBA,MAAKgG,OAASnB,IAGjB7E,KAAKgG,MAAQnB,EAEb7E,KAAKyB,aAAawE,MAAM,WACvB,GAAIvF,GAAMqF,EAAKvE,OAAsB,QAAbuE,EAAKnE,IAC7BvC,GAAEsG,gBAAgBI,EAAKlG,QAAS,UAAWgF,EAAOnE,QAMtDwF,UACC1F,MAAO,EAEPC,IAAK,GAAI0F;AAETC,OAAQ,SAASvG,EAASC,GAAc,GAARgD,GAAQ5C,UAAAf,QAAA,GAAAgB,SAAAD,UAAA,MAAAA,UAAA,EACvC,OAAIV,MAAK6G,GAAG,WAAYxG,KAAaiD,EAAEwD,WAC/B,GAAI9G,MAAK+G,WAAW1G,EAASC,EAAMgD,GAGpC,IAAItD,KAAKA,KAAK6G,GAAG,QAASxG,GAAU,QAAU,cAAaA,EAASC,EAAMgD,IAMlF5B,YAAa,SAASrB,GACrB,GAAIoB,GAAWpB,EAAQ0B,aAAa,aAAe1B,EAAQ0B,aAAa,WAUxE,QARKN,GAAYpB,EAAQ2G,aAAa,cACrCvF,EAAWpB,EAAQuC,MAAQvC,EAAQ4G,IAAM5G,EAAQgG,UAAU,IAGxD5E,GACHpB,EAAQ6G,aAAa,WAAYzF,GAG3BA,GAGRL,IAAK,SAASf,EAAS8G,GACtB,GAAIC,IAASrH,EAAEkB,IAAIG,IAAIf,QAAgBgH,OAAO,SAAAtB,GAAA,QAAUA,YAAgB/F,MAAK+G,aAE7E,OAAIK,GAAMzH,OAAS,IAAMwH,EACjBC,EAAM,GAGVA,EAAM,YAAcpH,MAAK4B,MACrBmE,KAAK,GADb,YAOAuB,MAAOA,MAAMzH","file":"mavo.min.js","sourcesContent":["(function($, $$) {\n\nvar _ = Mavo.Node = $.Class({\n\tabstract: true,\n\tconstructor: function (element, mavo, options = {}) {\n\t\tif (!element || !mavo) {\n\t\t\tthrow new Error(\"Mavo.Node constructor requires an element argument and a mavo object\");\n\t\t}\n\n\t\tvar env = {context: this, options};\n\n\t\tthis.uid = ++_.maxId;\n\n\t\t_.all.set(element, [...(_.all.get(this.element) || []), this]);\n\n\t\tthis.element = element;\n\t\tthis.template = env.options.template;\n\n\t\tif (this.template) {\n\t\t\t// TODO remove if this is deleted\n\t\t\tthis.template.copies.push(this);\n\t\t}\n\t\telse {\n\t\t\tthis.copies = [];\n\t\t}\n\n\t\tthis.mavo = mavo;\n\n\t\tif (!this.fromTemplate(\"property\", \"type\", \"modes\")) {\n\t\t\tthis.property = _.getProperty(element);\n\t\t\tthis.type = Mavo.Group.normalize(element);\n\t\t\tthis.store = this.element.getAttribute(\"mv-storage\");\n\t\t\tthis.modes = this.element.getAttribute(\"mv-mode\");\n\t\t}\n\n\t\tthis.modeObserver = new Mavo.Observer(this.element, \"mv-mode\", records => {\n\t\t\tthis.mode = this.element.getAttribute(\"mv-mode\");\n\t\t\tthis[this.mode == \"edit\"? \"edit\" : \"done\"]();\n\t\t});\n\n\t\tthis.mode = this.modes || \"read\";\n\n\t\tthis.group = this.parentGroup = env.options.group;\n\n\t\tMavo.hooks.run(\"node-init-end\", env);\n\t},\n\n\tget editing() {\n\t\treturn this.mode == \"edit\";\n\t},\n\n\tget constant() {\n\t\t// Is a \"constant\" if only allowed mode is read\n\t\treturn this.modes == \"read\";\n\t},\n\n\tget isRoot() {\n\t\treturn !this.property;\n\t},\n\n\tget name() {\n\t\treturn Mavo.readable(this.property || this.type).toLowerCase();\n\t},\n\n\tget data() {\n\t\treturn this.getData();\n\t},\n\n\tget saved() {\n\t\treturn this.store !== \"none\";\n\t},\n\n\tget path() {\n\t\tvar path = this.parentGroup? this.parentGroup.path : [];\n\n\t\treturn this.property? [...path, this.property] : path;\n\t},\n\n\t/**\n\t * Runs after the constructor is done (including the constructor of the inheriting class), synchronously\n\t */\n\tpostInit: function() {\n\t\tif (this.modes == \"edit\") {\n\t\t\tthis.edit();\n\t\t}\n\t},\n\n\tdestroy: function() {\n\t\tthis.modeObserver.destroy();\n\t},\n\n\tgetData: function(o = {}) {\n\t\tif (this.isDataNull(o)) {\n\t\t\treturn null;\n\t\t}\n\n\t\t// Check if any of the parent groups doesn't return data\n\t\tthis.walkUp(group => {\n\t\t\tif (group.isDataNull(o)) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t});\n\t},\n\n\tisDataNull: function(o) {\n\t\tvar env = {\n\t\t\tcontext: this,\n\t\t\toptions: o,\n\t\t\tresult: this.deleted || !this.saved && (o.store != \"*\")\n\t\t};\n\n\t\tMavo.hooks.run(\"unit-isdatanull\", env);\n\n\t\treturn env.result;\n\t},\n\n\t/**\n\t * Execute a callback on every node of the Mavo tree\n\t * If callback returns (strict) false, walk stops.\n\t * @return false if was stopped via a false return value, true otherwise\n\t */\n\twalk: function(callback, path = []) {\n\t\tvar walker = (obj, path) => {\n\t\t\tvar ret = callback(obj, path);\n\n\t\t\tif (ret !== false) {\n\t\t\t\tfor (let i in obj.children) {\n\t\t\t\t\tlet node = obj.children[i];\n\n\t\t\t\t\tif (node instanceof Mavo.Node) {\n\t\t\t\t\t\tvar ret = walker.call(node, node, [...path, i]);\n\n\t\t\t\t\t\tif (ret === false) {\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn ret !== false;\n\t\t};\n\n\t\treturn walker(this, path);\n\t},\n\n\twalkUp: function(callback) {\n\t\tvar group = this;\n\n\t\twhile (group = group.parentGroup) {\n\t\t\tvar ret = callback(group);\n\n\t\t\tif (ret !== undefined) {\n\t\t\t\treturn ret;\n\t\t\t}\n\t\t}\n\t},\n\n\tedit: function() {\n\t\tthis.mode = \"edit\";\n\n\t\tthis.propagate(\"edit\");\n\n\t\tMavo.hooks.run(\"node-edit-end\", this);\n\t},\n\n\tdone: function() {\n\t\tthis.mode = \"read\";\n\t\t$.unbind(this.element, \".mavo:edit\");\n\n\t\tthis.propagate(\"done\");\n\n\t\tMavo.hooks.run(\"node-done-end\", this);\n\t},\n\n\tpropagate: function(callback) {\n\t\tfor (let i in this.children) {\n\t\t\tlet node = this.children[i];\n\n\t\t\tif (node instanceof Mavo.Node) {\n\t\t\t\tif (typeof callback === \"function\") {\n\t\t\t\t\tcallback.call(node, node);\n\t\t\t\t}\n\t\t\t\telse if (callback in node) {\n\t\t\t\t\tnode[callback]();\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tpropagated: [\"save\", \"revert\", \"destroy\"],\n\n\ttoJSON: Mavo.prototype.toJSON,\n\n\tfromTemplate: function(...properties) {\n\t\tif (this.template) {\n\t\t\tfor (let property of properties) {\n\t\t\t\tthis[property] = this.template[property];\n\t\t\t}\n\t\t}\n\n\t\treturn !!this.template;\n\t},\n\n\trender: function(data) {\n\t\tMavo.hooks.run(\"node-render-start\", this);\n\n\t\tthis.rendering = true;\n\n\t\tif (this.editing) {\n\t\t\tthis.done();\n\t\t\tthis.dataRender(data);\n\t\t\tthis.edit();\n\t\t}\n\t\telse {\n\t\t\tthis.dataRender(data);\n\t\t}\n\n\t\tthis.save();\n\n\t\tthis.rendering = false;\n\n\t\tMavo.hooks.run(\"node-render-end\", this);\n\t},\n\n\tdataChanged: function(action, o = {}) {\n\t\tif (!this.rendering) {\n\t\t\t$.fire(o.element || this.element, \"mavo:datachange\", $.extend({\n\t\t\t\tproperty: this.property,\n\t\t\t\taction,\n\t\t\t\tmavo: this.mavo,\n\t\t\t\tnode: this\n\t\t\t}, o));\n\t\t}\n\t},\n\n\ttoString: function() {\n\t\treturn `#${this.uid}: ${this.nodeType} (${this.property})`;\n\t},\n\n\tlive: {\n\t\tstore: function(value) {\n\t\t\t$.toggleAttribute(this.element, \"mv-storage\", value);\n\t\t},\n\n\t\tunsavedChanges: function(value) {\n\t\t\tif (value && (!this.saved || !this.editing)) {\n\t\t\t\tvalue = false;\n\t\t\t}\n\n\t\t\tthis.element.classList.toggle(\"mv-unsaved-changes\", value);\n\n\t\t\treturn value;\n\t\t},\n\n\t\tmode: function (value) {\n\t\t\tif (this._mode != value) {\n\t\t\t\t// If we don't do this, calling setAttribute below will\n\t\t\t\t// result in infinite recursion\n\t\t\t\tthis._mode = value;\n\n\t\t\t\tthis.modeObserver.sneak(() => {\n\t\t\t\t\tvar set = this.modes || this.mode == \"edit\";\n\t\t\t\t\t$.toggleAttribute(this.element, \"mv-mode\", value, set);\n\t\t\t\t});\n\t\t\t}\n\t\t},\n\t},\n\n\tstatic: {\n\t\tmaxId: 0,\n\n\t\tall: new WeakMap(),\n\n\t\tcreate: function(element, mavo, o = {}) {\n\t\t\tif (Mavo.is(\"multiple\", element) && !o.collection) {\n\t\t\t\treturn new Mavo.Collection(element, mavo, o);\n\t\t\t}\n\n\t\t\treturn new Mavo[Mavo.is(\"group\", element)? \"Group\" : \"Primitive\"](element, mavo, o);\n\t\t},\n\n\t\t/**\n\t\t * Get & normalize property name, if exists\n\t\t */\n\t\tgetProperty: function(element) {\n\t\t\tvar property = element.getAttribute(\"property\") || element.getAttribute(\"itemprop\");\n\n\t\t\tif (!property && element.hasAttribute(\"property\")) {\n\t\t\t\tproperty = element.name || element.id || element.classList[0];\n\t\t\t}\n\n\t\t\tif (property) {\n\t\t\t\telement.setAttribute(\"property\", property);\n\t\t\t}\n\n\t\t\treturn property;\n\t\t},\n\n\t\tget: function(element, prioritizePrimitive) {\n\t\t\tvar nodes = (_.all.get(element) || []).filter(node => !(node instanceof Mavo.Collection));\n\n\t\t\tif (nodes.length < 2 || !prioritizePrimitive) {\n\t\t\t\treturn nodes[0];\n\t\t\t}\n\n\t\t\tif (nodes[0] instanceof Mavo.Group) {\n\t\t\t\treturn node[1];\n\t\t\t}\n\t\t}\n\t}\n});\n\n})(Bliss, Bliss.$);\n"],"sourceRoot":"/source/"}