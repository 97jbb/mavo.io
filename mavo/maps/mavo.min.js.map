{"version":3,"sources":["primitive.js"],"names":["_typeof","Symbol","iterator","obj","constructor","$","$$","_","Mavo","Primitive","Class","extends","Node","nodeType","element","mavo","o","_this","this","fromTemplate","defaults","getDefaults","attribute","getValueAttribute","datatype","modes","mode","hooks","run","init","call","changeEvents","events","evt","target","value","getValue","editor","children","filter","el","matches","selectors","formControl","property","textContent","editorValue","remove","hasAttribute","original","getAttribute","is","cloneNode","template","Observer","records","_iteratorNormalCompletion","_didIteratorError","_iteratorError","undefined","_step","_iterator","copies","next","done","primitive","setValue","force","silent","err","templateValue","_default","constant","defaultObserver","record","initialValue","emptyValue","observer","editing","postInit","getEditorValue","output","setEditorValue","editorDefaults","destroy","getData","arguments","length","env","context","options","data","save","savedValue","unsavedChanges","_this2","unbind","sneak","popup","close","prevTabindex","tabIndex","removeAttribute","revert","callback","initEdit","_this3","Elements","create","type","input change","focus","select","mavo:datachange","stopPropagation","fire","placeholder","label","dataInput","attributes","forEach","test","name","setAttribute","replace","Popup","classList","add","edit","_this4","addEventListener","preventDefault","preEdit","defer","resolve","reject","empty","timer","click.mavo:preedit","focus.mavo:preedit","mouseenter.mavo:preedit","e","clearTimeout","setTimeout","mouseleave.mavo:preedit","then","show","parentNode","appendChild","clear","dataRender","Array","isArray","toPrimitive","closestCollection","find","lazy","readable","_this5","presentational","safeCast","_value","document","activeElement","humanReadable","selectedOptions","dataOnly","saved","dataChanged","action","live","default","hide","toggle","static","all","WeakMap","ret","selector","cast","_ref","_ref$defaults","_ref$attribute","_ref$datatype","useProperty","_ref2","toggleAttribute","formatNumber","indexOf","namespaceURI","numberFormat","Intl","NumberFormat","maximumFractionDigits","Infinity","format","_this6","className","hidden","contents","keyup","keyCode","contains","size","Math","min","_this7","shown","hideCallback","position","bounds","getBoundingClientRect","x","left","y","bottom","style","top","body","requestAnimationFrame","window","_this8","removeEventListener","parseFloat","getComputedStyle","transitionDuration","click.mavo:showpopup","keyup.mavo:showpopup","proxy","Bliss"],"mappings":"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","file":"mavo.min.js","sourcesContent":["(function($, $$) {\n\nvar _ = Mavo.Primitive = $.Class({\n\textends: Mavo.Node,\n\tnodeType: \"Primitive\",\n\tconstructor: function (element, mavo, o) {\n\t\tif (!this.fromTemplate(\"defaults\", \"attribute\", \"templateValue\")) {\n\t\t\tthis.defaults = _.getDefaults(element);\n\n\t\t\t// Which attribute holds the data, if any?\n\t\t\t// \"null\" or null for none (i.e. data is in content).\n\t\t\tthis.attribute = _.getValueAttribute(this.element, this.defaults);\n\t\t}\n\n\t\tthis.datatype = this.defaults.datatype;\n\t\tthis.modes = this.modes || this.defaults.modes;\n\t\tthis.mode = this.modes || \"read\";\n\n\t\tMavo.hooks.run(\"primitive-init-start\", this);\n\n\t\tif (this.defaults.init) {\n\t\t\tthis.defaults.init.call(this, this.element);\n\t\t}\n\n\t\tif (this.defaults.changeEvents) {\n\t\t\t$.events(this.element, this.defaults.changeEvents, evt => {\n\t\t\t\tif (evt.target === this.element) {\n\t\t\t\t\tthis.value = this.getValue();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * Set up input widget\n\t\t */\n\n\t\t// Nested widgets\n\t\tif (!this.editor && !this.attribute) {\n\t\t\tthis.editor = $$(this.element.children).filter(function (el) {\n\t\t\t    return el.matches(Mavo.selectors.formControl) && !el.matches(Mavo.selectors.property);\n\t\t\t})[0];\n\n\t\t\tif (this.editor) {\n\t\t\t\tthis.element.textContent = this.editorValue;\n\t\t\t\t$.remove(this.editor);\n\t\t\t}\n\t\t}\n\n\t\t// Linked widgets\n\t\tif (!this.editor && this.element.hasAttribute(\"mv-edit\")) {\n\t\t\tvar original = $(this.element.getAttribute(\"mv-edit\"));\n\n\t\t\tif (original && Mavo.is(\"formControl\", original)) {\n\t\t\t\tthis.editor = original.cloneNode(true);\n\n\t\t\t\t// Update editor if original mutates\n\t\t\t\tif (!this.template) {\n\t\t\t\t\tnew Mavo.Observer(original, \"all\", records => {\n\t\t\t\t\t\tfor (let primitive of this.copies) {\n\t\t\t\t\t\t\tprimitive.editor = original.cloneNode(true);\n\t\t\t\t\t\t\tprimitive.setValue(primitive.value, {force: true, silent: true});\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis.templateValue = this.getValue();\n\n\t\tthis._default = this.element.getAttribute(\"mv-default\");\n\n\t\tif (this.default === null) { // no mv-default\n\t\t\tthis._default = this.constant? this.templateValue : (this.editor? this.editorValue : undefined);\n\t\t}\n\t\telse if (this.default === \"\") { // mv-default exists, no value, default is template value\n\t\t\tthis._default = this.templateValue;\n\t\t}\n\t\telse { // mv-default with value\n\t\t\tthis.defaultObserver = new Mavo.Observer(this.element, \"mv-default\", record => {\n\t\t\t\tthis.default = this.element.getAttribute(\"mv-default\");\n\t\t\t});\n\t\t}\n\n\t\t// if (!this.constant) {\n\t\t// \tthis.setValue(this.templateValue, {silent: true});\n\t\t// }\n\n\n\t\tthis.initialValue = (!this.template && this.default === undefined? this.templateValue : this.default) || this.emptyValue;\n\n\t\tthis.setValue(this.initialValue, {silent: true});\n\n\t\t// Observe future mutations to this property, if possible\n\t\t// Properties like input.checked or input.value cannot be observed that way\n\t\t// so we cannot depend on mutation observers for everything :(\n\t\tthis.observer = new Mavo.Observer(this.element, this.attribute, records => {\n\t\t\tif (this.attribute || !this.editing) {\n\t\t\t\tthis.value = this.getValue();\n\t\t\t}\n\t\t});\n\n\t\tthis.postInit();\n\n\t\tMavo.hooks.run(\"primitive-init-end\", this);\n\t},\n\n\tget editorValue() {\n\t\tif (this.defaults.getEditorValue) {\n\t\t\treturn this.defaults.getEditorValue.call(this);\n\t\t}\n\n\t\tif (this.editor) {\n\t\t\tif (this.editor.matches(Mavo.selectors.formControl)) {\n\t\t\t\treturn _.getValue(this.editor, {datatype: this.datatype});\n\t\t\t}\n\n\t\t\t// if we're here, this.editor is an entire HTML structure\n\t\t\tvar output = $(Mavo.selectors.output + \", \" + Mavo.selectors.formControl, this.editor);\n\n\t\t\tif (output) {\n\t\t\t\treturn _.getValue(output);\n\t\t\t}\n\t\t}\n\t},\n\n\tset editorValue(value) {\n\t\tif (this.defaults.setEditorValue) {\n\t\t\treturn this.defaults.setEditorValue.call(this, value);\n\t\t}\n\n\t\tif (this.editor) {\n\t\t\tif (this.editor.matches(Mavo.selectors.formControl)) {\n\t\t\t\t_.setValue(this.editor, value, {defaults: this.editorDefaults});\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// if we're here, this.editor is an entire HTML structure\n\t\t\t\tvar output = $(Mavo.selectors.output + \", \" + Mavo.selectors.formControl, this.editor);\n\n\t\t\t\tif (output) {\n\t\t\t\t\t_.setValue(output, value);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tdestroy: function() {\n\t\tthis.super.destroy.call(this);\n\n\t\tthis.defaultObserver && this.defaultObserver.destroy();\n\t\tthis.observer && this.observer.destroy();\n\t},\n\n\tgetData: function(o = {}) {\n\t\tvar env = {\n\t\t\tcontext: this,\n\t\t\toptions: o,\n\t\t\tdata: this.super.getData.call(this, o)\n\t\t};\n\n\t\tif (env.data !== undefined) {\n\t\t\treturn env.data;\n\t\t}\n\n\t\tenv.data = this.value;\n\n\t\tif (env.data === \"\") {\n\t\t\tenv.data = null;\n\t\t}\n\n\t\tMavo.hooks.run(\"node-getdata-end\", env);\n\n\t\treturn env.data;\n\t},\n\n\tsave: function() {\n\t\tthis.savedValue = this.value;\n\t\tthis.unsavedChanges = false;\n\t},\n\n\tdone: function () {\n\t\tif (this.modes == \"edit\") {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.super.done.call(this);\n\n\t\tif (\"preEdit\" in this) {\n\t\t\t$.unbind(this.element, \".mavo:preedit .mavo:edit\");\n\t\t}\n\n\t\tthis.sneak(() => {\n\t\t\tif (this.defaults.done) {\n\t\t\t\tthis.defaults.done.call(this);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (this.popup) {\n\t\t\t\tthis.popup.close();\n\t\t\t}\n\t\t\telse if (!this.attribute && this.editor) {\n\t\t\t\t$.remove(this.editor);\n\t\t\t\tthis.element.textContent = this.editorValue;\n\t\t\t}\n\t\t});\n\n\t\t// Revert tabIndex\n\t\tif (this.element._.data.prevTabindex !== null) {\n\t\t\tthis.element.tabIndex = this.element._.data.prevTabindex;\n\t\t}\n\t\telse {\n\t\t\tthis.element.removeAttribute(\"tabindex\");\n\t\t}\n\t},\n\n\trevert: function() {\n\t\tif (this.unsavedChanges && this.savedValue !== undefined) {\n\t\t\t// FIXME if we have a collection of properties (not groups), this will cause\n\t\t\t// cancel to not remove new unsaved items\n\t\t\t// This should be fixed by handling this on the collection level.\n\t\t\tthis.value = this.savedValue;\n\t\t\tthis.unsavedChanges = false;\n\t\t}\n\t},\n\n\tsneak: function(callback) {\n\t\tthis.observer? this.observer.sneak(callback) : callback();\n\t},\n\n\t// Called only the first time this primitive is edited\n\tinitEdit: function () {\n\t\tif (!this.editor) {\n\t\t\t// No editor provided, use default for element type\n\t\t\t// Find default editor for datatype\n\t\t\tvar editor = this.defaults.editor || Mavo.Elements[\"*\"].editor;\n\n\t\t\tthis.editor = $.create($.type(editor) === \"function\"? editor.call(this) : editor);\n\t\t\tthis.editorValue = this.value;\n\t\t}\n\n\t\t$.events(this.editor, {\n\t\t\t\"input change\": evt => {\n\t\t\t\tthis.value = this.editorValue;\n\t\t\t},\n\t\t\t\"focus\": evt => {\n\t\t\t\tthis.editor.select && this.editor.select();\n\t\t\t},\n\t\t\t\"mavo:datachange\": evt => {\n\t\t\t\tif (evt.property === \"output\") {\n\t\t\t\t\tevt.stopPropagation();\n\t\t\t\t\t$.fire(this.editor, \"input\");\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tif (\"placeholder\" in this.editor) {\n\t\t\tthis.editor.placeholder = \"(\" + this.label + \")\";\n\t\t}\n\n\t\t// Copy any data-input-* attributes from the element to the editor\n\t\tvar dataInput = /^mv-edit-/i;\n\t\t$$(this.element.attributes).forEach(function (attribute) {\n\t\t\tif (dataInput.test(attribute.name)) {\n\t\t\t\tthis.editor.setAttribute(attribute.name.replace(dataInput, \"\"), attribute.value);\n\t\t\t}\n\t\t}, this);\n\n\t\tif (this.attribute) {\n\t\t\tthis.popup = new _.Popup(this);\n\t\t}\n\n\t\tif (!this.popup) {\n\t\t\tthis.editor.classList.add(\"mv-editor\");\n\t\t}\n\n\t\tthis.initEdit = null;\n\t},\n\n\tedit: function () {\n\t\tif (this.modes == \"read\") {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.super.edit.call(this);\n\n\t\t// Make element focusable, so it can actually receive focus\n\t\tthis.element._.data.prevTabindex = this.element.getAttribute(\"tabindex\");\n\t\tthis.element.tabIndex = 0;\n\n\t\t// Prevent default actions while editing\n\t\t// e.g. following links etc\n\t\tthis.element.addEventListener(\"click.mavo:edit\", evt => evt.preventDefault());\n\n\t\tthis.preEdit = Mavo.defer((resolve, reject) => {\n\t\t\t// Empty properties should become editable immediately\n\t\t\t// otherwise they could be invisible!\n\t\t\tif (this.empty && !this.attribute) {\n\t\t\t\treturn resolve();\n\t\t\t}\n\n\t\t\tvar timer;\n\n\t\t\t$.events(this.element, {\n\t\t\t\t\"click.mavo:preedit\": resolve,\n\t\t\t\t\"focus.mavo:preedit\": resolve\n\t\t\t});\n\n\t\t\tif (!this.attribute) {\n\t\t\t\t// Hovering over the element for over 150ms will trigger edit\n\t\t\t\t$.events(this.element, {\n\t\t\t\t\t\"mouseenter.mavo:preedit\": e => {\n\t\t\t\t\t\tclearTimeout(timer);\n\t\t\t\t\t\ttimer = setTimeout(resolve, 150);\n\t\t\t\t\t},\n\t\t\t\t\t\"mouseleave.mavo:preedit\": e => {\n\t\t\t\t\t\tclearTimeout(timer);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\n\t\tif (this.defaults.edit) {\n\t\t\tthis.defaults.edit.call(this);\n\t\t\treturn;\n\t\t}\n\n\t\tthis.preEdit.then(() => {\n\t\t\t// Actual edit\n\t\t\t$.unbind(this.element, \".mavo:preedit\");\n\n\t\t\tif (this.initEdit) {\n\t\t\t\tthis.initEdit();\n\t\t\t}\n\n\t\t\tif (this.popup) {\n\t\t\t\tthis.popup.show();\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis.editor.focus();\n\t\t\t}\n\n\t\t\tif (!this.attribute) {\n\t\t\t\tif (this.editor.parentNode != this.element) {\n\t\t\t\t\tthis.editorValue = this.value;\n\t\t\t\t\tthis.element.textContent = \"\";\n\n\t\t\t\t\tthis.element.appendChild(this.editor);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}, // edit\n\n\tclear: function() {\n\t\tif (!this.constant) {\n\t\t\tthis.value = this.emptyValue;\n\t\t}\n\t},\n\n\tdataRender: function(data) {\n\t\tif (Array.isArray(data)) {\n\t\t\tdata = data[0]; // TODO what is gonna happen to the rest? Lost?\n\t\t}\n\n\t\tif (typeof data === \"object\") {\n\t\t\tdata = Symbol.toPrimitive in data? data[Symbol.toPrimitive]() : data[this.property];\n\t\t}\n\n\t\tif (data === undefined) {\n\t\t\t// New property has been added to the schema and nobody has saved since\n\t\t\tthis.value = this.closestCollection? this.default : this.templateValue;\n\t\t}\n\t\telse {\n\t\t\tthis.value = data;\n\t\t}\n\t},\n\n\tfind: function(property) {\n\t\tif (this.property == property) {\n\t\t\treturn this;\n\t\t}\n\t},\n\n\t/**\n\t * Get value from the DOM\n\t */\n\tgetValue: function(o) {\n\t\treturn _.getValue(this.element, {\n\t\t\tdefaults: this.defaults,\n\t\t\tattribute: this.attribute,\n\t\t\tdatatype: this.datatype\n\t\t});\n\t},\n\n\tlazy: {\n\t\tlabel: function() {\n\t\t\treturn Mavo.readable(this.property);\n\t\t},\n\n\t\temptyValue: function() {\n\t\t\tswitch (this.datatype) {\n\t\t\t\tcase \"boolean\":\n\t\t\t\t\treturn false;\n\t\t\t\tcase \"number\":\n\t\t\t\t\treturn 0;\n\t\t\t}\n\n\t\t\treturn \"\";\n\t\t},\n\n\t\teditorDefaults: function() {\n\t\t\treturn this.editor && _.getDefaults(this.editor);\n\t\t}\n\t},\n\n\tsetValue: function (value, o = {}) {\n\t\tthis.sneak(() => {\n\t\t\tif ($.type(value) == \"object\" && \"value\" in value) {\n\t\t\t\tvar presentational = value.presentational;\n\t\t\t\tvalue = value.value;\n\t\t\t}\n\n\t\t\tvalue = value || value === 0? value : \"\";\n\t\t\tvalue = _.safeCast(value, this.datatype);\n\n\t\t\tif (value == this._value && !o.force) {\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\tif (this.editor && document.activeElement != this.editor) {\n\t\t\t\tthis.editorValue = value;\n\t\t\t}\n\n\t\t\tif (this.defaults.humanReadable && this.attribute) {\n\t\t\t\tpresentational = this.defaults.humanReadable.call(this, value);\n\t\t\t}\n\n\t\t\tif (!this.editing || this.attribute || !this.editor) {\n\t\t\t\tif (this.defaults.setValue) {\n\t\t\t\t\tthis.defaults.setValue.call(this, this.element, value);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tif (this.editor && this.editor.matches(\"select\") && this.editor.selectedOptions[0]) {\n\t\t\t\t\t\tpresentational = this.editor.selectedOptions[0].textContent;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!o.dataOnly) {\n\t\t\t\t\t\t_.setValue(this.element, {value, presentational}, {\n\t\t\t\t\t\t\tdefaults: this.defaults,\n\t\t\t\t\t\t\tattribute: this.attribute,\n\t\t\t\t\t\t\tdatatype: this.datatype\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.empty = value === \"\";\n\n\t\t\tthis._value = value;\n\n\t\t\tif (!o.silent) {\n\t\t\t\tif (this.saved) {\n\t\t\t\t\tthis.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t\t\t}\n\n\t\t\t\tthis.dataChanged(\"propertychange\", {value});\n\t\t\t}\n\t\t});\n\n\t\treturn value;\n\t},\n\n\tdataChanged: function(action = \"propertychange\", o) {\n\t\treturn this.super.dataChanged.call(this, action, o);\n\t},\n\n\tlive: {\n\t\tdefault: function (value) {\n\t\t\tif (this.value == this._default) {\n\n\t\t\t\tthis.value = value;\n\t\t\t}\n\t\t},\n\n\t\tvalue: function (value) {\n\t\t\treturn this.setValue(value);\n\t\t},\n\n\t\tempty: function (value) {\n\t\t\tvar hide = value && // is empty\n\t\t\t!this.constant && // and editable\n\t\t\t!(this.attribute && $(Mavo.selectors.property, this.element)); // and has no property inside\n\n\t\t\tthis.element.classList.toggle(\"mv-empty\", hide);\n\t\t}\n\t},\n\n\tstatic: {\n\t\tall: new WeakMap(),\n\n\t\tgetDefaults: function (element) {\n\t\t\tvar ret = null;\n\n\t\t\tfor (var selector in Mavo.Elements) {\n\t\t\t\tif (element.matches(selector)) {\n\t\t\t\t\tret = Mavo.Elements[selector];\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn ret;\n\t\t},\n\n\t\tgetValueAttribute: function (element, defaults = _.getDefaults(element)) {\n\t\t\tvar ret = element.getAttribute(\"mv-attribute\") || defaults.attribute;\n\n\t\t\tif (!ret || ret === \"null\") {\n\t\t\t\tret = null;\n\t\t\t}\n\n\t\t\treturn ret;\n\t\t},\n\n\t\t/**\n\t\t * Only cast if conversion is lossless\n\t\t */\n\t\tsafeCast: function(value, datatype) {\n\t\t\tvar existingType = typeof value;\n\t\t\tvar cast = _.cast(value, datatype);\n\n\t\t\tif (value === null || value === undefined) {\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\tif (datatype == \"boolean\") {\n\t\t\t\tif (value === \"false\" || value === 0 || value === \"\") {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tif (value === \"true\" || value > 0) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\tif (datatype == \"number\") {\n\t\t\t\tif (/^[-+]?[0-9.e]+$/i.test(value + \"\")) {\n\t\t\t\t\treturn cast;\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\treturn cast;\n\t\t},\n\n\t\t/**\n\t\t * Cast to a different primitive datatype\n\t\t */\n\t\tcast: function(value, datatype) {\n\t\t\tswitch (datatype) {\n\t\t\t\tcase \"number\": return +value;\n\t\t\t\tcase \"boolean\": return !!value;\n\t\t\t\tcase \"string\": return value + \"\";\n\t\t\t}\n\n\t\t\treturn value;\n\t\t},\n\n\t\tgetValue: function (element, {\n\t\t\tdefaults = _.getDefaults(element),\n\t\t\tattribute = _.getValueAttribute(element, defaults),\n\t\t\tdatatype = defaults.datatype\n\t\t}) {\n\t\t\tif (defaults.getValue && attribute == defaults.attribute) {\n\t\t\t\treturn defaults.getValue(element);\n\t\t\t}\n\n\t\t\tvar ret;\n\n\t\t\tif (attribute in element && _.useProperty(element, attribute)) {\n\t\t\t\t// Returning properties (if they exist) instead of attributes\n\t\t\t\t// is needed for dynamic elements such as checkboxes, sliders etc\n\t\t\t\tret = element[attribute];\n\t\t\t}\n\t\t\telse if (attribute) {\n\t\t\t\tret = element.getAttribute(attribute);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tret = element.getAttribute(\"content\") || element.textContent || null;\n\t\t\t}\n\n\t\t\treturn _.safeCast(ret, datatype);\n\t\t},\n\n\t\tsetValue: function (element, value, {defaults, attribute, datatype}) {\n\t\t\tif ($.type(value) == \"object\" && \"value\" in value) {\n\t\t\t\tvar presentational = value.presentational;\n\t\t\t\tvalue = value.value;\n\t\t\t}\n\n\t\t\tif (element.nodeType === 1) {\n\t\t\t\tdefaults = defaults || _.getDefaults(element);\n\t\t\t\tattribute = attribute !== undefined? attribute : _.getValueAttribute(element, defaults);\n\t\t\t\tdatatype = datatype !== undefined? datatype : defaults.datatype;\n\n\t\t\t\tif (defaults.setValue && attribute == defaults.attribute) {\n\t\t\t\t\treturn defaults.setValue(element, value);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (attribute) {\n\t\t\t\tif (attribute in element && _.useProperty(element, attribute) && element[attribute] !== value) {\n\t\t\t\t\t// Setting properties (if they exist) instead of attributes\n\t\t\t\t\t// is needed for dynamic elements such as checkboxes, sliders etc\n\t\t\t\t\ttry {\n\t\t\t\t\t\telement[attribute] = value;\n\t\t\t\t\t}\n\t\t\t\t\tcatch (e) {}\n\t\t\t\t}\n\n\t\t\t\t// Set attribute anyway, even if we set a property because when\n\t\t\t\t// they're not in sync it gets really fucking confusing.\n\t\t\t\tif (datatype == \"boolean\") {\n\t\t\t\t\tif (value != element.hasAttribute(attribute)) {\n\t\t\t\t\t\t$.toggleAttribute(element, attribute, value, value);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse if (element.getAttribute(attribute) != value) {  // intentionally non-strict, e.g. \"3.\" !== 3\n\t\t\t\t\telement.setAttribute(attribute, value);\n\n\t\t\t\t\tif (presentational) {\n\t\t\t\t\t\telement.textContent = presentational;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif (datatype === \"number\" && !presentational) {\n\t\t\t\t\tpresentational = _.formatNumber(value);\n\t\t\t\t}\n\n\t\t\t\telement.textContent = presentational || value;\n\n\t\t\t\tif (presentational && element.setAttribute) {\n\t\t\t\t\telement.setAttribute(\"content\", value);\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\n\t\t/**\n\t\t *  Set/get a property or an attribute?\n\t\t * @return {Boolean} true to use a property, false to use the attribute\n\t\t */\n\t\tuseProperty: function(element, attribute) {\n\t\t\tif ([\"href\", \"src\"].indexOf(attribute) > -1) {\n\t\t\t\t// URL properties resolve \"\" as location.href, fucking up emptiness checks\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tif (element.namespaceURI == \"http://www.w3.org/2000/svg\") {\n\t\t\t\t// SVG has a fucked up DOM, do not use these properties\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn true;\n\t\t},\n\n\t\tlazy: {\n\t\t\tformatNumber: () => {\n\t\t\t\tvar numberFormat = new Intl.NumberFormat(\"en-US\", {maximumFractionDigits:2});\n\n\t\t\t\treturn function(value) {\n\t\t\t\t\tif (value === Infinity || value === -Infinity) {\n\t\t\t\t\t\t// Pretty print infinity\n\t\t\t\t\t\treturn value < 0? \"-∞\" : \"∞\";\n\t\t\t\t\t}\n\n\t\t\t\t\treturn numberFormat.format(value);\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t}\n});\n\n_.Popup = $.Class({\n\tconstructor: function(primitive) {\n\t\tthis.primitive = primitive;\n\n\t\tthis.popup = $.create(\"div\", {\n\t\t\tclassName: \"mv-popup\",\n\t\t\thidden: true,\n\t\t\tcontents: [\n\t\t\t\tthis.primitive.label + \":\",\n\t\t\t\tthis.editor\n\t\t\t],\n\t\t\tevents: {\n\t\t\t\tkeyup: evt => {\n\t\t\t\t\tif (evt.keyCode == 13 || evt.keyCode == 27) {\n\t\t\t\t\t\tif (this.popup.contains(document.activeElement)) {\n\t\t\t\t\t\t\tthis.element.focus();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tevt.stopPropagation();\n\t\t\t\t\t\tthis.hide();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\t// No point in having a dropdown in a popup\n\t\tif (this.editor.matches(\"select\")) {\n\t\t\tthis.editor.size = Math.min(10, this.editor.children.length);\n\t\t}\n\t},\n\n\tshow: function() {\n\t\t$.unbind([this.element, this.popup], \".mavo:showpopup\");\n\n\t\tthis.shown = true;\n\n\t\tthis.hideCallback = evt => {\n\t\t\tif (!this.popup.contains(evt.target) && !this.element.contains(evt.target)) {\n\t\t\t\tthis.hide();\n\t\t\t}\n\t\t};\n\n\t\tthis.position = evt => {\n\t\t\tvar bounds = this.element.getBoundingClientRect();\n\t\t\tvar x = bounds.left;\n\t\t\tvar y = bounds.bottom;\n\n\t\t\t // TODO what if it doesn’t fit?\n\t\t\t$.style(this.popup, { top:  `${y}px`, left: `${x}px` });\n\t\t};\n\n\t\tthis.position();\n\n\t\tdocument.body.appendChild(this.popup);\n\n\t\trequestAnimationFrame(e => this.popup.removeAttribute(\"hidden\")); // trigger transition\n\n\t\t$.events(document, \"focus click\", this.hideCallback, true);\n\t\twindow.addEventListener(\"scroll\", this.position);\n\t},\n\n\thide: function() {\n\t\t$.unbind(document, \"focus click\", this.hideCallback, true);\n\t\twindow.removeEventListener(\"scroll\", this.position);\n\t\tthis.popup.setAttribute(\"hidden\", \"\"); // trigger transition\n\t\tthis.shown = false;\n\n\t\tsetTimeout(() => {\n\t\t\t$.remove(this.popup);\n\t\t}, parseFloat(getComputedStyle(this.popup).transitionDuration) * 1000 || 400); // TODO transition-duration could override this\n\n\t\t$.events(this.element, {\n\t\t\t\"click.mavo:showpopup\": evt => {\n\t\t\t\tthis.show();\n\t\t\t},\n\t\t\t\"keyup.mavo:showpopup\": evt => {\n\t\t\t\tif ([13, 113].indexOf(evt.keyCode) > -1) { // Enter or F2\n\t\t\t\t\tthis.show();\n\t\t\t\t\tthis.editor.focus();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t},\n\n\tclose: function() {\n\t\tthis.hide();\n\t\t$.unbind(this.element, \".mavo:edit .mavo:preedit .mavo:showpopup\");\n\t},\n\n\tproxy: {\n\t\t\"editor\": \"primitive\",\n\t\t\"element\": \"primitive\"\n\t}\n});\n\n})(Bliss, Bliss.$);\n"],"sourceRoot":"/source/"}