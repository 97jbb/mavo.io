{"version":3,"sources":["collection.js"],"names":["_toConsumableArray","arr","Array","isArray","i","arr2","length","from","$","$$","Mavo","attributes","push","_","Collection","Class","extends","Node","nodeType","constructor","element","mavo","o","this","templateElement","children","fromTemplate","properties","selectors","property","map","getProperty","mutable","matches","multiple","accepts","getAttribute","split","cloneNode","item","createItem","add","itemTemplate","template","postInit","hooks","run","getData","arguments","undefined","env","context","options","data","_iteratorNormalCompletion","_didIteratorError","_iteratorError","_step","_iterator","Symbol","iterator","next","done","value","deleted","itemData","err","unhandled","before","concat","after","create","collection","type","index","get","adopt","rel","marker","bottomUp","previousIndex","changed","splice","remove","silent","forEach","dataChanged","unsavedChanges","_len","actions","_key","_iteratorNormalCompletion2","_didIteratorError2","_iteratorError2","_step2","_iterator2","action","isNaN","indexOf","sort","a","b","_iteratorNormalCompletion3","_didIteratorError3","_iteratorError3","_step3","_iterator3","_action","_children","toArray","apply","_item","_this","walk","obj","closestCollection","copies","delete","hard","_this2","transition","opacity","then","style","edit","_this3","call","addButton","parentNode","tag","tagName","toLowerCase","containerSelector","container","closest","dragula","getDragula","clear","propagate","_iteratorNormalCompletion4","_didIteratorError4","_iteratorError4","_step4","_iterator4","childNodes","save","_iteratorNormalCompletion5","_didIteratorError5","_iteratorError5","_step5","_iterator5","_item2","propagated","revert","_iteratorNormalCompletion6","_didIteratorError6","_iteratorError6","_step6","_iterator6","_item3","dataRender","_this4","fragment","document","createDocumentFragment","datum","render","appendChild","slice","find","items","filter","collections","ret","flatten","isCompatible","c","live","_mutable","createComment","_this5","pushUnique","containers","isContainer","el","root","moves","handle","classList","contains","target","source","previous","previousElementSibling","lastElementChild","on","nextElementSibling","closestItem","cancel","dragulas","lazy","order","test","compareDocumentPosition","DOCUMENT_POSITION_FOLLOWING","parent","_this6","selector","group","button","className","textContent","name","addEventListener","evt","preventDefault","static","include","self","_this7","attribute","swapUI","callback","sneak","ui","inside","descriptor","Object","getOwnPropertyDescriptor","prototype","defineProperty","_this8","set","_this9","_this10","itemControls","contents","title","events","click","replace","superKey","inViewport","scrollIntoView","behavior","itemControlsComment","replaceChild","getClosestCollection","parentGroup","_this11","toggle","elementContents","node","_deleted","isDeleted","Bliss"],"mappings":"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","file":"mavo.min.js","sourcesContent":["(function($, $$) {\n\nMavo.attributes.push(\"mv-multiple\", \"mv-order\", \"mv-accepts\");\n\nvar _ = Mavo.Collection = $.Class({\n\textends: Mavo.Node,\n\tnodeType: \"Collection\",\n\tconstructor: function (element, mavo, o) {\n\t\t/*\n\t\t * Create the template, remove it from the DOM and store it\n\t\t */\n\t\tthis.templateElement = this.element;\n\n\t\tthis.children = [];\n\n\t\t// ALL descendant property names as an array\n\t\tif (!this.fromTemplate(\"properties\", \"mutable\", \"templateElement\", \"accepts\")) {\n\t\t\tthis.properties = $$(Mavo.selectors.property, this.templateElement).map(Mavo.Node.getProperty);\n\t\t\tthis.mutable = this.templateElement.matches(Mavo.selectors.multiple);\n\t\t\tthis.accepts = (this.templateElement.getAttribute(\"mv-accepts\") || \"\").split(/\\s+/);\n\n\t\t\t// Must clone because otherwise once expressions are parsed on the template element\n\t\t\t// we will not be able to pick them up from subsequent items\n\t\t\tthis.templateElement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\tvar item = this.createItem(this.element);\n\t\t\tthis.add(item);\n\t\t\tthis.itemTemplate = item.template || item;\n\t\t}\n\n\t\tthis.postInit();\n\n\t\tMavo.hooks.run(\"collection-init-end\", this);\n\t},\n\n\tget length() {\n\t\treturn this.children.length;\n\t},\n\n\tgetData: function(o = {}) {\n\t\tvar env = {\n\t\t\tcontext: this,\n\t\t\toptions: o,\n\t\t\tdata: []\n\t\t};\n\n\t\tfor (item of this.children) {\n\t\t\tif (!item.deleted || o.null) {\n\t\t\t\tlet itemData = item.getData(env.options);\n\n\t\t\t\tif (itemData || o.null) {\n\t\t\t\t\tenv.data.push(itemData);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (this.unhandled && env.options.unhandled) {\n\t\t\tenv.data = this.unhandled.before.concat(env.data, this.unhandled.after);\n\t\t}\n\n\t\tif (!this.mutable && env.data.length == 1) {\n\t\t\t// See https://github.com/LeaVerou/mavo/issues/50#issuecomment-266079652\n\t\t\tenv.data = env.data[0];\n\t\t}\n\n\t\tMavo.hooks.run(\"node-getdata-end\", env);\n\n\t\treturn env.data;\n\t},\n\n\t// Create item but don't insert it anywhere\n\t// Mostly used internally\n\tcreateItem: function (element) {\n\t\tif (!element) {\n\t\t\telement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tvar item = Mavo.Node.create(element, this.mavo, {\n\t\t\tcollection: this,\n\t\t\ttemplate: this.itemTemplate || (this.template? this.template.itemTemplate : null),\n\t\t\tproperty: this.property,\n\t\t\ttype: this.type\n\t\t});\n\n\t\treturn item;\n\t},\n\n\t/**\n\t * Add a new item to this collection\n\t * @param item {Node|Mavo.Node} Optional. Element or Mavo object for the new item\n\t * @param index {Number} Optional. Index of existing item, will be added opposite to list direction\n\t * @param silent {Boolean} Optional. Throw a datachange event? Mainly used internally.\n\t */\n\tadd: function(item, index, o = {}) {\n\t\tif (item instanceof Node) {\n\t\t\titem = Mavo.Node.get(item) || this.createItem(item);\n\t\t}\n\t\telse {\n\t\t\titem = item || this.createItem();\n\t\t}\n\n\t\tif (item.collection != this) {\n\t\t\tthis.adopt(item);\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\t// Add it to the DOM, or fix its place\n\t\t\tvar rel = index === undefined? this.marker : this.children[index];\n\t\t\t$[this.bottomUp? \"after\" : \"before\"](item.element, rel);\n\n\t\t\tif (index === undefined) {\n\t\t\t\tindex = this.bottomUp? 0 : this.length;\n\t\t\t}\n\t\t}\n\n\t\tvar env = {context: this, item};\n\n\t\tenv.previousIndex = item.index;\n\n\t\t// Update internal data model\n\t\tenv.changed = this.splice({\n\t\t\tremove: env.item\n\t\t}, {\n\t\t\tindex: index,\n\t\t\tadd: env.item\n\t\t});\n\n\t\tif (!o.silent) {\n\t\t\tenv.changed.forEach(i => {\n\t\t\t\ti.dataChanged(i == env.item && env.previousIndex === undefined? \"add\" : \"move\");\n\t\t\t\ti.unsavedChanges = true;\n\t\t\t});\n\n\t\t\tthis.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t}\n\n\t\tMavo.hooks.run(\"collection-add-end\", env);\n\n\t\treturn env.item;\n\t},\n\n\tsplice: function(...actions) {\n\t\tfor (let action of actions) {\n\t\t\tif (action.index === undefined && action.remove && isNaN(action.remove)) {\n\t\t\t\t// Remove is an item\n\t\t\t\taction.index = this.children.indexOf(action.remove);\n\t\t\t\taction.remove = 1;\n\t\t\t}\n\t\t}\n\n\t\t// Sort in reverse index order\n\t\tactions.sort((a, b) => b.index - a.index);\n\n\t\t// FIXME this could still result in buggy behavior.\n\t\t// Think of e.g. adding items on i, then removing > 1 items on i-1.\n\t\t// The new items would get removed instead of the old ones.\n\t\t// Not a pressing issue though since we always remove 1 max when adding things too.\n\t\tfor (let action of actions) {\n\t\t\tif (action.index > -1 && (action.remove || action.add)) {\n\t\t\t\taction.remove = action.remove || 0;\n\t\t\t\taction.add = Mavo.toArray(action.add);\n\n\t\t\t\tthis.children.splice(action.index, +action.remove, ...action.add);\n\t\t\t}\n\t\t}\n\n\t\tvar changed = [];\n\n\t\tfor (let i = 0; i < this.length; i++) {\n\t\t\tlet item = this.children[i];\n\n\t\t\tif (item && item.index !== i) {\n\t\t\t\titem.index = i;\n\t\t\t\tchanged.push(item);\n\t\t\t}\n\t\t}\n\n\t\treturn changed;\n\t},\n\n\tadopt: function(item) {\n\t\tif (item.collection) {\n\t\t\t// It belongs to another collection, delete from there first\n\t\t\titem.collection.splice({remove: item});\n\t\t\titem.collection.dataChanged(\"delete\");\n\t\t}\n\n\t\t // Update collection & closestCollection properties\n\t\tthis.walk(obj => {\n\t\t\tif (obj.closestCollection === item.collection) {\n\t\t\t\tobj.closestCollection = this;\n\t\t\t}\n\n\t\t\t// Belongs to another Mavo?\n\t\t\tif (item.mavo != this.mavo) {\n\t\t\t\titem.mavo = this.mavo;\n\t\t\t}\n\t\t});\n\n\t\titem.collection = this;\n\n\t\t// Adjust templates and their copies\n\t\tif (item.template) {\n\t\t\tMavo.delete(item.template.copies, item);\n\n\t\t\titem.template = this.itemTemplate;\n\t\t}\n\t},\n\n\tdelete: function(item, hard) {\n\t\tif (hard) {\n\t\t\t// Hard delete\n\t\t\t$.remove(item.element);\n\t\t\tthis.splice({remove: item});\n\t\t\treturn;\n\t\t}\n\n\t\treturn $.transition(item.element, {opacity: 0}).then(() => {\n\t\t\titem.deleted = true; // schedule for deletion\n\t\t\titem.element.style.opacity = \"\";\n\n\t\t\titem.dataChanged(\"delete\");\n\n\t\t\tthis.unsavedChanges = item.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t});\n\t},\n\n\tedit: function() {\n\t\tthis.super.edit.call(this);\n\n\t\tif (this.mutable) {\n\t\t\t// Insert the add button if it's not already in the DOM\n\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\tvar tag = this.element.tagName.toLowerCase();\n\t\t\t\tvar containerSelector = Mavo.selectors.container[tag];\n\t\t\t\tvar rel = containerSelector? this.marker.parentNode.closest(containerSelector) : this.marker;\n\t\t\t\t$[this.bottomUp? \"before\" : \"after\"](this.addButton, rel);\n\t\t\t}\n\n\t\t\t// Set up drag & drop\n\t\t\t_.dragula.then(() => {\n\t\t\t\tthis.getDragula();\n\t\t\t});\n\t\t}\n\t},\n\n\tdone: function() {\n\t\tthis.super.done.call(this);\n\n\t\tif (this.mutable) {\n\t\t\tif (this.addButton.parentNode) {\n\t\t\t\tthis.addButton.remove();\n\t\t\t}\n\t\t}\n\t},\n\n\t/**\n\t * Delete all items in the collection.\n\t */\n\tclear: function() {\n\t\tif (this.mutable) {\n\t\t\tthis.propagate(item => {\n\t\t\t\tif (item.element.remove) {\n\t\t\t\t\titem.element.remove();\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// Document fragment, remove all children\n\t\t\t\t\tfor (let node of item.element.childNodes) {\n\t\t\t\t\t\tnode => node.remove();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis.children = [];\n\n\t\t\tthis.dataChanged(\"clear\");\n\t\t}\n\t},\n\n\tdataChanged: function(action, o = {}) {\n\t\to.element = o.element || this.marker;\n\t\treturn this.super.dataChanged.call(this, action, o);\n\t},\n\n\tsave: function() {\n\t\tfor (let item of this.children) {\n\t\t\tif (item.deleted) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t}\n\t\t\telse {\n\t\t\t\titem.unsavedChanges = false;\n\t\t\t}\n\t\t}\n\t},\n\n\tpropagated: [\"save\"],\n\n\trevert: function() {\n\t\tfor (let item of this.children) {\n\t\t\t// Delete added items\n\t\t\tif (item.unsavedChanges) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Bring back deleted items\n\t\t\t\tif (item.deleted) {\n\t\t\t\t\titem.deleted = false;\n\t\t\t\t}\n\n\t\t\t\t// Revert all properties\n\t\t\t\titem.revert();\n\t\t\t}\n\t\t}\n\t},\n\n\tdataRender: function(data) {\n\t\tthis.unhandled = {before: [], after: []};\n\n\t\tif (!data) {\n\t\t\treturn;\n\t\t}\n\n\t\tdata = Mavo.toArray(data);\n\n\t\tif (!this.mutable) {\n\t\t\tthis.children.forEach((item, i) => item.render(data && data[i]));\n\n\t\t\tif (data) {\n\t\t\t\tthis.unhandled.after = data.slice(this.length);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tthis.clear();\n\n\t\t\t// Using document fragments improved rendering performance by 60%\n\t\t\tvar fragment = document.createDocumentFragment();\n\n\t\t\tdata.forEach((datum, i) => {\n\t\t\t\tvar item = this.createItem();\n\n\t\t\t\titem.render(datum);\n\n\t\t\t\tthis.children.push(item);\n\t\t\t\titem.index = i;\n\n\t\t\t\tfragment.appendChild(item.element);\n\n\t\t\t\tvar env = {context: this, item};\n\t\t\t\tMavo.hooks.run(\"collection-add-end\", env);\n\t\t\t});\n\n\t\t\t$[this.bottomUp? \"after\" : \"before\"](fragment, this.marker);\n\t\t}\n\t},\n\n\tfind: function(property, o = {}) {\n\t\tvar items = this.children.filter(item => !item.deleted);\n\n\t\tif (this.property == property) {\n\t\t\treturn o.collections? this : items;\n\t\t}\n\n\t\tif (this.properties.indexOf(property) > -1) {\n\t\t\tvar ret = items.map(item => item.find(property, o));\n\n\t\t\treturn Mavo.flatten(ret);\n\t\t}\n\t},\n\n\tisCompatible: function(c) {\n\t\treturn c && this.itemTemplate.nodeType == c.itemTemplate.nodeType && (c === this\n\t\t       || c.template == this || this.template == c || this.template && this.template == c.template\n\t\t       || this.accepts.indexOf(c.property) > -1);\n\t},\n\n\tlive: {\n\t\tmutable: function(value) {\n\t\t\tif (value && value !== this.mutable) {\n\t\t\t\t// Why is all this code here? Because we want it executed\n\t\t\t\t// every time mutable changes, not just in the constructor\n\t\t\t\t// (think multiple elements with the same property name, where only one has mv-multiple)\n\t\t\t\tthis._mutable = value;\n\n\t\t\t\t// Keep position of the template in the DOM, since we might remove it\n\t\t\t\tthis.marker = document.createComment(\"mv-marker\");\n\t\t\t\tMavo.data(this.marker, \"collection\", this);\n\t\t\t\t$.after(this.marker, this.templateElement);\n\t\t\t}\n\t\t}\n\t},\n\n\t// Make sure to only call after dragula has loaded\n\tgetDragula: function() {\n\t\tif (this.dragula) {\n\t\t\treturn this.dragula;\n\t\t}\n\n\t\tif (this.template) {\n\t\t\tMavo.pushUnique(this.template.getDragula().containers, this.marker.parentNode);\n\t\t\treturn this.dragula = this.template.dragula || this.template.getDragula();\n\t\t}\n\n\t\tvar me = this;\n\t\tthis.dragula = dragula({\n\t\t\tcontainers: [this.marker.parentNode],\n\t\t\tisContainer: el => {\n\t\t\t\tif (this.accepts.length) {\n\t\t\t\t\treturn Mavo.flatten(this.accepts.map(property => this.mavo.root.find(property, {collections: true})))\n\t\t\t\t\t\t\t\t.filter(c => c && c instanceof _)\n\t\t\t\t\t\t\t\t.map(c => c.marker.parentNode)\n\t\t\t\t\t\t\t\t.indexOf(el) > -1;\n\t\t\t\t}\n\n\t\t\t\treturn false;\n\t\t\t},\n\t\t\tmoves: (el, container, handle) => {\n\t\t\t\treturn handle.classList.contains(\"mv-drag-handle\") && handle.closest(Mavo.selectors.multiple) == el;\n\t\t\t},\n\t\t\taccepts: function(el, target, source, next) {\n\t\t\t\tif (el.contains(target)) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tvar previous = next? next.previousElementSibling : target.lastElementChild;\n\n\t\t\t\tvar collection = _.get(previous) || _.get(next);\n\n\t\t\t\tif (!collection) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tvar item = Mavo.Node.get(el);\n\n\t\t\t\treturn item && item.collection.isCompatible(collection);\n\t\t\t}\n\t\t});\n\n\t\tthis.dragula.on(\"drop\", (el, target, source) => {\n\t\t\tvar item = Mavo.Node.get(el);\n\t\t\tvar oldIndex = item && item.index;\n\t\t\tvar next = el.nextElementSibling;\n\t\t\tvar previous = el.previousElementSibling;\n\t\t\tvar collection = _.get(previous) || _.get(next);\n\t\t\tvar closestItem = Mavo.Node.get(previous) || Mavo.Node.get(next);\n\n\t\t\tif (closestItem && closestItem.collection != collection) {\n\t\t\t\tclosestItem = null;\n\t\t\t}\n\n\t\t\tif (item.collection.isCompatible(collection)) {\n\t\t\t\tvar index = closestItem? closestItem.index + (closestItem.element === previous) : collection.length;\n\t\t\t\tcollection.add(item, index);\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturn this.dragula.cancel(true);\n\t\t\t}\n\t\t});\n\n\t\t_.dragulas.push(this.dragula);\n\n\t\treturn this.dragula;\n\t},\n\n\tlazy: {\n\t\tbottomUp: function() {\n\t\t\t/*\n\t\t\t * Add new items at the top or bottom?\n\t\t\t */\n\n\t\t\tif (!this.mutable) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tvar order = this.templateElement.getAttribute(\"mv-order\");\n\t\t\tif (order !== null) {\n\t\t\t\t// Attribute has the highest priority and overrides any heuristics\n\t\t\t\treturn /^desc\\b/i.test(order);\n\t\t\t}\n\n\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\t// If add button not in DOM, do the default\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// If add button is already in the DOM and *before* our template, then we default to prepending\n\t\t\treturn !!(this.addButton.compareDocumentPosition(this.templateElement) & Node.DOCUMENT_POSITION_FOLLOWING);\n\t\t},\n\n\t\tclosestCollection: function() {\n\t\t\tvar parent = this.marker? this.marker.parentNode : this.templateElement.parentNode;\n\n\t\t\treturn parent.closest(Mavo.selectors.multiple);\n\t\t},\n\n\t\taddButton: function() {\n\t\t\t// Find add button if provided, or generate one\n\t\t\tvar selector = `button.mv-add-${this.property}`;\n\t\t\tvar group = this.closestCollection || this.marker.parentNode.closest(Mavo.selectors.group);\n\n\t\t\tif (group) {\n\t\t\t\tvar button = $$(selector, group).filter(button => {\n\t\t\t\t\treturn !this.templateElement.contains(button);\n\t\t\t\t})[0];\n\t\t\t}\n\n\t\t\tif (!button) {\n\t\t\t\tbutton = $.create(\"button\", {\n\t\t\t\t\tclassName: \"mv-add\",\n\t\t\t\t\ttextContent: \"Add \" + this.name\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tbutton.classList.add(\"mv-ui\", \"mv-add\");\n\t\t\tMavo.data(button, \"collection\", this);\n\n\t\t\tif (this.property) {\n\t\t\t\tbutton.classList.add(`mv-add-${this.property}`);\n\t\t\t}\n\n\t\t\tbutton.addEventListener(\"click\", evt => {\n\t\t\t\tevt.preventDefault();\n\n\t\t\t\tthis.add().edit();\n\t\t\t});\n\n\t\t\treturn button;\n\t\t}\n\t},\n\n\tstatic: {\n\t\tdragulas: [],\n\t\tget: element => {\n\t\t\t// Is it an add button or a marker?\n\t\t\tvar collection = Mavo.data(element, \"collection\");\n\n\t\t\tif (collection) {\n\t\t\t\treturn collection;\n\t\t\t}\n\n\t\t\t// Maybe it's a collection item?\n\t\t\tvar item = Mavo.Node.get(element);\n\n\t\t\treturn item && item.collection || null;\n\t\t},\n\n\t\tlazy: {\n\t\t\tdragula: () => $.include(self.dragula, \"https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.js\")\n\t\t}\n\t}\n});\n\nMavo.hooks.add(\"primitive-init-end\", function() {\n\tif (this.collection && !this.attribute) {\n\t\t// Collection of primitives, deal with setting textContent etc without the UI interfering.\n\t\tvar swapUI = callback => {\n\t\t\tvar ret;\n\n\t\t\tthis.sneak(() => {\n\t\t\t\tvar ui = $.remove($(\".mv-item-controls\", this.element));\n\n\t\t\t\tret = callback();\n\n\t\t\t\t$.inside(ui, this.element);\n\t\t\t});\n\n\t\t\treturn ret;\n\t\t};\n\n\t\t// Intercept certain properties so that any Mavo UI inside this primitive will not be destroyed\n\t\t[\"textContent\", \"innerHTML\"].forEach(property => {\n\t\t\tvar descriptor = Object.getOwnPropertyDescriptor(Node.prototype, property);\n\n\t\t\tObject.defineProperty(this.element, property, {\n\t\t\t\tget: function() {\n\t\t\t\t\treturn swapUI(() => descriptor.get.call(this));\n\t\t\t\t},\n\n\t\t\t\tset: function(value) {\n\t\t\t\t\tswapUI(() => descriptor.set.call(this, value));\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n});\n\nMavo.hooks.add(\"node-edit-end\", function() {\n\tif (this.collection) {\n\t\tif (!this.itemControls) {\n\t\t\tthis.itemControls = $$(\".mv-item-controls\", this.element)\n\t\t\t\t\t\t\t\t   .filter(el => el.closest(Mavo.selectors.multiple) == this.element)[0];\n\n\t\t\tthis.itemControls = this.itemControls || $.create({\n\t\t\t\tclassName: \"mv-item-controls mv-ui\"\n\t\t\t});\n\n\t\t\t$.set(this.itemControls, {\n\t\t\t\tcontents: [\n\t\t\t\t\t{\n\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\ttitle: \"Delete this \" + this.name,\n\t\t\t\t\t\tclassName: \"mv-delete\",\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\"click\": evt => this.collection.delete(this)\n\t\t\t\t\t\t}\n\t\t\t\t\t}, {\n\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\ttitle: `Add new ${this.name.replace(/s$/i, \"\")} ${this.collection.bottomUp? \"after\" : \"before\"}`,\n\t\t\t\t\t\tclassName: \"mv-add\",\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\"click\": evt => {\n\t\t\t\t\t\t\t\tvar item = this.collection.add(null, this.index + this.collection.bottomUp);\n\n\t\t\t\t\t\t\t\tif (evt[Mavo.superKey]) {\n\t\t\t\t\t\t\t\t\titem.render(this.data);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tif (!Mavo.inViewport(item.element)) {\n\t\t\t\t\t\t\t\t\titem.element.scrollIntoView({behavior: \"smooth\"});\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\treturn item.edit();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}, {\n\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\ttitle: \"Drag to reorder \" + this.name,\n\t\t\t\t\t\tclassName: \"mv-drag-handle\"\n\t\t\t\t\t}\n\t\t\t\t]\n\t\t\t});\n\t\t}\n\n\t\tif (!this.itemControls.parentNode) {\n\t\t\tif (this.itemControlsComment) {\n\t\t\t\tthis.itemControlsComment.parentNode.replaceChild(this.itemControls, this.itemControlsComment);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis.element.appendChild(this.itemControls);\n\t\t\t}\n\t\t}\n\t}\n});\n\nMavo.hooks.add(\"node-done-end\", function() {\n\tif (this.collection) {\n\t\tif (this.itemControls) {\n\t\t\tthis.itemControlsComment = this.itemControlsComment || document.createComment(\"item controls\");\n\t\t\tthis.itemControls.parentNode.replaceChild(this.itemControlsComment, this.itemControls);\n\t\t}\n\t}\n});\n\nMavo.Node.prototype.getClosestCollection = function() {\n\treturn this.collection ||\n\t\t   this.group.collection ||\n\t\t   (this.parentGroup? this.parentGroup.closestCollection : null);\n};\n\n$.lazy(Mavo.Node.prototype, \"closestCollection\", function() {\n\treturn this.getClosestCollection();\n});\n\n$.live(Mavo.Node.prototype, \"deleted\", function(value) {\n\tthis.element.classList.toggle(\"mv-deleted\", value);\n\n\tif (value) {\n\t\t// Soft delete, store element contents in a fragment\n\t\t// and replace them with an undo prompt.\n\t\tthis.elementContents = document.createDocumentFragment();\n\t\t$$(this.element.childNodes).forEach(node => {\n\t\t\tthis.elementContents.appendChild(node);\n\t\t});\n\n\t\t$.contents(this.element, [\n\t\t\t{\n\t\t\t\ttag: \"button\",\n\t\t\t\tclassName: \"mv-close mv-ui\",\n\t\t\t\ttextContent: \"×\",\n\t\t\t\tevents: {\n\t\t\t\t\t\"click\": function(evt) {\n\t\t\t\t\t\t$.remove(this.parentNode);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\t\"Deleted \" + this.name,\n\t\t\t{\n\t\t\t\ttag: \"button\",\n\t\t\t\tclassName: \"mv-undo mv-ui\",\n\t\t\t\ttextContent: \"Undo\",\n\t\t\t\tevents: {\n\t\t\t\t\t\"click\": evt => this.deleted = false\n\t\t\t\t}\n\t\t\t}\n\t\t]);\n\n\t\tthis.element.classList.remove(\"mv-highlight\");\n\t}\n\telse if (this.deleted) {\n\t\t// Undelete\n\t\tthis.element.textContent = \"\";\n\t\tthis.element.appendChild(this.elementContents);\n\n\t\t// otherwise expressions won't update because this will still seem as deleted\n\t\t// Alternatively, we could fire datachange with a timeout.\n\t\tthis._deleted = false;\n\n\t\tthis.dataChanged(\"undelete\");\n\t}\n});\n\n/**\n * Check if this unit is either deleted or inside a deleted group\n */\nMavo.Node.prototype.isDeleted = function() {\n\tvar ret = this.deleted;\n\n\tif (this.deleted) {\n\t\treturn true;\n\t}\n\n\treturn !!this.parentGroup && this.parentGroup.isDeleted();\n};\n\nMavo.hooks.add(\"node-init-end\", function(env) {\n\tthis.collection = env.options.collection;\n\n\tif (this.collection) {\n\t\t// This is a collection item\n\t\tthis.group = this.parentGroup = this.collection.parentGroup;\n\t}\n});\n\n})(Bliss, Bliss.$);\n"],"sourceRoot":"/source/"}