{"version":3,"sources":["mavo.js"],"names":[],"mappings":"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","file":"mavo.es5.js","sourcesContent":["(function ($, $$) {\n\n\"use strict\";\n\nvar _ = self.Mavo = $.Class({\n\tconstructor: function (element) {\n\t\tthis.treeBuilt = Mavo.defer();\nconsole.trace()\n\t\tthis.element = element;\n\n\t\t// Index among other mavos in the page, 1 is first\n\t\tthis.index = _.all.push(this);\n\n\t\t// Convert any data-mv-* attributes to mv-*\n\t\tvar dataMv = _.attributes.map(attribute => `[data-${attribute}]`);\n\t\tfor (let element of $$(dataMv.join(\", \"), this.element).concat(this.element)) {\n\t\t\tfor (let attribute of _.attributes) {\n\t\t\t\tlet value = element.getAttribute(\"data-\" + attribute);\n\n\t\t\t\tif (value !== null) {\n\t\t\t\t\telement.setAttribute(attribute, value);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Assign a unique (for the page) id to this mavo instance\n\t\t_.allIds.push(this.id = Mavo.getAttribute(this.element, \"mv-app\", \"id\") || `mavo${this.index}`);\n\t\tthis.element.setAttribute(\"mv-app\", this.id);\n\n\t\t// Should we start in edit mode?\n\t\tthis.autoEdit = this.element.classList.contains(\"mv-autoedit\");\n\n\t\t// Should we save automatically?\n\t\tthis.autoSave = this.element.hasAttribute(\"mv-autosave\");\n\n\t\tthis.element.setAttribute(\"typeof\", \"\");\n\n\t\t// Apply heuristic for groups\n\t\t$$(_.selectors.primitive, element).forEach(element => {\n\t\t\tvar hasChildren = $(`${_.selectors.not(_.selectors.formControl)}, ${_.selectors.property}`, element);\n\n\t\t\tif (hasChildren) {\n\t\t\t\tvar config = Mavo.Primitive.getConfig(element);\n\t\t\t\tvar isCollection = Mavo.is(\"multiple\", element);\n\n\t\t\t\tif (isCollection || !config.attribute && !config.hasChildren) {\n\t\t\t\t\telement.setAttribute(\"typeof\", \"\");\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\t// Build mavo objects\n\t\tMavo.hooks.run(\"init-tree-before\", this);\n\n\t\tthis.root = new Mavo.Group(this.element, this);\n\t\tthis.treeBuilt.resolve();\n\n\t\tMavo.hooks.run(\"init-tree-after\", this);\n\n\t\tthis.ui = {\n\t\t\tbar: $(\".mv-bar\", this.element) || $.create({\n\t\t\t\tclassName: \"mv-bar mv-ui\",\n\t\t\t\tstart: this.element\n\t\t\t})\n\t\t};\n\n\t\tthis.ui.bar.classList.toggle(\"mv-compact\", this.ui.bar.parentNode.offsetWidth < 400);\n\t\tthis.ui.bar.classList.toggle(\"mv-tiny\", this.ui.bar.parentNode.offsetWidth < 250);\n\n\t\tthis.ui.status = $(\".mv-status\", this.ui.bar) || $.create(\"span\", {\n\t\t\tclassName: \"mv-status\",\n\t\t\tinside: this.ui.bar\n\t\t});\n\n\t\t// Figure out backends for storage, data reads, and initialization respectively\n\t\tfor (let role of [\"storage\", \"source\", \"init\"]) {\n\t\t\tif (this.index == 1) {\n\t\t\t\tthis[role] = _.Functions.urlOption(role);\n\t\t\t}\n\n\t\t\tif (!this[role]) {\n\t\t\t\tthis[role] =  _.Functions.urlOption(`${this.id}_${role}`) || this.element.getAttribute(\"mv-\" + role) || null;\n\t\t\t}\n\n\t\t\tif (this[role]) {\n\t\t\t\t// We have a string, convert to a backend object\n\t\t\t\tthis[role] = this[role].trim();\n\t\t\t\tthis[role] = this[role] == \"none\"? null : _.Backend.create(this[role], {\n\t\t\t\t\tmavo: this,\n\t\t\t\t\tformat: this.element.getAttribute(\"mv-format-\" + role) || this.element.getAttribute(\"mv-format\")\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tif (!this.storage && !this.source && this.init) {\n\t\t\t// If init is present with no storage and no source, init is equivalent to source\n\t\t\tthis.source = this.init;\n\t\t\tthis.init = null;\n\t\t}\n\n\t\tfor (let role of [\"storage\", \"source\", \"init\"]) {\n\t\t\tif (this[role]) {\n\t\t\t\tthis.primaryBackend = this[role];\n\t\t\t\tthis.permissions = this[role].permissions;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tthis.permissions = this.permissions || new Mavo.Permissions();\n\n\t\tif (this.primaryBackend)  {\n\t\t\t// Reflect backend permissions in global permissions\n\t\t\tthis.authControls = {};\n\n\t\t\t$.style(this.ui.bar, {\n\t\t\t\t\"--mv-backend\": `\"${this.primaryBackend.id}\"`\n\t\t\t});\n\n\t\t\tthis.permissions.can(\"login\", () => {\n\t\t\t\t// #login authenticates if only 1 mavo on the page, or if the first.\n\t\t\t\t// Otherwise, we have to generate a slightly more complex hash\n\t\t\t\tthis.loginHash = \"#login\" + (Mavo.all[0] === this? \"\" : \"-\" + this.id);\n\n\t\t\t\tthis.authControls.login = $.create({\n\t\t\t\t\ttag: \"a\",\n\t\t\t\t\thref: this.loginHash,\n\t\t\t\t\ttextContent: \"Login\",\n\t\t\t\t\ttitle: \"Login\",\n\t\t\t\t\tclassName: \"mv-login mv-button\",\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tclick: evt => {\n\t\t\t\t\t\t\tevt.preventDefault();\n\t\t\t\t\t\t\tthis.primaryBackend.login();\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tafter: $(\".mv-status\", this.ui.bar)\n\t\t\t\t});\n\n\t\t\t\t// We also support a hash to trigger login, in case the user doesn't want visible login UI\n\t\t\t\tvar login;\n\t\t\t\t(login = () => {\n\t\t\t\t\tif (location.hash === this.loginHash) {\n\t\t\t\t\t\t// This just does location.hash = \"\" without getting a pointless # at the end of the URL\n\t\t\t\t\t\thistory.replaceState(null, document.title, new URL(\"\", location) + \"\");\n\t\t\t\t\t\tthis.primaryBackend.login();\n\t\t\t\t\t}\n\t\t\t\t})();\n\t\t\t\twindow.addEventListener(\"hashchange.mavo\", login);\n\t\t\t}, () => {\n\t\t\t\t$.remove(this.authControls.login);\n\t\t\t\tthis.element._.unbind(\"hashchange.mavo\");\n\t\t\t});\n\n\t\t\t// Update login status\n\t\t\tthis.element.addEventListener(\"mavo:login.mavo\", evt => {\n\t\t\t\tif (evt.backend == this.primaryBackend) { // ignore logins from secondary backends\n\t\t\t\t\tvar status = $(\".mv-status\", this.ui.bar);\n\t\t\t\t\tstatus.innerHTML = \"\";\n\t\t\t\t\t$.set(status, {\n\t\t\t\t\t\tcontents: [\n\t\t\t\t\t\t\t{tag: \"strong\", innerHTML: evt.name},\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\t\t\ttextContent: \"Logout\",\n\t\t\t\t\t\t\t\tclassName: \"mv-logout\",\n\t\t\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\t\tclick: e => evt.backend.logout()\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\n\t\t\t\t\t// If last time we rendered we got nothing, maybe now we'll have better luck?\n\t\t\t\t\tif (!this.root.data && !this.unsavedChanges) {\n\t\t\t\t\t\tthis.load();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis.element.addEventListener(\"mavo:logout.mavo\", evt => {\n\t\t\t\t$(\".mv-status\", this.ui.bar).textContent = \"\";\n\t\t\t});\n\t\t}\n\n\t\t// Prevent editing properties inside <summary> to open and close the summary (fix bug #82)\n\t\tif ($(\"summary [property]:not([typeof])\")) {\n\t\t\tthis.element.addEventListener(\"click\", evt => {\n\t\t\t\tif (evt.target != document.activeElement) {\n\t\t\t\t\tevt.preventDefault();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\t// Is there any control that requires an edit button?\n\t\tthis.needsEdit = this.some(obj => obj != this.root && !obj.modes && obj.mode == \"read\");\n\n\t\tthis.setUnsavedChanges(false);\n\n\t\tthis.permissions.onchange(({action, value}) => {\n\t\t\tvar permissions = this.element.getAttribute(\"mv-permissions\") || \"\";\n\t\t\tpermissions = permissions.trim().split(/\\s+/).filter(a => a != action);\n\n\t\t\tif (value) {\n\t\t\t\tpermissions.push(action);\n\t\t\t}\n\n\t\t\tthis.element.setAttribute(\"mv-permissions\", permissions.join(\" \"));\n\t\t});\n\n\t\tif (this.needsEdit) {\n\t\t\tthis.permissions.can([\"edit\", \"add\", \"delete\"], () => {\n\t\t\t\tthis.ui.edit = $.create(\"button\", {\n\t\t\t\t\tclassName: \"mv-edit\",\n\t\t\t\t\ttextContent: \"Edit\",\n\t\t\t\t\ttitle: \"Edit\",\n\t\t\t\t\tinside: this.ui.bar\n\t\t\t\t});\n\n\t\t\t\t// Observe entire tree for mv-mode changes\n\t\t\t\tthis.modeObserver = new Mavo.Observer(this.element, \"mv-mode\", records => {\n\t\t\t\t\tfor (let record of records) {\n\t\t\t\t\t\tlet element = record.target;\n\n\t\t\t\t\t\tnodeloop: for (let node of _.Node.children(element)) {\n\t\t\t\t\t\t\tlet previousMode = node.mode, mode;\n\n\t\t\t\t\t\t\tif (node.element == element) {\n\t\t\t\t\t\t\t\t// If attribute set directly on a Mavo node, then it forces it into that mode\n\t\t\t\t\t\t\t\t// otherwise, descendant nodes still inherit, unless they are also mode-restricted\n\t\t\t\t\t\t\t\tmode = node.element.getAttribute(\"mv-mode\");\n\t\t\t\t\t\t\t\tnode.modes = mode;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t// Inherited\n\t\t\t\t\t\t\t\tif (node.modes) {\n\t\t\t\t\t\t\t\t\t// Mode-restricted, we cannot change to the other mode\n\t\t\t\t\t\t\t\t\tcontinue nodeloop;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tmode = _.getStyle(node.element.parentNode, \"--mv-mode\");\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tnode.mode = mode;\n\n\t\t\t\t\t\t\tif (previousMode != node.mode) {\n\t\t\t\t\t\t\t\tnode[node.mode == \"edit\"? \"edit\" : \"done\"]();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}, {subtree: true});\n\n\t\t\t\tif (this.autoEdit) {\n\t\t\t\t\tthis.edit();\n\t\t\t\t}\n\t\t\t}, () => { // cannot\n\t\t\t\t$.remove(this.ui.edit);\n\n\t\t\t\tif (this.editing) {\n\t\t\t\t\tthis.done();\n\t\t\t\t}\n\n\t\t\t\tthis.modeObserver && this.modeObserver.destroy();\n\t\t\t});\n\t\t}\n\n\t\tif (this.storage) {\n\t\t\tthis.permissions.can(\"delete\", () => {\n\t\t\t\tthis.ui.clear = $.create(\"button\", {\n\t\t\t\t\tclassName: \"mv-clear\",\n\t\t\t\t\ttextContent: \"Clear\",\n\t\t\t\t\ttitle: \"Clear\"\n\t\t\t\t});\n\n\t\t\t\tthis.ui.bar.appendChild(this.ui.clear);\n\t\t\t}, () => {\n\t\t\t\t$.remove(this.ui.clear);\n\t\t\t});\n\t\t}\n\n\t\tif (this.storage || this.source) {\n\t\t\t// Fetch existing data\n\t\t\tthis.permissions.can(\"read\", () => this.load());\n\t\t}\n\t\telse {\n\t\t\t// No storage\n\t\t\tthis.permissions.on([\"read\", \"edit\"]);\n\n\t\t\t$.fire(this.element, \"mavo:load\");\n\t\t}\n\n\t\tthis.permissions.can(\"save\", () => {\n\t\t\tif (this.autoSave) {\n\t\t\t\tvar delay = (this.element.getAttribute(\"mv-autosave\") || 3) * 1000;\n\n\t\t\t\tthis.element.addEventListener(\"mavo:load.mavo:autosave\", evt => {\n\t\t\t\t\tvar debouncedSave = _.debounce(() => {\n\t\t\t\t\t\tthis.save();\n\t\t\t\t\t}, delay);\n\n\t\t\t\t\tvar callback = evt => {\n\t\t\t\t\t\tif (evt.node.saved) {\n\t\t\t\t\t\t\tdebouncedSave();\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\n\t\t\t\t\trequestAnimationFrame(() => {\n\t\t\t\t\t\tthis.permissions.can(\"save\", () => {\n\t\t\t\t\t\t\tthis.element.addEventListener(\"mavo:datachange.mavo:autosave\", callback);\n\t\t\t\t\t\t}, () => {\n\t\t\t\t\t\t\tthis.element.removeEventListener(\"mavo:datachange.mavo:autosave\", callback);\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (!this.autoSave || delay > 0) {\n\t\t\t\t// If throttling is disabled, the Save button is pointless\n\t\t\t\tthis.ui.save = $.create(\"button\", {\n\t\t\t\t\tclassName: \"mv-save\",\n\t\t\t\t\ttextContent: \"Save\",\n\t\t\t\t\ttitle: \"Save\",\n\t\t\t\t\tinside: this.ui.bar\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t$.events(this.ui.save, {\n\t\t\t\t\"mouseenter focus\": e => {\n\t\t\t\t\tthis.element.classList.add(\"mv-highlight-unsaved\");\n\t\t\t\t},\n\t\t\t\t\"mouseleave blur\": e => this.element.classList.remove(\"mv-highlight-unsaved\")\n\t\t\t});\n\t\t}, () => {\n\t\t\t$.remove(this.ui.save);\n\t\t\tthis.ui.save = null;\n\t\t\tthis.element.removeEventListener(\".mavo:autosave\");\n\t\t});\n\n\t\t$.delegate(this.element, \"click\", {\n\t\t\t\".mv-save\": evt => {\n\t\t\t\tif (this.permissions.save) {\n\t\t\t\t\tthis.save();\n\t\t\t\t}\n\t\t\t},\n\t\t\t\".mv-edit\": evt => {\n\t\t\t\tif (this.editing || !this.permissions.edit) {\n\t\t\t\t\tthis.done();\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthis.edit();\n\t\t\t\t}\n\t\t\t},\n\t\t\t\".mv-clear\": evt => {\n\t\t\t\tif (this.permissions.delete) {\n\t\t\t\t\tthis.clear();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\t// Ctrl + S or Cmd + S to save\n\t\tthis.element.addEventListener(\"keydown\", evt => {\n\t\t\tif (evt.keyCode == 83 && evt[_.superKey]) {\n\t\t\t\tevt.preventDefault();\n\t\t\t\tthis.save();\n\t\t\t}\n\t\t});\n\n\t\tMavo.hooks.run(\"init-end\", this);\n\t},\n\n\tget editing() {\n\t\treturn this.root.editing;\n\t},\n\n\tgetData: function() {\n\t\treturn this.root.getData();\n\t},\n\n\ttoJSON: function() {\n\t\treturn _.toJSON(this.getData());\n\t},\n\n\terror: function(message, ...log) {\n\t\tvar close = () => $.transition(error, {opacity: 0}).then($.remove);\n\t\tvar closeTimeout;\n\t\tvar error = $.create(\"p\", {\n\t\t\tclassName: \"mv-error mv-ui\",\n\t\t\tcontents: [\n\t\t\t\tmessage,\n\t\t\t\t{\n\t\t\t\t\ttag: \"button\",\n\t\t\t\t\tclassName: \"mv-close mv-ui\",\n\t\t\t\t\ttextContent: \"×\",\n\t\t\t\t\tevents: {\n\t\t\t\t\t\t\"click\": close\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t],\n\t\t\tevents: {\n\t\t\t\tmouseenter: e => clearTimeout(closeTimeout),\n\t\t\t\tmouseleave: _.rr(e => closeTimeout = setTimeout(close, 5000)),\n\t\t\t\tclick: e => this.element.scrollIntoView({behavior: \"smooth\"})\n\t\t\t},\n\t\t\tstart: this.element\n\t\t});\n\n\t\t// Log more info for programmers\n\t\tif (log.length > 0) {\n\t\t\tconsole.log(`%c${this.id}: ${message}`, \"color: red; font-weight: bold\", ...log);\n\t\t}\n\t},\n\n\trender: function(data) {\n\t\tvar env = {context: this, data};\n\n\t\t_.hooks.run(\"render-start\", env);\n\n\t\tif (env.data) {\n\t\t\tthis.root.render(env.data);\n\t\t}\n\n\t\tthis.unsavedChanges = false;\n\n\t\t_.hooks.run(\"render-end\", env);\n\t},\n\n\tclear: function() {\n\t\tif (confirm(\"This will delete all your data. Are you sure?\")) {\n\t\t\tthis.store(null).then(() => this.root.clear());\n\t\t}\n\t},\n\n\tedit: function() {\n\t\tthis.root.edit();\n\n\t\t$.events(this.element, \"mouseenter.mavo:edit mouseleave.mavo:edit\", evt => {\n\t\t\tif (evt.target.matches(\".mv-item-controls *\")) {\n\t\t\t\tvar item = evt.target.closest(_.selectors.multiple);\n\t\t\t\titem.classList.toggle(\"mv-highlight\", evt.type == \"mouseenter\");\n\t\t\t}\n\n\t\t\tif (evt.target.matches(_.selectors.multiple)) {\n\t\t\t\tevt.target.classList.remove(\"mv-has-hovered-item\");\n\n\t\t\t\tvar parent = evt.target.parentNode.closest(_.selectors.multiple);\n\n\t\t\t\tif (parent) {\n\t\t\t\t\tparent.classList.toggle(\"mv-has-hovered-item\", evt.type == \"mouseenter\");\n\t\t\t\t}\n\t\t\t}\n\t\t}, true);\n\n\t\tthis.setUnsavedChanges();\n\t},\n\n\t/**\n\t * Set this mavo instance’s unsavedChanges flag.\n\t * @param {Boolean} [value]\n\t *        If true, just sets the flag to true, no traversal.\n\t *        If false, sets the flag of the Mavo instance and every tree node to false\n\t *        If not provided, traverses the tree and recalculates the flag value.\n\t */\n\tsetUnsavedChanges: function(value) {\n\t\tvar unsavedChanges = !!value;\n\n\t\tif (!value) {\n\t\t\tthis.walk(obj => {\n\t\t\t\tif (obj.unsavedChanges) {\n\t\t\t\t\tunsavedChanges = true;\n\n\t\t\t\t\tif (value === false) {\n\t\t\t\t\t\tobj.unsavedChanges = false;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn this.unsavedChanges = unsavedChanges;\n\t},\n\n\t// Conclude editing\n\tdone: function() {\n\t\tthis.root.done();\n\t\t$.unbind(this.element, \".mavo:edit\");\n\t\tthis.unsavedChanges = false;\n\t},\n\n\t/**\n\t * load - Fetch data from source and render it.\n\t *\n\t * @return {Promise}  A promise that resolves when the data is loaded.\n\t */\n\tload: function() {\n\t\tthis.inProgress = \"Loading\";\n\n\t\tvar backend = this.source || this.storage;\n\n\t\treturn backend.ready.then(() => backend.load())\n\t\t.catch(err => {\n\t\t\t// Try again with init\n\t\t\tif (this.init && this.init != backend) {\n\t\t\t\tbackend = this.init;\n\t\t\t\treturn this.init.ready.then(() => this.init.load());\n\t\t\t}\n\n\t\t\t// No init, propagate error\n\t\t\treturn Promise.reject(err);\n\t\t})\n\t\t.catch(err => {\n\t\t\tif (err) {\n\t\t\t\tvar xhr = err instanceof XMLHttpRequest? err : err.xhr;\n\n\t\t\t\tif (xhr && xhr.status == 404) {\n\t\t\t\t\tthis.render(null);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tvar message = \"Problem loading data\";\n\n\t\t\t\t\tif (xhr) {\n\t\t\t\t\t\tmessage += xhr.status? `: HTTP error ${err.status}: ${err.statusText}` : \": Can’t connect to the Internet\";\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.error(message, err);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn null;\n\t\t})\n\t\t.then(data => this.render(data))\n\t\t.then(() => {\n\t\t\tthis.inProgress = false;\n\t\t\t$.fire(this.element, \"mavo:load\");\n\t\t});\n\t},\n\n\tstore: function() {\n\t\tif (!this.storage) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.inProgress = \"Saving\";\n\n\t\treturn this.storage.login()\n\t\t\t.then(() => this.storage.store(this.getData()))\n\t\t\t.catch(err => {\n\t\t\t\tif (err) {\n\t\t\t\t\tvar message = \"Problem saving data\";\n\n\t\t\t\t\tif (err instanceof XMLHttpRequest) {\n\t\t\t\t\t\tmessage += xhr.status? `: HTTP error ${err.status}: ${err.statusText}` : \": Can’t connect to the Internet\";\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.error(message, err);\n\t\t\t\t}\n\n\t\t\t\treturn null;\n\t\t\t})\n\t\t\t.then(saved => {\n\t\t\t\tthis.inProgress = false;\n\t\t\t\treturn saved;\n\t\t\t});\n\t},\n\n\tsave: function() {\n\t\treturn this.store().then(saved => {\n\t\t\tif (saved) {\n\t\t\t\t$.fire(this.element, \"mavo:save\", saved);\n\n\t\t\t\tthis.lastSaved = Date.now();\n\t\t\t\tthis.root.save();\n\t\t\t\tthis.unsavedChanges = false;\n\t\t\t}\n\t\t});\n\t},\n\n\twalk: function(callback) {\n\t\treturn this.root.walk(callback);\n\t},\n\n\t/**\n\t * Executes a test on every node. If ANY node passes (test returns true),\n\t * the function returns true. Otherwise, it returns false.\n\t * Similar semantics to Array.prototype.some().\n\t */\n\tsome: function(test) {\n\t\treturn !this.walk((obj, path) => {\n\t\t\tvar ret = test(obj, path);\n\n\t\t\tif (ret === true) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t});\n\t},\n\n\tlive: {\n\t\tinProgress: function(value) {\n\t\t\t$.toggleAttribute(this.element, \"mv-progress\", value, value);\n\t\t},\n\n\t\tunsavedChanges: function(value) {\n\t\t\tthis.element.classList.toggle(\"mv-unsaved-changes\", value);\n\t\t},\n\n\t\tneedsEdit: function(value) {\n\t\t\t$.remove(this.ui.edit);\n\t\t}\n\t},\n\n\tstatic: {\n\t\tall: [],\n\n\t\tallIds: [],\n\n\t\tget: function(id) {\n\t\t\tfor (let mavo of _.all) {\n\t\t\t\tif (mavo.id === id) {\n\t\t\t\t\treturn mavo;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn null;\n\t\t},\n\n\t\tsuperKey: navigator.platform.indexOf(\"Mac\") === 0? \"metaKey\" : \"ctrlKey\",\n\n\t\tinit: function(container) {\n\t\t\treturn $$(_.selectors.init, container || document)\n\t\t\t\t.filter(element => element == document.documentElement || !element.parentNode.closest(_.selectors.init))\n\t\t\t\t.map(element => new _(element));\n\t\t},\n\n\t\tplugin: function(o) {\n\t\t\t_.hooks.add(o.hooks);\n\n\t\t\tfor (let Class in o.extend) {\n\t\t\t\tlet def = Class == \"Mavo\"? _ : _[Class];\n\t\t\t\t$.Class(def, o.extend[Class]);\n\t\t\t}\n\t\t},\n\n\t\thooks: new $.Hooks(),\n\n\t\tattributes: [\n\t\t\t\"mv-app\", \"mv-storage\", \"mv-source\", \"mv-init\", \"mv-path\", \"mv-format\",\n\t\t\t\"mv-attribute\", \"mv-default\", \"mv-mode\", \"mv-edit\", \"mv-permisssions\"\n\t\t]\n\t}\n});\n\n{\n\nlet s = _.selectors = {\n\tinit: \".mv-app, [mv-app], [data-mv-app], [mv-storage], [data-mv-storage]\",\n\tproperty: \"[property], [itemprop]\",\n\tspecificProperty: name => `[property=${name}], [itemprop=${name}]`,\n\tgroup: \"[typeof], [itemscope], [itemtype], [mv-group]\",\n\tmultiple: \"[mv-multiple]\",\n\tformControl: \"input, select, option, textarea\",\n\tui: \".mv-ui\",\n\tcontainer: {\n\t\t// \"li\": \"ul, ol\",\n\t\t\"tr\": \"table\",\n\t\t\"option\": \"select\",\n\t\t// \"dt\": \"dl\",\n\t\t// \"dd\": \"dl\"\n\t}\n};\n\nlet arr = s.arr = selector => selector.split(/\\s*,\\s*/g);\nlet not = s.not = selector => arr(selector).map(s => `:not(${s})`).join(\"\");\nlet or = s.or = (selector1, selector2) => selector1 + \", \" + selector2;\nlet and = s.and = (selector1, selector2) => {\n\tvar ret = [], arr2 = arr(selector2);\n\n\tarr(selector1).forEach(s1 => ret.push(...arr2.map(s2 => s1 + s2)));\n\n\treturn ret.join(\", \");\n};\nlet andNot = s.andNot = (selector1, selector2) => and(selector1, not(selector2));\n\n$.extend(_.selectors, {\n\tprimitive: andNot(s.property, s.group),\n\trootGroup: andNot(s.group, s.property),\n\toutput: or(s.specificProperty(\"output\"), \".mv-output, .mv-value\")\n});\n\n}\n\n// Init mavo\nPromise.all([\n\t$.ready(),\n\t$.include(Array.from && window.Intl && document.documentElement.closest, \"https://cdn.polyfill.io/v2/polyfill.min.js?features=blissfuljs,Intl.~locale.en\")\n])\n.catch(err => console.error(err))\n.then(() => Mavo.init());\n\nStretchy.selectors.filter = \".mv-editor:not([property])\";\n\n})(Bliss, Bliss.$);\n"],"sourceRoot":"/source/"}