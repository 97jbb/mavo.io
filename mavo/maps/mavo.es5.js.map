{"version":3,"sources":["backend.js"],"names":["$","_","Mavo","Backend","Class","constructor","url","o","source","URL","base","mavo","format","Formats","create","permissions","Permissions","get","searchParams","set","Date","now","fetch","href","then","Promise","resolve","xhr","responseText","load","ready","response","replace","parse","store","data","path","serialize","stringify","put","serialized","login","logout","isAuthenticated","accessToken","oAuthParams","toString","id","equals","backend","request","call","method","req","responseType","headers","type","Object","keys","map","p","encodeURIComponent","join","JSON","apiDomain","catch","err","reject","error","oAuthenticate","passive","toLowerCase","localStorage","popup","width","Math","min","innerWidth","height","innerHeight","top","screen","screenTop","left","screenLeft","state","location","authPopup","open","oAuth","key","addEventListener","evt","token","Error","oAuthLogout","removeItem","off","on","element","fire","static","types","filter","test","Remote","register","prototype","push","extends","slice","inside","document","body","textContent","indexOf","value","Bliss"],"mappings":"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","file":"../mavo.es5.js","sourcesContent":["(function($) {\n\n/**\n * Base class for all backends\n */\nvar _ = Mavo.Backend = $.Class({\n\tconstructor: function(url, o = {}) {\n\t\tthis.source = url;\n\t\tthis.url = new URL(this.source, Mavo.base);\n\t\tthis.mavo = o.mavo;\n\t\tthis.format = Mavo.Formats.create(o.format, this);\n\n\t\t// Permissions of this particular backend.\n\t\tthis.permissions = new Mavo.Permissions();\n\t},\n\n\tget: function() {\n\t\tvar url = new URL(this.url);\n\t\turl.searchParams.set(\"timestamp\", Date.now()); // ensure fresh copy\n\n\t\treturn $.fetch(this.url.href).then(xhr => Promise.resolve(xhr.responseText), () => Promise.resolve(null));\n\t},\n\n\tload: function() {\n\t\treturn this.ready\n\t\t\t.then(() => this.get())\n\t\t\t.then(response => {\n\t\t\tif (typeof response != \"string\") {\n\t\t\t\t// Backend did the parsing, we're done here\n\t\t\t\treturn response;\n\t\t\t}\n\n\t\t\tresponse = response.replace(/^\\ufeff/, \"\"); // Remove Unicode BOM\n\n\t\t\treturn this.format.parse(response);\n\t\t});\n\t},\n\n\tstore: function(data, {path, format = this.format} = {}) {\n\t\treturn this.ready.then(() => {\n\t\t\tvar serialize = typeof data === \"string\"? Promise.resolve(data) : format.stringify(data);\n\n\t\t\treturn serialize.then(serialized => this.put(serialized, path).then(() => {\n\t\t\t\treturn {data, serialized};\n\t\t\t}));\n\t\t});\n\t},\n\n\t// To be be overriden by subclasses\n\tready: Promise.resolve(),\n\tlogin: () => Promise.resolve(),\n\tlogout: () => Promise.resolve(),\n\n\tisAuthenticated: function() {\n\t\treturn !!this.accessToken;\n\t},\n\n\t// Any extra params to be passed to the oAuth URL.\n\toAuthParams: () => \"\",\n\n\ttoString: function() {\n\t\treturn `${this.id} (${this.url})`;\n\t},\n\n\tequals: function(backend) {\n\t\treturn backend === this || (backend && this.id == backend.id && this.source == backend.source);\n\t},\n\n\t/**\n\t * Helper for making OAuth requests with JSON-based APIs.\n\t */\n\trequest: function(call, data, method = \"GET\", req = {}) {\n\t\treq.method = req.method || method;\n\t\treq.responseType = req.responseType || \"json\";\n\t\treq.headers = req.headers || {};\n\t\treq.headers[\"Content-Type\"] = req.headers[\"Content-Type\"] || \"application/json; charset=utf-8\";\n\t\treq.data = data;\n\n\t\tif (this.isAuthenticated()) {\n\t\t\treq.headers[\"Authorization\"] = req.headers[\"Authorization\"] || `Bearer ${this.accessToken}`;\n\t\t}\n\n\t\tif ($.type(req.data) === \"object\") {\n\t\t\tif (req.method == \"GET\") {\n\t\t\t\treq.data = Object.keys(req.data).map(p => p + \"=\" + encodeURIComponent(req.data[p])).join(\"&\");\n\t\t\t}\n\t\t\telse {\n\t\t\t\treq.data = JSON.stringify(req.data);\n\t\t\t}\n\t\t}\n\n\t\tcall = new URL(call, this.constructor.apiDomain);\n\n\t\treturn $.fetch(call, req)\n\t\t\t.catch(err => {\n\t\t\t\tif (err && err.xhr) {\n\t\t\t\t\treturn Promise.reject(err.xhr);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthis.mavo.error(\"Something went wrong while connecting to \" + this.id, err);\n\t\t\t\t}\n\t\t\t})\n\t\t\t.then(xhr => req.method == \"HEAD\"? xhr : xhr.response);\n\t},\n\n\t/**\n\t * Helper method for authenticating in OAuth APIs\n\t */\n\toAuthenticate: function(passive) {\n\t\treturn this.ready.then(() => {\n\t\t\tif (this.isAuthenticated()) {\n\t\t\t\treturn Promise.resolve();\n\t\t\t}\n\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tvar id = this.id.toLowerCase();\n\n\t\t\t\tif (passive) {\n\t\t\t\t\tthis.accessToken = localStorage[`mavo:${id}token`];\n\n\t\t\t\t\tif (this.accessToken) {\n\t\t\t\t\t\tresolve(this.accessToken);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// Show window\n\t\t\t\t\tvar popup = {\n\t\t\t\t\t\twidth: Math.min(1000, innerWidth - 100),\n\t\t\t\t\t\theight: Math.min(800, innerHeight - 100)\n\t\t\t\t\t};\n\n\t\t\t\t\tpopup.top = (innerHeight - popup.height)/2 + (screen.top || screenTop);\n\t\t\t\t\tpopup.left = (innerWidth - popup.width)/2 + (screen.left || screenLeft);\n\n\t\t\t\t\tvar state = {\n\t\t\t\t\t\turl: location.href,\n\t\t\t\t\t\tbackend: this.id\n\t\t\t\t\t};\n\n\t\t\t\t\tthis.authPopup = open(`${this.constructor.oAuth}?client_id=${this.key}&state=${encodeURIComponent(JSON.stringify(state))}` + this.oAuthParams(),\n\t\t\t\t\t\t\"popup\", `width=${popup.width},height=${popup.height},left=${popup.left},top=${popup.top}`);\n\n\t\t\t\t\taddEventListener(\"message\", evt => {\n\t\t\t\t\t\tif (evt.source === this.authPopup) {\n\t\t\t\t\t\t\tif (evt.data.backend == this.id) {\n\t\t\t\t\t\t\t\tthis.accessToken = localStorage[`mavo:${id}token`] = evt.data.token;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (!this.accessToken) {\n\t\t\t\t\t\t\t\treject(Error(\"Authentication error\"));\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tresolve(this.accessToken);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t},\n\n\t/**\n\t * oAuth logout helper\n\t */\n\toAuthLogout: function() {\n\t\tif (this.isAuthenticated()) {\n\t\t\tvar id = this.id.toLowerCase();\n\n\t\t\tlocalStorage.removeItem(`mavo:${id}token`);\n\t\t\tdelete this.accessToken;\n\n\t\t\tthis.permissions.off([\"edit\", \"add\", \"delete\", \"save\"]).on(\"login\");\n\n\t\t\tthis.mavo.element._.fire(\"mavo:logout\", {backend: this});\n\t\t}\n\n\t\treturn Promise.resolve();\n\t},\n\n\tstatic: {\n\t\t// Return the appropriate backend(s) for this url\n\t\tcreate: function(url, o) {\n\t\t\tif (url) {\n\t\t\t\tvar Backend = _.types.filter(Backend => Backend.test(url))[0] || _.Remote;\n\n\t\t\t\treturn new Backend(url, o);\n\t\t\t}\n\n\t\t\treturn null;\n\t\t},\n\n\t\ttypes: [],\n\n\t\tregister: function(Class) {\n\t\t\t_[Class.prototype.id] = Class;\n\t\t\t_.types.push(Class);\n\t\t\treturn Class;\n\t\t}\n\t}\n});\n\n/**\n * Save in an HTML element\n */\n_.register($.Class({\n\tid: \"Element\",\n\textends: _,\n\tconstructor: function () {\n\t\tthis.permissions.on([\"read\", \"edit\", \"save\"]);\n\n\t\tthis.element = $(this.source) || $.create(\"script\", {\n\t\t\ttype: \"application/json\",\n\t\t\tid: this.source.slice(1),\n\t\t\tinside: document.body\n\t\t});\n\t},\n\n\tget: function() {\n\t\treturn Promise.resolve(this.element.textContent);\n\t},\n\n\tput: function(serialized) {\n\t\treturn Promise.resolve(this.element.textContent = serialized);\n\t},\n\n\tstatic: {\n\t\ttest: url => url.indexOf(\"#\") === 0\n\t}\n}));\n\n// Load from a remote URL, no save\n_.register($.Class({\n\tid: \"Remote\",\n\textends: _,\n\tconstructor: function() {\n\t\tthis.permissions.on(\"read\");\n\t},\n\n\tstatic: {\n\t\ttest: url => false\n\t}\n}));\n\n// Save in localStorage\n_.register($.Class({\n\textends: _,\n\tid: \"Local\",\n\tconstructor: function() {\n\t\tthis.permissions.on([\"read\", \"edit\", \"save\"]);\n\t\tthis.key = this.mavo.id;\n\t},\n\n\tget: function() {\n\t\treturn Promise[this.key in localStorage? \"resolve\" : \"reject\"](localStorage[this.key]);\n\t},\n\n\tput: function(serialized) {\n\t\tif (!serialized) {\n\t\t\tdelete localStorage[this.key];\n\t\t}\n\t\telse {\n\t\t\tlocalStorage[this.key] = serialized;\n\t\t}\n\n\t\treturn Promise.resolve(serialized);\n\t},\n\n\tstatic: {\n\t\ttest: value => value == \"local\"\n\t}\n}));\n\n})(Bliss);\n"]}