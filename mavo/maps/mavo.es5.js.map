{"version":3,"sources":["mavo.js"],"names":["$","$$","_","self","Mavo","Class","constructor","element","treeBuilt","defer","index","length","Object","defineProperty","all","value","dataMv","attributes","map","attribute","join","concat","getAttribute","setAttribute","id","i","autoEdit","classList","contains","autoSave","hasAttribute","selectors","primitive","forEach","hasChildren","not","formControl","property","config","Primitive","getConfig","isCollection","is","hooks","run","root","Group","resolve","ui","bar","create","className","start","toggle","parentNode","offsetWidth","status","inside","permissions","Permissions","backendTypes","role","updateBackend","authControls","backendObserver","Observer","changed","roles","records","record","attributeName","replace","source","load","storage","init","data","can","loginHash","login","tag","href","textContent","title","events","click","evt","preventDefault","primaryBackend","after","Functions","urlOption","remove","addEventListener","backend","innerHTML","set","contents","name","logout","unsavedChanges","target","document","activeElement","needsEdit","some","obj","modes","mode","setUnsavedChanges","onchange","action","undefined","console","trace","trim","split","filter","a","push","edit","modeObserver","nodeloop","Node","children","node","previousMode","getStyle","subtree","editing","done","destroy","clear","appendChild","fire","delay","debouncedSave","debounce","save","callback","saved","requestAnimationFrame","removeEventListener","add","delegate","delete","keyCode","superKey","getData","toJSON","error","message","close","transition","opacity","then","closeTimeout","mouseenter","clearTimeout","mouseleave","rr","setTimeout","scrollIntoView","behavior","log","render","env","context","confirm","store","matches","itemControls","closest","item","type","multiple","parent","walk","unbind","previous","equals","Backend","mavo","format","inProgress","ready","catch","Promise","reject","err","xhr","XMLHttpRequest","statusText","lastSaved","Date","now","test","path","ret","live","toggleAttribute","_storage","_primaryBackend","style","setProperty","removeProperty","static","keys","get","Element","navigator","platform","indexOf","include","Array","from","window","Intl","documentElement","container","plugins","plugin","o","extend","def","Hooks","s","specificProperty","group","arr","selector","or","selector1","selector2","and","arr2","s1","s2","andNot","rootGroup","output","Stretchy","Bliss"],"mappings":"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","file":"../mavo.es5.js","sourcesContent":["(function ($, $$) {\n\n\"use strict\";\n\nvar _ = self.Mavo = $.Class({\n\tconstructor: function (element) {\n\t\tthis.treeBuilt = Mavo.defer();\n\n\t\tthis.element = element;\n\n\t\t// Index among other mavos in the page, 1 is first\n\t\tthis.index = _.length + 1;\n\t\tObject.defineProperty(_.all, this.index - 1, {value: this});\n\n\t\t// Convert any data-mv-* attributes to mv-*\n\t\tvar dataMv = _.attributes.map(attribute => `[data-${attribute}]`);\n\t\tfor (let element of $$(dataMv.join(\", \"), this.element).concat(this.element)) {\n\t\t\tfor (let attribute of _.attributes) {\n\t\t\t\tlet value = element.getAttribute(\"data-\" + attribute);\n\n\t\t\t\tif (value !== null) {\n\t\t\t\t\telement.setAttribute(attribute, value);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Assign a unique (for the page) id to this mavo instance\n\t\tthis.id = Mavo.getAttribute(this.element, \"mv-app\", \"id\") || `mavo${this.index}`;\n\n\t\tif (this.id in _.all) {\n\t\t\t// Duplicate app name\n\t\t\tfor (var i=2; this.id + i in _.all; i++) {}\n\t\t\tthis.id = this.id + i;\n\t\t}\n\n\t\t_.all[this.id] = this;\n\t\tthis.element.setAttribute(\"mv-app\", this.id);\n\n\t\t// Should we start in edit mode?\n\t\tthis.autoEdit = this.element.classList.contains(\"mv-autoedit\");\n\n\t\t// Should we save automatically?\n\t\tthis.autoSave = this.element.hasAttribute(\"mv-autosave\");\n\n\t\tthis.element.setAttribute(\"typeof\", \"\");\n\n\t\t// Apply heuristic for groups\n\t\t$$(_.selectors.primitive, element).forEach(element => {\n\t\t\tvar hasChildren = $(`${_.selectors.not(_.selectors.formControl)}, ${_.selectors.property}`, element);\n\n\t\t\tif (hasChildren) {\n\t\t\t\tvar config = Mavo.Primitive.getConfig(element);\n\t\t\t\tvar isCollection = Mavo.is(\"multiple\", element);\n\n\t\t\t\tif (isCollection || !config.attribute && !config.hasChildren) {\n\t\t\t\t\telement.setAttribute(\"typeof\", \"\");\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\t// Build mavo objects\n\t\tMavo.hooks.run(\"init-tree-before\", this);\n\n\t\tthis.root = new Mavo.Group(this.element, this);\n\t\tthis.treeBuilt.resolve();\n\n\t\tMavo.hooks.run(\"init-tree-after\", this);\n\n\t\tthis.ui = {\n\t\t\tbar: $(\".mv-bar\", this.element) || $.create({\n\t\t\t\tclassName: \"mv-bar mv-ui\",\n\t\t\t\tstart: this.element\n\t\t\t})\n\t\t};\n\n\t\tthis.ui.bar.classList.toggle(\"mv-compact\", this.ui.bar.parentNode.offsetWidth < 400);\n\t\tthis.ui.bar.classList.toggle(\"mv-tiny\", this.ui.bar.parentNode.offsetWidth < 250);\n\n\t\tthis.ui.status = $(\".mv-status\", this.ui.bar) || $.create(\"span\", {\n\t\t\tclassName: \"mv-status\",\n\t\t\tinside: this.ui.bar\n\t\t});\n\n\t\tthis.permissions = new Mavo.Permissions();\n\n\t\tvar backendTypes = [\"source\", \"storage\", \"init\"]; // order is significant!\n\n\t\t// Figure out backends for storage, data reads, and initialization respectively\n\t\tfor (let role of backendTypes) {\n\t\t\tthis.updateBackend(role);\n\t\t}\n\n\t\tthis.authControls = {};\n\n\t\tthis.backendObserver = new Mavo.Observer(this.element, backendTypes.map(role => \"mv-\" + role), records => {\n\t\t\tvar changed = {};\n\n\t\t\tvar roles = records.map(record => {\n\t\t\t\tvar role = record.attributeName.replace(/^mv-/, \"\");\n\t\t\t\tchanged[role] = this.updateBackend(role);\n\n\t\t\t\treturn role;\n\t\t\t});\n\n\t\t\t// Do we need to re-load data?\n\t\t\tif (changed.source) {  // if source changes, always reload\n\t\t\t\tthis.load();\n\t\t\t}\n\t\t\telse if (!this.source) {\n\t\t\t\tif (changed.storage || changed.init && !this.root.data) {\n\t\t\t\t\tthis.load();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tthis.permissions.can(\"login\", () => {\n\t\t\t// #login authenticates if only 1 mavo on the page, or if the first.\n\t\t\t// Otherwise, we have to generate a slightly more complex hash\n\t\t\tthis.loginHash = \"#login\" + (Mavo.all[0] === this? \"\" : \"-\" + this.id);\n\n\t\t\tthis.authControls.login = $.create({\n\t\t\t\ttag: \"a\",\n\t\t\t\thref: this.loginHash,\n\t\t\t\ttextContent: \"Login\",\n\t\t\t\ttitle: \"Login\",\n\t\t\t\tclassName: \"mv-login mv-button\",\n\t\t\t\tevents: {\n\t\t\t\t\tclick: evt => {\n\t\t\t\t\t\tevt.preventDefault();\n\t\t\t\t\t\tthis.primaryBackend.login();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tafter: $(\".mv-status\", this.ui.bar)\n\t\t\t});\n\n\t\t\t// We also support a URL param to trigger login, in case the user doesn't want visible login UI\n\t\t\tif (Mavo.Functions.urlOption(\"login\") !== null) {\n\t\t\t\tthis.primaryBackend.login();\n\t\t\t}\n\t\t}, () => {\n\t\t\t$.remove(this.authControls.login);\n\t\t});\n\n\t\t// Update login status\n\t\tthis.element.addEventListener(\"mavo:login.mavo\", evt => {\n\t\t\tif (evt.backend == this.primaryBackend) { // ignore logins from secondary backends\n\t\t\t\tvar status = $(\".mv-status\", this.ui.bar);\n\t\t\t\tstatus.innerHTML = \"\";\n\t\t\t\t$.set(status, {\n\t\t\t\t\tcontents: [\n\t\t\t\t\t\t{tag: \"strong\", innerHTML: evt.name},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\t\ttextContent: \"Logout\",\n\t\t\t\t\t\t\tclassName: \"mv-logout\",\n\t\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\tclick: e => evt.backend.logout()\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t});\n\n\t\t\t\t// If last time we rendered we got nothing, maybe now we'll have better luck?\n\t\t\t\tif (!this.root.data && !this.unsavedChanges) {\n\t\t\t\t\tthis.load();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tthis.element.addEventListener(\"mavo:logout.mavo\", evt => {\n\t\t\tif (evt.backend == this.primaryBackend) { // ignore logouts from secondary backends\n\t\t\t\t$(\".mv-status\", this.ui.bar).textContent = \"\";\n\t\t\t}\n\t\t});\n\n\t\t// Prevent editing properties inside <summary> to open and close the summary (fix bug #82)\n\t\tif ($(\"summary [property]:not([typeof])\")) {\n\t\t\tthis.element.addEventListener(\"click\", evt => {\n\t\t\t\tif (evt.target != document.activeElement) {\n\t\t\t\t\tevt.preventDefault();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\t// Is there any control that requires an edit button?\n\t\tthis.needsEdit = this.some(obj => obj != this.root && !obj.modes && obj.mode == \"read\");\n\n\t\tthis.setUnsavedChanges(false);\n\n\t\tthis.permissions.onchange(({action, value}) => {\n\t\t\tif (action === undefined) {\n\t\t\t\tconsole.trace();\n\t\t\t}\n\t\t\tvar permissions = this.element.getAttribute(\"mv-permissions\") || \"\";\n\t\t\tpermissions = permissions.trim().split(/\\s+/).filter(a => a != action);\n\n\t\t\tif (value) {\n\t\t\t\tpermissions.push(action);\n\t\t\t}\n\n\t\t\tthis.element.setAttribute(\"mv-permissions\", permissions.join(\" \"));\n\t\t});\n\n\t\tif (this.needsEdit) {\n\t\t\tthis.permissions.can([\"edit\", \"add\", \"delete\"], () => {\n\t\t\t\tthis.ui.edit = $.create(\"button\", {\n\t\t\t\t\tclassName: \"mv-edit\",\n\t\t\t\t\ttextContent: \"Edit\",\n\t\t\t\t\ttitle: \"Edit\",\n\t\t\t\t\tinside: this.ui.bar\n\t\t\t\t});\n\n\t\t\t\t// Observe entire tree for mv-mode changes\n\t\t\t\tthis.modeObserver = new Mavo.Observer(this.element, \"mv-mode\", records => {\n\t\t\t\t\tfor (let record of records) {\n\t\t\t\t\t\tlet element = record.target;\n\n\t\t\t\t\t\tnodeloop: for (let node of _.Node.children(element)) {\n\t\t\t\t\t\t\tlet previousMode = node.mode, mode;\n\n\t\t\t\t\t\t\tif (node.element == element) {\n\t\t\t\t\t\t\t\t// If attribute set directly on a Mavo node, then it forces it into that mode\n\t\t\t\t\t\t\t\t// otherwise, descendant nodes still inherit, unless they are also mode-restricted\n\t\t\t\t\t\t\t\tmode = node.element.getAttribute(\"mv-mode\");\n\t\t\t\t\t\t\t\tnode.modes = mode;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t// Inherited\n\t\t\t\t\t\t\t\tif (node.modes) {\n\t\t\t\t\t\t\t\t\t// Mode-restricted, we cannot change to the other mode\n\t\t\t\t\t\t\t\t\tcontinue nodeloop;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tmode = _.getStyle(node.element.parentNode, \"--mv-mode\");\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tnode.mode = mode;\n\n\t\t\t\t\t\t\tif (previousMode != node.mode) {\n\t\t\t\t\t\t\t\tnode[node.mode == \"edit\"? \"edit\" : \"done\"]();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}, {subtree: true});\n\n\t\t\t\tif (this.autoEdit) {\n\t\t\t\t\tthis.edit();\n\t\t\t\t}\n\t\t\t}, () => { // cannot\n\t\t\t\t$.remove(this.ui.edit);\n\n\t\t\t\tif (this.editing) {\n\t\t\t\t\tthis.done();\n\t\t\t\t}\n\n\t\t\t\tthis.modeObserver && this.modeObserver.destroy();\n\t\t\t});\n\t\t}\n\n\t\tthis.permissions.can(\"delete\", () => {\n\t\t\tthis.ui.clear = $.create(\"button\", {\n\t\t\t\tclassName: \"mv-clear\",\n\t\t\t\ttextContent: \"Clear\",\n\t\t\t\ttitle: \"Clear\"\n\t\t\t});\n\n\t\t\tthis.ui.bar.appendChild(this.ui.clear);\n\t\t}, () => {\n\t\t\t$.remove(this.ui.clear);\n\t\t});\n\n\t\tif (this.storage || this.source) {\n\t\t\t// Fetch existing data\n\t\t\tthis.permissions.can(\"read\", () => this.load());\n\t\t}\n\t\telse {\n\t\t\t// No storage or source\n\t\t\t$.fire(this.element, \"mavo:load\");\n\t\t}\n\n\t\tthis.permissions.can(\"save\", () => {\n\t\t\tif (this.autoSave) {\n\t\t\t\tvar delay = (this.element.getAttribute(\"mv-autosave\") || 3) * 1000;\n\n\t\t\t\tthis.element.addEventListener(\"mavo:load.mavo:autosave\", evt => {\n\t\t\t\t\tvar debouncedSave = _.debounce(() => {\n\t\t\t\t\t\tthis.save();\n\t\t\t\t\t}, delay);\n\n\t\t\t\t\tvar callback = evt => {\n\t\t\t\t\t\tif (evt.node.saved) {\n\t\t\t\t\t\t\tdebouncedSave();\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\n\t\t\t\t\trequestAnimationFrame(() => {\n\t\t\t\t\t\tthis.permissions.can(\"save\", () => {\n\t\t\t\t\t\t\tthis.element.addEventListener(\"mavo:datachange.mavo:autosave\", callback);\n\t\t\t\t\t\t}, () => {\n\t\t\t\t\t\t\tthis.element.removeEventListener(\"mavo:datachange.mavo:autosave\", callback);\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (!this.autoSave || delay > 0) {\n\t\t\t\t// If throttling is disabled, the Save button is pointless\n\t\t\t\tthis.ui.save = $.create(\"button\", {\n\t\t\t\t\tclassName: \"mv-save\",\n\t\t\t\t\ttextContent: \"Save\",\n\t\t\t\t\ttitle: \"Save\",\n\t\t\t\t\tinside: this.ui.bar\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t$.events(this.ui.save, {\n\t\t\t\t\"mouseenter focus\": e => {\n\t\t\t\t\tthis.element.classList.add(\"mv-highlight-unsaved\");\n\t\t\t\t},\n\t\t\t\t\"mouseleave blur\": e => this.element.classList.remove(\"mv-highlight-unsaved\")\n\t\t\t});\n\t\t}, () => {\n\t\t\t$.remove(this.ui.save);\n\t\t\tthis.ui.save = null;\n\t\t\tthis.element.removeEventListener(\".mavo:autosave\");\n\t\t});\n\n\t\t$.delegate(this.element, \"click\", {\n\t\t\t\".mv-save\": evt => {\n\t\t\t\tif (this.permissions.save) {\n\t\t\t\t\tthis.save();\n\t\t\t\t}\n\t\t\t},\n\t\t\t\".mv-edit\": evt => {\n\t\t\t\tif (this.editing || !this.permissions.edit) {\n\t\t\t\t\tthis.done();\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthis.edit();\n\t\t\t\t}\n\t\t\t},\n\t\t\t\".mv-clear\": evt => {\n\t\t\t\tif (this.permissions.delete) {\n\t\t\t\t\tthis.clear();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\t// Ctrl + S or Cmd + S to save\n\t\tthis.element.addEventListener(\"keydown\", evt => {\n\t\t\tif (evt.keyCode == 83 && evt[_.superKey]) {\n\t\t\t\tevt.preventDefault();\n\t\t\t\tthis.save();\n\t\t\t}\n\t\t});\n\n\t\tMavo.hooks.run(\"init-end\", this);\n\t},\n\n\tget editing() {\n\t\treturn this.root.editing;\n\t},\n\n\tgetData: function() {\n\t\treturn this.root.getData();\n\t},\n\n\ttoJSON: function() {\n\t\treturn _.toJSON(this.getData());\n\t},\n\n\terror: function(message, ...log) {\n\t\tvar close = () => $.transition(error, {opacity: 0}).then($.remove);\n\t\tvar closeTimeout;\n\t\tvar error = $.create(\"p\", {\n\t\t\tclassName: \"mv-error mv-ui\",\n\t\t\tcontents: [\n\t\t\t\tmessage,\n\t\t\t\t{\n\t\t\t\t\ttag: \"button\",\n\t\t\t\t\tclassName: \"mv-close mv-ui\",\n\t\t\t\t\ttextContent: \"×\",\n\t\t\t\t\tevents: {\n\t\t\t\t\t\t\"click\": close\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t],\n\t\t\tevents: {\n\t\t\t\tmouseenter: e => clearTimeout(closeTimeout),\n\t\t\t\tmouseleave: _.rr(e => closeTimeout = setTimeout(close, 5000)),\n\t\t\t\tclick: e => this.element.scrollIntoView({behavior: \"smooth\"})\n\t\t\t},\n\t\t\tstart: this.element\n\t\t});\n\n\t\t// Log more info for programmers\n\t\tif (log.length > 0) {\n\t\t\tconsole.log(`%c${this.id}: ${message}`, \"color: red; font-weight: bold\", ...log);\n\t\t}\n\t},\n\n\trender: function(data) {\n\t\tvar env = {context: this, data};\n\n\t\t_.hooks.run(\"render-start\", env);\n\n\t\tif (env.data) {\n\t\t\tthis.root.render(env.data);\n\t\t}\n\n\t\tthis.unsavedChanges = false;\n\n\t\t_.hooks.run(\"render-end\", env);\n\t},\n\n\tclear: function() {\n\t\tif (confirm(\"This will delete all your data. Are you sure?\")) {\n\t\t\tthis.store(null).then(() => this.root.clear());\n\t\t}\n\t},\n\n\tedit: function() {\n\t\tthis.root.edit();\n\n\t\t$.events(this.element, \"mouseenter.mavo:edit mouseleave.mavo:edit\", evt => {\n\t\t\tif (evt.target.matches(\".mv-item-controls *\")) {\n\t\t\t\tvar itemControls = evt.target.closest(\".mv-item-controls\");\n\t\t\t\tvar item = Mavo.data(itemControls, \"item\");\n\n\t\t\t\tif (item && item.element) {\n\t\t\t\t\titem.element.classList.toggle(\"mv-highlight\", evt.type == \"mouseenter\");\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (evt.target.matches(_.selectors.multiple)) {\n\t\t\t\tevt.target.classList.remove(\"mv-has-hovered-item\");\n\n\t\t\t\tvar parent = evt.target.parentNode.closest(_.selectors.multiple);\n\n\t\t\t\tif (parent) {\n\t\t\t\t\tparent.classList.toggle(\"mv-has-hovered-item\", evt.type == \"mouseenter\");\n\t\t\t\t}\n\t\t\t}\n\t\t}, true);\n\n\t\tthis.setUnsavedChanges();\n\t},\n\n\t/**\n\t * Set this mavo instance’s unsavedChanges flag.\n\t * @param {Boolean} [value]\n\t *        If true, just sets the flag to true, no traversal.\n\t *        If false, sets the flag of the Mavo instance and every tree node to false\n\t *        If not provided, traverses the tree and recalculates the flag value.\n\t */\n\tsetUnsavedChanges: function(value) {\n\t\tvar unsavedChanges = !!value;\n\n\t\tif (!value) {\n\t\t\tthis.walk(obj => {\n\t\t\t\tif (obj.unsavedChanges) {\n\t\t\t\t\tunsavedChanges = true;\n\n\t\t\t\t\tif (value === false) {\n\t\t\t\t\t\tobj.unsavedChanges = false;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn this.unsavedChanges = unsavedChanges;\n\t},\n\n\t// Conclude editing\n\tdone: function() {\n\t\tthis.root.done();\n\t\t$.unbind(this.element, \".mavo:edit\");\n\t\tthis.unsavedChanges = false;\n\t},\n\n\t/**\n\t * Update the backend for a given role\n\t * @return {Boolean} true if a change occurred, false otherwise\n\t */\n\tupdateBackend: function(role) {\n\t\tvar previous = this[role], backend;\n\n\t\tif (this.index == 1) {\n\t\t\tbackend = _.Functions.urlOption(role);\n\t\t}\n\n\t\tif (!backend) {\n\t\t\tbackend =  _.Functions.urlOption(`${this.id}-${role}`) || this.element.getAttribute(\"mv-\" + role) || null;\n\t\t}\n\n\t\tif (backend) {\n\t\t\tbackend = backend.trim();\n\n\t\t\tif (backend == \"none\") {\n\t\t\t\tbackend = null;\n\t\t\t}\n\t\t}\n\n\t\tif (backend && (!previous || !previous.equals(backend))) {\n\t\t\t// We have a string, convert to a backend object if different than existing\n\t\t\tthis[role] = backend = _.Backend.create(backend, {\n\t\t\t\tmavo: this,\n\t\t\t\tformat: this.element.getAttribute(\"mv-format-\" + role) || this.element.getAttribute(\"mv-format\")\n\t\t\t});\n\t\t}\n\t\telse if (!backend) {\n\t\t\t// We had a backend and now we will un-have it\n\t\t\tthis[role] = null;\n\t\t}\n\n\t\tvar changed = backend? !backend.equals(previous) : !!previous;\n\n\t\tif (changed) {\n\t\t\t// A change occured\n\t\t\tif (!this.storage && !this.source && this.init) {\n\t\t\t\t// If init is present with no storage and no source, init is equivalent to source\n\t\t\t\tthis.source = this.init;\n\t\t\t\tthis.init = null;\n\t\t\t}\n\n\t\t\tvar permissions = this.storage? this.storage.permissions : new Mavo.Permissions({edit: true, save: false});\n\t\t\tpermissions.parent = this.source && this.source.permissions;\n\t\t\tthis.permissions.parent = permissions;\n\n\t\t\tthis.primaryBackend = this.storage || this.source;\n\t\t}\n\n\t\treturn changed;\n\t},\n\n\t/**\n\t * load - Fetch data from source and render it.\n\t *\n\t * @return {Promise}  A promise that resolves when the data is loaded.\n\t */\n\tload: function() {\n\t\tvar backend = this.source || this.storage;\n\n\t\tif (!backend) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.inProgress = \"Loading\";\n\n\t\treturn backend.ready.then(() => backend.load())\n\t\t.catch(err => {\n\t\t\t// Try again with init\n\t\t\tif (this.init && this.init != backend) {\n\t\t\t\tbackend = this.init;\n\t\t\t\treturn this.init.ready.then(() => this.init.load());\n\t\t\t}\n\n\t\t\t// No init, propagate error\n\t\t\treturn Promise.reject(err);\n\t\t})\n\t\t.catch(err => {\n\t\t\tif (err) {\n\t\t\t\tvar xhr = err instanceof XMLHttpRequest? err : err.xhr;\n\n\t\t\t\tif (xhr && xhr.status == 404) {\n\t\t\t\t\tthis.render(null);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tvar message = \"Problem loading data\";\n\n\t\t\t\t\tif (xhr) {\n\t\t\t\t\t\tmessage += xhr.status? `: HTTP error ${err.status}: ${err.statusText}` : \": Can’t connect to the Internet\";\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.error(message, err);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn null;\n\t\t})\n\t\t.then(data => this.render(data))\n\t\t.then(() => {\n\t\t\tthis.inProgress = false;\n\t\t\t$.fire(this.element, \"mavo:load\");\n\t\t});\n\t},\n\n\tstore: function() {\n\t\tif (!this.storage) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.inProgress = \"Saving\";\n\n\t\treturn this.storage.login()\n\t\t\t.then(() => this.storage.store(this.getData()))\n\t\t\t.catch(err => {\n\t\t\t\tif (err) {\n\t\t\t\t\tvar message = \"Problem saving data\";\n\n\t\t\t\t\tif (err instanceof XMLHttpRequest) {\n\t\t\t\t\t\tmessage += xhr.status? `: HTTP error ${err.status}: ${err.statusText}` : \": Can’t connect to the Internet\";\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.error(message, err);\n\t\t\t\t}\n\n\t\t\t\treturn null;\n\t\t\t})\n\t\t\t.then(saved => {\n\t\t\t\tthis.inProgress = false;\n\t\t\t\treturn saved;\n\t\t\t});\n\t},\n\n\tsave: function() {\n\t\treturn this.store().then(saved => {\n\t\t\tif (saved) {\n\t\t\t\t$.fire(this.element, \"mavo:save\", saved);\n\n\t\t\t\tthis.lastSaved = Date.now();\n\t\t\t\tthis.root.save();\n\t\t\t\tthis.unsavedChanges = false;\n\t\t\t}\n\t\t});\n\t},\n\n\twalk: function(callback) {\n\t\treturn this.root.walk(callback);\n\t},\n\n\t/**\n\t * Executes a test on every node. If ANY node passes (test returns true),\n\t * the function returns true. Otherwise, it returns false.\n\t * Similar semantics to Array.prototype.some().\n\t */\n\tsome: function(test) {\n\t\treturn !this.walk((obj, path) => {\n\t\t\tvar ret = test(obj, path);\n\n\t\t\tif (ret === true) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t});\n\t},\n\n\tlive: {\n\t\tinProgress: function(value) {\n\t\t\t$.toggleAttribute(this.element, \"mv-progress\", value, value);\n\t\t},\n\n\t\tunsavedChanges: function(value) {\n\t\t\tthis.element.classList.toggle(\"mv-unsaved-changes\", value);\n\t\t},\n\n\t\tneedsEdit: function(value) {\n\t\t\t$.remove(this.ui.edit);\n\t\t},\n\n\t\tstorage: function(value) {\n\t\t\tif (value !== this._storage && !value) {\n\t\t\t\tvar permissions = new Mavo.Permissions({edit: true, save: false});\n\t\t\t\tpermissions.parent = this.permissions.parent;\n\t\t\t\tthis.permissions.parent = permissions;\n\t\t\t}\n\t\t},\n\n\t\tprimaryBackend: function(value) {\n\t\t\tvalue = value || null;\n\n\t\t\tif (value != this._primaryBackend) {\n\t\t\t\tif (value)  {\n\t\t\t\t\tthis.ui.bar.style.setProperty(\"--mv-backend\", `\"${value.id}\"`);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthis.ui.bar.style.removeProperty(\"--mv-backend\");\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t}\n\t\t}\n\t},\n\n\tstatic: {\n\t\tall: {},\n\n\t\tget length() {\n\t\t\treturn Object.keys(_.all).length;\n\t\t},\n\n\t\tget: function(id) {\n\t\t\tif (id instanceof Element) {\n\t\t\t\t// Get by element\n\t\t\t\tfor (var name in _.all) {\n\t\t\t\t\tif (_.all[name].element == id) {\n\t\t\t\t\t\treturn _.all[name];\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tvar name = typeof id === \"number\"? Object.keys(_.all)[id] : id;\n\n\t\t\treturn _.all[name] || null;\n\t\t},\n\n\t\tsuperKey: navigator.platform.indexOf(\"Mac\") === 0? \"metaKey\" : \"ctrlKey\",\n\n\t\tready: Promise.all([\n\t\t\t$.ready(),\n\t\t\t$.include(Array.from && window.Intl && document.documentElement.closest, \"https://cdn.polyfill.io/v2/polyfill.min.js?features=blissfuljs,Intl.~locale.en\")\n\t\t]),\n\n\t\tinit: function(container = document) {\n\t\t\treturn $$(_.selectors.init, container)\n\t\t\t\t.filter(element => !_.get(element)) // not already inited\n\t\t\t\t.map(element => new _(element));\n\t\t},\n\n\t\tplugins: {},\n\n\t\tplugin: function(o) {\n\t\t\t_.hooks.add(o.hooks);\n\n\t\t\tfor (let Class in o.extend) {\n\t\t\t\tlet def = Class == \"Mavo\"? _ : _[Class];\n\t\t\t\t$.Class(def, o.extend[Class]);\n\t\t\t}\n\n\t\t\tif (o.name) {\n\t\t\t\t_.plugins[o.name] = o;\n\t\t\t}\n\t\t},\n\n\t\thooks: new $.Hooks(),\n\n\t\tattributes: [\n\t\t\t\"mv-app\", \"mv-storage\", \"mv-source\", \"mv-init\", \"mv-path\", \"mv-format\",\n\t\t\t\"mv-attribute\", \"mv-default\", \"mv-mode\", \"mv-edit\", \"mv-permisssions\"\n\t\t]\n\t}\n});\n\n{\n\nlet s = _.selectors = {\n\tinit: \".mv-app, [mv-app], [data-mv-app]\",\n\tproperty: \"[property], [itemprop]\",\n\tspecificProperty: name => `[property=${name}], [itemprop=${name}]`,\n\tgroup: \"[typeof], [itemscope], [itemtype], [mv-group]\",\n\tmultiple: \"[mv-multiple]\",\n\tformControl: \"input, select, option, textarea\",\n\tui: \".mv-ui\",\n\tcontainer: {\n\t\t// \"li\": \"ul, ol\",\n\t\t\"tr\": \"table\",\n\t\t\"option\": \"select\",\n\t\t// \"dt\": \"dl\",\n\t\t// \"dd\": \"dl\"\n\t}\n};\n\nlet arr = s.arr = selector => selector.split(/\\s*,\\s*/g);\nlet not = s.not = selector => arr(selector).map(s => `:not(${s})`).join(\"\");\nlet or = s.or = (selector1, selector2) => selector1 + \", \" + selector2;\nlet and = s.and = (selector1, selector2) => {\n\tvar ret = [], arr2 = arr(selector2);\n\n\tarr(selector1).forEach(s1 => ret.push(...arr2.map(s2 => s1 + s2)));\n\n\treturn ret.join(\", \");\n};\nlet andNot = s.andNot = (selector1, selector2) => and(selector1, not(selector2));\n\n$.extend(_.selectors, {\n\tprimitive: andNot(s.property, s.group),\n\trootGroup: andNot(s.group, s.property),\n\toutput: or(s.specificProperty(\"output\"), \".mv-output, .mv-value\")\n});\n\n}\n\n// Init mavo. Async to give other scripts a chance to modify stuff.\nrequestAnimationFrame(() => _.ready.catch(console.error).then(() => Mavo.init()));\n\nStretchy.selectors.filter = \".mv-editor:not([property])\";\n\n})(Bliss, Bliss.$);\n"]}