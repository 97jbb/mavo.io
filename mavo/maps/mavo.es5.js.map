{"version":3,"sources":["domexpression.js"],"names":["$","_","Mavo","DOMExpression","Class","constructor","o","mavo","template","prop","undefined","node","elementPath","item","element","path","attribute","hooks","run","expression","nodeType","parentNode","children","length","normalize","getAttribute","trim","firstChild","childNodes","whitespace","textContent","match","splitText","after","lastChild","insertBefore","parsed","syntax","tokenize","oldValue","value","map","x","Expression","Node","get","closest","selectors","treeBuilt","then","elements","set","changedBy","evt","every","expr","update","data","event","env","context","ret","parentEnv","i","eval","Error","fallback","presentational","Array","isArray","join","Primitive","formatNumber","primitive","datatype","output","setValue","live","_item","delete","expressions","push","static","WeakMap","search","all","arguments","filter","et","Bliss"],"mappings":"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","file":"../mavo.es5.js","sourcesContent":["(function($) {\n\nvar _ = Mavo.DOMExpression = $.Class({\n\tconstructor: function(o = {}) {\n\t\tthis.mavo = o.mavo;\n\t\tthis.template = o.template && o.template.template || o.template;\n\n\t\tfor (let prop of [\"item\", \"path\", \"syntax\", \"fallback\", \"attribute\"]) {\n\t\t\tthis[prop] = o[prop] === undefined && this.template? this.template[prop] : o[prop];\n\t\t}\n\n\t\tthis.node = o.node;\n\n\t\tif (!this.node) {\n\t\t\t// No node provided, figure it out from path\n\t\t\tthis.node = Mavo.elementPath(this.item.element, this.path);\n\t\t}\n\n\t\tthis.element = this.node;\n\t\tthis.attribute = this.attribute || null;\n\n\t\tMavo.hooks.run(\"domexpression-init-start\", this);\n\n\t\tif (!this.expression) { // Still unhandled?\n\t\t\tif (this.node.nodeType === 3) {\n\t\t\t\tthis.element = this.node.parentNode;\n\n\t\t\t\t// If no element siblings make this.node the element, which is more robust\n\t\t\t\t// Same if attribute, there are no attributes on a text node!\n\t\t\t\tif (!this.node.parentNode.children.length || this.attribute) {\n\t\t\t\t\tthis.node = this.element;\n\t\t\t\t\tthis.element.normalize();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (this.attribute) {\n\t\t\t\tthis.expression = this.node.getAttribute(this.attribute).trim();\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Move whitespace outside to prevent it from messing with types\n\t\t\t\tthis.node.normalize();\n\n\t\t\t\tif (this.node.firstChild && this.node.childNodes.length === 1 && this.node.firstChild.nodeType === 3) {\n\t\t\t\t\tvar whitespace = this.node.firstChild.textContent.match(/^\\s*|\\s*$/g);\n\n\t\t\t\t\tif (whitespace[1]) {\n\t\t\t\t\t\tthis.node.firstChild.splitText(this.node.firstChild.textContent.length - whitespace[1].length);\n\t\t\t\t\t\t$.after(this.node.lastChild, this.node);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (whitespace[0]) {\n\t\t\t\t\t\tthis.node.firstChild.splitText(whitespace[0].length);\n\t\t\t\t\t\tthis.node.parentNode.insertBefore(this.node.firstChild, this.node);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tthis.expression = this.node.textContent;\n\t\t\t}\n\n\n\t\t\tthis.parsed = o.template? o.template.parsed : this.syntax.tokenize(this.expression);\n\t\t}\n\n\t\tthis.oldValue = this.value = this.parsed.map(x => x instanceof Mavo.Expression? x.expression : x);\n\n\t\tthis.item = Mavo.Node.get(this.element.closest(Mavo.selectors.item));\n\n\t\tthis.mavo.treeBuilt.then(() => {\n\t\t\tif (!this.template && !this.item) {\n\t\t\t\t// Only collection items and groups can have their own expressions arrays\n\t\t\t\tthis.item = Mavo.Node.get(this.element.closest(Mavo.selectors.item));\n\t\t\t}\n\n\t\t\tMavo.hooks.run(\"domexpression-init-treebuilt\", this);\n\t\t});\n\n\t\tMavo.hooks.run(\"domexpression-init-end\", this);\n\n\t\t_.elements.set(this.element, [...(_.elements.get(this.element) || []), this]);\n\t},\n\n\tchangedBy: function(evt) {\n\t\treturn !this.parsed.every(expr => !(expr instanceof Mavo.Expression) || !expr.changedBy(evt));\n\t},\n\n\tupdate: function(data = this.data, event) {\n\t\tvar env = {context: this, ret: {}, event};\n\t\tvar parentEnv = env;\n\n\t\tthis.data = data;\n\n\t\tenv.ret = {};\n\n\t\tMavo.hooks.run(\"domexpression-update-start\", env);\n\n\t\tthis.oldValue = this.value;\n\n\t\tenv.ret.value = this.value = this.parsed.map((expr, i) => {\n\t\t\tif (expr instanceof Mavo.Expression) {\n\t\t\t\tif (expr.changedBy(parentEnv.event)) {\n\t\t\t\t\tvar env = {context: this, expr, parentEnv};\n\n\t\t\t\t\tMavo.hooks.run(\"domexpression-update-beforeeval\", env);\n\n\t\t\t\t\tenv.value = env.expr.eval(data);\n\n\t\t\t\t\tMavo.hooks.run(\"domexpression-update-aftereval\", env);\n\n\t\t\t\t\tif (env.value instanceof Error) {\n\t\t\t\t\t\treturn this.fallback !== undefined? this.fallback : env.expr.expression;\n\t\t\t\t\t}\n\t\t\t\t\tif (env.value === undefined || env.value === null) {\n\t\t\t\t\t\t// Don’t print things like \"undefined\" or \"null\"\n\t\t\t\t\t\treturn \"\";\n\t\t\t\t\t}\n\n\t\t\t\t\treturn env.value;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\treturn this.oldValue[i];\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn expr;\n\t\t});\n\n\t\tif (!this.attribute) {\n\t\t\t// Separate presentational & actual values only apply when content is variable\n\t\t\tenv.ret.presentational = this.value.map(value => {\n\t\t\t\tif (Array.isArray(value)) {\n\t\t\t\t\treturn value.join(\", \");\n\t\t\t\t}\n\n\t\t\t\tif (typeof value == \"number\") {\n\t\t\t\t\treturn Mavo.Primitive.formatNumber(value);\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t});\n\n\t\t\tenv.ret.presentational = env.ret.presentational.length === 1? env.ret.presentational[0] : env.ret.presentational.join(\"\");\n\t\t}\n\n\t\tenv.ret.value = env.ret.value.length === 1? env.ret.value[0] : env.ret.value.join(\"\");\n\n\t\tif (this.primitive && this.parsed.length === 1) {\n\t\t\tif (typeof env.ret.value === \"number\") {\n\t\t\t\tthis.primitive.datatype = \"number\";\n\t\t\t}\n\t\t\telse if (typeof env.ret.value === \"boolean\") {\n\t\t\t\tthis.primitive.datatype = \"boolean\";\n\t\t\t}\n\t\t}\n\n\t\tif (env.ret.presentational === env.ret.value) {\n\t\t\tenv.ret = env.ret.value;\n\t\t}\n\n\t\tthis.output(env.ret);\n\n\t\tMavo.hooks.run(\"domexpression-update-end\", env);\n\t},\n\n\toutput: function(value) {\n\t\tif (this.primitive) {\n\t\t\tthis.primitive.value = value;\n\t\t}\n\t\telse {\n\t\t\tvalue = value.presentational || value;\n\t\t\tMavo.Primitive.setValue(this.node, value, {attribute: this.attribute});\n\t\t}\n\t},\n\n\tlive: {\n\t\titem: function(item) {\n\t\t\tif (item && this._item != item) {\n\t\t\t\tif (this._item) {\n\t\t\t\t\t// Previous item, delete from its expressions\n\t\t\t\t\tMavo.delete(this._item.expressions, this);\n\t\t\t\t}\n\n\t\t\t\titem.expressions = item.expressions || [];\n\t\t\t\titem.expressions.push(this);\n\t\t\t}\n\t\t}\n\t},\n\n\tstatic: {\n\t\telements: new WeakMap(),\n\n\t\t/**\n\t\t * Search for Mavo.DOMExpression object(s) associated with a given element\n\t\t * and optionally an attribute.\n\t\t *\n\t\t * @return If one argument, array of matching DOMExpression objects.\n\t\t *         If two arguments, the matching DOMExpression object or null\n\t\t */\n\t\tsearch: function(element, attribute) {\n\t\t\tvar all = _.elements.get(element) || [];\n\n\t\t\tif (arguments.length > 1) {\n\t\t\t\tif (!all.length) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\treturn all.filter(et => et.attribute === attribute)[0] || null;\n\t\t\t}\n\n\t\t\treturn all;\n\t\t}\n\t}\n});\n\n})(Bliss);\n"]}