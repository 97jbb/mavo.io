{"version":3,"sources":["backend.dropbox.js"],"names":["$","_","Mavo","Backend","register","Class","extends","id","constructor","permissions","on","key","mavo","element","getAttribute","url","URL","location","hostname","search","replace","login","put","serialized","path","request","headers","JSON","stringify","mode","oAuthParams","encodeURIComponent","getUser","user","Promise","resolve","then","username","info","email","name","display_name","avatar","profile_photo_url","passive","oAuthenticate","logout","source","path_lower","oAuthLogout","static","apiDomain","oAuth","test","host","Bliss"],"mappings":";;AAAA,CAAC,UAASA,CAAT,EAAY;;AAEb,KAAIC,IAAIC,KAAKC,OAAL,CAAaC,QAAb,CAAsBJ,EAAEK,KAAF,CAAQ;AACrCC,WAASJ,KAAKC,OADuB;AAErCI,MAAI,SAFiC;AAGrCC,eAAa,uBAAW;AACvB,QAAKC,WAAL,CAAiBC,EAAjB,CAAoB,CAAC,OAAD,EAAU,MAAV,CAApB;;AAEA,QAAKC,GAAL,GAAW,KAAKC,IAAL,CAAUC,OAAV,CAAkBC,YAAlB,CAA+B,gBAA/B,KAAoD,iBAA/D;;AAEA;AACA,QAAKC,GAAL,GAAW,IAAIC,GAAJ,CAAQ,KAAKD,GAAb,EAAkBE,QAAlB,CAAX;;AAEA,QAAKF,GAAL,CAASG,QAAT,GAAoB,2BAApB;AACA,QAAKH,GAAL,CAASI,MAAT,GAAkB,KAAKJ,GAAL,CAASI,MAAT,CAAgBC,OAAhB,CAAwB,WAAxB,EAAqC,OAArC,CAAlB;;AAEA,QAAKC,KAAL,CAAW,IAAX;AACA,GAfoC;;AAiBrC;;;;;AAKAC,OAAK,aAASC,UAAT,EAAqBC,IAArB,EAA2B;AAC/B,UAAO,KAAKC,OAAL,CAAa,+CAAb,EAA8DF,UAA9D,EAA0E,MAA1E,EAAkF;AACxFG,aAAS;AACR,wBAAmBC,KAAKC,SAAL,CAAe;AACjCJ,YAAM,KAAKA,IADsB;AAEjCK,YAAM;AAF2B,MAAf,CADX;AAKR,qBAAgB;AALR;AAD+E,IAAlF,CAAP;AASA,GAhCoC;;AAkCrCC,eAAa;AAAA,6BAAuBC,mBAAmB,sBAAnB,CAAvB;AAAA,GAlCwB;;AAoCrCC,WAAS,mBAAW;AAAA;;AACnB,OAAI,KAAKC,IAAT,EAAe;AACd,WAAOC,QAAQC,OAAR,CAAgB,KAAKF,IAArB,CAAP;AACA;;AAED,UAAO,KAAKR,OAAL,CAAa,2BAAb,EAA0C,MAA1C,EAAkD,MAAlD,EACLW,IADK,CACA,gBAAQ;AACb,UAAKH,IAAL,GAAY;AACXI,eAAUC,KAAKC,KADJ;AAEXC,WAAMF,KAAKE,IAAL,CAAUC,YAFL;AAGXC,aAAQJ,KAAKK,iBAHF;AAIXL;AAJW,KAAZ;AAMA,IARK,CAAP;AASA,GAlDoC;;AAoDrCjB,SAAO,eAASuB,OAAT,EAAkB;AAAA;;AACxB,UAAO,KAAKC,aAAL,CAAmBD,OAAnB,EACLR,IADK,CACA;AAAA,WAAM,OAAKJ,OAAL,EAAN;AAAA,IADA,EAELI,IAFK,CAEA,aAAK;AACV,QAAI,OAAKH,IAAT,EAAe;AACd,YAAKxB,WAAL,CAAiBqC,MAAjB,GAA0B,IAA1B;;AAEA;AACA,YAAKrB,OAAL,CAAa,kCAAb,EAAiD;AAChD,aAAO,OAAKsB;AADoC,MAAjD,EAEG,MAFH,EAEWX,IAFX,CAEgB,gBAAQ;AACvB,aAAKZ,IAAL,GAAYc,KAAKU,UAAjB;AACA,aAAKvC,WAAL,CAAiBC,EAAjB,CAAoB,CAAC,MAAD,EAAS,MAAT,CAApB;AACA,MALD;AAMA;AACD,IAdK,CAAP;AAeA,GApEoC;;AAsErCoC,UAAQ,kBAAW;AAClB,UAAO,KAAKG,WAAL,EAAP;AACA,GAxEoC;;AA0ErCC,UAAQ;AACPC,cAAW,+BADJ;AAEPC,UAAO,0CAFA;;AAIPC,SAAM,cAAStC,GAAT,EAAc;AACnBA,UAAM,IAAIC,GAAJ,CAAQD,GAAR,EAAaE,QAAb,CAAN;AACA,WAAO,eAAcoC,IAAd,CAAmBtC,IAAIuC,IAAvB;AAAP;AACA;AAPM;AA1E6B,EAAR,CAAtB,CAAR;AAqFC,CAvFD,EAuFGC,KAvFH","file":"../mavo.es5.js","sourcesContent":["(function($) {\n\nvar _ = Mavo.Backend.register($.Class({\n\textends: Mavo.Backend,\n\tid: \"Dropbox\",\n\tconstructor: function() {\n\t\tthis.permissions.on([\"login\", \"read\"]);\n\n\t\tthis.key = this.mavo.element.getAttribute(\"mv-dropbox-key\") || \"2mx6061p054bpbp\";\n\n\t\t// Transform the dropbox shared URL into something raw and CORS-enabled\n\t\tthis.url = new URL(this.url, location);\n\n\t\tthis.url.hostname = \"dl.dropboxusercontent.com\";\n\t\tthis.url.search = this.url.search.replace(/\\bdl=0|^$/, \"raw=1\");\n\n\t\tthis.login(true);\n\t},\n\n\t/**\n\t * Saves a file to the backend.\n\t * @param {Object} file - An object with name & data keys\n\t * @return {Promise} A promise that resolves when the file is saved.\n\t */\n\tput: function(serialized, path) {\n\t\treturn this.request(\"https://content.dropboxapi.com/2/files/upload\", serialized, \"POST\", {\n\t\t\theaders: {\n\t\t\t\t\"Dropbox-API-Arg\": JSON.stringify({\n\t\t\t\t\tpath: this.path,\n\t\t\t\t\tmode: \"overwrite\"\n\t\t\t\t}),\n\t\t\t\t\"Content-Type\": \"application/octet-stream\"\n\t\t\t}\n\t\t});\n\t},\n\n\toAuthParams: () => `&redirect_uri=${encodeURIComponent(\"https://auth.mavo.io\")}&response_type=code`,\n\n\tgetUser: function() {\n\t\tif (this.user) {\n\t\t\treturn Promise.resolve(this.user);\n\t\t}\n\n\t\treturn this.request(\"users/get_current_account\", \"null\", \"POST\")\n\t\t\t.then(info => {\n\t\t\t\tthis.user = {\n\t\t\t\t\tusername: info.email,\n\t\t\t\t\tname: info.name.display_name,\n\t\t\t\t\tavatar: info.profile_photo_url,\n\t\t\t\t\tinfo\n\t\t\t\t};\n\t\t\t});\n\t},\n\n\tlogin: function(passive) {\n\t\treturn this.oAuthenticate(passive)\n\t\t\t.then(() => this.getUser())\n\t\t\t.then(u => {\n\t\t\t\tif (this.user) {\n\t\t\t\t\tthis.permissions.logout = true;\n\n\t\t\t\t\t// Check if can actually edit the file\n\t\t\t\t\tthis.request(\"sharing/get_shared_link_metadata\", {\n\t\t\t\t\t\t\"url\": this.source\n\t\t\t\t\t}, \"POST\").then(info => {\n\t\t\t\t\t\tthis.path = info.path_lower;\n\t\t\t\t\t\tthis.permissions.on([\"edit\", \"save\"]);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t},\n\n\tlogout: function() {\n\t\treturn this.oAuthLogout();\n\t},\n\n\tstatic: {\n\t\tapiDomain: \"https://api.dropboxapi.com/2/\",\n\t\toAuth: \"https://www.dropbox.com/oauth2/authorize\",\n\n\t\ttest: function(url) {\n\t\t\turl = new URL(url, location);\n\t\t\treturn /dropbox.com/.test(url.host);\n\t\t}\n\t}\n}));\n\n})(Bliss);\n"]}