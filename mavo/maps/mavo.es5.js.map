{"version":3,"sources":["expressions.js"],"names":["$","$$","_","Mavo","Expressions","Class","constructor","mavo","active","expressions","syntax","Expression","Syntax","create","element","closest","default","traverse","undefined","scheduled","Set","treeBuilt","then","document","documentElement","addEventListener","evt","action","node","closestCollection","has","property","setTimeout","delete","update","PROPERTYCHANGE_THROTTLE","add","requestAnimationFrame","root","rootGroup","Element","selectors","group","Node","get","data","getData","live","walk","obj","path","length","isDeleted","env","context","value","hooks","run","et","changedBy","extract","attribute","name","directives","indexOf","test","textContent","push","DOMExpression","slice","split","map","i","nodeType","normalize","ESCAPE","is","attributes","forEach","childNodes","child","static","directive","o","Plugins","register","self","Proxy","options","collection","Primitive","Symbol","toPrimitive","proxy","index","Group","ret","walkUp","children","find","Array","isArray","item","filter","all","set","Error","Bliss"],"mappings":"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","file":"../mavo.es5.js","sourcesContent":["(function($, $$) {\n\nvar _ = Mavo.Expressions = $.Class({\n\tconstructor: function(mavo) {\n\t\tthis.mavo = mavo;\n\t\tthis.active = true;\n\n\t\tthis.expressions = [];\n\n\t\tvar syntax = Mavo.Expression.Syntax.create(this.mavo.element.closest(\"[mv-expressions]\")) || Mavo.Expression.Syntax.default;\n\t\tthis.traverse(this.mavo.element, undefined, syntax);\n\n\t\tthis.scheduled = new Set();\n\n\t\tthis.mavo.treeBuilt.then(() => {\n\t\t\tthis.expressions = [];\n\n\t\t\t// Watch changes and update value\n\t\t\tdocument.documentElement.addEventListener(\"mavo:datachange\", evt => {\n\t\t\t\tif (!this.active) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (evt.action == \"propertychange\" && evt.node.closestCollection) {\n\t\t\t\t\t// Throttle propertychange events in collections and events from other Mavos\n\t\t\t\t\tif (!this.scheduled.has(evt.property)) {\n\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\tthis.scheduled.delete(evt.property);\n\t\t\t\t\t\t\tthis.update(evt);\n\t\t\t\t\t\t}, _.PROPERTYCHANGE_THROTTLE);\n\n\t\t\t\t\t\tthis.scheduled.add(evt.property);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\trequestAnimationFrame(() => this.update(evt));\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis.update();\n\t\t});\n\t},\n\n\tupdate: function(evt) {\n\t\tvar root, rootGroup;\n\n\t\tif (evt instanceof Element) {\n\t\t\troot = evt.closest(Mavo.selectors.group);\n\t\t\tevt = null;\n\t\t}\n\n\t\troot = root || this.mavo.element;\n\t\trootGroup = Mavo.Node.get(root);\n\n\t\tvar data = rootGroup.getData({live: true});\n\n\t\trootGroup.walk((obj, path) => {\n\t\t\tif (obj.expressions && obj.expressions.length && !obj.isDeleted()) {\n\t\t\t\tlet env = { context: this, data: $.value(data, ...path) };\n\n\t\t\t\tMavo.hooks.run(\"expressions-update-start\", env);\n\t\t\t\tfor (let et of obj.expressions) {\n\t\t\t\t\tif (et.changedBy(evt)) {\n\t\t\t\t\t\tet.update(env.data, evt);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t},\n\n\textract: function(node, attribute, path, syntax) {\n\t\tif (attribute && attribute.name == \"mv-expressions\") {\n\t\t\treturn;\n\t\t}\n\n\t\tif ((attribute && _.directives.indexOf(attribute.name) > -1) ||\n\t\t    syntax.test(attribute? attribute.value : node.textContent)\n\t\t) {\n\t\t\tthis.expressions.push(new Mavo.DOMExpression({\n\t\t\t\tnode, syntax,\n\t\t\t\tpath: path? path.slice(1).split(\"/\").map(i => +i) : [],\n\t\t\t\tattribute: attribute && attribute.name,\n\t\t\t\tmavo: this.mavo\n\t\t\t}));\n\t\t}\n\t},\n\n\t// Traverse an element, including attribute nodes, text nodes and all descendants\n\ttraverse: function(node, path = \"\", syntax) {\n\t\tif (node.nodeType === 8) {\n\t\t\t// We don't want expressions to be picked up from comments!\n\t\t\t// Commenting stuff out is a common debugging technique\n\t\t\treturn;\n\t\t}\n\n\t\tif (node.nodeType === 3) { // Text node\n\t\t\t// Leaf node, extract references from content\n\t\t\tthis.extract(node, null, path, syntax);\n\t\t}\n\t\telse {\n\t\t\tnode.normalize();\n\n\t\t\tsyntax = Mavo.Expression.Syntax.create(node) || syntax;\n\n\t\t\tif (syntax === Mavo.Expression.Syntax.ESCAPE) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (Mavo.is(\"multiple\", node)) {\n\t\t\t\tpath = \"\";\n\t\t\t}\n\n\t\t\t$$(node.attributes).forEach(attribute => this.extract(node, attribute, path, syntax));\n\t\t\t$$(node.childNodes).forEach((child, i) => this.traverse(child, `${path}/${i}`, syntax));\n\t\t}\n\t},\n\n\tstatic: {\n\t\tdirectives: [],\n\n\t\tPROPERTYCHANGE_THROTTLE: 50,\n\n\t\tdirective: function(name, o) {\n\t\t\t_.directives.push(name);\n\t\t\tMavo.attributes.push(name);\n\t\t\to.name = name;\n\t\t\tMavo.Plugins.register(o);\n\t\t}\n\t}\n});\n\nif (self.Proxy) {\n\tMavo.hooks.add(\"node-getdata-end\", function(env) {\n\t\tif (env.options.live && (env.data && typeof env.data === \"object\" || this.collection)) {\n\t\t\tvar data = env.data;\n\n\t\t\tif (this instanceof Mavo.Primitive) {\n\t\t\t\tenv.data = {\n\t\t\t\t\t[Symbol.toPrimitive]: () => data,\n\t\t\t\t\t[this.property]: data\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tenv.data = new Proxy(env.data, {\n\t\t\t\tget: (data, property, proxy) => {\n\t\t\t\t\t// Checking if property is in proxy might add it to the data\n\t\t\t\t\tif (property in data || (property in proxy && property in data)) {\n\t\t\t\t\t\treturn data[property];\n\t\t\t\t\t}\n\t\t\t\t},\n\n\t\t\t\thas: (data, property) => {\n\t\t\t\t\tif (property in data) {\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Property does not exist, look for it elsewhere\n\n\t\t\t\t\tif (property == \"$index\") {\n\t\t\t\t\t\tdata[property] = this.index || 0;\n\t\t\t\t\t\treturn true; // if index is 0 it's falsy and has would return false!\n\t\t\t\t\t}\n\n\t\t\t\t\tif (property == \"$all\") {\n\t\t\t\t\t\treturn data[property] = this.closestCollection? this.closestCollection.getData(env.options) : [env.data];\n\t\t\t\t\t}\n\n\t\t\t\t\tif (property == \"$next\" || property == \"$previous\") {\n\t\t\t\t\t\tif (this.closestCollection) {\n\t\t\t\t\t\t\treturn data[property] = this.closestCollection.getData(env.options)[this.index + (property == \"$next\"? 1 : -1)];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tdata[property] = null;\n\t\t\t\t\t\treturn null;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this instanceof Mavo.Group && property == this.property && this.collection) {\n\t\t\t\t\t\treturn data[property] = env.data;\n\t\t\t\t\t}\n\n\t\t\t\t\t// First look in ancestors\n\t\t\t\t\tvar ret = this.walkUp(group => {\n\t\t\t\t\t\tif (property in group.children) {\n\t\t\t\t\t\t\treturn group.children[property];\n\t\t\t\t\t\t};\n\t\t\t\t\t});\n\n\t\t\t\t\tif (ret === undefined) {\n\t\t\t\t\t\t// Still not found, look in descendants\n\t\t\t\t\t\tret = this.find(property);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (ret !== undefined) {\n\t\t\t\t\t\tif (Array.isArray(ret)) {\n\t\t\t\t\t\t\tret = ret.map(item => item.getData(env.options))\n\t\t\t\t\t\t\t\t\t .filter(item => item !== null);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (ret instanceof Mavo.Node) {\n\t\t\t\t\t\t\tret = ret.getData(env.options);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tdata[property] = ret;\n\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Does it reference another Mavo?\n\t\t\t\t\tif (property in Mavo.all) {\n\t\t\t\t\t\treturn data[property] = Mavo.all[property].root.getData(env.options);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\n\t\t\t\tset: function(data, property, value) {\n\t\t\t\t\tthrow Error(\"You can’t set data via expressions.\");\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t});\n}\n\n})(Bliss, Bliss.$);\n"]}