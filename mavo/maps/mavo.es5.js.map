{"version":3,"sources":["collection.js"],"names":["$","$$","Mavo","attributes","push","_","Collection","Class","extends","Node","nodeType","constructor","element","mavo","o","templateElement","children","fromTemplate","properties","selectors","property","map","getProperty","mutable","matches","multiple","accepts","getAttribute","split","cloneNode","item","createItem","add","undefined","silent","itemTemplate","template","postInit","hooks","run","length","getData","env","context","options","data","deleted","live","itemData","filter","rendered","subset","inPath","concat","slice","create","collection","type","index","get","adopt","rel","marker","bottomUp","previousIndex","changed","splice","remove","expressions","active","requestAnimationFrame","forEach","i","dataChanged","unsavedChanges","update","actions","action","isNaN","indexOf","sort","a","b","toArray","walk","obj","closestCollection","delete","copies","hard","destroy","transition","opacity","then","style","move","offset","editItem","itemControls","UI","Itembar","edit","super","call","addButton","parentNode","tag","tagName","toLowerCase","containerSelector","container","closest","dragula","getDragula","propagate","done","clear","save","propagated","dataRender","render","fragment","document","createDocumentFragment","j","appendChild","after","before","find","items","collections","ret","flatten","isCompatible","c","value","_mutable","createComment","ref","pushUnique","containers","me","isContainer","root","el","moves","handle","classList","contains","target","source","next","previous","previousElementSibling","lastElementChild","on","oldIndex","nextElementSibling","closestItem","cancel","dragulas","lazy","order","test","compareDocumentPosition","DOCUMENT_POSITION_FOLLOWING","parent","selector","group","button","className","textContent","name","addEventListener","evt","preventDefault","static","include","self","Bliss"],"mappings":"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","file":"../mavo.es5.js","sourcesContent":["(function($, $$) {\n\nMavo.attributes.push(\"mv-multiple\", \"mv-order\", \"mv-accepts\");\n\nvar _ = Mavo.Collection = $.Class({\n\textends: Mavo.Node,\n\tnodeType: \"Collection\",\n\tconstructor: function (element, mavo, o) {\n\t\t/*\n\t\t * Create the template, remove it from the DOM and store it\n\t\t */\n\t\tthis.templateElement = this.element;\n\n\t\tthis.children = [];\n\n\t\t// ALL descendant property names as an array\n\t\tif (!this.fromTemplate(\"properties\", \"mutable\", \"templateElement\", \"accepts\")) {\n\t\t\tthis.properties = $$(Mavo.selectors.property, this.templateElement).map(Mavo.Node.getProperty);\n\t\t\tthis.mutable = this.templateElement.matches(Mavo.selectors.multiple);\n\t\t\tthis.accepts = (this.templateElement.getAttribute(\"mv-accepts\") || \"\").split(/\\s+/);\n\n\t\t\t// Must clone because otherwise once expressions are parsed on the template element\n\t\t\t// we will not be able to pick them up from subsequent items\n\t\t\tthis.templateElement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tvar item = this.createItem(this.element);\n\t\tthis.add(item, undefined, {silent: true});\n\t\tthis.itemTemplate = item.template || item;\n\n\t\tthis.postInit();\n\n\t\tMavo.hooks.run(\"collection-init-end\", this);\n\t},\n\n\tget length() {\n\t\treturn this.children.length;\n\t},\n\n\tgetData: function(o = {}) {\n\t\tvar env = {\n\t\t\tcontext: this,\n\t\t\toptions: o,\n\t\t\tdata: []\n\t\t};\n\n\t\tfor (item of this.children) {\n\t\t\tif (!item.deleted || env.options.live) {\n\t\t\t\tlet itemData = item.getData(env.options);\n\n\t\t\t\tif (itemData || env.options.live) {\n\t\t\t\t\tenv.data.push(itemData);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (!this.mutable) {\n\t\t\t// If immutable, drop nulls\n\n\t\t\tenv.data = env.data.filter(item => item !== null);\n\n\t\t\tif (env.options.live && env.data.length === 1) {\n\t\t\t\t// If immutable with only 1 item, return the item\n\t\t\t\t// See https://github.com/LeaVerou/mavo/issues/50#issuecomment-266079652\n\t\t\t\tenv.data = env.data[0];\n\t\t\t}\n\t\t\telse if (this.data && !env.options.live) {\n\t\t\t\tvar rendered = Mavo.subset(this.data, this.inPath);\n\t\t\t\tenv.data = env.data.concat(rendered.slice(env.data.length));\n\t\t\t}\n\t\t}\n\n\t\tMavo.hooks.run(\"node-getdata-end\", env);\n\n\t\treturn env.data;\n\t},\n\n\t// Create item but don't insert it anywhere\n\t// Mostly used internally\n\tcreateItem: function (element) {\n\t\tif (!element) {\n\t\t\telement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tvar item = Mavo.Node.create(element, this.mavo, {\n\t\t\tcollection: this,\n\t\t\ttemplate: this.itemTemplate || (this.template? this.template.itemTemplate : null),\n\t\t\tproperty: this.property,\n\t\t\ttype: this.type\n\t\t});\n\n\t\treturn item;\n\t},\n\n\t/**\n\t * Add a new item to this collection\n\t * @param item {Node|Mavo.Node} Optional. Element or Mavo object for the new item\n\t * @param index {Number} Optional. Index of existing item, will be added opposite to list direction\n\t * @param silent {Boolean} Optional. Throw a datachange event? Mainly used internally.\n\t */\n\tadd: function(item, index, o = {}) {\n\t\tif (item instanceof Node) {\n\t\t\titem = Mavo.Node.get(item) || this.createItem(item);\n\t\t}\n\t\telse {\n\t\t\titem = item || this.createItem();\n\t\t}\n\n\t\tif (item.collection != this) {\n\t\t\tthis.adopt(item);\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\t// Add it to the DOM, or fix its place\n\t\t\tvar rel = this.children[index]? this.children[index].element : this.marker;\n\t\t\t$[this.bottomUp? \"after\" : \"before\"](item.element, rel);\n\n\t\t\tif (index === undefined) {\n\t\t\t\tindex = this.bottomUp? 0 : this.length;\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tindex = this.length;\n\t\t}\n\n\t\tvar env = {context: this, item};\n\n\t\tenv.previousIndex = item.index;\n\n\t\t// Update internal data model\n\t\tenv.changed = this.splice({\n\t\t\tremove: env.item\n\t\t}, {\n\t\t\tindex: index,\n\t\t\tadd: env.item\n\t\t});\n\n\t\tif (this.mavo.expressions.active && !o.silent) {\n\t\t\trequestAnimationFrame(() => {\n\t\t\t\tenv.changed.forEach(i => {\n\t\t\t\t\ti.dataChanged(i == env.item && env.previousIndex === undefined? \"add\" : \"move\");\n\t\t\t\t\ti.unsavedChanges = true;\n\t\t\t\t});\n\n\t\t\t\tthis.unsavedChanges = this.mavo.unsavedChanges = true;\n\n\t\t\t\tthis.mavo.expressions.update(env.item.element);\n\t\t\t});\n\t\t}\n\n\t\tMavo.hooks.run(\"collection-add-end\", env);\n\n\t\treturn env.item;\n\t},\n\n\tsplice: function(...actions) {\n\t\tfor (let action of actions) {\n\t\t\tif (action.index === undefined && action.remove && isNaN(action.remove)) {\n\t\t\t\t// Remove is an item\n\t\t\t\taction.index = this.children.indexOf(action.remove);\n\t\t\t\taction.remove = 1;\n\t\t\t}\n\t\t}\n\n\t\t// Sort in reverse index order\n\t\tactions.sort((a, b) => b.index - a.index);\n\n\t\t// FIXME this could still result in buggy behavior.\n\t\t// Think of e.g. adding items on i, then removing > 1 items on i-1.\n\t\t// The new items would get removed instead of the old ones.\n\t\t// Not a pressing issue though since we always remove 1 max when adding things too.\n\t\tfor (let action of actions) {\n\t\t\tif (action.index > -1 && (action.remove || action.add)) {\n\t\t\t\taction.remove = action.remove || 0;\n\t\t\t\taction.add = Mavo.toArray(action.add);\n\n\t\t\t\tthis.children.splice(action.index, +action.remove, ...action.add);\n\t\t\t}\n\t\t}\n\n\t\tvar changed = [];\n\n\t\tfor (let i = 0; i < this.length; i++) {\n\t\t\tlet item = this.children[i];\n\n\t\t\tif (item && item.index !== i) {\n\t\t\t\titem.index = i;\n\t\t\t\tchanged.push(item);\n\t\t\t}\n\t\t}\n\n\t\treturn changed;\n\t},\n\n\tadopt: function(item) {\n\t\tif (item.collection) {\n\t\t\t// It belongs to another collection, delete from there first\n\t\t\titem.collection.splice({remove: item});\n\t\t\titem.collection.dataChanged(\"delete\");\n\t\t}\n\n\t\t // Update collection & closestCollection properties\n\t\tthis.walk(obj => {\n\t\t\tif (obj.closestCollection === item.collection) {\n\t\t\t\tobj.closestCollection = this;\n\t\t\t}\n\n\t\t\t// Belongs to another Mavo?\n\t\t\tif (item.mavo != this.mavo) {\n\t\t\t\titem.mavo = this.mavo;\n\t\t\t}\n\t\t});\n\n\t\titem.collection = this;\n\n\t\t// Adjust templates and their copies\n\t\tif (item.template) {\n\t\t\tMavo.delete(item.template.copies, item);\n\n\t\t\titem.template = this.itemTemplate;\n\t\t}\n\t},\n\n\tdelete: function(item, hard) {\n\t\tif (hard) {\n\t\t\t// Hard delete\n\t\t\t$.remove(item.element);\n\t\t\tthis.splice({remove: item});\n\t\t\titem.destroy();\n\t\t\treturn;\n\t\t}\n\n\t\treturn $.transition(item.element, {opacity: 0}).then(() => {\n\t\t\titem.deleted = true; // schedule for deletion\n\t\t\titem.element.style.opacity = \"\";\n\n\t\t\titem.dataChanged(\"delete\");\n\n\t\t\tthis.unsavedChanges = item.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t});\n\t},\n\n\t/**\n\t * Move existing item to a new position. Wraps around if position is out of bounds.\n\t * @offset relative position\n\t */\n\tmove: function(item, offset) {\n\t\tindex = item.index + offset + (offset > 0);\n\n\t\tif (index < 0) {\n\t\t\tindex = this.children.length;\n\t\t}\n\t\telse if (index > this.children.length) {\n\t\t\tindex = 0;\n\t\t}\n\n\t\tthis.add(item, index);\n\t},\n\n\teditItem: function(item) {\n\t\tif (this.mutable) {\n\t\t\tif (!item.itemControls) {\n\t\t\t\titem.itemControls = new Mavo.UI.Itembar(item);\n\t\t\t}\n\n\t\t\titem.itemControls.add();\n\t\t}\n\n\t\titem.edit();\n\t},\n\n\tedit: function() {\n\t\tif (this.super.edit.call(this) === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\t// Insert the add button if it's not already in the DOM\n\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\tvar tag = this.element.tagName.toLowerCase();\n\t\t\t\tvar containerSelector = Mavo.selectors.container[tag];\n\t\t\t\tvar rel = containerSelector? this.marker.parentNode.closest(containerSelector) : this.marker;\n\t\t\t\t$[this.bottomUp? \"before\" : \"after\"](this.addButton, rel);\n\t\t\t}\n\n\t\t\t// Set up drag & drop\n\t\t\t_.dragula.then(() => {\n\t\t\t\tthis.getDragula();\n\t\t\t});\n\t\t}\n\n\t\t// Edit items, maybe insert item bar\n\t\tthis.propagate(item => {\n\t\t\tthis.editItem(item);\n\t\t});\n\t},\n\n\tdone: function() {\n\t\tif (this.super.done.call(this) === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\tif (this.addButton.parentNode) {\n\t\t\t\tthis.addButton.remove();\n\t\t\t}\n\n\t\t\tthis.propagate(item => {\n\t\t\t\tif (item.itemControls) {\n\t\t\t\t\titem.itemControls.remove();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\t/**\n\t * Delete all items in the collection. Not undoable.\n\t */\n\tclear: function() {\n\t\tif (this.mutable) {\n\t\t\tfor (var i = 1, item; item = this.children[i]; i++) {\n\t\t\t\titem.element.remove();\n\t\t\t\titem.destroy();\n\t\t\t}\n\n\t\t\tthis.children = this.children.slice(0, 1);\n\n\t\t\tthis.dataChanged(\"clear\");\n\t\t}\n\n\t\tthis.propagate(\"clear\");\n\t},\n\n\tdataChanged: function(action, o = {}) {\n\t\to.element = o.element || this.marker;\n\t\treturn this.super.dataChanged.call(this, action, o);\n\t},\n\n\tsave: function() {\n\t\tfor (let item of this.children) {\n\t\t\tif (item.deleted) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t}\n\t\t\telse {\n\t\t\t\titem.unsavedChanges = false;\n\t\t\t}\n\t\t}\n\t},\n\n\tpropagated: [\"save\"],\n\n\tdataRender: function(data) {\n\t\tif (!data) {\n\t\t\treturn;\n\t\t}\n\n\t\tdata = Mavo.toArray(data);\n\n\t\tif (!this.mutable) {\n\t\t\tthis.children.forEach((item, i) => item.render(data && data[i]));\n\t\t}\n\t\telse {\n\t\t\t// First render on existing items\n\t\t\tfor (var i = 0; i < this.children.length; i++) {\n\t\t\t\tif (i < data.length) {\n\t\t\t\t\tthis.children[i].render(data[i]);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthis.children[i].dataChanged(\"delete\");\n\t\t\t\t\tthis.delete(this.children[i], true);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (data.length > i) {\n\t\t\t\t// There are still remaining items\n\t\t\t\t// Using document fragments improves performance by 60%\n\t\t\t\tvar fragment = document.createDocumentFragment();\n\n\t\t\t\tfor (var j = i; j < data.length; j++) {\n\t\t\t\t\tvar item = this.createItem();\n\n\t\t\t\t\titem.render(data[j]);\n\n\t\t\t\t\tthis.children.push(item);\n\t\t\t\t\titem.index = j;\n\n\t\t\t\t\tfragment.appendChild(item.element);\n\n\t\t\t\t\tvar env = {context: this, item};\n\t\t\t\t\tMavo.hooks.run(\"collection-add-end\", env);\n\t\t\t\t}\n\n\t\t\t\tif (this.bottomUp) {\n\t\t\t\t\t$.after(fragment, i > 0? this.children[i-1].element : this.marker);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t$.before(fragment, this.marker);\n\t\t\t\t}\n\n\t\t\t\tfor (var j = i; j < this.children.length; j++) {\n\t\t\t\t\tthis.children[j].dataChanged(\"add\");\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tfind: function(property, o = {}) {\n\t\tvar items = this.children.filter(item => !item.deleted);\n\n\t\tif (this.property == property) {\n\t\t\treturn o.collections? this : items;\n\t\t}\n\n\t\tif (this.properties.indexOf(property) > -1) {\n\t\t\tvar ret = items.map(item => item.find(property, o));\n\n\t\t\treturn Mavo.flatten(ret);\n\t\t}\n\t},\n\n\tisCompatible: function(c) {\n\t\treturn c && this.itemTemplate.nodeType == c.itemTemplate.nodeType && (c === this\n\t\t       || c.template == this || this.template == c || this.template && this.template == c.template\n\t\t       || this.accepts.indexOf(c.property) > -1);\n\t},\n\n\tlive: {\n\t\tmutable: function(value) {\n\t\t\tif (value && value !== this.mutable) {\n\t\t\t\t// Why is all this code here? Because we want it executed\n\t\t\t\t// every time mutable changes, not just in the constructor\n\t\t\t\t// (think multiple elements with the same property name, where only one has mv-multiple)\n\t\t\t\tthis._mutable = value;\n\n\t\t\t\t// Keep position of the template in the DOM, since we might remove it\n\t\t\t\tthis.marker = document.createComment(\"mv-marker\");\n\t\t\t\tMavo.data(this.marker, \"collection\", this);\n\t\t\t\t\n\t\t\t\tvar ref = this.templateElement.parentNode? this.templateElement : this.children[this.length - 1].element;\n\n\t\t\t\t$.after(this.marker, ref);\n\t\t\t}\n\t\t}\n\t},\n\n\t// Make sure to only call after dragula has loaded\n\tgetDragula: function() {\n\t\tif (this.dragula) {\n\t\t\treturn this.dragula;\n\t\t}\n\n\t\tif (this.template) {\n\t\t\tMavo.pushUnique(this.template.getDragula().containers, this.marker.parentNode);\n\t\t\treturn this.dragula = this.template.dragula || this.template.getDragula();\n\t\t}\n\n\t\tvar me = this;\n\t\tthis.dragula = dragula({\n\t\t\tcontainers: [this.marker.parentNode],\n\t\t\tisContainer: el => {\n\t\t\t\tif (this.accepts.length) {\n\t\t\t\t\treturn Mavo.flatten(this.accepts.map(property => this.mavo.root.find(property, {collections: true})))\n\t\t\t\t\t\t\t\t.filter(c => c && c instanceof _)\n\t\t\t\t\t\t\t\t.map(c => c.marker.parentNode)\n\t\t\t\t\t\t\t\t.indexOf(el) > -1;\n\t\t\t\t}\n\n\t\t\t\treturn false;\n\t\t\t},\n\t\t\tmoves: (el, container, handle) => {\n\t\t\t\treturn handle.classList.contains(\"mv-drag-handle\") && handle.closest(Mavo.selectors.multiple) == el;\n\t\t\t},\n\t\t\taccepts: function(el, target, source, next) {\n\t\t\t\tif (el.contains(target)) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tvar previous = next? next.previousElementSibling : target.lastElementChild;\n\n\t\t\t\tvar collection = _.get(previous) || _.get(next);\n\n\t\t\t\tif (!collection) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tvar item = Mavo.Node.get(el);\n\n\t\t\t\treturn item && item.collection.isCompatible(collection);\n\t\t\t}\n\t\t});\n\n\t\tthis.dragula.on(\"drop\", (el, target, source) => {\n\t\t\tvar item = Mavo.Node.get(el);\n\t\t\tvar oldIndex = item && item.index;\n\t\t\tvar next = el.nextElementSibling;\n\t\t\tvar previous = el.previousElementSibling;\n\t\t\tvar collection = _.get(previous) || _.get(next);\n\t\t\tvar closestItem = Mavo.Node.get(previous) || Mavo.Node.get(next);\n\n\t\t\tif (closestItem && closestItem.collection != collection) {\n\t\t\t\tclosestItem = null;\n\t\t\t}\n\n\t\t\tif (item.collection.isCompatible(collection)) {\n\t\t\t\tvar index = closestItem? closestItem.index + (closestItem.element === previous) : collection.length;\n\t\t\t\tcollection.add(item, index);\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturn this.dragula.cancel(true);\n\t\t\t}\n\t\t});\n\n\t\t_.dragulas.push(this.dragula);\n\n\t\treturn this.dragula;\n\t},\n\n\tlazy: {\n\t\tbottomUp: function() {\n\t\t\t/*\n\t\t\t * Add new items at the top or bottom?\n\t\t\t */\n\n\t\t\tif (!this.mutable) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tvar order = this.templateElement.getAttribute(\"mv-order\");\n\t\t\tif (order !== null) {\n\t\t\t\t// Attribute has the highest priority and overrides any heuristics\n\t\t\t\treturn /^desc\\b/i.test(order);\n\t\t\t}\n\n\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\t// If add button not in DOM, do the default\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// If add button is already in the DOM and *before* our template, then we default to prepending\n\t\t\treturn !!(this.addButton.compareDocumentPosition(this.marker) & Node.DOCUMENT_POSITION_FOLLOWING);\n\t\t},\n\n\t\tclosestCollection: function() {\n\t\t\tvar parent = this.marker? this.marker.parentNode : this.templateElement.parentNode;\n\n\t\t\treturn parent.closest(Mavo.selectors.multiple);\n\t\t},\n\n\t\taddButton: function() {\n\t\t\t// Find add button if provided, or generate one\n\t\t\tvar selector = `button.mv-add-${this.property}`;\n\t\t\tvar group = this.closestCollection || this.marker.parentNode.closest(Mavo.selectors.group);\n\n\t\t\tif (group) {\n\t\t\t\tvar button = $$(selector, group).filter(button => {\n\t\t\t\t\treturn !this.templateElement.contains(button);\n\t\t\t\t})[0];\n\t\t\t}\n\n\t\t\tif (!button) {\n\t\t\t\tbutton = $.create(\"button\", {\n\t\t\t\t\tclassName: \"mv-add\",\n\t\t\t\t\ttextContent: \"Add \" + this.name\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tbutton.classList.add(\"mv-ui\", \"mv-add\");\n\t\t\tMavo.data(button, \"collection\", this);\n\n\t\t\tif (this.property) {\n\t\t\t\tbutton.classList.add(`mv-add-${this.property}`);\n\t\t\t}\n\n\t\t\tbutton.addEventListener(\"click\", evt => {\n\t\t\t\tevt.preventDefault();\n\n\t\t\t\tthis.editItem(this.add());\n\t\t\t});\n\n\t\t\treturn button;\n\t\t}\n\t},\n\n\tstatic: {\n\t\tdragulas: [],\n\t\tget: element => {\n\t\t\t// Is it an add button or a marker?\n\t\t\tvar collection = Mavo.data(element, \"collection\");\n\n\t\t\tif (collection) {\n\t\t\t\treturn collection;\n\t\t\t}\n\n\t\t\t// Maybe it's a collection item?\n\t\t\tvar item = Mavo.Node.get(element);\n\n\t\t\treturn item && item.collection || null;\n\t\t},\n\n\t\tlazy: {\n\t\t\tdragula: () => $.include(self.dragula, \"https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.js\")\n\t\t}\n\t}\n});\n\n})(Bliss, Bliss.$);\n"]}