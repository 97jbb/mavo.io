{"version":3,"sources":["mavo.js"],"names":["$","$$","_","self","Mavo","Class","constructor","element","treeBuilt","defer","index","length","Object","defineProperty","all","value","selector","attributes","map","attribute","join","forEach","getAttribute","setAttribute","id","i","autoEdit","classList","contains","autoSave","hasAttribute","autoSaveDelay","hooks","run","selectors","primitive","hasChildren","not","formControl","property","config","Primitive","getConfig","isCollection","is","expressions","Expressions","root","Group","resolve","permissions","Permissions","backendTypes","role","updateBackend","backendObserver","Observer","changed","roles","records","record","attributeName","replace","source","load","storage","init","data","can","Functions","$url","primaryBackend","login","addEventListener","evt","backend","unsavedChanges","bar","UI","Bar","target","document","activeElement","preventDefault","needsEdit","some","obj","modes","mode","setUnsavedChanges","onchange","action","trim","split","filter","a","push","modeObserver","nodeloop","Node","children","node","previousMode","getStyle","parentNode","subtree","edit","destroy","fire","debouncedSave","debounce","save","callback","saved","requestAnimationFrame","removeEventListener","keyCode","superKey","editing","getData","toJSON","message","options","Message","error","classes","dismiss","log","render","active","env","context","update","clear","confirm","store","then","events","matches","multiple","remove","parent","closest","toggle","type","walk","done","unbind","previous","equals","Backend","create","mavo","format","Promise","inProgress","ready","catch","reject","err","xhr","XMLHttpRequest","status","statusText","upload","file","path","name","uploadBackend","url","lastSaved","Date","now","test","ret","live","toggleAttribute","_storage","_primaryBackend","style","setProperty","removeProperty","get","static","keys","Element","navigator","platform","indexOf","base","location","protocol","currentScript","src","dependencies","container","Hooks","s","specificProperty","group","ui","arr","or","selector1","selector2","and","arr2","s1","s2","andNot","extend","rootGroup","output","isDecentBrowser","Array","from","window","Intl","documentElement","URL","prototype","Plugins","include","inited","console","Stretchy","Bliss"],"mappings":";;;;AAAA,CAAC,UAAUA,CAAV,EAAaC,EAAb,EAAiB;;AAElB,KAAIC,IAAIC,KAAKC,IAAL,GAAYJ,EAAEK,KAAF,CAAQ;AAC3BC,eAAa,qBAAUC,OAAV,EAAmB;AAAA;;AAC/B,QAAKC,SAAL,GAAiBJ,KAAKK,KAAL,EAAjB;;AAEA,QAAKF,OAAL,GAAeA,OAAf;;AAEA;AACA,QAAKG,KAAL,GAAaR,EAAES,MAAF,GAAW,CAAxB;AACAC,UAAOC,cAAP,CAAsBX,EAAEY,GAAxB,EAA6B,KAAKJ,KAAL,GAAa,CAA1C,EAA6C,EAACK,OAAO,IAAR,EAA7C;;AAEA;AACA,OAAIC,WAAWd,EAAEe,UAAF,CAAaC,GAAb,CAAiB;AAAA,sBAAsBC,SAAtB;AAAA,IAAjB,EAAqDC,IAArD,CAA0D,IAA1D,CAAf;;AAEA,IAAC,KAAKb,OAAN,4BAAkBN,GAAGe,QAAH,EAAa,KAAKT,OAAlB,CAAlB,GAA8Cc,OAA9C,CAAsD,mBAAW;AAAA;AAAA;AAAA;;AAAA;AAChE,0BAAsBnB,EAAEe,UAAxB,8HAAoC;AAAA,UAA3BE,SAA2B;;AACnC,UAAIJ,QAAQR,QAAQe,YAAR,CAAqB,UAAUH,SAA/B,CAAZ;;AAEA,UAAIJ,UAAU,IAAd,EAAoB;AACnBR,eAAQgB,YAAR,CAAqBJ,SAArB,EAAgCJ,KAAhC;AACA;AACD;AAP+D;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAQhE,IARD;;AAUA;AACA,QAAKS,EAAL,GAAUpB,KAAKkB,YAAL,CAAkB,KAAKf,OAAvB,EAAgC,QAAhC,EAA0C,IAA1C,cAA0D,KAAKG,KAAzE;;AAEA,OAAI,KAAKc,EAAL,IAAWtB,EAAEY,GAAjB,EAAsB;AACrB;AACA,SAAK,IAAIW,IAAE,CAAX,EAAc,KAAKD,EAAL,GAAUC,CAAV,IAAevB,EAAEY,GAA/B,EAAoCW,GAApC,EAAyC,CAAE;AAC3C,SAAKD,EAAL,GAAU,KAAKA,EAAL,GAAUC,CAApB;AACA;;AAEDvB,KAAEY,GAAF,CAAM,KAAKU,EAAX,IAAiB,IAAjB;AACA,QAAKjB,OAAL,CAAagB,YAAb,CAA0B,QAA1B,EAAoC,KAAKC,EAAzC;;AAEA;AACA,QAAKE,QAAL,GAAgB,KAAKnB,OAAL,CAAaoB,SAAb,CAAuBC,QAAvB,CAAgC,aAAhC,CAAhB;;AAEA;AACA,QAAKC,QAAL,GAAgB,KAAKtB,OAAL,CAAauB,YAAb,CAA0B,aAA1B,CAAhB;AACA,QAAKC,aAAL,GAAqB,CAAC,KAAKxB,OAAL,CAAae,YAAb,CAA0B,aAA1B,KAA4C,CAA7C,IAAkD,IAAvE;;AAEA,QAAKf,OAAL,CAAagB,YAAb,CAA0B,QAA1B,EAAoC,EAApC;;AAEAnB,QAAK4B,KAAL,CAAWC,GAAX,CAAe,YAAf,EAA6B,IAA7B;;AAEA;AA7C+B;AAAA;AAAA;;AAAA;AA8C/B,0BAAoBhC,GAAGC,EAAEgC,SAAF,CAAYC,SAAf,EAA0B,KAAK5B,OAA/B,CAApB,mIAA6D;AAAA,SAApDA,OAAoD;;AAC5D,SAAI6B,cAAcpC,EAAKE,EAAEgC,SAAF,CAAYG,GAAZ,CAAgBnC,EAAEgC,SAAF,CAAYI,WAA5B,CAAL,UAAkDpC,EAAEgC,SAAF,CAAYK,QAA9D,EAA0EhC,OAA1E,CAAlB;;AAEA,SAAI6B,WAAJ,EAAiB;AAChB,UAAII,SAASpC,KAAKqC,SAAL,CAAeC,SAAf,CAAyBnC,OAAzB,CAAb;AACA,UAAIoC,eAAevC,KAAKwC,EAAL,CAAQ,UAAR,EAAoBrC,OAApB,CAAnB;;AAEA,UAAIoC,gBAAgB,CAACH,OAAOrB,SAAR,IAAqB,CAACqB,OAAOJ,WAAjD,EAA8D;AAC7D7B,eAAQgB,YAAR,CAAqB,QAArB,EAA+B,EAA/B;AACA;AACD;AACD;AAzD8B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AA2D/B,QAAKsB,WAAL,GAAmB,IAAIzC,KAAK0C,WAAT,CAAqB,IAArB,CAAnB;;AAEA;AACA1C,QAAK4B,KAAL,CAAWC,GAAX,CAAe,kBAAf,EAAmC,IAAnC;;AAEA,QAAKc,IAAL,GAAY,IAAI3C,KAAK4C,KAAT,CAAe,KAAKzC,OAApB,EAA6B,IAA7B,CAAZ;AACA,QAAKC,SAAL,CAAeyC,OAAf;;AAEA7C,QAAK4B,KAAL,CAAWC,GAAX,CAAe,iBAAf,EAAkC,IAAlC;;AAEA,QAAKiB,WAAL,GAAmB,IAAI9C,KAAK+C,WAAT,EAAnB;;AAEA,OAAIC,eAAe,CAAC,QAAD,EAAW,SAAX,EAAsB,MAAtB,CAAnB,CAvE+B,CAuEmB;;AAElD;AAzE+B;AAAA;AAAA;;AAAA;AA0E/B,0BAAiBA,YAAjB,mIAA+B;AAAA,SAAtBC,IAAsB;;AAC9B,UAAKC,aAAL,CAAmBD,IAAnB;AACA;AA5E8B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AA8E/B,QAAKE,eAAL,GAAuB,IAAInD,KAAKoD,QAAT,CAAkB,KAAKjD,OAAvB,EAAgC6C,aAAalC,GAAb,CAAiB;AAAA,WAAQ,QAAQmC,IAAhB;AAAA,IAAjB,CAAhC,EAAwE,mBAAW;AACzG,QAAII,UAAU,EAAd;;AAEA,QAAIC,QAAQC,QAAQzC,GAAR,CAAY,kBAAU;AACjC,SAAImC,OAAOO,OAAOC,aAAP,CAAqBC,OAArB,CAA6B,MAA7B,EAAqC,EAArC,CAAX;AACAL,aAAQJ,IAAR,IAAgB,MAAKC,aAAL,CAAmBD,IAAnB,CAAhB;;AAEA,YAAOA,IAAP;AACA,KALW,CAAZ;;AAOA;AACA,QAAII,QAAQM,MAAZ,EAAoB;AAAG;AACtB,WAAKC,IAAL;AACA,KAFD,MAGK,IAAI,CAAC,MAAKD,MAAV,EAAkB;AACtB,SAAIN,QAAQQ,OAAR,IAAmBR,QAAQS,IAAR,IAAgB,CAAC,MAAKnB,IAAL,CAAUoB,IAAlD,EAAwD;AACvD,YAAKH,IAAL;AACA;AACD;AACD,IAnBsB,CAAvB;;AAqBA,QAAKd,WAAL,CAAiBkB,GAAjB,CAAqB,OAArB,EAA8B,YAAM;AACnC;AACA,QAAI,WAAWhE,KAAKiE,SAAL,CAAeC,IAA1B,IAAkC,MAAK5D,KAAL,IAAc,CAAhD,IAAqD,MAAKc,EAAL,GAAU,QAAV,IAAsBpB,KAAKiE,SAAL,CAAeC,IAA9F,EAAoG;AACnG,WAAKC,cAAL,CAAoBC,KAApB;AACA;AACD,IALD;;AAOA;AACA,QAAKjE,OAAL,CAAakE,gBAAb,CAA8B,iBAA9B,EAAiD,eAAO;AACvD,QAAIC,IAAIC,OAAJ,KAAgB,MAAKZ,MAAL,IAAe,MAAKE,OAApC,CAAJ,EAAkD;AACjD;AACA,SAAI,CAAC,MAAKlB,IAAL,CAAUoB,IAAX,IAAmB,CAAC,MAAKS,cAA7B,EAA6C;AAC5C,YAAKZ,IAAL;AACA;AACD;AACD,IAPD;;AASA,QAAKa,GAAL,GAAW,IAAIzE,KAAK0E,EAAL,CAAQC,GAAZ,CAAgB,IAAhB,CAAX;;AAEA;AACA,OAAI/E,EAAE,kCAAF,CAAJ,EAA2C;AAC1C,SAAKO,OAAL,CAAakE,gBAAb,CAA8B,OAA9B,EAAuC,eAAO;AAC7C,SAAIC,IAAIM,MAAJ,IAAcC,SAASC,aAA3B,EAA0C;AACzCR,UAAIS,cAAJ;AACA;AACD,KAJD;AAKA;;AAED;AACA,QAAKC,SAAL,GAAiB,KAAKC,IAAL,CAAU;AAAA,WAAOC,OAAO,MAAKvC,IAAZ,IAAoB,CAACuC,IAAIC,KAAzB,IAAkCD,IAAIE,IAAJ,IAAY,MAArD;AAAA,IAAV,CAAjB;;AAEA,QAAKC,iBAAL,CAAuB,KAAvB;;AAEA,QAAKvC,WAAL,CAAiBwC,QAAjB,CAA0B,gBAAqB;AAAA,QAAnBC,MAAmB,QAAnBA,MAAmB;AAAA,QAAX5E,KAAW,QAAXA,KAAW;;AAC9C,QAAImC,cAAc,MAAK3C,OAAL,CAAae,YAAb,CAA0B,gBAA1B,KAA+C,EAAjE;AACA4B,kBAAcA,YAAY0C,IAAZ,GAAmBC,KAAnB,CAAyB,KAAzB,EAAgCC,MAAhC,CAAuC;AAAA,YAAKC,KAAKJ,MAAV;AAAA,KAAvC,CAAd;;AAEA,QAAI5E,KAAJ,EAAW;AACVmC,iBAAY8C,IAAZ,CAAiBL,MAAjB;AACA;;AAED,UAAKpF,OAAL,CAAagB,YAAb,CAA0B,gBAA1B,EAA4C2B,YAAY9B,IAAZ,CAAiB,GAAjB,CAA5C;AACA,IATD;;AAWA,OAAI,KAAKgE,SAAT,EAAoB;AACnB,SAAKlC,WAAL,CAAiBkB,GAAjB,CAAqB,CAAC,MAAD,EAAS,KAAT,EAAgB,QAAhB,CAArB,EAAgD,YAAM;AACrD;AACA,WAAK6B,YAAL,GAAoB,IAAI7F,KAAKoD,QAAT,CAAkB,MAAKjD,OAAvB,EAAgC,SAAhC,EAA2C,mBAAW;AAAA;AAAA;AAAA;;AAAA;AACzE,6BAAmBoD,OAAnB,mIAA4B;AAAA,YAAnBC,MAAmB;;AAC3B,YAAIrD,WAAUqD,OAAOoB,MAArB;;AAD2B;AAAA;AAAA;;AAAA;AAG3BkB,iBAH2B,EAGjB,sBAAiBhG,EAAEiG,IAAF,CAAOC,QAAP,CAAgB7F,QAAhB,CAAjB,mIAA2C;AAAA,cAAlC8F,IAAkC;;AACpD,cAAIC,eAAeD,KAAKb,IAAxB;AAAA,cAA8BA,aAA9B;;AAEA,cAAIa,KAAK9F,OAAL,IAAgBA,QAApB,EAA6B;AAC5B;AACA;AACAiF,kBAAOa,KAAK9F,OAAL,CAAae,YAAb,CAA0B,SAA1B,CAAP;AACA+E,gBAAKd,KAAL,GAAaC,IAAb;AACA,WALD,MAMK;AACJ;AACA,eAAIa,KAAKd,KAAT,EAAgB;AACf;AACA,qBAASW,QAAT;AACA;;AAEDV,kBAAOtF,EAAEqG,QAAF,CAAWF,KAAK9F,OAAL,CAAaiG,UAAxB,EAAoC,WAApC,CAAP;AACA;;AAEDH,eAAKb,IAAL,GAAYA,IAAZ;;AAEA,cAAIc,gBAAgBD,KAAKb,IAAzB,EAA+B;AAC9Ba,gBAAKA,KAAKb,IAAL,IAAa,MAAb,GAAqB,MAArB,GAA8B,MAAnC;AACA;AACD;AA3B0B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AA4B3B;AA7BwE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AA8BzE,MA9BmB,EA8BjB,EAACiB,SAAS,IAAV,EA9BiB,CAApB;;AAgCA,SAAI,MAAK/E,QAAT,EAAmB;AAClB,YAAKgF,IAAL;AACA;AACD,KArCD,EAqCG,YAAM;AAAE;AACV,WAAKT,YAAL,IAAqB,MAAKA,YAAL,CAAkBU,OAAlB,EAArB;AACA,KAvCD;AAwCA;;AAED,OAAI,KAAK1C,OAAL,IAAgB,KAAKF,MAAzB,EAAiC;AAChC;AACA,SAAKb,WAAL,CAAiBkB,GAAjB,CAAqB,MAArB,EAA6B;AAAA,YAAM,MAAKJ,IAAL,EAAN;AAAA,KAA7B;AACA,IAHD,MAIK;AACJ;AACAhE,MAAE4G,IAAF,CAAO,KAAKrG,OAAZ,EAAqB,WAArB;AACA;;AAED,QAAK2C,WAAL,CAAiBkB,GAAjB,CAAqB,MAArB,EAA6B,YAAM;AAClC,QAAI,MAAKvC,QAAT,EAAmB;AAClB,WAAKtB,OAAL,CAAakE,gBAAb,CAA8B,yBAA9B,EAAyD,eAAO;AAC/D,UAAIoC,gBAAgB3G,EAAE4G,QAAF,CAAW,YAAM;AACpC,aAAKC,IAAL;AACA,OAFmB,EAEjB,MAAKhF,aAFY,CAApB;;AAIA,UAAIiF,WAAW,SAAXA,QAAW,MAAO;AACrB,WAAItC,IAAI2B,IAAJ,CAASY,KAAb,EAAoB;AACnBJ;AACA;AACD,OAJD;;AAMAK,4BAAsB,YAAM;AAC3B,aAAKhE,WAAL,CAAiBkB,GAAjB,CAAqB,MAArB,EAA6B,YAAM;AAClC,cAAK7D,OAAL,CAAakE,gBAAb,CAA8B,+BAA9B,EAA+DuC,QAA/D;AACA,QAFD,EAEG,YAAM;AACR,cAAKzG,OAAL,CAAa4G,mBAAb,CAAiC,+BAAjC,EAAkEH,QAAlE;AACA,QAJD;AAKA,OAND;AAOA,MAlBD;AAmBA;AACD,IAtBD,EAsBG,YAAM;AACR,UAAKzG,OAAL,CAAa4G,mBAAb,CAAiC,gBAAjC;AACA,IAxBD;;AA0BA;AACA,QAAK5G,OAAL,CAAakE,gBAAb,CAA8B,SAA9B,EAAyC,eAAO;AAC/C,QAAIC,IAAI0C,OAAJ,IAAe,EAAf,IAAqB1C,IAAIxE,EAAEmH,QAAN,CAAzB,EAA0C;AACzC3C,SAAIS,cAAJ;AACA,WAAK4B,IAAL;AACA;AACD,IALD;;AAOA3G,QAAK4B,KAAL,CAAWC,GAAX,CAAe,UAAf,EAA2B,IAA3B;AACA,GAvO0B;;AAyO3B,MAAIqF,OAAJ,GAAc;AACb,UAAO,KAAKvE,IAAL,CAAUuE,OAAjB;AACA,GA3O0B;;AA6O3BC,WAAS,mBAAW;AACnB,UAAO,KAAKxE,IAAL,CAAUwE,OAAV,EAAP;AACA,GA/O0B;;AAiP3BC,UAAQ,kBAAW;AAClB,UAAOtH,EAAEsH,MAAF,CAAS,KAAKD,OAAL,EAAT,CAAP;AACA,GAnP0B;;AAqP3BE,WAAS,iBAASA,QAAT,EAAkBC,OAAlB,EAA2B;AACnC,UAAO,IAAIxH,EAAE4E,EAAF,CAAK6C,OAAT,CAAiB,IAAjB,EAAuBF,QAAvB,EAAgCC,OAAhC,CAAP;AACA,GAvP0B;;AAyP3BE,SAAO,eAASH,OAAT,EAA0B;AAChC,QAAKA,OAAL,CAAaA,OAAb,EAAsB;AACrBI,aAAS,UADY;AAErBC,aAAS,CAAC,QAAD,EAAW,SAAX;AAFY,IAAtB;;AAKA;;AANgC,qCAALC,GAAK;AAALA,OAAK;AAAA;;AAOhC,OAAIA,IAAIpH,MAAJ,GAAa,CAAjB,EAAoB;AAAA;;AACnB,yBAAQoH,GAAR,yBAAiB,KAAKvG,EAAtB,UAA6BiG,OAA7B,EAAwC,+BAAxC,SAA4EM,GAA5E;AACA;AACD,GAnQ0B;;AAqQ3BC,UAAQ,gBAAS7D,IAAT,EAAe;AACtB,QAAKtB,WAAL,CAAiBoF,MAAjB,GAA0B,KAA1B;;AAEA,OAAIC,MAAM,EAACC,SAAS,IAAV,EAAgBhE,UAAhB,EAAV;AACAjE,KAAE8B,KAAF,CAAQC,GAAR,CAAY,cAAZ,EAA4BiG,GAA5B;;AAEA,OAAIA,IAAI/D,IAAR,EAAc;AACb,SAAKpB,IAAL,CAAUiF,MAAV,CAAiBE,IAAI/D,IAArB;AACA;;AAED,QAAKS,cAAL,GAAsB,KAAtB;;AAEA,QAAK/B,WAAL,CAAiBoF,MAAjB,GAA0B,IAA1B;AACA,QAAKpF,WAAL,CAAiBuF,MAAjB;;AAEAlI,KAAE8B,KAAF,CAAQC,GAAR,CAAY,YAAZ,EAA0BiG,GAA1B;AACA,GArR0B;;AAuR3BG,SAAO,iBAAW;AAAA;;AACjB,OAAIC,QAAQ,+CAAR,CAAJ,EAA8D;AAC7D,SAAKC,KAAL,CAAW,IAAX,EAAiBC,IAAjB,CAAsB;AAAA,YAAM,OAAKzF,IAAL,CAAUsF,KAAV,EAAN;AAAA,KAAtB;AACA;AACD,GA3R0B;;AA6R3B3B,QAAM,gBAAW;AAChB,QAAK3D,IAAL,CAAU2D,IAAV;;AAEA1G,KAAEyI,MAAF,CAAS,KAAKlI,OAAd,EAAuB,2CAAvB,EAAoE,eAAO;AAC1E,QAAImE,IAAIM,MAAJ,CAAW0D,OAAX,CAAmBxI,EAAEgC,SAAF,CAAYyG,QAA/B,CAAJ,EAA8C;AAC7CjE,SAAIM,MAAJ,CAAWrD,SAAX,CAAqBiH,MAArB,CAA4B,qBAA5B;;AAEA,SAAIC,SAASnE,IAAIM,MAAJ,CAAWwB,UAAX,CAAsBsC,OAAtB,CAA8B5I,EAAEgC,SAAF,CAAYyG,QAA1C,CAAb;;AAEA,SAAIE,MAAJ,EAAY;AACXA,aAAOlH,SAAP,CAAiBoH,MAAjB,CAAwB,qBAAxB,EAA+CrE,IAAIsE,IAAJ,IAAY,YAA3D;AACA;AACD;AACD,IAVD,EAUG,IAVH;;AAYA,QAAKvD,iBAAL;AACA,GA7S0B;;AA+S3B;;;;;;;AAOAA,qBAAmB,2BAAS1E,KAAT,EAAgB;AAClC,OAAI6D,iBAAiB,CAAC,CAAC7D,KAAvB;;AAEA,OAAI,CAACA,KAAL,EAAY;AACX,SAAKkI,IAAL,CAAU,eAAO;AAChB,SAAI3D,IAAIV,cAAR,EAAwB;AACvBA,uBAAiB,IAAjB;;AAEA,UAAI7D,UAAU,KAAd,EAAqB;AACpBuE,WAAIV,cAAJ,GAAqB,KAArB;AACA;;AAED,aAAO,KAAP;AACA;AACD,KAVD;AAWA;;AAED,UAAO,KAAKA,cAAL,GAAsBA,cAA7B;AACA,GAxU0B;;AA0U3B;AACAsE,QAAM,gBAAW;AAChB,QAAKnG,IAAL,CAAUmG,IAAV;AACAlJ,KAAEmJ,MAAF,CAAS,KAAK5I,OAAd,EAAuB,YAAvB;AACA,QAAKqE,cAAL,GAAsB,KAAtB;AACA,GA/U0B;;AAiV3B;;;;AAIAtB,iBAAe,uBAASD,IAAT,EAAe;AAC7B,OAAI+F,WAAW,KAAK/F,IAAL,CAAf;AAAA,OAA2BsB,OAA3B;;AAEA,OAAI,KAAKjE,KAAL,IAAc,CAAlB,EAAqB;AACpBiE,cAAUzE,EAAEmE,SAAF,CAAYC,IAAZ,CAAiBjB,IAAjB,CAAV;AACA;;AAED,OAAI,CAACsB,OAAL,EAAc;AACbA,cAAWzE,EAAEmE,SAAF,CAAYC,IAAZ,CAAoB,KAAK9C,EAAzB,SAA+B6B,IAA/B,KAA0C,KAAK9C,OAAL,CAAae,YAAb,CAA0B,QAAQ+B,IAAlC,CAA1C,IAAqF,IAAhG;AACA;;AAED,OAAIsB,OAAJ,EAAa;AACZA,cAAUA,QAAQiB,IAAR,EAAV;;AAEA,QAAIjB,WAAW,MAAf,EAAuB;AACtBA,eAAU,IAAV;AACA;AACD;;AAED,OAAIA,YAAY,CAACyE,QAAD,IAAa,CAACA,SAASC,MAAT,CAAgB1E,OAAhB,CAA1B,CAAJ,EAAyD;AACxD;AACA,SAAKtB,IAAL,IAAasB,UAAUzE,EAAEoJ,OAAF,CAAUC,MAAV,CAAiB5E,OAAjB,EAA0B;AAChD6E,WAAM,IAD0C;AAEhDC,aAAQ,KAAKlJ,OAAL,CAAae,YAAb,CAA0B,eAAe+B,IAAzC,KAAkD,KAAK9C,OAAL,CAAae,YAAb,CAA0B,WAA1B;AAFV,KAA1B,CAAvB;AAIA,IAND,MAOK,IAAI,CAACqD,OAAL,EAAc;AAClB;AACA,SAAKtB,IAAL,IAAa,IAAb;AACA;;AAED,OAAII,UAAUkB,UAAS,CAACA,QAAQ0E,MAAR,CAAeD,QAAf,CAAV,GAAqC,CAAC,CAACA,QAArD;;AAEA,OAAI3F,OAAJ,EAAa;AACZ;AACA,QAAI,CAAC,KAAKQ,OAAN,IAAiB,CAAC,KAAKF,MAAvB,IAAiC,KAAKG,IAA1C,EAAgD;AAC/C;AACA,UAAKH,MAAL,GAAc,KAAKG,IAAnB;AACA,UAAKA,IAAL,GAAY,IAAZ;AACA;;AAED,QAAIhB,cAAc,KAAKe,OAAL,GAAc,KAAKA,OAAL,CAAaf,WAA3B,GAAyC,IAAI9C,KAAK+C,WAAT,CAAqB,EAACuD,MAAM,IAAP,EAAaK,MAAM,KAAnB,EAArB,CAA3D;AACA7D,gBAAY2F,MAAZ,GAAqB,KAAK9E,MAAL,IAAe,KAAKA,MAAL,CAAYb,WAAhD;AACA,SAAKA,WAAL,CAAiB2F,MAAjB,GAA0B3F,WAA1B;;AAEA,SAAKqB,cAAL,GAAsB,KAAKN,OAAL,IAAgB,KAAKF,MAA3C;AACA;;AAED,UAAON,OAAP;AACA,GAtY0B;;AAwY3B;;;;;AAKAO,QAAM,gBAAW;AAAA;;AAChB,OAAIW,UAAU,KAAKZ,MAAL,IAAe,KAAKE,OAAlC;;AAEA,OAAI,CAACU,OAAL,EAAc;AACb,WAAO+E,QAAQzG,OAAR,EAAP;AACA;;AAED,QAAK0G,UAAL,GAAkB,SAAlB;;AAEA,UAAOhF,QAAQiF,KAAR,CAAcpB,IAAd,CAAmB;AAAA,WAAM7D,QAAQX,IAAR,EAAN;AAAA,IAAnB,EACN6F,KADM,CACA,eAAO;AACb;AACA,QAAI,OAAK3F,IAAL,IAAa,OAAKA,IAAL,IAAaS,OAA9B,EAAuC;AACtCA,eAAU,OAAKT,IAAf;AACA,YAAO,OAAKA,IAAL,CAAU0F,KAAV,CAAgBpB,IAAhB,CAAqB;AAAA,aAAM,OAAKtE,IAAL,CAAUF,IAAV,EAAN;AAAA,MAArB,CAAP;AACA;;AAED;AACA,WAAO0F,QAAQI,MAAR,CAAeC,GAAf,CAAP;AACA,IAVM,EAWNF,KAXM,CAWA,eAAO;AACb,QAAIE,GAAJ,EAAS;AACR,SAAIC,MAAMD,eAAeE,cAAf,GAA+BF,GAA/B,GAAqCA,IAAIC,GAAnD;;AAEA,SAAIA,OAAOA,IAAIE,MAAJ,IAAc,GAAzB,EAA8B;AAC7B,aAAKlC,MAAL,CAAY,IAAZ;AACA,MAFD,MAGK;AACJ,UAAIP,UAAU,sBAAd;;AAEA,UAAIuC,GAAJ,EAAS;AACRvC,kBAAWuC,IAAIE,MAAJ,qBAA4BH,IAAIG,MAAhC,UAA2CH,IAAII,UAA/C,GAA8D,iCAAzE;AACA;;AAED,aAAKvC,KAAL,CAAWH,OAAX,EAAoBsC,GAApB;AACA;AACD;AACD,WAAO,IAAP;AACA,IA7BM,EA8BNvB,IA9BM,CA8BD;AAAA,WAAQ,OAAKR,MAAL,CAAY7D,IAAZ,CAAR;AAAA,IA9BC,EA+BNqE,IA/BM,CA+BD,YAAM;AACX,WAAKmB,UAAL,GAAkB,KAAlB;AACA3J,MAAE4G,IAAF,CAAO,OAAKrG,OAAZ,EAAqB,WAArB;AACA,IAlCM,CAAP;AAmCA,GAzb0B;;AA2b3BgI,SAAO,iBAAW;AAAA;;AACjB,OAAI,CAAC,KAAKtE,OAAV,EAAmB;AAClB,WAAOyF,QAAQzG,OAAR,EAAP;AACA;;AAED,QAAK0G,UAAL,GAAkB,QAAlB;;AAEA,UAAO,KAAK1F,OAAL,CAAaO,KAAb,GACLgE,IADK,CACA;AAAA,WAAM,OAAKvE,OAAL,CAAasE,KAAb,CAAmB,OAAKhB,OAAL,EAAnB,CAAN;AAAA,IADA,EAELsC,KAFK,CAEC,eAAO;AACb,QAAIE,GAAJ,EAAS;AACR,SAAItC,UAAU,qBAAd;;AAEA,SAAIsC,eAAeE,cAAnB,EAAmC;AAClCxC,iBAAWsC,IAAIG,MAAJ,qBAA4BH,IAAIG,MAAhC,UAA2CH,IAAII,UAA/C,GAA8D,iCAAzE;AACA;;AAED,YAAKvC,KAAL,CAAWH,OAAX,EAAoBsC,GAApB;AACA;;AAED,WAAO,IAAP;AACA,IAdK,EAeLvB,IAfK,CAeA,iBAAS;AACd,WAAKmB,UAAL,GAAkB,KAAlB;AACA,WAAO1C,KAAP;AACA,IAlBK,CAAP;AAmBA,GArd0B;;AAud3BmD,UAAQ,gBAASC,IAAT,EAA6C;AAAA;;AAAA,OAA9BC,IAA8B,uEAAvB,YAAYD,KAAKE,IAAM;;AACpD,OAAI,CAAC,KAAKC,aAAV,EAAyB;AACxB,WAAOd,QAAQI,MAAR,EAAP;AACA;;AAED,QAAKH,UAAL,GAAkB,WAAlB;;AAEA,UAAO,KAAKa,aAAL,CAAmBJ,MAAnB,CAA0BC,IAA1B,EAAgCC,IAAhC,EACL9B,IADK,CACA,eAAO;AACZ,WAAKmB,UAAL,GAAkB,KAAlB;AACA,WAAOc,GAAP;AACA,IAJK,EAKLZ,KALK,CAKC,eAAO;AACb,WAAKjC,KAAL,CAAW,sBAAX,EAAmCmC,GAAnC;AACA,WAAKJ,UAAL,GAAkB,KAAlB;AACA,WAAO,IAAP;AACA,IATK,CAAP;AAUA,GAxe0B;;AA0e3B5C,QAAM,gBAAW;AAAA;;AAChB,UAAO,KAAKwB,KAAL,GAAaC,IAAb,CAAkB,iBAAS;AACjC,QAAIvB,KAAJ,EAAW;AACVjH,OAAE4G,IAAF,CAAO,OAAKrG,OAAZ,EAAqB,WAArB,EAAkC0G,KAAlC;;AAEA,YAAKyD,SAAL,GAAiBC,KAAKC,GAAL,EAAjB;AACA,YAAK7H,IAAL,CAAUgE,IAAV;AACA,YAAKnC,cAAL,GAAsB,KAAtB;AACA;AACD,IARM,CAAP;AASA,GApf0B;;AAsf3BqE,QAAM,cAASjC,QAAT,EAAmB;AACxB,UAAO,KAAKjE,IAAL,CAAUkG,IAAV,CAAejC,QAAf,CAAP;AACA,GAxf0B;;AA0f3B;;;;;AAKA3B,QAAM,cAASwF,IAAT,EAAe;AACpB,UAAO,CAAC,KAAK5B,IAAL,CAAU,UAAC3D,GAAD,EAAMgF,IAAN,EAAe;AAChC,QAAIQ,MAAMD,KAAKvF,GAAL,EAAUgF,IAAV,CAAV;;AAEA,QAAIQ,QAAQ,IAAZ,EAAkB;AACjB,YAAO,KAAP;AACA;AACD,IANO,CAAR;AAOA,GAvgB0B;;AAygB3BC,QAAM;AACLpB,eAAY,oBAAS5I,KAAT,EAAgB;AAC3Bf,MAAEgL,eAAF,CAAkB,KAAKzK,OAAvB,EAAgC,aAAhC,EAA+CQ,KAA/C,EAAsDA,KAAtD;AACA,IAHI;;AAKL6D,mBAAgB,wBAAS7D,KAAT,EAAgB;AAC/B,SAAKR,OAAL,CAAaoB,SAAb,CAAuBoH,MAAvB,CAA8B,oBAA9B,EAAoDhI,KAApD;AACA,IAPI;;AASLqE,cAAW,mBAASrE,KAAT,EAAgB;AAC1B,SAAK8D,GAAL,CAASkE,MAAT,CAAgB,MAAhB,EAAwBhI,KAAxB;AACA,IAXI;;AAaLkD,YAAS,iBAASlD,KAAT,EAAgB;AACxB,QAAIA,UAAU,KAAKkK,QAAf,IAA2B,CAAClK,KAAhC,EAAuC;AACtC,SAAImC,cAAc,IAAI9C,KAAK+C,WAAT,CAAqB,EAACuD,MAAM,IAAP,EAAaK,MAAM,KAAnB,EAArB,CAAlB;AACA7D,iBAAY2F,MAAZ,GAAqB,KAAK3F,WAAL,CAAiB2F,MAAtC;AACA,UAAK3F,WAAL,CAAiB2F,MAAjB,GAA0B3F,WAA1B;AACA;AACD,IAnBI;;AAqBLqB,mBAAgB,wBAASxD,KAAT,EAAgB;AAC/BA,YAAQA,SAAS,IAAjB;;AAEA,QAAIA,SAAS,KAAKmK,eAAlB,EAAmC;AAClC,SAAInK,KAAJ,EAAY;AACX,WAAKR,OAAL,CAAa4K,KAAb,CAAmBC,WAAnB,CAA+B,cAA/B,SAAmDrK,MAAMS,EAAzD;AACA,MAFD,MAGK;AACJ,WAAKjB,OAAL,CAAa4K,KAAb,CAAmBE,cAAnB,CAAkC,cAAlC;AACA;;AAED,YAAOtK,KAAP;AACA;AACD,IAlCI;;AAoCLyJ,kBAAe;AACdc,SAAK,eAAW;AACf,SAAI,KAAKrH,OAAL,IAAgB,KAAKA,OAAL,CAAamG,MAAjC,EAAyC;AACxC;AACA,aAAO,KAAKnG,OAAZ;AACA;AACD;AANa;AApCV,GAzgBqB;;AAujB3BsH,UAAQ;AACPzK,QAAK,EADE;;AAGP,OAAIH,MAAJ,GAAa;AACZ,WAAOC,OAAO4K,IAAP,CAAYtL,EAAEY,GAAd,EAAmBH,MAA1B;AACA,IALM;;AAOP2K,QAAK,aAAS9J,EAAT,EAAa;AACjB,QAAIA,cAAciK,OAAlB,EAA2B;AAC1B;AACA,UAAK,IAAIlB,IAAT,IAAiBrK,EAAEY,GAAnB,EAAwB;AACvB,UAAIZ,EAAEY,GAAF,CAAMyJ,IAAN,EAAYhK,OAAZ,IAAuBiB,EAA3B,EAA+B;AAC9B,cAAOtB,EAAEY,GAAF,CAAMyJ,IAAN,CAAP;AACA;AACD;;AAED,YAAO,IAAP;AACA;;AAED,QAAIA,OAAO,OAAO/I,EAAP,KAAc,QAAd,GAAwBZ,OAAO4K,IAAP,CAAYtL,EAAEY,GAAd,EAAmBU,EAAnB,CAAxB,GAAiDA,EAA5D;;AAEA,WAAOtB,EAAEY,GAAF,CAAMyJ,IAAN,KAAe,IAAtB;AACA,IAtBM;;AAwBPlD,aAAUqE,UAAUC,QAAV,CAAmBC,OAAnB,CAA2B,KAA3B,MAAsC,CAAtC,GAAyC,SAAzC,GAAqD,SAxBxD;AAyBPC,SAAMC,SAASC,QAAT,IAAqB,QAArB,GAAgC9G,SAAS+G,aAAT,GAAwB/G,SAAS+G,aAAT,CAAuBC,GAA/C,GAAqD,gBAArF,GAAyGH,QAzBxG;AA0BPI,iBAAc,EA1BP;;AA4BPhI,SAAM,gBAA+B;AAAA,QAAtBiI,SAAsB,uEAAVlH,QAAU;;AACpC,WAAOhF,GAAGC,EAAEgC,SAAF,CAAYgC,IAAf,EAAqBiI,SAArB,EACLrG,MADK,CACE;AAAA,YAAW,CAAC5F,EAAEoL,GAAF,CAAM/K,OAAN,CAAZ;AAAA,KADF,EAC8B;AAD9B,KAELW,GAFK,CAED;AAAA,YAAW,IAAIhB,CAAJ,CAAMK,OAAN,CAAX;AAAA,KAFC,CAAP;AAGA,IAhCM;;AAkCPuE,OAAI,EAlCG;;AAoCP9C,UAAO,IAAIhC,EAAEoM,KAAN,EApCA;;AAsCPnL,eAAY,CACX,QADW,EACD,YADC,EACa,WADb,EAC0B,SAD1B,EACqC,SADrC,EACgD,WADhD,EAEX,cAFW,EAEK,YAFL,EAEmB,SAFnB,EAE8B,SAF9B,EAEyC,iBAFzC,EAGX,QAHW;AAtCL;AAvjBmB,EAAR,CAApB;;AAqmBA;;AAEA,MAAIoL,IAAInM,EAAEgC,SAAF,GAAc;AACrBgC,SAAM,kCADe;AAErB3B,aAAU,wBAFW;AAGrB+J,qBAAkB;AAAA,0BAAqB/B,IAArB,qBAAyCA,IAAzC;AAAA,IAHG;AAIrBgC,UAAO,+CAJc;AAKrB5D,aAAU,eALW;AAMrBrG,gBAAa,iCANQ;AAOrBkK,OAAI,QAPiB;AAQrBL,cAAW;AACV;AACA,UAAM,OAFI;AAGV,cAAU;AAHA;AARU,GAAtB;;AAiBA,MAAIM,MAAMJ,EAAEI,GAAF,GAAQ;AAAA,UAAYzL,SAAS6E,KAAT,CAAe,UAAf,CAAZ;AAAA,GAAlB;AACA,MAAIxD,MAAMgK,EAAEhK,GAAF,GAAQ;AAAA,UAAYoK,IAAIzL,QAAJ,EAAcE,GAAd,CAAkB;AAAA,qBAAamL,CAAb;AAAA,IAAlB,EAAqCjL,IAArC,CAA0C,EAA1C,CAAZ;AAAA,GAAlB;AACA,MAAIsL,KAAKL,EAAEK,EAAF,GAAO,UAACC,SAAD,EAAYC,SAAZ;AAAA,UAA0BD,YAAY,IAAZ,GAAmBC,SAA7C;AAAA,GAAhB;AACA,MAAIC,MAAMR,EAAEQ,GAAF,GAAQ,UAACF,SAAD,EAAYC,SAAZ,EAA0B;AAC3C,OAAI9B,MAAM,EAAV;AAAA,OAAcgC,OAAOL,IAAIG,SAAJ,CAArB;;AAEAH,OAAIE,SAAJ,EAAetL,OAAf,CAAuB;AAAA,WAAMyJ,IAAI9E,IAAJ,+BAAY8G,KAAK5L,GAAL,CAAS;AAAA,YAAM6L,KAAKC,EAAX;AAAA,KAAT,CAAZ,EAAN;AAAA,IAAvB;;AAEA,UAAOlC,IAAI1J,IAAJ,CAAS,IAAT,CAAP;AACA,GAND;AAOA,MAAI6L,SAASZ,EAAEY,MAAF,GAAW,UAACN,SAAD,EAAYC,SAAZ;AAAA,UAA0BC,IAAIF,SAAJ,EAAetK,IAAIuK,SAAJ,CAAf,CAA1B;AAAA,GAAxB;;AAEA5M,IAAEkN,MAAF,CAAShN,EAAEgC,SAAX,EAAsB;AACrBC,cAAW8K,OAAOZ,EAAE9J,QAAT,EAAmB8J,EAAEE,KAArB,CADU;AAErBY,cAAWF,OAAOZ,EAAEE,KAAT,EAAgBF,EAAE9J,QAAlB,CAFU;AAGrB6K,WAAQV,GAAGL,EAAEC,gBAAF,CAAmB,QAAnB,CAAH,EAAiC,YAAjC;AAHa,GAAtB;AAMC;;AAED;AACApF,uBAAsB,YAAM;AAC3B,MAAImG,kBAAkBC,MAAMC,IAAN,IAAcC,OAAOC,IAArB,IAA6BxI,SAASyI,eAAT,CAAyB5E,OAAtD,IAAiE3I,KAAKwN,GAAtE,IAA6E,kBAAkBA,IAAIC,SAAzH;;AAEA1N,IAAEgM,YAAF,CAAelG,IAAf,CACChG,EAAE4J,KAAF,EADD,EAEC1J,EAAE2N,OAAF,CAAU7J,IAAV,EAFD,EAGChE,EAAE8N,OAAF,CAAUT,eAAV,EAA2B,gFAA3B,CAHD;;AAMAnN,IAAE0J,KAAF,GAAU1J,EAAEY,GAAF,CAAMZ,EAAEgM,YAAR,CAAV;AACAhM,IAAE6N,MAAF,GAAW7N,EAAE0J,KAAF,CAAQC,KAAR,CAAcmE,QAAQpG,KAAtB,EAA6BY,IAA7B,CAAkC;AAAA,UAAMpI,KAAK8D,IAAL,EAAN;AAAA,GAAlC,CAAX;AACA,EAXD;;AAaA+J,UAAS/L,SAAT,CAAmB4D,MAAnB,GAA4B,0CAA5B;AAEC,CA9pBD,EA8pBGoI,KA9pBH,EA8pBUA,MAAMlO,CA9pBhB","file":"../mavo.es5.js","sourcesContent":["(function ($, $$) {\n\nvar _ = self.Mavo = $.Class({\n\tconstructor: function (element) {\n\t\tthis.treeBuilt = Mavo.defer();\n\n\t\tthis.element = element;\n\n\t\t// Index among other mavos in the page, 1 is first\n\t\tthis.index = _.length + 1;\n\t\tObject.defineProperty(_.all, this.index - 1, {value: this});\n\n\t\t// Convert any data-mv-* attributes to mv-*\n\t\tvar selector = _.attributes.map(attribute => `[data-${attribute}]`).join(\", \");\n\n\t\t[this.element, ...$$(selector, this.element)].forEach(element => {\n\t\t\tfor (let attribute of _.attributes) {\n\t\t\t\tlet value = element.getAttribute(\"data-\" + attribute);\n\n\t\t\t\tif (value !== null) {\n\t\t\t\t\telement.setAttribute(attribute, value);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\t// Assign a unique (for the page) id to this mavo instance\n\t\tthis.id = Mavo.getAttribute(this.element, \"mv-app\", \"id\") || `mavo${this.index}`;\n\n\t\tif (this.id in _.all) {\n\t\t\t// Duplicate app name\n\t\t\tfor (var i=2; this.id + i in _.all; i++) {}\n\t\t\tthis.id = this.id + i;\n\t\t}\n\n\t\t_.all[this.id] = this;\n\t\tthis.element.setAttribute(\"mv-app\", this.id);\n\n\t\t// Should we start in edit mode?\n\t\tthis.autoEdit = this.element.classList.contains(\"mv-autoedit\");\n\n\t\t// Should we save automatically?\n\t\tthis.autoSave = this.element.hasAttribute(\"mv-autosave\");\n\t\tthis.autoSaveDelay = (this.element.getAttribute(\"mv-autosave\") || 3) * 1000;\n\n\t\tthis.element.setAttribute(\"typeof\", \"\");\n\n\t\tMavo.hooks.run(\"init-start\", this);\n\n\t\t// Apply heuristic for groups\n\t\tfor (var element of $$(_.selectors.primitive, this.element)) {\n\t\t\tvar hasChildren = $(`${_.selectors.not(_.selectors.formControl)}, ${_.selectors.property}`, element);\n\n\t\t\tif (hasChildren) {\n\t\t\t\tvar config = Mavo.Primitive.getConfig(element);\n\t\t\t\tvar isCollection = Mavo.is(\"multiple\", element);\n\n\t\t\t\tif (isCollection || !config.attribute && !config.hasChildren) {\n\t\t\t\t\telement.setAttribute(\"typeof\", \"\");\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis.expressions = new Mavo.Expressions(this);\n\n\t\t// Build mavo objects\n\t\tMavo.hooks.run(\"init-tree-before\", this);\n\n\t\tthis.root = new Mavo.Group(this.element, this);\n\t\tthis.treeBuilt.resolve();\n\n\t\tMavo.hooks.run(\"init-tree-after\", this);\n\n\t\tthis.permissions = new Mavo.Permissions();\n\n\t\tvar backendTypes = [\"source\", \"storage\", \"init\"]; // order is significant!\n\n\t\t// Figure out backends for storage, data reads, and initialization respectively\n\t\tfor (let role of backendTypes) {\n\t\t\tthis.updateBackend(role);\n\t\t}\n\n\t\tthis.backendObserver = new Mavo.Observer(this.element, backendTypes.map(role => \"mv-\" + role), records => {\n\t\t\tvar changed = {};\n\n\t\t\tvar roles = records.map(record => {\n\t\t\t\tvar role = record.attributeName.replace(/^mv-/, \"\");\n\t\t\t\tchanged[role] = this.updateBackend(role);\n\n\t\t\t\treturn role;\n\t\t\t});\n\n\t\t\t// Do we need to re-load data?\n\t\t\tif (changed.source) {  // if source changes, always reload\n\t\t\t\tthis.load();\n\t\t\t}\n\t\t\telse if (!this.source) {\n\t\t\t\tif (changed.storage || changed.init && !this.root.data) {\n\t\t\t\t\tthis.load();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tthis.permissions.can(\"login\", () => {\n\t\t\t// We also support a URL param to trigger login, in case the user doesn't want visible login UI\n\t\t\tif (\"login\" in Mavo.Functions.$url && this.index == 1 || this.id + \"-login\" in Mavo.Functions.$url) {\n\t\t\t\tthis.primaryBackend.login();\n\t\t\t}\n\t\t});\n\n\t\t// Update login status\n\t\tthis.element.addEventListener(\"mavo:login.mavo\", evt => {\n\t\t\tif (evt.backend == (this.source || this.storage)) {\n\t\t\t\t// If last time we rendered we got nothing, maybe now we'll have better luck?\n\t\t\t\tif (!this.root.data && !this.unsavedChanges) {\n\t\t\t\t\tthis.load();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tthis.bar = new Mavo.UI.Bar(this);\n\n\t\t// Prevent editing properties inside <summary> to open and close the summary (fix bug #82)\n\t\tif ($(\"summary [property]:not([typeof])\")) {\n\t\t\tthis.element.addEventListener(\"click\", evt => {\n\t\t\t\tif (evt.target != document.activeElement) {\n\t\t\t\t\tevt.preventDefault();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\t// Is there any control that requires an edit button?\n\t\tthis.needsEdit = this.some(obj => obj != this.root && !obj.modes && obj.mode == \"read\");\n\n\t\tthis.setUnsavedChanges(false);\n\n\t\tthis.permissions.onchange(({action, value}) => {\n\t\t\tvar permissions = this.element.getAttribute(\"mv-permissions\") || \"\";\n\t\t\tpermissions = permissions.trim().split(/\\s+/).filter(a => a != action);\n\n\t\t\tif (value) {\n\t\t\t\tpermissions.push(action);\n\t\t\t}\n\n\t\t\tthis.element.setAttribute(\"mv-permissions\", permissions.join(\" \"));\n\t\t});\n\n\t\tif (this.needsEdit) {\n\t\t\tthis.permissions.can([\"edit\", \"add\", \"delete\"], () => {\n\t\t\t\t// Observe entire tree for mv-mode changes\n\t\t\t\tthis.modeObserver = new Mavo.Observer(this.element, \"mv-mode\", records => {\n\t\t\t\t\tfor (let record of records) {\n\t\t\t\t\t\tlet element = record.target;\n\n\t\t\t\t\t\tnodeloop: for (let node of _.Node.children(element)) {\n\t\t\t\t\t\t\tlet previousMode = node.mode, mode;\n\n\t\t\t\t\t\t\tif (node.element == element) {\n\t\t\t\t\t\t\t\t// If attribute set directly on a Mavo node, then it forces it into that mode\n\t\t\t\t\t\t\t\t// otherwise, descendant nodes still inherit, unless they are also mode-restricted\n\t\t\t\t\t\t\t\tmode = node.element.getAttribute(\"mv-mode\");\n\t\t\t\t\t\t\t\tnode.modes = mode;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t// Inherited\n\t\t\t\t\t\t\t\tif (node.modes) {\n\t\t\t\t\t\t\t\t\t// Mode-restricted, we cannot change to the other mode\n\t\t\t\t\t\t\t\t\tcontinue nodeloop;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tmode = _.getStyle(node.element.parentNode, \"--mv-mode\");\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tnode.mode = mode;\n\n\t\t\t\t\t\t\tif (previousMode != node.mode) {\n\t\t\t\t\t\t\t\tnode[node.mode == \"edit\"? \"edit\" : \"done\"]();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}, {subtree: true});\n\n\t\t\t\tif (this.autoEdit) {\n\t\t\t\t\tthis.edit();\n\t\t\t\t}\n\t\t\t}, () => { // cannot\n\t\t\t\tthis.modeObserver && this.modeObserver.destroy();\n\t\t\t});\n\t\t}\n\n\t\tif (this.storage || this.source) {\n\t\t\t// Fetch existing data\n\t\t\tthis.permissions.can(\"read\", () => this.load());\n\t\t}\n\t\telse {\n\t\t\t// No storage or source\n\t\t\t$.fire(this.element, \"mavo:load\");\n\t\t}\n\n\t\tthis.permissions.can(\"save\", () => {\n\t\t\tif (this.autoSave) {\n\t\t\t\tthis.element.addEventListener(\"mavo:load.mavo:autosave\", evt => {\n\t\t\t\t\tvar debouncedSave = _.debounce(() => {\n\t\t\t\t\t\tthis.save();\n\t\t\t\t\t}, this.autoSaveDelay);\n\n\t\t\t\t\tvar callback = evt => {\n\t\t\t\t\t\tif (evt.node.saved) {\n\t\t\t\t\t\t\tdebouncedSave();\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\n\t\t\t\t\trequestAnimationFrame(() => {\n\t\t\t\t\t\tthis.permissions.can(\"save\", () => {\n\t\t\t\t\t\t\tthis.element.addEventListener(\"mavo:datachange.mavo:autosave\", callback);\n\t\t\t\t\t\t}, () => {\n\t\t\t\t\t\t\tthis.element.removeEventListener(\"mavo:datachange.mavo:autosave\", callback);\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\t\t}, () => {\n\t\t\tthis.element.removeEventListener(\".mavo:autosave\");\n\t\t});\n\n\t\t// Ctrl + S or Cmd + S to save\n\t\tthis.element.addEventListener(\"keydown\", evt => {\n\t\t\tif (evt.keyCode == 83 && evt[_.superKey]) {\n\t\t\t\tevt.preventDefault();\n\t\t\t\tthis.save();\n\t\t\t}\n\t\t});\n\n\t\tMavo.hooks.run(\"init-end\", this);\n\t},\n\n\tget editing() {\n\t\treturn this.root.editing;\n\t},\n\n\tgetData: function() {\n\t\treturn this.root.getData();\n\t},\n\n\ttoJSON: function() {\n\t\treturn _.toJSON(this.getData());\n\t},\n\n\tmessage: function(message, options) {\n\t\treturn new _.UI.Message(this, message, options);\n\t},\n\n\terror: function(message, ...log) {\n\t\tthis.message(message, {\n\t\t\tclasses: \"mv-error\",\n\t\t\tdismiss: [\"button\", \"timeout\"]\n\t\t});\n\n\t\t// Log more info for programmers\n\t\tif (log.length > 0) {\n\t\t\tconsole.log(`%c${this.id}: ${message}`, \"color: red; font-weight: bold\", ...log);\n\t\t}\n\t},\n\n\trender: function(data) {\n\t\tthis.expressions.active = false;\n\n\t\tvar env = {context: this, data};\n\t\t_.hooks.run(\"render-start\", env);\n\n\t\tif (env.data) {\n\t\t\tthis.root.render(env.data);\n\t\t}\n\n\t\tthis.unsavedChanges = false;\n\n\t\tthis.expressions.active = true;\n\t\tthis.expressions.update();\n\n\t\t_.hooks.run(\"render-end\", env);\n\t},\n\n\tclear: function() {\n\t\tif (confirm(\"This will delete all your data. Are you sure?\")) {\n\t\t\tthis.store(null).then(() => this.root.clear());\n\t\t}\n\t},\n\n\tedit: function() {\n\t\tthis.root.edit();\n\n\t\t$.events(this.element, \"mouseenter.mavo:edit mouseleave.mavo:edit\", evt => {\n\t\t\tif (evt.target.matches(_.selectors.multiple)) {\n\t\t\t\tevt.target.classList.remove(\"mv-has-hovered-item\");\n\n\t\t\t\tvar parent = evt.target.parentNode.closest(_.selectors.multiple);\n\n\t\t\t\tif (parent) {\n\t\t\t\t\tparent.classList.toggle(\"mv-has-hovered-item\", evt.type == \"mouseenter\");\n\t\t\t\t}\n\t\t\t}\n\t\t}, true);\n\n\t\tthis.setUnsavedChanges();\n\t},\n\n\t/**\n\t * Set this mavo instance’s unsavedChanges flag.\n\t * @param {Boolean} [value]\n\t *        If true, just sets the flag to true, no traversal.\n\t *        If false, sets the flag of the Mavo instance and every tree node to false\n\t *        If not provided, traverses the tree and recalculates the flag value.\n\t */\n\tsetUnsavedChanges: function(value) {\n\t\tvar unsavedChanges = !!value;\n\n\t\tif (!value) {\n\t\t\tthis.walk(obj => {\n\t\t\t\tif (obj.unsavedChanges) {\n\t\t\t\t\tunsavedChanges = true;\n\n\t\t\t\t\tif (value === false) {\n\t\t\t\t\t\tobj.unsavedChanges = false;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn this.unsavedChanges = unsavedChanges;\n\t},\n\n\t// Conclude editing\n\tdone: function() {\n\t\tthis.root.done();\n\t\t$.unbind(this.element, \".mavo:edit\");\n\t\tthis.unsavedChanges = false;\n\t},\n\n\t/**\n\t * Update the backend for a given role\n\t * @return {Boolean} true if a change occurred, false otherwise\n\t */\n\tupdateBackend: function(role) {\n\t\tvar previous = this[role], backend;\n\n\t\tif (this.index == 1) {\n\t\t\tbackend = _.Functions.$url[role];\n\t\t}\n\n\t\tif (!backend) {\n\t\t\tbackend =  _.Functions.$url[`${this.id}-${role}`] || this.element.getAttribute(\"mv-\" + role) || null;\n\t\t}\n\n\t\tif (backend) {\n\t\t\tbackend = backend.trim();\n\n\t\t\tif (backend == \"none\") {\n\t\t\t\tbackend = null;\n\t\t\t}\n\t\t}\n\n\t\tif (backend && (!previous || !previous.equals(backend))) {\n\t\t\t// We have a string, convert to a backend object if different than existing\n\t\t\tthis[role] = backend = _.Backend.create(backend, {\n\t\t\t\tmavo: this,\n\t\t\t\tformat: this.element.getAttribute(\"mv-format-\" + role) || this.element.getAttribute(\"mv-format\")\n\t\t\t});\n\t\t}\n\t\telse if (!backend) {\n\t\t\t// We had a backend and now we will un-have it\n\t\t\tthis[role] = null;\n\t\t}\n\n\t\tvar changed = backend? !backend.equals(previous) : !!previous;\n\n\t\tif (changed) {\n\t\t\t// A change occured\n\t\t\tif (!this.storage && !this.source && this.init) {\n\t\t\t\t// If init is present with no storage and no source, init is equivalent to source\n\t\t\t\tthis.source = this.init;\n\t\t\t\tthis.init = null;\n\t\t\t}\n\n\t\t\tvar permissions = this.storage? this.storage.permissions : new Mavo.Permissions({edit: true, save: false});\n\t\t\tpermissions.parent = this.source && this.source.permissions;\n\t\t\tthis.permissions.parent = permissions;\n\n\t\t\tthis.primaryBackend = this.storage || this.source;\n\t\t}\n\n\t\treturn changed;\n\t},\n\n\t/**\n\t * load - Fetch data from source and render it.\n\t *\n\t * @return {Promise}  A promise that resolves when the data is loaded.\n\t */\n\tload: function() {\n\t\tvar backend = this.source || this.storage;\n\n\t\tif (!backend) {\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\tthis.inProgress = \"Loading\";\n\n\t\treturn backend.ready.then(() => backend.load())\n\t\t.catch(err => {\n\t\t\t// Try again with init\n\t\t\tif (this.init && this.init != backend) {\n\t\t\t\tbackend = this.init;\n\t\t\t\treturn this.init.ready.then(() => this.init.load());\n\t\t\t}\n\n\t\t\t// No init, propagate error\n\t\t\treturn Promise.reject(err);\n\t\t})\n\t\t.catch(err => {\n\t\t\tif (err) {\n\t\t\t\tvar xhr = err instanceof XMLHttpRequest? err : err.xhr;\n\n\t\t\t\tif (xhr && xhr.status == 404) {\n\t\t\t\t\tthis.render(null);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tvar message = \"Problem loading data\";\n\n\t\t\t\t\tif (xhr) {\n\t\t\t\t\t\tmessage += xhr.status? `: HTTP error ${err.status}: ${err.statusText}` : \": Can’t connect to the Internet\";\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.error(message, err);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn null;\n\t\t})\n\t\t.then(data => this.render(data))\n\t\t.then(() => {\n\t\t\tthis.inProgress = false;\n\t\t\t$.fire(this.element, \"mavo:load\");\n\t\t});\n\t},\n\n\tstore: function() {\n\t\tif (!this.storage) {\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\tthis.inProgress = \"Saving\";\n\n\t\treturn this.storage.login()\n\t\t\t.then(() => this.storage.store(this.getData()))\n\t\t\t.catch(err => {\n\t\t\t\tif (err) {\n\t\t\t\t\tvar message = \"Problem saving data\";\n\n\t\t\t\t\tif (err instanceof XMLHttpRequest) {\n\t\t\t\t\t\tmessage += err.status? `: HTTP error ${err.status}: ${err.statusText}` : \": Can’t connect to the Internet\";\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.error(message, err);\n\t\t\t\t}\n\n\t\t\t\treturn null;\n\t\t\t})\n\t\t\t.then(saved => {\n\t\t\t\tthis.inProgress = false;\n\t\t\t\treturn saved;\n\t\t\t});\n\t},\n\n\tupload: function(file, path = \"images/\" + file.name) {\n\t\tif (!this.uploadBackend) {\n\t\t\treturn Promise.reject();\n\t\t}\n\n\t\tthis.inProgress = \"Uploading\";\n\n\t\treturn this.uploadBackend.upload(file, path)\n\t\t\t.then(url => {\n\t\t\t\tthis.inProgress = false;\n\t\t\t\treturn url;\n\t\t\t})\n\t\t\t.catch(err => {\n\t\t\t\tthis.error(\"Error uploading file\", err);\n\t\t\t\tthis.inProgress = false;\n\t\t\t\treturn null;\n\t\t\t});\n\t},\n\n\tsave: function() {\n\t\treturn this.store().then(saved => {\n\t\t\tif (saved) {\n\t\t\t\t$.fire(this.element, \"mavo:save\", saved);\n\n\t\t\t\tthis.lastSaved = Date.now();\n\t\t\t\tthis.root.save();\n\t\t\t\tthis.unsavedChanges = false;\n\t\t\t}\n\t\t});\n\t},\n\n\twalk: function(callback) {\n\t\treturn this.root.walk(callback);\n\t},\n\n\t/**\n\t * Executes a test on every node. If ANY node passes (test returns true),\n\t * the function returns true. Otherwise, it returns false.\n\t * Similar semantics to Array.prototype.some().\n\t */\n\tsome: function(test) {\n\t\treturn !this.walk((obj, path) => {\n\t\t\tvar ret = test(obj, path);\n\n\t\t\tif (ret === true) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t});\n\t},\n\n\tlive: {\n\t\tinProgress: function(value) {\n\t\t\t$.toggleAttribute(this.element, \"mv-progress\", value, value);\n\t\t},\n\n\t\tunsavedChanges: function(value) {\n\t\t\tthis.element.classList.toggle(\"mv-unsaved-changes\", value);\n\t\t},\n\n\t\tneedsEdit: function(value) {\n\t\t\tthis.bar.toggle(\"edit\", value);\n\t\t},\n\n\t\tstorage: function(value) {\n\t\t\tif (value !== this._storage && !value) {\n\t\t\t\tvar permissions = new Mavo.Permissions({edit: true, save: false});\n\t\t\t\tpermissions.parent = this.permissions.parent;\n\t\t\t\tthis.permissions.parent = permissions;\n\t\t\t}\n\t\t},\n\n\t\tprimaryBackend: function(value) {\n\t\t\tvalue = value || null;\n\n\t\t\tif (value != this._primaryBackend) {\n\t\t\t\tif (value)  {\n\t\t\t\t\tthis.element.style.setProperty(\"--mv-backend\", `\"${value.id}\"`);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthis.element.style.removeProperty(\"--mv-backend\");\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t}\n\t\t},\n\n\t\tuploadBackend: {\n\t\t\tget: function() {\n\t\t\t\tif (this.storage && this.storage.upload) {\n\t\t\t\t\t// Prioritize storage\n\t\t\t\t\treturn this.storage;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tstatic: {\n\t\tall: {},\n\n\t\tget length() {\n\t\t\treturn Object.keys(_.all).length;\n\t\t},\n\n\t\tget: function(id) {\n\t\t\tif (id instanceof Element) {\n\t\t\t\t// Get by element\n\t\t\t\tfor (var name in _.all) {\n\t\t\t\t\tif (_.all[name].element == id) {\n\t\t\t\t\t\treturn _.all[name];\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tvar name = typeof id === \"number\"? Object.keys(_.all)[id] : id;\n\n\t\t\treturn _.all[name] || null;\n\t\t},\n\n\t\tsuperKey: navigator.platform.indexOf(\"Mac\") === 0? \"metaKey\" : \"ctrlKey\",\n\t\tbase: location.protocol == \"about:\"? (document.currentScript? document.currentScript.src : \"http://mavo.io\") : location,\n\t\tdependencies: [],\n\n\t\tinit: function(container = document) {\n\t\t\treturn $$(_.selectors.init, container)\n\t\t\t\t.filter(element => !_.get(element)) // not already inited\n\t\t\t\t.map(element => new _(element));\n\t\t},\n\n\t\tUI: {},\n\n\t\thooks: new $.Hooks(),\n\n\t\tattributes: [\n\t\t\t\"mv-app\", \"mv-storage\", \"mv-source\", \"mv-init\", \"mv-path\", \"mv-format\",\n\t\t\t\"mv-attribute\", \"mv-default\", \"mv-mode\", \"mv-edit\", \"mv-permisssions\",\n\t\t\t\"mv-rel\"\n\t\t]\n\t}\n});\n\n{\n\nlet s = _.selectors = {\n\tinit: \".mv-app, [mv-app], [data-mv-app]\",\n\tproperty: \"[property], [itemprop]\",\n\tspecificProperty: name => `[property=${name}], [itemprop=${name}]`,\n\tgroup: \"[typeof], [itemscope], [itemtype], [mv-group]\",\n\tmultiple: \"[mv-multiple]\",\n\tformControl: \"input, select, option, textarea\",\n\tui: \".mv-ui\",\n\tcontainer: {\n\t\t// \"li\": \"ul, ol\",\n\t\t\"tr\": \"table\",\n\t\t\"option\": \"select\",\n\t\t// \"dt\": \"dl\",\n\t\t// \"dd\": \"dl\"\n\t}\n};\n\nlet arr = s.arr = selector => selector.split(/\\s*,\\s*/g);\nlet not = s.not = selector => arr(selector).map(s => `:not(${s})`).join(\"\");\nlet or = s.or = (selector1, selector2) => selector1 + \", \" + selector2;\nlet and = s.and = (selector1, selector2) => {\n\tvar ret = [], arr2 = arr(selector2);\n\n\tarr(selector1).forEach(s1 => ret.push(...arr2.map(s2 => s1 + s2)));\n\n\treturn ret.join(\", \");\n};\nlet andNot = s.andNot = (selector1, selector2) => and(selector1, not(selector2));\n\n$.extend(_.selectors, {\n\tprimitive: andNot(s.property, s.group),\n\trootGroup: andNot(s.group, s.property),\n\toutput: or(s.specificProperty(\"output\"), \".mv-output\")\n});\n\n}\n\n// Init mavo. Async to give other scripts a chance to modify stuff.\nrequestAnimationFrame(() => {\n\tvar isDecentBrowser = Array.from && window.Intl && document.documentElement.closest && self.URL && \"searchParams\" in URL.prototype;\n\n\t_.dependencies.push(\n\t\t$.ready(),\n\t\t_.Plugins.load(),\n\t\t$.include(isDecentBrowser, \"https://cdn.polyfill.io/v2/polyfill.min.js?features=blissfuljs,Intl.~locale.en\")\n\t);\n\n\t_.ready = _.all(_.dependencies);\n\t_.inited = _.ready.catch(console.error).then(() => Mavo.init());\n});\n\nStretchy.selectors.filter = \".mv-editor:not([property]), .mv-autosize\";\n\n})(Bliss, Bliss.$);\n"]}