{"version":3,"sources":["collection.js"],"names":["$","$$","Mavo","attributes","push","_","Collection","Class","extends","Node","nodeType","constructor","element","mavo","o","templateElement","children","fromTemplate","properties","selectors","property","map","getProperty","mutable","matches","multiple","accepts","getAttribute","split","cloneNode","item","createItem","add","itemTemplate","template","postInit","hooks","run","length","getData","env","context","options","data","deleted","null","itemData","unhandled","before","concat","after","create","collection","type","index","get","adopt","rel","marker","bottomUp","undefined","previousIndex","changed","splice","remove","silent","forEach","i","dataChanged","unsavedChanges","actions","action","isNaN","indexOf","sort","a","b","toArray","walk","obj","closestCollection","delete","copies","hard","destroy","transition","opacity","then","style","move","offset","editItem","itemControls","filter","el","closest","className","set","contents","tag","title","name","events","replace","newItem","evt","superKey","render","scrollIntoViewIfNeeded","click","target","focus","keydown","keyCode","stopPropagation","preventDefault","parentNode","revocably","Primitive","attribute","classList","appendChild","edit","super","call","addButton","tagName","toLowerCase","containerSelector","container","propagate","dragula","getDragula","done","clear","slice","save","propagated","dataRender","fragment","document","createDocumentFragment","j","find","items","collections","ret","flatten","isCompatible","c","live","value","_mutable","createComment","pushUnique","containers","me","isContainer","root","moves","handle","contains","source","next","previous","previousElementSibling","lastElementChild","on","oldIndex","nextElementSibling","closestItem","cancel","dragulas","lazy","order","test","compareDocumentPosition","DOCUMENT_POSITION_FOLLOWING","parent","selector","group","button","textContent","addEventListener","static","include","self","Bliss"],"mappings":";;;;AAAA,CAAC,UAASA,CAAT,EAAYC,EAAZ,EAAgB;;AAEjBC,MAAKC,UAAL,CAAgBC,IAAhB,CAAqB,aAArB,EAAoC,UAApC,EAAgD,YAAhD;;AAEA,KAAIC,IAAIH,KAAKI,UAAL,GAAkBN,EAAEO,KAAF,CAAQ;AACjCC,WAASN,KAAKO,IADmB;AAEjCC,YAAU,YAFuB;AAGjCC,eAAa,qBAAUC,OAAV,EAAmBC,IAAnB,EAAyBC,CAAzB,EAA4B;AACxC;;;AAGA,QAAKC,eAAL,GAAuB,KAAKH,OAA5B;;AAEA,QAAKI,QAAL,GAAgB,EAAhB;;AAEA;AACA,OAAI,CAAC,KAAKC,YAAL,CAAkB,YAAlB,EAAgC,SAAhC,EAA2C,iBAA3C,EAA8D,SAA9D,CAAL,EAA+E;AAC9E,SAAKC,UAAL,GAAkBjB,GAAGC,KAAKiB,SAAL,CAAeC,QAAlB,EAA4B,KAAKL,eAAjC,EAAkDM,GAAlD,CAAsDnB,KAAKO,IAAL,CAAUa,WAAhE,CAAlB;AACA,SAAKC,OAAL,GAAe,KAAKR,eAAL,CAAqBS,OAArB,CAA6BtB,KAAKiB,SAAL,CAAeM,QAA5C,CAAf;AACA,SAAKC,OAAL,GAAe,CAAC,KAAKX,eAAL,CAAqBY,YAArB,CAAkC,YAAlC,KAAmD,EAApD,EAAwDC,KAAxD,CAA8D,KAA9D,CAAf;;AAEA;AACA;AACA,SAAKb,eAAL,GAAuB,KAAKA,eAAL,CAAqBc,SAArB,CAA+B,IAA/B,CAAvB;AACA;;AAED,OAAI,KAAKN,OAAT,EAAkB;AACjB,QAAIO,OAAO,KAAKC,UAAL,CAAgB,KAAKnB,OAArB,CAAX;AACA,SAAKoB,GAAL,CAASF,IAAT;AACA,SAAKG,YAAL,GAAoBH,KAAKI,QAAL,IAAiBJ,IAArC;AACA;;AAED,QAAKK,QAAL;;AAEAjC,QAAKkC,KAAL,CAAWC,GAAX,CAAe,qBAAf,EAAsC,IAAtC;AACA,GA/BgC;;AAiCjC,MAAIC,MAAJ,GAAa;AACZ,UAAO,KAAKtB,QAAL,CAAcsB,MAArB;AACA,GAnCgC;;AAqCjCC,WAAS,mBAAiB;AAAA,OAARzB,CAAQ,uEAAJ,EAAI;;AACzB,OAAI0B,MAAM;AACTC,aAAS,IADA;AAETC,aAAS5B,CAFA;AAGT6B,UAAM;AAHG,IAAV;;AADyB;AAAA;AAAA;;AAAA;AAOzB,yBAAa,KAAK3B,QAAlB,8HAA4B;AAAvBc,SAAuB;;AAC3B,SAAI,CAACA,KAAKc,OAAN,IAAiB9B,EAAE+B,IAAvB,EAA6B;AAC5B,UAAIC,WAAWhB,KAAKS,OAAL,CAAaC,IAAIE,OAAjB,CAAf;;AAEA,UAAII,YAAYhC,EAAE+B,IAAlB,EAAwB;AACvBL,WAAIG,IAAJ,CAASvC,IAAT,CAAc0C,QAAd;AACA;AACD;AACD;AAfwB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAiBzB,OAAI,KAAKC,SAAT,EAAoB;AACnBP,QAAIG,IAAJ,GAAW,KAAKI,SAAL,CAAeC,MAAf,CAAsBC,MAAtB,CAA6BT,IAAIG,IAAjC,EAAuC,KAAKI,SAAL,CAAeG,KAAtD,CAAX;AACA;;AAED,OAAI,CAAC,KAAK3B,OAAN,IAAiBiB,IAAIG,IAAJ,CAASL,MAAT,IAAmB,CAAxC,EAA2C;AAC1C;AACAE,QAAIG,IAAJ,GAAWH,IAAIG,IAAJ,CAAS,CAAT,CAAX;AACA;;AAEDzC,QAAKkC,KAAL,CAAWC,GAAX,CAAe,kBAAf,EAAmCG,GAAnC;;AAEA,UAAOA,IAAIG,IAAX;AACA,GAlEgC;;AAoEjC;AACA;AACAZ,cAAY,oBAAUnB,OAAV,EAAmB;AAC9B,OAAI,CAACA,OAAL,EAAc;AACbA,cAAU,KAAKG,eAAL,CAAqBc,SAArB,CAA+B,IAA/B,CAAV;AACA;;AAED,OAAIC,OAAO5B,KAAKO,IAAL,CAAU0C,MAAV,CAAiBvC,OAAjB,EAA0B,KAAKC,IAA/B,EAAqC;AAC/CuC,gBAAY,IADmC;AAE/ClB,cAAU,KAAKD,YAAL,KAAsB,KAAKC,QAAL,GAAe,KAAKA,QAAL,CAAcD,YAA7B,GAA4C,IAAlE,CAFqC;AAG/Cb,cAAU,KAAKA,QAHgC;AAI/CiC,UAAM,KAAKA;AAJoC,IAArC,CAAX;;AAOA,UAAOvB,IAAP;AACA,GAnFgC;;AAqFjC;;;;;;AAMAE,OAAK,aAASF,IAAT,EAAewB,KAAf,EAA8B;AAAA,OAARxC,CAAQ,uEAAJ,EAAI;;AAClC,OAAIgB,gBAAgBrB,IAApB,EAA0B;AACzBqB,WAAO5B,KAAKO,IAAL,CAAU8C,GAAV,CAAczB,IAAd,KAAuB,KAAKC,UAAL,CAAgBD,IAAhB,CAA9B;AACA,IAFD,MAGK;AACJA,WAAOA,QAAQ,KAAKC,UAAL,EAAf;AACA;;AAED,OAAID,KAAKsB,UAAL,IAAmB,IAAvB,EAA6B;AAC5B,SAAKI,KAAL,CAAW1B,IAAX;AACA;;AAED,OAAI,KAAKP,OAAT,EAAkB;AACjB;AACA,QAAIkC,MAAM,KAAKzC,QAAL,CAAcsC,KAAd,IAAsB,KAAKtC,QAAL,CAAcsC,KAAd,EAAqB1C,OAA3C,GAAqD,KAAK8C,MAApE;AACA1D,MAAE,KAAK2D,QAAL,GAAe,OAAf,GAAyB,QAA3B,EAAqC7B,KAAKlB,OAA1C,EAAmD6C,GAAnD;;AAEA,QAAIH,UAAUM,SAAd,EAAyB;AACxBN,aAAQ,KAAKK,QAAL,GAAe,CAAf,GAAmB,KAAKrB,MAAhC;AACA;AACD,IARD,MASK;AACJgB,YAAQ,KAAKhB,MAAb;AACA;;AAED,OAAIE,MAAM,EAACC,SAAS,IAAV,EAAgBX,UAAhB,EAAV;;AAEAU,OAAIqB,aAAJ,GAAoB/B,KAAKwB,KAAzB;;AAEA;AACAd,OAAIsB,OAAJ,GAAc,KAAKC,MAAL,CAAY;AACzBC,YAAQxB,IAAIV;AADa,IAAZ,EAEX;AACFwB,WAAOA,KADL;AAEFtB,SAAKQ,IAAIV;AAFP,IAFW,CAAd;;AAOA,OAAI,CAAChB,EAAEmD,MAAP,EAAe;AACdzB,QAAIsB,OAAJ,CAAYI,OAAZ,CAAoB,aAAK;AACxBC,OAAEC,WAAF,CAAcD,KAAK3B,IAAIV,IAAT,IAAiBU,IAAIqB,aAAJ,KAAsBD,SAAvC,GAAkD,KAAlD,GAA0D,MAAxE;AACAO,OAAEE,cAAF,GAAmB,IAAnB;AACA,KAHD;;AAKA,SAAKA,cAAL,GAAsB,KAAKxD,IAAL,CAAUwD,cAAV,GAA2B,IAAjD;AACA;;AAEDnE,QAAKkC,KAAL,CAAWC,GAAX,CAAe,oBAAf,EAAqCG,GAArC;;AAEA,UAAOA,IAAIV,IAAX;AACA,GA5IgC;;AA8IjCiC,UAAQ,kBAAqB;AAAA,qCAATO,OAAS;AAATA,WAAS;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAC5B,0BAAmBA,OAAnB,mIAA4B;AAAA,SAAnBC,MAAmB;;AAC3B,SAAIA,OAAOjB,KAAP,KAAiBM,SAAjB,IAA8BW,OAAOP,MAArC,IAA+CQ,MAAMD,OAAOP,MAAb,CAAnD,EAAyE;AACxE;AACAO,aAAOjB,KAAP,GAAe,KAAKtC,QAAL,CAAcyD,OAAd,CAAsBF,OAAOP,MAA7B,CAAf;AACAO,aAAOP,MAAP,GAAgB,CAAhB;AACA;AACD;;AAED;AAT4B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAU5BM,WAAQI,IAAR,CAAa,UAACC,CAAD,EAAIC,CAAJ;AAAA,WAAUA,EAAEtB,KAAF,GAAUqB,EAAErB,KAAtB;AAAA,IAAb;;AAEA;AACA;AACA;AACA;AAf4B;AAAA;AAAA;;AAAA;AAgB5B,0BAAmBgB,OAAnB,mIAA4B;AAAA,SAAnBC,OAAmB;;AAC3B,SAAIA,QAAOjB,KAAP,GAAe,CAAC,CAAhB,KAAsBiB,QAAOP,MAAP,IAAiBO,QAAOvC,GAA9C,CAAJ,EAAwD;AAAA;;AACvDuC,cAAOP,MAAP,GAAgBO,QAAOP,MAAP,IAAiB,CAAjC;AACAO,cAAOvC,GAAP,GAAa9B,KAAK2E,OAAL,CAAaN,QAAOvC,GAApB,CAAb;;AAEA,wBAAKhB,QAAL,EAAc+C,MAAd,mBAAqBQ,QAAOjB,KAA5B,EAAmC,CAACiB,QAAOP,MAA3C,4BAAsDO,QAAOvC,GAA7D;AACA;AACD;AAvB2B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAyB5B,OAAI8B,UAAU,EAAd;;AAEA,QAAK,IAAIK,IAAI,CAAb,EAAgBA,IAAI,KAAK7B,MAAzB,EAAiC6B,GAAjC,EAAsC;AACrC,QAAIrC,QAAO,KAAKd,QAAL,CAAcmD,CAAd,CAAX;;AAEA,QAAIrC,SAAQA,MAAKwB,KAAL,KAAea,CAA3B,EAA8B;AAC7BrC,WAAKwB,KAAL,GAAaa,CAAb;AACAL,aAAQ1D,IAAR,CAAa0B,KAAb;AACA;AACD;;AAED,UAAOgC,OAAP;AACA,GAnLgC;;AAqLjCN,SAAO,eAAS1B,IAAT,EAAe;AAAA;;AACrB,OAAIA,KAAKsB,UAAT,EAAqB;AACpB;AACAtB,SAAKsB,UAAL,CAAgBW,MAAhB,CAAuB,EAACC,QAAQlC,IAAT,EAAvB;AACAA,SAAKsB,UAAL,CAAgBgB,WAAhB,CAA4B,QAA5B;AACA;;AAEA;AACD,QAAKU,IAAL,CAAU,eAAO;AAChB,QAAIC,IAAIC,iBAAJ,KAA0BlD,KAAKsB,UAAnC,EAA+C;AAC9C2B,SAAIC,iBAAJ;AACA;;AAED;AACA,QAAIlD,KAAKjB,IAAL,IAAa,MAAKA,IAAtB,EAA4B;AAC3BiB,UAAKjB,IAAL,GAAY,MAAKA,IAAjB;AACA;AACD,IATD;;AAWAiB,QAAKsB,UAAL,GAAkB,IAAlB;;AAEA;AACA,OAAItB,KAAKI,QAAT,EAAmB;AAClBhC,SAAK+E,MAAL,CAAYnD,KAAKI,QAAL,CAAcgD,MAA1B,EAAkCpD,IAAlC;;AAEAA,SAAKI,QAAL,GAAgB,KAAKD,YAArB;AACA;AACD,GAhNgC;;AAkNjCgD,UAAQ,iBAASnD,IAAT,EAAeqD,IAAf,EAAqB;AAAA;;AAC5B,OAAIA,IAAJ,EAAU;AACT;AACAnF,MAAEgE,MAAF,CAASlC,KAAKlB,OAAd;AACA,SAAKmD,MAAL,CAAY,EAACC,QAAQlC,IAAT,EAAZ;AACAA,SAAKsD,OAAL;AACA;AACA;;AAED,UAAOpF,EAAEqF,UAAF,CAAavD,KAAKlB,OAAlB,EAA2B,EAAC0E,SAAS,CAAV,EAA3B,EAAyCC,IAAzC,CAA8C,YAAM;AAC1DzD,SAAKc,OAAL,GAAe,IAAf,CAD0D,CACrC;AACrBd,SAAKlB,OAAL,CAAa4E,KAAb,CAAmBF,OAAnB,GAA6B,EAA7B;;AAEAxD,SAAKsC,WAAL,CAAiB,QAAjB;;AAEA,WAAKC,cAAL,GAAsBvC,KAAKuC,cAAL,GAAsB,OAAKxD,IAAL,CAAUwD,cAAV,GAA2B,IAAvE;AACA,IAPM,CAAP;AAQA,GAnOgC;;AAqOjC;;;;AAIAoB,QAAM,cAAS3D,IAAT,EAAe4D,MAAf,EAAuB;AAC5BpC,WAAQxB,KAAKwB,KAAL,GAAaoC,MAAb,IAAuBA,SAAS,CAAhC,CAAR;;AAEA,OAAIpC,QAAQ,CAAZ,EAAe;AACdA,YAAQ,KAAKtC,QAAL,CAAcsB,MAAtB;AACA,IAFD,MAGK,IAAIgB,QAAQ,KAAKtC,QAAL,CAAcsB,MAA1B,EAAkC;AACtCgB,YAAQ,CAAR;AACA;;AAED,QAAKtB,GAAL,CAASF,IAAT,EAAewB,KAAf;AACA,GApPgC;;AAsPjCqC,YAAU,kBAAS7D,IAAT,EAAe;AAAA;;AACxB,OAAI,CAACA,KAAK8D,YAAV,EAAwB;AACvB9D,SAAK8D,YAAL,GAAoB3F,GAAG,mBAAH,EAAwB6B,KAAKlB,OAA7B,EACXiF,MADW,CACJ,cAAM;AACb;AACA,YAAOC,GAAGC,OAAH,CAAW7F,KAAKiB,SAAL,CAAeM,QAA1B,KAAuCK,KAAKlB,OAA5C,IAAuD,CAACV,KAAKyC,IAAL,CAAUmD,EAAV,EAAc,MAAd,CAA/D;AACA,KAJW,EAIT,CAJS,CAApB;;AAMAhE,SAAK8D,YAAL,GAAoB9D,KAAK8D,YAAL,IAAqB5F,EAAEmD,MAAF,CAAS;AACjD6C,gBAAW;AADsC,KAAT,CAAzC;;AAIA9F,SAAKyC,IAAL,CAAUb,KAAK8D,YAAf,EAA6B,MAA7B,EAAqC9D,IAArC;;AAEA9B,MAAEiG,GAAF,CAAMnE,KAAK8D,YAAX,EAAyB;AACxBM,eAAU,CACT;AACCC,WAAK,QADN;AAECC,aAAO,iBAAiBtE,KAAKuE,IAF9B;AAGCL,iBAAW,WAHZ;AAICM,cAAQ;AACP,gBAAS;AAAA,eAAOxE,KAAKsB,UAAL,CAAgB6B,MAAhB,CAAuBnD,IAAvB,CAAP;AAAA;AADF;AAJT,MADS,EAQN;AACFqE,WAAK,QADH;AAEFC,0BAAkBtE,KAAKuE,IAAL,CAAUE,OAAV,CAAkB,KAAlB,EAAyB,EAAzB,CAAlB,UAAkD,KAAK5C,QAAL,GAAe,OAAf,GAAyB,QAA3E,CAFE;AAGFqC,iBAAW,QAHT;AAIFM,cAAQ;AACP,gBAAS,oBAAO;AACf,YAAIE,UAAU,OAAKxE,GAAL,CAAS,IAAT,EAAeF,KAAKwB,KAApB,CAAd;;AAEA,YAAImD,IAAIvG,KAAKwG,QAAT,CAAJ,EAAwB;AACvBF,iBAAQG,MAAR,CAAe7E,KAAKa,IAApB;AACA;;AAEDzC,aAAK0G,sBAAL,CAA4BJ,QAAQ5F,OAApC;;AAEA,eAAO,OAAK+E,QAAL,CAAca,OAAd,CAAP;AACA;AAXM;AAJN,MARM,EAyBN;AACFL,WAAK,QADH;AAEFC,aAAO,qBAAqBtE,KAAKuE,IAF/B;AAGFL,iBAAW,gBAHT;AAIFM,cAAQ;AACPO,cAAO;AAAA,eAAOJ,IAAIK,MAAJ,CAAWC,KAAX,EAAP;AAAA,QADA;AAEPC,gBAAS,sBAAO;AACf,YAAIP,IAAIQ,OAAJ,IAAe,EAAf,IAAqBR,IAAIQ,OAAJ,IAAe,EAAxC,EAA4C;AAC3C;AACA,gBAAKxB,IAAL,CAAU3D,IAAV,EAAgB2E,IAAIQ,OAAJ,IAAe,EAAf,GAAmB,CAAC,CAApB,GAAwB,CAAxC;;AAEAR,aAAIS,eAAJ;AACAT,aAAIU,cAAJ;AACAV,aAAIK,MAAJ,CAAWC,KAAX;AACA;AACD;AAXM;AAJN,MAzBM;AADc,KAAzB;AA8CA;;AAED,OAAI,CAACjF,KAAK8D,YAAL,CAAkBwB,UAAvB,EAAmC;AAClC,QAAI,CAAClH,KAAKmH,SAAL,CAAerF,GAAf,CAAmBF,KAAK8D,YAAxB,CAAL,EAA4C;AAC3C,SAAI9D,gBAAgB5B,KAAKoH,SAArB,IAAkC,CAACxF,KAAKyF,SAA5C,EAAuD;AACtDzF,WAAK8D,YAAL,CAAkB4B,SAAlB,CAA4BxF,GAA5B,CAAgC,aAAhC;AACAhC,QAAEkD,KAAF,CAAQpB,KAAK8D,YAAb,EAA2B9D,KAAKlB,OAAhC;AACA,MAHD,MAIK;AACJkB,WAAKlB,OAAL,CAAa6G,WAAb,CAAyB3F,KAAK8D,YAA9B;AACA;AACD;AACD;;AAED9D,QAAK4F,IAAL;AACA,GAjUgC;;AAmUjCA,QAAM,gBAAW;AAAA;;AAChB,OAAI,KAAKC,KAAL,CAAWD,IAAX,CAAgBE,IAAhB,CAAqB,IAArB,MAA+B,KAAnC,EAA0C;AACzC,WAAO,KAAP;AACA;;AAED,OAAI,KAAKrG,OAAT,EAAkB;AACjB;AACA,QAAI,CAAC,KAAKsG,SAAL,CAAeT,UAApB,EAAgC;AAC/B,SAAIjB,MAAM,KAAKvF,OAAL,CAAakH,OAAb,CAAqBC,WAArB,EAAV;AACA,SAAIC,oBAAoB9H,KAAKiB,SAAL,CAAe8G,SAAf,CAAyB9B,GAAzB,CAAxB;AACA,SAAI1C,MAAMuE,oBAAmB,KAAKtE,MAAL,CAAY0D,UAAZ,CAAuBrB,OAAvB,CAA+BiC,iBAA/B,CAAnB,GAAuE,KAAKtE,MAAtF;AACA1D,OAAE,KAAK2D,QAAL,GAAe,QAAf,GAA0B,OAA5B,EAAqC,KAAKkE,SAA1C,EAAqDpE,GAArD;AACA;;AAED;AACA,SAAKyE,SAAL,CAAe,gBAAQ;AACtB,YAAKvC,QAAL,CAAc7D,IAAd;AACA,KAFD;;AAIA;AACAzB,MAAE8H,OAAF,CAAU5C,IAAV,CAAe,YAAM;AACpB,YAAK6C,UAAL;AACA,KAFD;AAGA;AACD,GA3VgC;;AA6VjCC,QAAM,gBAAW;AAChB,OAAI,KAAKV,KAAL,CAAWU,IAAX,CAAgBT,IAAhB,CAAqB,IAArB,MAA+B,KAAnC,EAA0C;AACzC,WAAO,KAAP;AACA;;AAED,OAAI,KAAKrG,OAAT,EAAkB;AACjB,QAAI,KAAKsG,SAAL,CAAeT,UAAnB,EAA+B;AAC9B,UAAKS,SAAL,CAAe7D,MAAf;AACA;;AAED,SAAKkE,SAAL,CAAe;AAAA,YAAQhI,KAAKmH,SAAL,CAAerD,MAAf,CAAsBlC,KAAK8D,YAA3B,CAAR;AAAA,KAAf;AACA;AACD,GAzWgC;;AA2WjC;;;AAGA0C,SAAO,iBAAW;AACjB,OAAI,KAAK/G,OAAT,EAAkB;AACjB,SAAK,IAAI4C,IAAI,CAAR,EAAWrC,IAAhB,EAAsBA,OAAO,KAAKd,QAAL,CAAcmD,CAAd,CAA7B,EAA+CA,GAA/C,EAAoD;AACnDrC,UAAKlB,OAAL,CAAaoD,MAAb;AACAlC,UAAKsD,OAAL;AACA;;AAED,SAAKpE,QAAL,GAAgB,KAAKA,QAAL,CAAcuH,KAAd,CAAoB,CAApB,EAAuB,CAAvB,CAAhB;;AAEA,SAAKnE,WAAL,CAAiB,OAAjB;AACA;;AAED,QAAK8D,SAAL,CAAe,OAAf;AACA,GA3XgC;;AA6XjC9D,eAAa,qBAASG,MAAT,EAAyB;AAAA,OAARzD,CAAQ,uEAAJ,EAAI;;AACrCA,KAAEF,OAAF,GAAYE,EAAEF,OAAF,IAAa,KAAK8C,MAA9B;AACA,UAAO,KAAKiE,KAAL,CAAWvD,WAAX,CAAuBwD,IAAvB,CAA4B,IAA5B,EAAkCrD,MAAlC,EAA0CzD,CAA1C,CAAP;AACA,GAhYgC;;AAkYjC0H,QAAM,gBAAW;AAAA;AAAA;AAAA;;AAAA;AAChB,0BAAiB,KAAKxH,QAAtB,mIAAgC;AAAA,SAAvBc,MAAuB;;AAC/B,SAAIA,OAAKc,OAAT,EAAkB;AACjB,WAAKqC,MAAL,CAAYnD,MAAZ,EAAkB,IAAlB;AACA,MAFD,MAGK;AACJA,aAAKuC,cAAL,GAAsB,KAAtB;AACA;AACD;AARe;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAShB,GA3YgC;;AA6YjCoE,cAAY,CAAC,MAAD,CA7YqB;;AA+YjCC,cAAY,oBAAS/F,IAAT,EAAe;AAC1B,QAAKI,SAAL,GAAiB,EAACC,QAAQ,EAAT,EAAaE,OAAO,EAApB,EAAjB;;AAEA,OAAI,CAACP,IAAL,EAAW;AACV;AACA;;AAEDA,UAAOzC,KAAK2E,OAAL,CAAalC,IAAb,CAAP;;AAEA,OAAI,CAAC,KAAKpB,OAAV,EAAmB;AAClB,SAAKP,QAAL,CAAckD,OAAd,CAAsB,UAACpC,IAAD,EAAOqC,CAAP;AAAA,YAAarC,KAAK6E,MAAL,CAAYhE,QAAQA,KAAKwB,CAAL,CAApB,CAAb;AAAA,KAAtB;;AAEA,QAAIxB,IAAJ,EAAU;AACT,UAAKI,SAAL,CAAeG,KAAf,GAAuBP,KAAK4F,KAAL,CAAW,KAAKjG,MAAhB,CAAvB;AACA;AACD,IAND,MAOK;AACJ;AACA,SAAK,IAAI6B,IAAI,CAAb,EAAgBA,IAAI,KAAKnD,QAAL,CAAcsB,MAAlC,EAA0C6B,GAA1C,EAA+C;AAC9C,SAAIA,IAAIxB,KAAKL,MAAb,EAAqB;AACpB,WAAKtB,QAAL,CAAcmD,CAAd,EAAiBwC,MAAjB,CAAwBhE,KAAKwB,CAAL,CAAxB;AACA,MAFD,MAGK;AACJ,WAAKc,MAAL,CAAY,KAAKjE,QAAL,CAAcmD,CAAd,CAAZ,EAA8B,IAA9B;AACA;AACD;;AAED,QAAIxB,KAAKL,MAAL,GAAc6B,CAAlB,EAAqB;AACpB;AACA;AACA,SAAIwE,WAAWC,SAASC,sBAAT,EAAf;;AAEA,UAAK,IAAIC,IAAI3E,CAAb,EAAgB2E,IAAInG,KAAKL,MAAzB,EAAiCwG,GAAjC,EAAsC;AACrC,UAAIhH,OAAO,KAAKC,UAAL,EAAX;;AAEAD,WAAK6E,MAAL,CAAYhE,KAAKmG,CAAL,CAAZ;;AAEA,WAAK9H,QAAL,CAAcZ,IAAd,CAAmB0B,IAAnB;AACAA,WAAKwB,KAAL,GAAawF,CAAb;;AAEAH,eAASlB,WAAT,CAAqB3F,KAAKlB,OAA1B;;AAEA,UAAI4B,MAAM,EAACC,SAAS,IAAV,EAAgBX,UAAhB,EAAV;AACA5B,WAAKkC,KAAL,CAAWC,GAAX,CAAe,oBAAf,EAAqCG,GAArC;AACA;;AAED,SAAI,KAAKmB,QAAT,EAAmB;AAClB3D,QAAEkD,KAAF,CAAQyF,QAAR,EAAkBxE,IAAI,CAAJ,GAAO,KAAKnD,QAAL,CAAcmD,IAAE,CAAhB,EAAmBvD,OAA1B,GAAoC,KAAK8C,MAA3D;AACA,MAFD,MAGK;AACJ1D,QAAEgD,MAAF,CAAS2F,QAAT,EAAmB,KAAKjF,MAAxB;AACA;AACD;AACD;AACD,GArcgC;;AAucjCqF,QAAM,cAAS3H,QAAT,EAA2B;AAAA,OAARN,CAAQ,uEAAJ,EAAI;;AAChC,OAAIkI,QAAQ,KAAKhI,QAAL,CAAc6E,MAAd,CAAqB;AAAA,WAAQ,CAAC/D,KAAKc,OAAd;AAAA,IAArB,CAAZ;;AAEA,OAAI,KAAKxB,QAAL,IAAiBA,QAArB,EAA+B;AAC9B,WAAON,EAAEmI,WAAF,GAAe,IAAf,GAAsBD,KAA7B;AACA;;AAED,OAAI,KAAK9H,UAAL,CAAgBuD,OAAhB,CAAwBrD,QAAxB,IAAoC,CAAC,CAAzC,EAA4C;AAC3C,QAAI8H,MAAMF,MAAM3H,GAAN,CAAU;AAAA,YAAQS,KAAKiH,IAAL,CAAU3H,QAAV,EAAoBN,CAApB,CAAR;AAAA,KAAV,CAAV;;AAEA,WAAOZ,KAAKiJ,OAAL,CAAaD,GAAb,CAAP;AACA;AACD,GAndgC;;AAqdjCE,gBAAc,sBAASC,CAAT,EAAY;AACzB,UAAOA,KAAK,KAAKpH,YAAL,CAAkBvB,QAAlB,IAA8B2I,EAAEpH,YAAF,CAAevB,QAAlD,KAA+D2I,MAAM,IAAN,IAC5DA,EAAEnH,QAAF,IAAc,IAD8C,IACtC,KAAKA,QAAL,IAAiBmH,CADqB,IAChB,KAAKnH,QAAL,IAAiB,KAAKA,QAAL,IAAiBmH,EAAEnH,QADpB,IAE5D,KAAKR,OAAL,CAAa+C,OAAb,CAAqB4E,EAAEjI,QAAvB,IAAmC,CAAC,CAFvC,CAAP;AAGA,GAzdgC;;AA2djCkI,QAAM;AACL/H,YAAS,iBAASgI,KAAT,EAAgB;AACxB,QAAIA,SAASA,UAAU,KAAKhI,OAA5B,EAAqC;AACpC;AACA;AACA;AACA,UAAKiI,QAAL,GAAgBD,KAAhB;;AAEA;AACA,UAAK7F,MAAL,GAAckF,SAASa,aAAT,CAAuB,WAAvB,CAAd;AACAvJ,UAAKyC,IAAL,CAAU,KAAKe,MAAf,EAAuB,YAAvB,EAAqC,IAArC;AACA1D,OAAEkD,KAAF,CAAQ,KAAKQ,MAAb,EAAqB,KAAK3C,eAA1B;AACA;AACD;AAbI,GA3d2B;;AA2ejC;AACAqH,cAAY,sBAAW;AAAA;;AACtB,OAAI,KAAKD,OAAT,EAAkB;AACjB,WAAO,KAAKA,OAAZ;AACA;;AAED,OAAI,KAAKjG,QAAT,EAAmB;AAClBhC,SAAKwJ,UAAL,CAAgB,KAAKxH,QAAL,CAAckG,UAAd,GAA2BuB,UAA3C,EAAuD,KAAKjG,MAAL,CAAY0D,UAAnE;AACA,WAAO,KAAKe,OAAL,GAAe,KAAKjG,QAAL,CAAciG,OAAd,IAAyB,KAAKjG,QAAL,CAAckG,UAAd,EAA/C;AACA;;AAED,OAAIwB,KAAK,IAAT;AACA,QAAKzB,OAAL,GAAeA,QAAQ;AACtBwB,gBAAY,CAAC,KAAKjG,MAAL,CAAY0D,UAAb,CADU;AAEtByC,iBAAa,yBAAM;AAClB,SAAI,OAAKnI,OAAL,CAAaY,MAAjB,EAAyB;AACxB,aAAOpC,KAAKiJ,OAAL,CAAa,OAAKzH,OAAL,CAAaL,GAAb,CAAiB;AAAA,cAAY,OAAKR,IAAL,CAAUiJ,IAAV,CAAef,IAAf,CAAoB3H,QAApB,EAA8B,EAAC6H,aAAa,IAAd,EAA9B,CAAZ;AAAA,OAAjB,CAAb,EACHpD,MADG,CACI;AAAA,cAAKwD,KAAKA,aAAahJ,CAAvB;AAAA,OADJ,EAEHgB,GAFG,CAEC;AAAA,cAAKgI,EAAE3F,MAAF,CAAS0D,UAAd;AAAA,OAFD,EAGH3C,OAHG,CAGKqB,EAHL,IAGW,CAAC,CAHnB;AAIA;;AAED,YAAO,KAAP;AACA,KAXqB;AAYtBiE,WAAO,eAACjE,EAAD,EAAKmC,SAAL,EAAgB+B,MAAhB,EAA2B;AACjC,YAAOA,OAAOxC,SAAP,CAAiByC,QAAjB,CAA0B,gBAA1B,KAA+CD,OAAOjE,OAAP,CAAe7F,KAAKiB,SAAL,CAAeM,QAA9B,KAA2CqE,EAAjG;AACA,KAdqB;AAetBpE,aAAS,iBAASoE,EAAT,EAAagB,MAAb,EAAqBoD,MAArB,EAA6BC,IAA7B,EAAmC;AAC3C,SAAIrE,GAAGmE,QAAH,CAAYnD,MAAZ,CAAJ,EAAyB;AACxB,aAAO,KAAP;AACA;;AAED,SAAIsD,WAAWD,OAAMA,KAAKE,sBAAX,GAAoCvD,OAAOwD,gBAA1D;;AAEA,SAAIlH,aAAa/C,EAAEkD,GAAF,CAAM6G,QAAN,KAAmB/J,EAAEkD,GAAF,CAAM4G,IAAN,CAApC;;AAEA,SAAI,CAAC/G,UAAL,EAAiB;AAChB,aAAO,KAAP;AACA;;AAED,SAAItB,OAAO5B,KAAKO,IAAL,CAAU8C,GAAV,CAAcuC,EAAd,CAAX;;AAEA,YAAOhE,QAAQA,KAAKsB,UAAL,CAAgBgG,YAAhB,CAA6BhG,UAA7B,CAAf;AACA;AA/BqB,IAAR,CAAf;;AAkCA,QAAK+E,OAAL,CAAaoC,EAAb,CAAgB,MAAhB,EAAwB,UAACzE,EAAD,EAAKgB,MAAL,EAAaoD,MAAb,EAAwB;AAC/C,QAAIpI,OAAO5B,KAAKO,IAAL,CAAU8C,GAAV,CAAcuC,EAAd,CAAX;AACA,QAAI0E,WAAW1I,QAAQA,KAAKwB,KAA5B;AACA,QAAI6G,OAAOrE,GAAG2E,kBAAd;AACA,QAAIL,WAAWtE,GAAGuE,sBAAlB;AACA,QAAIjH,aAAa/C,EAAEkD,GAAF,CAAM6G,QAAN,KAAmB/J,EAAEkD,GAAF,CAAM4G,IAAN,CAApC;AACA,QAAIO,cAAcxK,KAAKO,IAAL,CAAU8C,GAAV,CAAc6G,QAAd,KAA2BlK,KAAKO,IAAL,CAAU8C,GAAV,CAAc4G,IAAd,CAA7C;;AAEA,QAAIO,eAAeA,YAAYtH,UAAZ,IAA0BA,UAA7C,EAAyD;AACxDsH,mBAAc,IAAd;AACA;;AAED,QAAI5I,KAAKsB,UAAL,CAAgBgG,YAAhB,CAA6BhG,UAA7B,CAAJ,EAA8C;AAC7C,SAAIE,QAAQoH,cAAaA,YAAYpH,KAAZ,IAAqBoH,YAAY9J,OAAZ,KAAwBwJ,QAA7C,CAAb,GAAsEhH,WAAWd,MAA7F;AACAc,gBAAWpB,GAAX,CAAeF,IAAf,EAAqBwB,KAArB;AACA,KAHD,MAIK;AACJ,YAAO,OAAK6E,OAAL,CAAawC,MAAb,CAAoB,IAApB,CAAP;AACA;AACD,IAnBD;;AAqBAtK,KAAEuK,QAAF,CAAWxK,IAAX,CAAgB,KAAK+H,OAArB;;AAEA,UAAO,KAAKA,OAAZ;AACA,GAjjBgC;;AAmjBjC0C,QAAM;AACLlH,aAAU,oBAAW;AACpB;;;;AAIA,QAAI,CAAC,KAAKpC,OAAV,EAAmB;AAClB,YAAO,KAAP;AACA;;AAED,QAAIuJ,QAAQ,KAAK/J,eAAL,CAAqBY,YAArB,CAAkC,UAAlC,CAAZ;AACA,QAAImJ,UAAU,IAAd,EAAoB;AACnB;AACA,YAAO,YAAWC,IAAX,CAAgBD,KAAhB;AAAP;AACA;;AAED,QAAI,CAAC,KAAKjD,SAAL,CAAeT,UAApB,EAAgC;AAC/B;AACA,YAAO,KAAP;AACA;;AAED;AACA,WAAO,CAAC,EAAE,KAAKS,SAAL,CAAemD,uBAAf,CAAuC,KAAKtH,MAA5C,IAAsDjD,KAAKwK,2BAA7D,CAAR;AACA,IAvBI;;AAyBLjG,sBAAmB,6BAAW;AAC7B,QAAIkG,SAAS,KAAKxH,MAAL,GAAa,KAAKA,MAAL,CAAY0D,UAAzB,GAAsC,KAAKrG,eAAL,CAAqBqG,UAAxE;;AAEA,WAAO8D,OAAOnF,OAAP,CAAe7F,KAAKiB,SAAL,CAAeM,QAA9B,CAAP;AACA,IA7BI;;AA+BLoG,cAAW,qBAAW;AAAA;;AACrB;AACA,QAAIsD,8BAA4B,KAAK/J,QAArC;AACA,QAAIgK,QAAQ,KAAKpG,iBAAL,IAA0B,KAAKtB,MAAL,CAAY0D,UAAZ,CAAuBrB,OAAvB,CAA+B7F,KAAKiB,SAAL,CAAeiK,KAA9C,CAAtC;;AAEA,QAAIA,KAAJ,EAAW;AACV,SAAIC,SAASpL,GAAGkL,QAAH,EAAaC,KAAb,EAAoBvF,MAApB,CAA2B,kBAAU;AACjD,aAAO,CAAC,OAAK9E,eAAL,CAAqBkJ,QAArB,CAA8BoB,MAA9B,CAAR;AACA,MAFY,EAEV,CAFU,CAAb;AAGA;;AAED,QAAI,CAACA,MAAL,EAAa;AACZA,cAASrL,EAAEmD,MAAF,CAAS,QAAT,EAAmB;AAC3B6C,iBAAW,QADgB;AAE3BsF,mBAAa,SAAS,KAAKjF;AAFA,MAAnB,CAAT;AAIA;;AAEDgF,WAAO7D,SAAP,CAAiBxF,GAAjB,CAAqB,OAArB,EAA8B,QAA9B;AACA9B,SAAKyC,IAAL,CAAU0I,MAAV,EAAkB,YAAlB,EAAgC,IAAhC;;AAEA,QAAI,KAAKjK,QAAT,EAAmB;AAClBiK,YAAO7D,SAAP,CAAiBxF,GAAjB,aAA+B,KAAKZ,QAApC;AACA;;AAEDiK,WAAOE,gBAAP,CAAwB,OAAxB,EAAiC,eAAO;AACvC9E,SAAIU,cAAJ;;AAEA,YAAKxB,QAAL,CAAc,OAAK3D,GAAL,EAAd;AACA,KAJD;;AAMA,WAAOqJ,MAAP;AACA;AA/DI,GAnjB2B;;AAqnBjCG,UAAQ;AACPZ,aAAU,EADH;AAEPrH,QAAK,sBAAW;AACf;AACA,QAAIH,aAAalD,KAAKyC,IAAL,CAAU/B,OAAV,EAAmB,YAAnB,CAAjB;;AAEA,QAAIwC,UAAJ,EAAgB;AACf,YAAOA,UAAP;AACA;;AAED;AACA,QAAItB,OAAO5B,KAAKO,IAAL,CAAU8C,GAAV,CAAc3C,OAAd,CAAX;;AAEA,WAAOkB,QAAQA,KAAKsB,UAAb,IAA2B,IAAlC;AACA,IAdM;;AAgBPyH,SAAM;AACL1C,aAAS;AAAA,YAAMnI,EAAEyL,OAAF,CAAUC,KAAKvD,OAAf,EAAwB,qEAAxB,CAAN;AAAA;AADJ;AAhBC;AArnByB,EAAR,CAA1B;AA2oBC,CA/oBD,EA+oBGwD,KA/oBH,EA+oBUA,MAAM3L,CA/oBhB","file":"../mavo.es5.js","sourcesContent":["(function($, $$) {\n\nMavo.attributes.push(\"mv-multiple\", \"mv-order\", \"mv-accepts\");\n\nvar _ = Mavo.Collection = $.Class({\n\textends: Mavo.Node,\n\tnodeType: \"Collection\",\n\tconstructor: function (element, mavo, o) {\n\t\t/*\n\t\t * Create the template, remove it from the DOM and store it\n\t\t */\n\t\tthis.templateElement = this.element;\n\n\t\tthis.children = [];\n\n\t\t// ALL descendant property names as an array\n\t\tif (!this.fromTemplate(\"properties\", \"mutable\", \"templateElement\", \"accepts\")) {\n\t\t\tthis.properties = $$(Mavo.selectors.property, this.templateElement).map(Mavo.Node.getProperty);\n\t\t\tthis.mutable = this.templateElement.matches(Mavo.selectors.multiple);\n\t\t\tthis.accepts = (this.templateElement.getAttribute(\"mv-accepts\") || \"\").split(/\\s+/);\n\n\t\t\t// Must clone because otherwise once expressions are parsed on the template element\n\t\t\t// we will not be able to pick them up from subsequent items\n\t\t\tthis.templateElement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\tvar item = this.createItem(this.element);\n\t\t\tthis.add(item);\n\t\t\tthis.itemTemplate = item.template || item;\n\t\t}\n\n\t\tthis.postInit();\n\n\t\tMavo.hooks.run(\"collection-init-end\", this);\n\t},\n\n\tget length() {\n\t\treturn this.children.length;\n\t},\n\n\tgetData: function(o = {}) {\n\t\tvar env = {\n\t\t\tcontext: this,\n\t\t\toptions: o,\n\t\t\tdata: []\n\t\t};\n\n\t\tfor (item of this.children) {\n\t\t\tif (!item.deleted || o.null) {\n\t\t\t\tlet itemData = item.getData(env.options);\n\n\t\t\t\tif (itemData || o.null) {\n\t\t\t\t\tenv.data.push(itemData);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (this.unhandled) {\n\t\t\tenv.data = this.unhandled.before.concat(env.data, this.unhandled.after);\n\t\t}\n\n\t\tif (!this.mutable && env.data.length == 1) {\n\t\t\t// See https://github.com/LeaVerou/mavo/issues/50#issuecomment-266079652\n\t\t\tenv.data = env.data[0];\n\t\t}\n\n\t\tMavo.hooks.run(\"node-getdata-end\", env);\n\n\t\treturn env.data;\n\t},\n\n\t// Create item but don't insert it anywhere\n\t// Mostly used internally\n\tcreateItem: function (element) {\n\t\tif (!element) {\n\t\t\telement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tvar item = Mavo.Node.create(element, this.mavo, {\n\t\t\tcollection: this,\n\t\t\ttemplate: this.itemTemplate || (this.template? this.template.itemTemplate : null),\n\t\t\tproperty: this.property,\n\t\t\ttype: this.type\n\t\t});\n\n\t\treturn item;\n\t},\n\n\t/**\n\t * Add a new item to this collection\n\t * @param item {Node|Mavo.Node} Optional. Element or Mavo object for the new item\n\t * @param index {Number} Optional. Index of existing item, will be added opposite to list direction\n\t * @param silent {Boolean} Optional. Throw a datachange event? Mainly used internally.\n\t */\n\tadd: function(item, index, o = {}) {\n\t\tif (item instanceof Node) {\n\t\t\titem = Mavo.Node.get(item) || this.createItem(item);\n\t\t}\n\t\telse {\n\t\t\titem = item || this.createItem();\n\t\t}\n\n\t\tif (item.collection != this) {\n\t\t\tthis.adopt(item);\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\t// Add it to the DOM, or fix its place\n\t\t\tvar rel = this.children[index]? this.children[index].element : this.marker;\n\t\t\t$[this.bottomUp? \"after\" : \"before\"](item.element, rel);\n\n\t\t\tif (index === undefined) {\n\t\t\t\tindex = this.bottomUp? 0 : this.length;\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tindex = this.length;\n\t\t}\n\n\t\tvar env = {context: this, item};\n\n\t\tenv.previousIndex = item.index;\n\n\t\t// Update internal data model\n\t\tenv.changed = this.splice({\n\t\t\tremove: env.item\n\t\t}, {\n\t\t\tindex: index,\n\t\t\tadd: env.item\n\t\t});\n\n\t\tif (!o.silent) {\n\t\t\tenv.changed.forEach(i => {\n\t\t\t\ti.dataChanged(i == env.item && env.previousIndex === undefined? \"add\" : \"move\");\n\t\t\t\ti.unsavedChanges = true;\n\t\t\t});\n\n\t\t\tthis.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t}\n\n\t\tMavo.hooks.run(\"collection-add-end\", env);\n\n\t\treturn env.item;\n\t},\n\n\tsplice: function(...actions) {\n\t\tfor (let action of actions) {\n\t\t\tif (action.index === undefined && action.remove && isNaN(action.remove)) {\n\t\t\t\t// Remove is an item\n\t\t\t\taction.index = this.children.indexOf(action.remove);\n\t\t\t\taction.remove = 1;\n\t\t\t}\n\t\t}\n\n\t\t// Sort in reverse index order\n\t\tactions.sort((a, b) => b.index - a.index);\n\n\t\t// FIXME this could still result in buggy behavior.\n\t\t// Think of e.g. adding items on i, then removing > 1 items on i-1.\n\t\t// The new items would get removed instead of the old ones.\n\t\t// Not a pressing issue though since we always remove 1 max when adding things too.\n\t\tfor (let action of actions) {\n\t\t\tif (action.index > -1 && (action.remove || action.add)) {\n\t\t\t\taction.remove = action.remove || 0;\n\t\t\t\taction.add = Mavo.toArray(action.add);\n\n\t\t\t\tthis.children.splice(action.index, +action.remove, ...action.add);\n\t\t\t}\n\t\t}\n\n\t\tvar changed = [];\n\n\t\tfor (let i = 0; i < this.length; i++) {\n\t\t\tlet item = this.children[i];\n\n\t\t\tif (item && item.index !== i) {\n\t\t\t\titem.index = i;\n\t\t\t\tchanged.push(item);\n\t\t\t}\n\t\t}\n\n\t\treturn changed;\n\t},\n\n\tadopt: function(item) {\n\t\tif (item.collection) {\n\t\t\t// It belongs to another collection, delete from there first\n\t\t\titem.collection.splice({remove: item});\n\t\t\titem.collection.dataChanged(\"delete\");\n\t\t}\n\n\t\t // Update collection & closestCollection properties\n\t\tthis.walk(obj => {\n\t\t\tif (obj.closestCollection === item.collection) {\n\t\t\t\tobj.closestCollection = this;\n\t\t\t}\n\n\t\t\t// Belongs to another Mavo?\n\t\t\tif (item.mavo != this.mavo) {\n\t\t\t\titem.mavo = this.mavo;\n\t\t\t}\n\t\t});\n\n\t\titem.collection = this;\n\n\t\t// Adjust templates and their copies\n\t\tif (item.template) {\n\t\t\tMavo.delete(item.template.copies, item);\n\n\t\t\titem.template = this.itemTemplate;\n\t\t}\n\t},\n\n\tdelete: function(item, hard) {\n\t\tif (hard) {\n\t\t\t// Hard delete\n\t\t\t$.remove(item.element);\n\t\t\tthis.splice({remove: item});\n\t\t\titem.destroy();\n\t\t\treturn;\n\t\t}\n\n\t\treturn $.transition(item.element, {opacity: 0}).then(() => {\n\t\t\titem.deleted = true; // schedule for deletion\n\t\t\titem.element.style.opacity = \"\";\n\n\t\t\titem.dataChanged(\"delete\");\n\n\t\t\tthis.unsavedChanges = item.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t});\n\t},\n\n\t/**\n\t * Move existing item to a new position. Wraps around if position is out of bounds.\n\t * @offset relative position\n\t */\n\tmove: function(item, offset) {\n\t\tindex = item.index + offset + (offset > 0);\n\n\t\tif (index < 0) {\n\t\t\tindex = this.children.length;\n\t\t}\n\t\telse if (index > this.children.length) {\n\t\t\tindex = 0;\n\t\t}\n\n\t\tthis.add(item, index);\n\t},\n\n\teditItem: function(item) {\n\t\tif (!item.itemControls) {\n\t\t\titem.itemControls = $$(\".mv-item-controls\", item.element)\n\t\t\t\t\t\t\t\t   .filter(el => {\n\t\t\t\t\t\t\t\t\t   // Remove item controls meant for other collections\n\t\t\t\t\t\t\t\t\t   return el.closest(Mavo.selectors.multiple) == item.element && !Mavo.data(el, \"item\");\n\t\t\t\t\t\t\t\t   })[0];\n\n\t\t\titem.itemControls = item.itemControls || $.create({\n\t\t\t\tclassName: \"mv-item-controls mv-ui\"\n\t\t\t});\n\n\t\t\tMavo.data(item.itemControls, \"item\", item);\n\n\t\t\t$.set(item.itemControls, {\n\t\t\t\tcontents: [\n\t\t\t\t\t{\n\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\ttitle: \"Delete this \" + item.name,\n\t\t\t\t\t\tclassName: \"mv-delete\",\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\"click\": evt => item.collection.delete(item)\n\t\t\t\t\t\t}\n\t\t\t\t\t}, {\n\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\ttitle: `Add new ${item.name.replace(/s$/i, \"\")} ${this.bottomUp? \"after\" : \"before\"}`,\n\t\t\t\t\t\tclassName: \"mv-add\",\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\"click\": evt => {\n\t\t\t\t\t\t\t\tvar newItem = this.add(null, item.index);\n\n\t\t\t\t\t\t\t\tif (evt[Mavo.superKey]) {\n\t\t\t\t\t\t\t\t\tnewItem.render(item.data);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tMavo.scrollIntoViewIfNeeded(newItem.element);\n\n\t\t\t\t\t\t\t\treturn this.editItem(newItem);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}, {\n\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\ttitle: \"Drag to reorder \" + item.name,\n\t\t\t\t\t\tclassName: \"mv-drag-handle\",\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\tclick: evt => evt.target.focus(),\n\t\t\t\t\t\t\tkeydown: evt => {\n\t\t\t\t\t\t\t\tif (evt.keyCode >= 37 && evt.keyCode <= 40) {\n\t\t\t\t\t\t\t\t\t// Arrow keys\n\t\t\t\t\t\t\t\t\tthis.move(item, evt.keyCode <= 38? -1 : 1);\n\n\t\t\t\t\t\t\t\t\tevt.stopPropagation();\n\t\t\t\t\t\t\t\t\tevt.preventDefault();\n\t\t\t\t\t\t\t\t\tevt.target.focus();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t]\n\t\t\t});\n\t\t}\n\n\t\tif (!item.itemControls.parentNode) {\n\t\t\tif (!Mavo.revocably.add(item.itemControls)) {\n\t\t\t\tif (item instanceof Mavo.Primitive && !item.attribute) {\n\t\t\t\t\titem.itemControls.classList.add(\"mv-adjacent\");\n\t\t\t\t\t$.after(item.itemControls, item.element);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\titem.element.appendChild(item.itemControls);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\titem.edit();\n\t},\n\n\tedit: function() {\n\t\tif (this.super.edit.call(this) === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\t// Insert the add button if it's not already in the DOM\n\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\tvar tag = this.element.tagName.toLowerCase();\n\t\t\t\tvar containerSelector = Mavo.selectors.container[tag];\n\t\t\t\tvar rel = containerSelector? this.marker.parentNode.closest(containerSelector) : this.marker;\n\t\t\t\t$[this.bottomUp? \"before\" : \"after\"](this.addButton, rel);\n\t\t\t}\n\n\t\t\t// Insert item controls\n\t\t\tthis.propagate(item => {\n\t\t\t\tthis.editItem(item);\n\t\t\t});\n\n\t\t\t// Set up drag & drop\n\t\t\t_.dragula.then(() => {\n\t\t\t\tthis.getDragula();\n\t\t\t});\n\t\t}\n\t},\n\n\tdone: function() {\n\t\tif (this.super.done.call(this) === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\tif (this.addButton.parentNode) {\n\t\t\t\tthis.addButton.remove();\n\t\t\t}\n\n\t\t\tthis.propagate(item => Mavo.revocably.remove(item.itemControls));\n\t\t}\n\t},\n\n\t/**\n\t * Delete all items in the collection. Not undoable.\n\t */\n\tclear: function() {\n\t\tif (this.mutable) {\n\t\t\tfor (var i = 1, item; item = this.children[i]; i++) {\n\t\t\t\titem.element.remove();\n\t\t\t\titem.destroy();\n\t\t\t}\n\n\t\t\tthis.children = this.children.slice(0, 1);\n\n\t\t\tthis.dataChanged(\"clear\");\n\t\t}\n\n\t\tthis.propagate(\"clear\");\n\t},\n\n\tdataChanged: function(action, o = {}) {\n\t\to.element = o.element || this.marker;\n\t\treturn this.super.dataChanged.call(this, action, o);\n\t},\n\n\tsave: function() {\n\t\tfor (let item of this.children) {\n\t\t\tif (item.deleted) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t}\n\t\t\telse {\n\t\t\t\titem.unsavedChanges = false;\n\t\t\t}\n\t\t}\n\t},\n\n\tpropagated: [\"save\"],\n\n\tdataRender: function(data) {\n\t\tthis.unhandled = {before: [], after: []};\n\n\t\tif (!data) {\n\t\t\treturn;\n\t\t}\n\n\t\tdata = Mavo.toArray(data);\n\n\t\tif (!this.mutable) {\n\t\t\tthis.children.forEach((item, i) => item.render(data && data[i]));\n\n\t\t\tif (data) {\n\t\t\t\tthis.unhandled.after = data.slice(this.length);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\t// First render on existing items\n\t\t\tfor (var i = 0; i < this.children.length; i++) {\n\t\t\t\tif (i < data.length) {\n\t\t\t\t\tthis.children[i].render(data[i]);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthis.delete(this.children[i], true);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (data.length > i) {\n\t\t\t\t// There are still remaining items\n\t\t\t\t// Using document fragments improves performance by 60%\n\t\t\t\tvar fragment = document.createDocumentFragment();\n\n\t\t\t\tfor (var j = i; j < data.length; j++) {\n\t\t\t\t\tvar item = this.createItem();\n\n\t\t\t\t\titem.render(data[j]);\n\n\t\t\t\t\tthis.children.push(item);\n\t\t\t\t\titem.index = j;\n\n\t\t\t\t\tfragment.appendChild(item.element);\n\n\t\t\t\t\tvar env = {context: this, item};\n\t\t\t\t\tMavo.hooks.run(\"collection-add-end\", env);\n\t\t\t\t}\n\n\t\t\t\tif (this.bottomUp) {\n\t\t\t\t\t$.after(fragment, i > 0? this.children[i-1].element : this.marker);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t$.before(fragment, this.marker);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tfind: function(property, o = {}) {\n\t\tvar items = this.children.filter(item => !item.deleted);\n\n\t\tif (this.property == property) {\n\t\t\treturn o.collections? this : items;\n\t\t}\n\n\t\tif (this.properties.indexOf(property) > -1) {\n\t\t\tvar ret = items.map(item => item.find(property, o));\n\n\t\t\treturn Mavo.flatten(ret);\n\t\t}\n\t},\n\n\tisCompatible: function(c) {\n\t\treturn c && this.itemTemplate.nodeType == c.itemTemplate.nodeType && (c === this\n\t\t       || c.template == this || this.template == c || this.template && this.template == c.template\n\t\t       || this.accepts.indexOf(c.property) > -1);\n\t},\n\n\tlive: {\n\t\tmutable: function(value) {\n\t\t\tif (value && value !== this.mutable) {\n\t\t\t\t// Why is all this code here? Because we want it executed\n\t\t\t\t// every time mutable changes, not just in the constructor\n\t\t\t\t// (think multiple elements with the same property name, where only one has mv-multiple)\n\t\t\t\tthis._mutable = value;\n\n\t\t\t\t// Keep position of the template in the DOM, since we might remove it\n\t\t\t\tthis.marker = document.createComment(\"mv-marker\");\n\t\t\t\tMavo.data(this.marker, \"collection\", this);\n\t\t\t\t$.after(this.marker, this.templateElement);\n\t\t\t}\n\t\t}\n\t},\n\n\t// Make sure to only call after dragula has loaded\n\tgetDragula: function() {\n\t\tif (this.dragula) {\n\t\t\treturn this.dragula;\n\t\t}\n\n\t\tif (this.template) {\n\t\t\tMavo.pushUnique(this.template.getDragula().containers, this.marker.parentNode);\n\t\t\treturn this.dragula = this.template.dragula || this.template.getDragula();\n\t\t}\n\n\t\tvar me = this;\n\t\tthis.dragula = dragula({\n\t\t\tcontainers: [this.marker.parentNode],\n\t\t\tisContainer: el => {\n\t\t\t\tif (this.accepts.length) {\n\t\t\t\t\treturn Mavo.flatten(this.accepts.map(property => this.mavo.root.find(property, {collections: true})))\n\t\t\t\t\t\t\t\t.filter(c => c && c instanceof _)\n\t\t\t\t\t\t\t\t.map(c => c.marker.parentNode)\n\t\t\t\t\t\t\t\t.indexOf(el) > -1;\n\t\t\t\t}\n\n\t\t\t\treturn false;\n\t\t\t},\n\t\t\tmoves: (el, container, handle) => {\n\t\t\t\treturn handle.classList.contains(\"mv-drag-handle\") && handle.closest(Mavo.selectors.multiple) == el;\n\t\t\t},\n\t\t\taccepts: function(el, target, source, next) {\n\t\t\t\tif (el.contains(target)) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tvar previous = next? next.previousElementSibling : target.lastElementChild;\n\n\t\t\t\tvar collection = _.get(previous) || _.get(next);\n\n\t\t\t\tif (!collection) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tvar item = Mavo.Node.get(el);\n\n\t\t\t\treturn item && item.collection.isCompatible(collection);\n\t\t\t}\n\t\t});\n\n\t\tthis.dragula.on(\"drop\", (el, target, source) => {\n\t\t\tvar item = Mavo.Node.get(el);\n\t\t\tvar oldIndex = item && item.index;\n\t\t\tvar next = el.nextElementSibling;\n\t\t\tvar previous = el.previousElementSibling;\n\t\t\tvar collection = _.get(previous) || _.get(next);\n\t\t\tvar closestItem = Mavo.Node.get(previous) || Mavo.Node.get(next);\n\n\t\t\tif (closestItem && closestItem.collection != collection) {\n\t\t\t\tclosestItem = null;\n\t\t\t}\n\n\t\t\tif (item.collection.isCompatible(collection)) {\n\t\t\t\tvar index = closestItem? closestItem.index + (closestItem.element === previous) : collection.length;\n\t\t\t\tcollection.add(item, index);\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturn this.dragula.cancel(true);\n\t\t\t}\n\t\t});\n\n\t\t_.dragulas.push(this.dragula);\n\n\t\treturn this.dragula;\n\t},\n\n\tlazy: {\n\t\tbottomUp: function() {\n\t\t\t/*\n\t\t\t * Add new items at the top or bottom?\n\t\t\t */\n\n\t\t\tif (!this.mutable) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tvar order = this.templateElement.getAttribute(\"mv-order\");\n\t\t\tif (order !== null) {\n\t\t\t\t// Attribute has the highest priority and overrides any heuristics\n\t\t\t\treturn /^desc\\b/i.test(order);\n\t\t\t}\n\n\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\t// If add button not in DOM, do the default\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// If add button is already in the DOM and *before* our template, then we default to prepending\n\t\t\treturn !!(this.addButton.compareDocumentPosition(this.marker) & Node.DOCUMENT_POSITION_FOLLOWING);\n\t\t},\n\n\t\tclosestCollection: function() {\n\t\t\tvar parent = this.marker? this.marker.parentNode : this.templateElement.parentNode;\n\n\t\t\treturn parent.closest(Mavo.selectors.multiple);\n\t\t},\n\n\t\taddButton: function() {\n\t\t\t// Find add button if provided, or generate one\n\t\t\tvar selector = `button.mv-add-${this.property}`;\n\t\t\tvar group = this.closestCollection || this.marker.parentNode.closest(Mavo.selectors.group);\n\n\t\t\tif (group) {\n\t\t\t\tvar button = $$(selector, group).filter(button => {\n\t\t\t\t\treturn !this.templateElement.contains(button);\n\t\t\t\t})[0];\n\t\t\t}\n\n\t\t\tif (!button) {\n\t\t\t\tbutton = $.create(\"button\", {\n\t\t\t\t\tclassName: \"mv-add\",\n\t\t\t\t\ttextContent: \"Add \" + this.name\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tbutton.classList.add(\"mv-ui\", \"mv-add\");\n\t\t\tMavo.data(button, \"collection\", this);\n\n\t\t\tif (this.property) {\n\t\t\t\tbutton.classList.add(`mv-add-${this.property}`);\n\t\t\t}\n\n\t\t\tbutton.addEventListener(\"click\", evt => {\n\t\t\t\tevt.preventDefault();\n\n\t\t\t\tthis.editItem(this.add());\n\t\t\t});\n\n\t\t\treturn button;\n\t\t}\n\t},\n\n\tstatic: {\n\t\tdragulas: [],\n\t\tget: element => {\n\t\t\t// Is it an add button or a marker?\n\t\t\tvar collection = Mavo.data(element, \"collection\");\n\n\t\t\tif (collection) {\n\t\t\t\treturn collection;\n\t\t\t}\n\n\t\t\t// Maybe it's a collection item?\n\t\t\tvar item = Mavo.Node.get(element);\n\n\t\t\treturn item && item.collection || null;\n\t\t},\n\n\t\tlazy: {\n\t\t\tdragula: () => $.include(self.dragula, \"https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.js\")\n\t\t}\n\t}\n});\n\n})(Bliss, Bliss.$);\n"]}