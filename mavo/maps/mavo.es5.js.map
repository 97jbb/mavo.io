{"version":3,"sources":["ui.bar.js"],"names":["$","$$","Mavo","attributes","push","_","UI","Bar","Class","constructor","mavo","element","create","className","start","innerHTML","order","getAttribute","split","Object","keys","controls","filter","id","length","targetHeight","offsetHeight","o","call","label","Functions","readable","textContent","title","add","permission","permissions","can","toggle","condition","remove","events","bind","action","delegate","is","resize","self","ResizeObserver","previousRect","resizeObserver","contentRect","entries","width","height","observe","disconnect","classList","prepare","revocably","cleanup","proxy","static","status","backend","primaryBackend","parent","user","html","name","avatar","url","bar","edit","editing","done","save","autoSave","autoSaveDelay","clear","login","logout","Bliss"],"mappings":";;AAAA,CAAC,UAAUA,CAAV,EAAaC,EAAb,EAAiB;;AAElBC,MAAKC,UAAL,CAAgBC,IAAhB,CAAqB,QAArB;;AAEA,KAAIC,IAAIH,KAAKI,EAAL,CAAQC,GAAR,GAAcP,EAAEQ,KAAF,CAAQ;AAC7BC,eAAa,qBAASC,IAAT,EAAe;AAAA;;AAC3B,QAAKA,IAAL,GAAYA,IAAZ;;AAEA,QAAKC,OAAL,GAAeX,EAAE,SAAF,EAAa,KAAKU,IAAL,CAAUC,OAAvB,KAAmCX,EAAEY,MAAF,CAAS;AAC1DC,eAAW,cAD+C;AAE1DC,WAAO,KAAKJ,IAAL,CAAUC,OAFyC;AAG1DI,eAAW;AAH+C,IAAT,CAAlD;;AAMA,QAAKC,KAAL,GAAa,KAAKN,IAAL,CAAUC,OAAV,CAAkBM,YAAlB,CAA+B,QAA/B,CAAb;;AAEA,OAAI,KAAKD,KAAT,EAAgB;AACf,SAAKA,KAAL,GAAa,KAAKA,KAAL,IAAc,MAAd,GAAsB,EAAtB,GAA2B,KAAKA,KAAL,CAAWE,KAAX,CAAiB,KAAjB,CAAxC;AACA,IAFD,MAGK;AACJ,SAAKF,KAAL,GAAaG,OAAOC,IAAP,CAAYf,EAAEgB,QAAd,CAAb;AACA;;AAED,QAAKL,KAAL,GAAa,KAAKA,KAAL,CAAWM,MAAX,CAAkB;AAAA,WAAMjB,EAAEgB,QAAF,CAAWE,EAAX,CAAN;AAAA,IAAlB,CAAb;;AAEA,OAAI,KAAKP,KAAL,CAAWQ,MAAf,EAAuB;AACtB;AACA,SAAKC,YAAL,GAAoB,KAAKd,OAAL,CAAae,YAAjC;AACA;;AAED,QAAKf,OAAL,CAAaI,SAAb,GAAyB,EAAzB;;AAzB2B,8BA2BlBQ,EA3BkB;AA4B1B,QAAII,IAAItB,EAAEgB,QAAF,CAAWE,EAAX,CAAR;;AAEA,QAAII,EAAEf,MAAN,EAAc;AACb,WAAKW,EAAL,IAAWI,EAAEf,MAAF,CAASgB,IAAT,CAAc,MAAKlB,IAAnB,CAAX;AACA,KAFD,MAGK;AACAmB,aAAQF,EAAEE,KAAF,IAAW3B,KAAK4B,SAAL,CAAeC,QAAf,CAAwBR,EAAxB,CADnB;;;AAGJ,WAAKA,EAAL,IAAWvB,EAAEY,MAAF,CAAS,QAAT,EAAmB;AAC7BC,yBAAiBU,EADY;AAE7BS,mBAAaH,KAFgB;AAG7BI,aAAOJ;AAHsB,MAAnB,CAAX;AAKA;;AAED;AACA;AACA,UAAKK,GAAL,CAASX,EAAT;;AAEA,QAAII,EAAEQ,UAAN,EAAkB;AACjB,WAAKC,WAAL,CAAiBC,GAAjB,CAAqBV,EAAEQ,UAAvB,EAAmC,YAAM;AACxC,YAAKG,MAAL,CAAYf,EAAZ,EAAgB,CAACI,EAAEY,SAAH,IAAgBZ,EAAEY,SAAF,CAAYX,IAAZ,CAAiB,MAAKlB,IAAtB,CAAhC;AACA,MAFD,EAEG,YAAM;AACR,YAAK8B,MAAL,CAAYjB,EAAZ;AACA,MAJD;AAKA,KAND,MAOK,IAAII,EAAEY,SAAF,IAAe,CAACZ,EAAEY,SAAF,CAAYX,IAAZ,CAAiB,MAAKlB,IAAtB,CAApB,EAAiD;AACrD,WAAK8B,MAAL,CAAYjB,EAAZ;AACA;;AAED,SAASkB,MAAT,IAAmBd,EAAEc,MAArB,EAA6B;AAC5BzC,OAAEyC,MAAF,CAAS,MAAKlB,EAAL,CAAT,EAAmBkB,MAAnB,EAA2Bd,EAAEc,MAAF,CAASA,MAAT,EAAiBC,IAAjB,CAAsB,MAAKhC,IAA3B,CAA3B;AACA;;AAED,QAAIiB,EAAEgB,MAAN,EAAc;AACb3C,OAAE4C,QAAF,CAAW,MAAKjC,OAAhB,EAAyB,OAAzB,EAAkC,SAASY,EAA3C,EAA+C,YAAM;AACpD,UAAI,CAACI,EAAEQ,UAAH,IAAiB,MAAKC,WAAL,CAAiBS,EAAjB,CAAoBlB,EAAEQ,UAAtB,CAArB,EAAwD;AACvDR,SAAEgB,MAAF,CAASf,IAAT,CAAc,MAAKlB,IAAnB;AACA;AACD,MAJD;AAKA;AApEyB;;AAAA;AAAA;AAAA;;AAAA;AA2B3B,yBAAe,KAAKM,KAApB,8HAA2B;AAAA,SAAlBO,EAAkB;AAAA,SAOrBM,KAPqB;AAAA,SA+BjBY,MA/BiB;;AAAA,WAAlBlB,EAAkB;AA0C1B;AArE0B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAuE3B,OAAI,KAAKP,KAAL,CAAWQ,MAAf,EAAuB;AACtB,SAAKsB,MAAL;;AAEA,QAAIC,KAAKC,cAAT,EAAyB;AACxB,SAAIC,eAAe,IAAnB;;AAEA,UAAKC,cAAL,GAAsB,IAAIF,cAAJ,CAAmB,mBAAW;AACnD,UAAIG,cAAcC,QAAQA,QAAQ5B,MAAR,GAAiB,CAAzB,EAA4B2B,WAA9C;;AAEA,UAAIF,gBACAA,aAAaI,KAAb,IAAsBF,YAAYE,KADlC,IAEAJ,aAAaK,MAAb,IAAuBH,YAAYG,MAFvC,EAE+C;AAC9C;AACA;;AAED,YAAKR,MAAL;;AAEAG,qBAAeE,WAAf;AACA,MAZqB,CAAtB;;AAcA,UAAKD,cAAL,CAAoBK,OAApB,CAA4B,KAAK5C,OAAjC;AACA;AACD;AACD,GA/F4B;;AAiG7BmC,UAAQ,kBAAW;AAClB,QAAKI,cAAL,IAAuB,KAAKA,cAAL,CAAoBM,UAApB,EAAvB;;AAEA,QAAK7C,OAAL,CAAa8C,SAAb,CAAuBjB,MAAvB,CAA8B,YAA9B,EAA4C,SAA5C;;AAEA;AACA,OAAI,KAAK7B,OAAL,CAAae,YAAb,GAA4B,KAAKD,YAAL,GAAoB,GAApD,EAAyD;AACxD,SAAKd,OAAL,CAAa8C,SAAb,CAAuBvB,GAAvB,CAA2B,YAA3B;;AAEA,QAAI,KAAKvB,OAAL,CAAae,YAAb,GAA4B,KAAKD,YAAL,GAAoB,GAApD,EAAyD;AACxD;AACA,UAAKd,OAAL,CAAa8C,SAAb,CAAuBvB,GAAvB,CAA2B,SAA3B;AACA;AACD;;AAED,QAAKgB,cAAL,IAAuB,KAAKA,cAAL,CAAoBK,OAApB,CAA4B,KAAK5C,OAAjC,CAAvB;AACA,GAjH4B;;AAmH7BuB,OAAK,aAASX,EAAT,EAAa;AACjB,OAAII,IAAGtB,EAAEgB,QAAF,CAAWE,EAAX,CAAP;;AAEA,OAAII,EAAE+B,OAAN,EAAe;AACd/B,MAAE+B,OAAF,CAAU9B,IAAV,CAAe,KAAKlB,IAApB;AACA;;AAEDR,QAAKyD,SAAL,CAAezB,GAAf,CAAmB,KAAKX,EAAL,CAAnB,EAA6B,KAAKZ,OAAlC;AACA,GA3H4B;;AA6H7B6B,UAAQ,gBAASjB,EAAT,EAAa;AACpB,OAAII,IAAGtB,EAAEgB,QAAF,CAAWE,EAAX,CAAP;;AAEArB,QAAKyD,SAAL,CAAenB,MAAf,CAAsB,KAAKjB,EAAL,CAAtB,EAAgC,QAAQA,EAAxC;;AAEA,OAAII,EAAEiC,OAAN,EAAe;AACdjC,MAAEiC,OAAF,CAAUhC,IAAV,CAAe,KAAKlB,IAApB;AACA;AACD,GArI4B;;AAuI7B4B,UAAQ,gBAASf,EAAT,EAAaW,GAAb,EAAkB;AACzB,UAAO,KAAKA,MAAK,KAAL,GAAa,QAAlB,EAA4BX,EAA5B,CAAP;AACA,GAzI4B;;AA2I7BsC,SAAO;AACN,kBAAe;AADT,GA3IsB;;AA+I7BC,UAAQ;AACPzC,aAAU;AACT0C,YAAQ;AACPnD,aAAQ,kBAAW;AAClB,UAAImD,SAAS/D,EAAEY,MAAF,CAAS;AACrBC,kBAAW;AADU,OAAT,CAAb;;AAIA,aAAOkD,MAAP;AACA,MAPM;AAQPL,cAAS,mBAAW;AACnB,UAAIM,UAAU,KAAKC,cAAnB;;AAEA,UAAID,WAAW,KAAK5B,WAAL,CAAiB8B,MAAjB,IAA2BF,QAAQ5B,WAA9C,IAA6D4B,QAAQG,IAAzE,EAA+E;AAC9E,WAAIA,OAAOH,QAAQG,IAAnB;AACA,WAAIC,OAAOD,KAAKE,IAAL,IAAa,EAAxB;;AAEA,WAAIF,KAAKG,MAAT,EAAiB;AAChBF,mDAAsCD,KAAKG,MAA3C,cAAyDF,IAAzD;AACA;;AAED,WAAID,KAAKI,GAAT,EAAc;AACbH,8BAAmBD,KAAKI,GAAxB,6BAAgDH,IAAhD;AACA;;AAED,YAAKI,GAAL,CAAST,MAAT,CAAgBhD,SAAhB,GAA4BqD,IAA5B;AACA;AACD,MAzBM;AA0BPjC,iBAAY;AA1BL,KADC;;AA8BTsC,UAAM;AACL9B,aAAQ,kBAAW;AAClB,UAAI,KAAK+B,OAAT,EAAkB;AACjB,YAAKC,IAAL;AACA,OAFD,MAGK;AACJ,YAAKF,IAAL;AACA;AACD,MARI;AASLtC,iBAAY,CAAC,MAAD,EAAS,KAAT,EAAgB,QAAhB,CATP;AAULyB,cAAS,mBAAW;AACnB,UAAI,KAAKc,OAAT,EAAkB;AACjB,YAAKC,IAAL;AACA;AACD;AAdI,KA9BG;;AA+CTC,UAAM;AACLjC,aAAQ,kBAAW;AAClB,WAAKiC,IAAL;AACA,MAHI;AAILnC,aAAQ;AACP,0BAAoB,2BAAW;AAC9B,YAAK9B,OAAL,CAAa8C,SAAb,CAAuBvB,GAAvB,CAA2B,sBAA3B;AACA,OAHM;AAIP,yBAAmB,0BAAW;AAC7B,YAAKvB,OAAL,CAAa8C,SAAb,CAAuBjB,MAAvB,CAA8B,sBAA9B;AACA;AANM,MAJH;AAYLL,iBAAY,MAZP;AAaLI,gBAAW,qBAAW;AACrB,aAAO,CAAC,KAAKsC,QAAN,IAAkB,KAAKC,aAAL,GAAqB,CAA9C;AACA;AAfI,KA/CG;;AAiETC,WAAO;AACNpC,aAAQ,kBAAW;AAClB,WAAKoC,KAAL;AACA,MAHK;AAIN5C,iBAAY;AAJN,KAjEE;;AAwET6C,WAAO;AACNrC,aAAQ,kBAAW;AAClB,WAAKsB,cAAL,CAAoBe,KAApB;AACA,MAHK;AAIN7C,iBAAY;AAJN,KAxEE;;AA+ET8C,YAAQ;AACPtC,aAAQ,kBAAW;AAClB,WAAKsB,cAAL,CAAoBgB,MAApB;AACA,MAHM;AAIP9C,iBAAY;AAJL;AA/EC;AADH;AA/IqB,EAAR,CAAtB;AAyOC,CA7OD,EA6OG+C,KA7OH,EA6OUA,MAAMlF,CA7OhB","file":"../mavo.es5.js","sourcesContent":["(function ($, $$) {\n\nMavo.attributes.push(\"mv-bar\");\n\nvar _ = Mavo.UI.Bar = $.Class({\n\tconstructor: function(mavo) {\n\t\tthis.mavo = mavo;\n\n\t\tthis.element = $(\".mv-bar\", this.mavo.element) || $.create({\n\t\t\tclassName: \"mv-bar mv-ui\",\n\t\t\tstart: this.mavo.element,\n\t\t\tinnerHTML: \"<button>&nbsp;</button>\"\n\t\t});\n\n\t\tthis.order = this.mavo.element.getAttribute(\"mv-bar\");\n\n\t\tif (this.order) {\n\t\t\tthis.order = this.order == \"none\"? [] : this.order.split(/\\s+/);\n\t\t}\n\t\telse {\n\t\t\tthis.order = Object.keys(_.controls);\n\t\t}\n\n\t\tthis.order = this.order.filter(id => _.controls[id]);\n\n\t\tif (this.order.length) {\n\t\t\t// Measure height of 1 row\n\t\t\tthis.targetHeight = this.element.offsetHeight;\n\t\t}\n\n\t\tthis.element.innerHTML = \"\";\n\n\t\tfor (let id of this.order) {\n\t\t\tlet o = _.controls[id];\n\n\t\t\tif (o.create) {\n\t\t\t\tthis[id] = o.create.call(this.mavo);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tvar label = o.label || Mavo.Functions.readable(id);\n\n\t\t\t\tthis[id] = $.create(\"button\", {\n\t\t\t\t\tclassName: `mv-${id}`,\n\t\t\t\t\ttextContent: label,\n\t\t\t\t\ttitle: label\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// We initially add all of them to retain order,\n\t\t\t// then we remove revocably when/if needed\n\t\t\tthis.add(id);\n\n\t\t\tif (o.permission) {\n\t\t\t\tthis.permissions.can(o.permission, () => {\n\t\t\t\t\tthis.toggle(id, !o.condition || o.condition.call(this.mavo));\n\t\t\t\t}, () => {\n\t\t\t\t\tthis.remove(id);\n\t\t\t\t});\n\t\t\t}\n\t\t\telse if (o.condition && !o.condition.call(this.mavo)) {\n\t\t\t\tthis.remove(id);\n\t\t\t}\n\n\t\t\tfor (var events in o.events) {\n\t\t\t\t$.events(this[id], events, o.events[events].bind(this.mavo));\n\t\t\t}\n\n\t\t\tif (o.action) {\n\t\t\t\t$.delegate(this.element, \"click\", \".mv-\" + id, () => {\n\t\t\t\t\tif (!o.permission || this.permissions.is(o.permission)) {\n\t\t\t\t\t\to.action.call(this.mavo);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tif (this.order.length) {\n\t\t\tthis.resize();\n\n\t\t\tif (self.ResizeObserver) {\n\t\t\t\tvar previousRect = null;\n\n\t\t\t\tthis.resizeObserver = new ResizeObserver(entries => {\n\t\t\t\t\tvar contentRect = entries[entries.length - 1].contentRect;\n\n\t\t\t\t\tif (previousRect\n\t\t\t\t\t\t&& previousRect.width == contentRect.width\n\t\t\t\t\t\t&& previousRect.height == contentRect.height) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.resize();\n\n\t\t\t\t\tpreviousRect = contentRect;\n\t\t\t\t});\n\n\t\t\t\tthis.resizeObserver.observe(this.element);\n\t\t\t}\n\t\t}\n\t},\n\n\tresize: function() {\n\t\tthis.resizeObserver && this.resizeObserver.disconnect();\n\n\t\tthis.element.classList.remove(\"mv-compact\", \"mv-tiny\");\n\n\t\t// Exceeded single row?\n\t\tif (this.element.offsetHeight > this.targetHeight * 1.2) {\n\t\t\tthis.element.classList.add(\"mv-compact\");\n\n\t\t\tif (this.element.offsetHeight > this.targetHeight * 1.2) {\n\t\t\t\t// Still too tall\n\t\t\t\tthis.element.classList.add(\"mv-tiny\");\n\t\t\t}\n\t\t}\n\n\t\tthis.resizeObserver && this.resizeObserver.observe(this.element);\n\t},\n\n\tadd: function(id) {\n\t\tvar o =_.controls[id];\n\n\t\tif (o.prepare) {\n\t\t\to.prepare.call(this.mavo);\n\t\t}\n\n\t\tMavo.revocably.add(this[id], this.element);\n\t},\n\n\tremove: function(id) {\n\t\tvar o =_.controls[id];\n\n\t\tMavo.revocably.remove(this[id], \"mv-\" + id);\n\n\t\tif (o.cleanup) {\n\t\t\to.cleanup.call(this.mavo);\n\t\t}\n\t},\n\n\ttoggle: function(id, add) {\n\t\treturn this[add? \"add\" : \"remove\"](id);\n\t},\n\n\tproxy: {\n\t\t\"permissions\": \"mavo\"\n\t},\n\n\tstatic: {\n\t\tcontrols: {\n\t\t\tstatus: {\n\t\t\t\tcreate: function() {\n\t\t\t\t\tvar status = $.create({\n\t\t\t\t\t\tclassName: \"mv-status\"\n\t\t\t\t\t});\n\n\t\t\t\t\treturn status;\n\t\t\t\t},\n\t\t\t\tprepare: function() {\n\t\t\t\t\tvar backend = this.primaryBackend;\n\n\t\t\t\t\tif (backend && this.permissions.parent == backend.permissions && backend.user) {\n\t\t\t\t\t\tvar user = backend.user;\n\t\t\t\t\t\tvar html = user.name || \"\";\n\n\t\t\t\t\t\tif (user.avatar) {\n\t\t\t\t\t\t\thtml = `<img class=\"mv-avatar\" src=\"${user.avatar}\" /> ${html}`;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (user.url) {\n\t\t\t\t\t\t\thtml = `<a href=\"${user.url}\" target=\"_blank\">${html}</a>`;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.bar.status.innerHTML = html;\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tpermission: \"logout\"\n\t\t\t},\n\n\t\t\tedit: {\n\t\t\t\taction: function() {\n\t\t\t\t\tif (this.editing) {\n\t\t\t\t\t\tthis.done();\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tthis.edit();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tpermission: [\"edit\", \"add\", \"delete\"],\n\t\t\t\tcleanup: function() {\n\t\t\t\t\tif (this.editing) {\n\t\t\t\t\t\tthis.done();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tsave: {\n\t\t\t\taction: function() {\n\t\t\t\t\tthis.save();\n\t\t\t\t},\n\t\t\t\tevents: {\n\t\t\t\t\t\"mouseenter focus\": function() {\n\t\t\t\t\t\tthis.element.classList.add(\"mv-highlight-unsaved\");\n\t\t\t\t\t},\n\t\t\t\t\t\"mouseleave blur\": function() {\n\t\t\t\t\t\tthis.element.classList.remove(\"mv-highlight-unsaved\");\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tpermission: \"save\",\n\t\t\t\tcondition: function() {\n\t\t\t\t\treturn !this.autoSave || this.autoSaveDelay > 0;\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tclear: {\n\t\t\t\taction: function() {\n\t\t\t\t\tthis.clear();\n\t\t\t\t},\n\t\t\t\tpermission: \"delete\"\n\t\t\t},\n\n\t\t\tlogin: {\n\t\t\t\taction: function() {\n\t\t\t\t\tthis.primaryBackend.login();\n\t\t\t\t},\n\t\t\t\tpermission: \"login\"\n\t\t\t},\n\n\t\t\tlogout: {\n\t\t\t\taction: function() {\n\t\t\t\t\tthis.primaryBackend.logout();\n\t\t\t\t},\n\t\t\t\tpermission: \"logout\"\n\t\t\t}\n\t\t}\n\t}\n});\n\n})(Bliss, Bliss.$);\n"]}