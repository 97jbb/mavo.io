{"version":3,"sources":["collection.js"],"names":["$","$$","Mavo","attributes","push","_","Collection","Class","extends","Node","nodeType","constructor","element","mavo","o","templateElement","children","fromTemplate","properties","selectors","property","map","getProperty","mutable","matches","multiple","accepts","getAttribute","split","cloneNode","item","createItem","add","itemTemplate","template","postInit","hooks","run","length","getData","env","context","options","data","deleted","live","itemData","filter","rendered","subset","inPath","concat","slice","create","collection","type","index","get","adopt","rel","marker","bottomUp","undefined","previousIndex","changed","splice","remove","requestAnimationFrame","silent","forEach","i","dataChanged","unsavedChanges","expressions","update","actions","action","isNaN","indexOf","sort","a","b","toArray","walk","obj","closestCollection","delete","copies","hard","destroy","transition","opacity","then","style","move","offset","editItem","itemControls","UI","Itembar","edit","super","call","addButton","parentNode","tag","tagName","toLowerCase","containerSelector","container","closest","propagate","dragula","getDragula","done","clear","save","propagated","dataRender","render","fragment","document","createDocumentFragment","j","appendChild","after","before","find","items","collections","ret","flatten","isCompatible","c","value","_mutable","createComment","pushUnique","containers","me","isContainer","root","el","moves","handle","classList","contains","target","source","next","previous","previousElementSibling","lastElementChild","on","oldIndex","nextElementSibling","closestItem","cancel","dragulas","lazy","order","test","compareDocumentPosition","DOCUMENT_POSITION_FOLLOWING","parent","selector","group","button","className","textContent","name","addEventListener","evt","preventDefault","static","include","self","Bliss"],"mappings":"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","file":"../mavo.es5.js","sourcesContent":["(function($, $$) {\n\nMavo.attributes.push(\"mv-multiple\", \"mv-order\", \"mv-accepts\");\n\nvar _ = Mavo.Collection = $.Class({\n\textends: Mavo.Node,\n\tnodeType: \"Collection\",\n\tconstructor: function (element, mavo, o) {\n\t\t/*\n\t\t * Create the template, remove it from the DOM and store it\n\t\t */\n\t\tthis.templateElement = this.element;\n\n\t\tthis.children = [];\n\n\t\t// ALL descendant property names as an array\n\t\tif (!this.fromTemplate(\"properties\", \"mutable\", \"templateElement\", \"accepts\")) {\n\t\t\tthis.properties = $$(Mavo.selectors.property, this.templateElement).map(Mavo.Node.getProperty);\n\t\t\tthis.mutable = this.templateElement.matches(Mavo.selectors.multiple);\n\t\t\tthis.accepts = (this.templateElement.getAttribute(\"mv-accepts\") || \"\").split(/\\s+/);\n\n\t\t\t// Must clone because otherwise once expressions are parsed on the template element\n\t\t\t// we will not be able to pick them up from subsequent items\n\t\t\tthis.templateElement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\tvar item = this.createItem(this.element);\n\t\t\tthis.add(item);\n\t\t\tthis.itemTemplate = item.template || item;\n\t\t}\n\n\t\tthis.postInit();\n\n\t\tMavo.hooks.run(\"collection-init-end\", this);\n\t},\n\n\tget length() {\n\t\treturn this.children.length;\n\t},\n\n\tgetData: function(o = {}) {\n\t\tvar env = {\n\t\t\tcontext: this,\n\t\t\toptions: o,\n\t\t\tdata: []\n\t\t};\n\n\t\tfor (item of this.children) {\n\t\t\tif (!item.deleted || env.options.live) {\n\t\t\t\tlet itemData = item.getData(env.options);\n\n\t\t\t\tif (itemData || env.options.live) {\n\t\t\t\t\tenv.data.push(itemData);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (!this.mutable) {\n\t\t\t// If immutable, drop nulls\n\n\t\t\tenv.data = env.data.filter(item => item !== null);\n\n\t\t\tif (env.options.live && env.data.length === 1) {\n\t\t\t\t// If immutable with only 1 item, return the item\n\t\t\t\t// See https://github.com/LeaVerou/mavo/issues/50#issuecomment-266079652\n\t\t\t\tenv.data = env.data[0];\n\t\t\t}\n\t\t\telse if (this.data && !env.options.live) {\n\t\t\t\tvar rendered = Mavo.subset(this.data, this.inPath);\n\t\t\t\tenv.data = env.data.concat(rendered.slice(env.data.length));\n\t\t\t}\n\t\t}\n\n\t\tMavo.hooks.run(\"node-getdata-end\", env);\n\n\t\treturn env.data;\n\t},\n\n\t// Create item but don't insert it anywhere\n\t// Mostly used internally\n\tcreateItem: function (element) {\n\t\tif (!element) {\n\t\t\telement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tvar item = Mavo.Node.create(element, this.mavo, {\n\t\t\tcollection: this,\n\t\t\ttemplate: this.itemTemplate || (this.template? this.template.itemTemplate : null),\n\t\t\tproperty: this.property,\n\t\t\ttype: this.type\n\t\t});\n\n\t\treturn item;\n\t},\n\n\t/**\n\t * Add a new item to this collection\n\t * @param item {Node|Mavo.Node} Optional. Element or Mavo object for the new item\n\t * @param index {Number} Optional. Index of existing item, will be added opposite to list direction\n\t * @param silent {Boolean} Optional. Throw a datachange event? Mainly used internally.\n\t */\n\tadd: function(item, index, o = {}) {\n\t\tif (item instanceof Node) {\n\t\t\titem = Mavo.Node.get(item) || this.createItem(item);\n\t\t}\n\t\telse {\n\t\t\titem = item || this.createItem();\n\t\t}\n\n\t\tif (item.collection != this) {\n\t\t\tthis.adopt(item);\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\t// Add it to the DOM, or fix its place\n\t\t\tvar rel = this.children[index]? this.children[index].element : this.marker;\n\t\t\t$[this.bottomUp? \"after\" : \"before\"](item.element, rel);\n\n\t\t\tif (index === undefined) {\n\t\t\t\tindex = this.bottomUp? 0 : this.length;\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tindex = this.length;\n\t\t}\n\n\t\tvar env = {context: this, item};\n\n\t\tenv.previousIndex = item.index;\n\n\t\t// Update internal data model\n\t\tenv.changed = this.splice({\n\t\t\tremove: env.item\n\t\t}, {\n\t\t\tindex: index,\n\t\t\tadd: env.item\n\t\t});\n\n\t\trequestAnimationFrame(() => {\n\t\t\tif (!o.silent) {\n\t\t\t\tenv.changed.forEach(i => {\n\t\t\t\t\ti.dataChanged(i == env.item && env.previousIndex === undefined? \"add\" : \"move\");\n\t\t\t\t\ti.unsavedChanges = true;\n\t\t\t\t});\n\n\t\t\t\tthis.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t\t}\n\n\t\t\tthis.mavo.expressions.update(env.item.element);\n\t\t});\n\n\t\tMavo.hooks.run(\"collection-add-end\", env);\n\n\t\treturn env.item;\n\t},\n\n\tsplice: function(...actions) {\n\t\tfor (let action of actions) {\n\t\t\tif (action.index === undefined && action.remove && isNaN(action.remove)) {\n\t\t\t\t// Remove is an item\n\t\t\t\taction.index = this.children.indexOf(action.remove);\n\t\t\t\taction.remove = 1;\n\t\t\t}\n\t\t}\n\n\t\t// Sort in reverse index order\n\t\tactions.sort((a, b) => b.index - a.index);\n\n\t\t// FIXME this could still result in buggy behavior.\n\t\t// Think of e.g. adding items on i, then removing > 1 items on i-1.\n\t\t// The new items would get removed instead of the old ones.\n\t\t// Not a pressing issue though since we always remove 1 max when adding things too.\n\t\tfor (let action of actions) {\n\t\t\tif (action.index > -1 && (action.remove || action.add)) {\n\t\t\t\taction.remove = action.remove || 0;\n\t\t\t\taction.add = Mavo.toArray(action.add);\n\n\t\t\t\tthis.children.splice(action.index, +action.remove, ...action.add);\n\t\t\t}\n\t\t}\n\n\t\tvar changed = [];\n\n\t\tfor (let i = 0; i < this.length; i++) {\n\t\t\tlet item = this.children[i];\n\n\t\t\tif (item && item.index !== i) {\n\t\t\t\titem.index = i;\n\t\t\t\tchanged.push(item);\n\t\t\t}\n\t\t}\n\n\t\treturn changed;\n\t},\n\n\tadopt: function(item) {\n\t\tif (item.collection) {\n\t\t\t// It belongs to another collection, delete from there first\n\t\t\titem.collection.splice({remove: item});\n\t\t\titem.collection.dataChanged(\"delete\");\n\t\t}\n\n\t\t // Update collection & closestCollection properties\n\t\tthis.walk(obj => {\n\t\t\tif (obj.closestCollection === item.collection) {\n\t\t\t\tobj.closestCollection = this;\n\t\t\t}\n\n\t\t\t// Belongs to another Mavo?\n\t\t\tif (item.mavo != this.mavo) {\n\t\t\t\titem.mavo = this.mavo;\n\t\t\t}\n\t\t});\n\n\t\titem.collection = this;\n\n\t\t// Adjust templates and their copies\n\t\tif (item.template) {\n\t\t\tMavo.delete(item.template.copies, item);\n\n\t\t\titem.template = this.itemTemplate;\n\t\t}\n\t},\n\n\tdelete: function(item, hard) {\n\t\tif (hard) {\n\t\t\t// Hard delete\n\t\t\t$.remove(item.element);\n\t\t\tthis.splice({remove: item});\n\t\t\titem.destroy();\n\t\t\treturn;\n\t\t}\n\n\t\treturn $.transition(item.element, {opacity: 0}).then(() => {\n\t\t\titem.deleted = true; // schedule for deletion\n\t\t\titem.element.style.opacity = \"\";\n\n\t\t\titem.dataChanged(\"delete\");\n\n\t\t\tthis.unsavedChanges = item.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t});\n\t},\n\n\t/**\n\t * Move existing item to a new position. Wraps around if position is out of bounds.\n\t * @offset relative position\n\t */\n\tmove: function(item, offset) {\n\t\tindex = item.index + offset + (offset > 0);\n\n\t\tif (index < 0) {\n\t\t\tindex = this.children.length;\n\t\t}\n\t\telse if (index > this.children.length) {\n\t\t\tindex = 0;\n\t\t}\n\n\t\tthis.add(item, index);\n\t},\n\n\teditItem: function(item) {\n\t\tif (!item.itemControls) {\n\t\t\titem.itemControls = new Mavo.UI.Itembar(item);\n\t\t}\n\n\t\titem.itemControls.add();\n\n\t\titem.edit();\n\t},\n\n\tedit: function() {\n\t\tif (this.super.edit.call(this) === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\t// Insert the add button if it's not already in the DOM\n\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\tvar tag = this.element.tagName.toLowerCase();\n\t\t\t\tvar containerSelector = Mavo.selectors.container[tag];\n\t\t\t\tvar rel = containerSelector? this.marker.parentNode.closest(containerSelector) : this.marker;\n\t\t\t\t$[this.bottomUp? \"before\" : \"after\"](this.addButton, rel);\n\t\t\t}\n\n\t\t\t// Insert item controls\n\t\t\tthis.propagate(item => {\n\t\t\t\tthis.editItem(item);\n\t\t\t});\n\n\t\t\t// Set up drag & drop\n\t\t\t_.dragula.then(() => {\n\t\t\t\tthis.getDragula();\n\t\t\t});\n\t\t}\n\t},\n\n\tdone: function() {\n\t\tif (this.super.done.call(this) === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\tif (this.addButton.parentNode) {\n\t\t\t\tthis.addButton.remove();\n\t\t\t}\n\n\t\t\tthis.propagate(item => {\n\t\t\t\tif (item.itemControls) {\n\t\t\t\t\titem.itemControls.remove();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\t/**\n\t * Delete all items in the collection. Not undoable.\n\t */\n\tclear: function() {\n\t\tif (this.mutable) {\n\t\t\tfor (var i = 1, item; item = this.children[i]; i++) {\n\t\t\t\titem.element.remove();\n\t\t\t\titem.destroy();\n\t\t\t}\n\n\t\t\tthis.children = this.children.slice(0, 1);\n\n\t\t\tthis.dataChanged(\"clear\");\n\t\t}\n\n\t\tthis.propagate(\"clear\");\n\t},\n\n\tdataChanged: function(action, o = {}) {\n\t\to.element = o.element || this.marker;\n\t\treturn this.super.dataChanged.call(this, action, o);\n\t},\n\n\tsave: function() {\n\t\tfor (let item of this.children) {\n\t\t\tif (item.deleted) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t}\n\t\t\telse {\n\t\t\t\titem.unsavedChanges = false;\n\t\t\t}\n\t\t}\n\t},\n\n\tpropagated: [\"save\"],\n\n\tdataRender: function(data) {\n\t\tif (!data) {\n\t\t\treturn;\n\t\t}\n\n\t\tdata = Mavo.toArray(data);\n\n\t\tif (!this.mutable) {\n\t\t\tthis.children.forEach((item, i) => item.render(data && data[i]));\n\t\t}\n\t\telse {\n\t\t\t// First render on existing items\n\t\t\tfor (var i = 0; i < this.children.length; i++) {\n\t\t\t\tif (i < data.length) {\n\t\t\t\t\tthis.children[i].render(data[i]);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthis.children[i].dataChanged(\"delete\");\n\t\t\t\t\tthis.delete(this.children[i], true);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (data.length > i) {\n\t\t\t\t// There are still remaining items\n\t\t\t\t// Using document fragments improves performance by 60%\n\t\t\t\tvar fragment = document.createDocumentFragment();\n\n\t\t\t\tfor (var j = i; j < data.length; j++) {\n\t\t\t\t\tvar item = this.createItem();\n\n\t\t\t\t\titem.render(data[j]);\n\n\t\t\t\t\tthis.children.push(item);\n\t\t\t\t\titem.index = j;\n\n\t\t\t\t\tfragment.appendChild(item.element);\n\n\t\t\t\t\tvar env = {context: this, item};\n\t\t\t\t\tMavo.hooks.run(\"collection-add-end\", env);\n\n\t\t\t\t\titem.dataChanged(\"add\");\n\t\t\t\t}\n\n\t\t\t\tif (this.bottomUp) {\n\t\t\t\t\t$.after(fragment, i > 0? this.children[i-1].element : this.marker);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t$.before(fragment, this.marker);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tfind: function(property, o = {}) {\n\t\tvar items = this.children.filter(item => !item.deleted);\n\n\t\tif (this.property == property) {\n\t\t\treturn o.collections? this : items;\n\t\t}\n\n\t\tif (this.properties.indexOf(property) > -1) {\n\t\t\tvar ret = items.map(item => item.find(property, o));\n\n\t\t\treturn Mavo.flatten(ret);\n\t\t}\n\t},\n\n\tisCompatible: function(c) {\n\t\treturn c && this.itemTemplate.nodeType == c.itemTemplate.nodeType && (c === this\n\t\t       || c.template == this || this.template == c || this.template && this.template == c.template\n\t\t       || this.accepts.indexOf(c.property) > -1);\n\t},\n\n\tlive: {\n\t\tmutable: function(value) {\n\t\t\tif (value && value !== this.mutable) {\n\t\t\t\t// Why is all this code here? Because we want it executed\n\t\t\t\t// every time mutable changes, not just in the constructor\n\t\t\t\t// (think multiple elements with the same property name, where only one has mv-multiple)\n\t\t\t\tthis._mutable = value;\n\n\t\t\t\t// Keep position of the template in the DOM, since we might remove it\n\t\t\t\tthis.marker = document.createComment(\"mv-marker\");\n\t\t\t\tMavo.data(this.marker, \"collection\", this);\n\t\t\t\t$.after(this.marker, this.templateElement);\n\t\t\t}\n\t\t}\n\t},\n\n\t// Make sure to only call after dragula has loaded\n\tgetDragula: function() {\n\t\tif (this.dragula) {\n\t\t\treturn this.dragula;\n\t\t}\n\n\t\tif (this.template) {\n\t\t\tMavo.pushUnique(this.template.getDragula().containers, this.marker.parentNode);\n\t\t\treturn this.dragula = this.template.dragula || this.template.getDragula();\n\t\t}\n\n\t\tvar me = this;\n\t\tthis.dragula = dragula({\n\t\t\tcontainers: [this.marker.parentNode],\n\t\t\tisContainer: el => {\n\t\t\t\tif (this.accepts.length) {\n\t\t\t\t\treturn Mavo.flatten(this.accepts.map(property => this.mavo.root.find(property, {collections: true})))\n\t\t\t\t\t\t\t\t.filter(c => c && c instanceof _)\n\t\t\t\t\t\t\t\t.map(c => c.marker.parentNode)\n\t\t\t\t\t\t\t\t.indexOf(el) > -1;\n\t\t\t\t}\n\n\t\t\t\treturn false;\n\t\t\t},\n\t\t\tmoves: (el, container, handle) => {\n\t\t\t\treturn handle.classList.contains(\"mv-drag-handle\") && handle.closest(Mavo.selectors.multiple) == el;\n\t\t\t},\n\t\t\taccepts: function(el, target, source, next) {\n\t\t\t\tif (el.contains(target)) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tvar previous = next? next.previousElementSibling : target.lastElementChild;\n\n\t\t\t\tvar collection = _.get(previous) || _.get(next);\n\n\t\t\t\tif (!collection) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tvar item = Mavo.Node.get(el);\n\n\t\t\t\treturn item && item.collection.isCompatible(collection);\n\t\t\t}\n\t\t});\n\n\t\tthis.dragula.on(\"drop\", (el, target, source) => {\n\t\t\tvar item = Mavo.Node.get(el);\n\t\t\tvar oldIndex = item && item.index;\n\t\t\tvar next = el.nextElementSibling;\n\t\t\tvar previous = el.previousElementSibling;\n\t\t\tvar collection = _.get(previous) || _.get(next);\n\t\t\tvar closestItem = Mavo.Node.get(previous) || Mavo.Node.get(next);\n\n\t\t\tif (closestItem && closestItem.collection != collection) {\n\t\t\t\tclosestItem = null;\n\t\t\t}\n\n\t\t\tif (item.collection.isCompatible(collection)) {\n\t\t\t\tvar index = closestItem? closestItem.index + (closestItem.element === previous) : collection.length;\n\t\t\t\tcollection.add(item, index);\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturn this.dragula.cancel(true);\n\t\t\t}\n\t\t});\n\n\t\t_.dragulas.push(this.dragula);\n\n\t\treturn this.dragula;\n\t},\n\n\tlazy: {\n\t\tbottomUp: function() {\n\t\t\t/*\n\t\t\t * Add new items at the top or bottom?\n\t\t\t */\n\n\t\t\tif (!this.mutable) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tvar order = this.templateElement.getAttribute(\"mv-order\");\n\t\t\tif (order !== null) {\n\t\t\t\t// Attribute has the highest priority and overrides any heuristics\n\t\t\t\treturn /^desc\\b/i.test(order);\n\t\t\t}\n\n\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\t// If add button not in DOM, do the default\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// If add button is already in the DOM and *before* our template, then we default to prepending\n\t\t\treturn !!(this.addButton.compareDocumentPosition(this.marker) & Node.DOCUMENT_POSITION_FOLLOWING);\n\t\t},\n\n\t\tclosestCollection: function() {\n\t\t\tvar parent = this.marker? this.marker.parentNode : this.templateElement.parentNode;\n\n\t\t\treturn parent.closest(Mavo.selectors.multiple);\n\t\t},\n\n\t\taddButton: function() {\n\t\t\t// Find add button if provided, or generate one\n\t\t\tvar selector = `button.mv-add-${this.property}`;\n\t\t\tvar group = this.closestCollection || this.marker.parentNode.closest(Mavo.selectors.group);\n\n\t\t\tif (group) {\n\t\t\t\tvar button = $$(selector, group).filter(button => {\n\t\t\t\t\treturn !this.templateElement.contains(button);\n\t\t\t\t})[0];\n\t\t\t}\n\n\t\t\tif (!button) {\n\t\t\t\tbutton = $.create(\"button\", {\n\t\t\t\t\tclassName: \"mv-add\",\n\t\t\t\t\ttextContent: \"Add \" + this.name\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tbutton.classList.add(\"mv-ui\", \"mv-add\");\n\t\t\tMavo.data(button, \"collection\", this);\n\n\t\t\tif (this.property) {\n\t\t\t\tbutton.classList.add(`mv-add-${this.property}`);\n\t\t\t}\n\n\t\t\tbutton.addEventListener(\"click\", evt => {\n\t\t\t\tevt.preventDefault();\n\n\t\t\t\tthis.editItem(this.add());\n\t\t\t});\n\n\t\t\treturn button;\n\t\t}\n\t},\n\n\tstatic: {\n\t\tdragulas: [],\n\t\tget: element => {\n\t\t\t// Is it an add button or a marker?\n\t\t\tvar collection = Mavo.data(element, \"collection\");\n\n\t\t\tif (collection) {\n\t\t\t\treturn collection;\n\t\t\t}\n\n\t\t\t// Maybe it's a collection item?\n\t\t\tvar item = Mavo.Node.get(element);\n\n\t\t\treturn item && item.collection || null;\n\t\t},\n\n\t\tlazy: {\n\t\t\tdragula: () => $.include(self.dragula, \"https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.js\")\n\t\t}\n\t}\n});\n\n})(Bliss, Bliss.$);\n"]}