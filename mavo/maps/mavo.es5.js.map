{"version":3,"sources":["domexpression.js"],"names":["$","_","Mavo","DOMExpression","Class","constructor","o","mavo","template","prop","undefined","node","path","reduce","index","childNodes","item","element","attribute","hooks","run","expression","nodeType","parentNode","children","length","normalize","getAttribute","trim","firstChild","whitespace","textContent","match","splitText","after","lastChild","insertBefore","parsed","syntax","tokenize","oldValue","value","map","x","Expression","treeBuilt","then","Node","get","closest","selectors","multiple","group","expressions","elements","set","changedBy","evt","every","expr","update","data","event","env","context","ret","parentEnv","i","eval","Error","fallback","presentational","Array","isArray","join","Primitive","formatNumber","primitive","datatype","output","setValue","static","WeakMap","search","all","arguments","filter","et","Bliss"],"mappings":"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","file":"../mavo.es5.js","sourcesContent":["(function($) {\n\nvar _ = Mavo.DOMExpression = $.Class({\n\tconstructor: function(o = {}) {\n\t\tthis.mavo = o.mavo;\n\t\tthis.template = o.template && o.template.template || o.template;\n\n\t\tfor (let prop of [\"item\", \"path\", \"syntax\", \"fallback\", \"attribute\"]) {\n\t\t\tthis[prop] = o[prop] === undefined && this.template? this.template[prop] : o[prop];\n\t\t}\n\n\t\tthis.node = o.node;\n\n\t\tif (!this.node) {\n\t\t\t// No node provided, figure it out from path\n\t\t\tthis.node = this.path.reduce((node, index) => {\n\t\t\t\treturn node.childNodes[index];\n\t\t\t}, this.item.element);\n\t\t}\n\n\t\tthis.element = this.node;\n\t\tthis.attribute = this.attribute || null;\n\n\t\tMavo.hooks.run(\"domexpression-init-start\", this);\n\n\t\tif (!this.expression) { // Still unhandled?\n\t\t\tif (this.node.nodeType === 3) {\n\t\t\t\tthis.element = this.node.parentNode;\n\n\t\t\t\t// If no element siblings make this.node the element, which is more robust\n\t\t\t\t// Same if attribute, there are no attributes on a text node!\n\t\t\t\tif (!this.node.parentNode.children.length || this.attribute) {\n\t\t\t\t\tthis.node = this.element;\n\t\t\t\t\tthis.element.normalize();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (this.attribute) {\n\t\t\t\tthis.expression = this.node.getAttribute(this.attribute).trim();\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Move whitespace outside to prevent it from messing with types\n\t\t\t\tthis.node.normalize();\n\n\t\t\t\tif (this.node.firstChild && this.node.childNodes.length === 1 && this.node.firstChild.nodeType === 3) {\n\t\t\t\t\tvar whitespace = this.node.firstChild.textContent.match(/^\\s*|\\s*$/g);\n\n\t\t\t\t\tif (whitespace[1]) {\n\t\t\t\t\t\tthis.node.firstChild.splitText(this.node.firstChild.textContent.length - whitespace[1].length);\n\t\t\t\t\t\t$.after(this.node.lastChild, this.node);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (whitespace[0]) {\n\t\t\t\t\t\tthis.node.firstChild.splitText(whitespace[0].length);\n\t\t\t\t\t\tthis.node.parentNode.insertBefore(this.node.firstChild, this.node);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tthis.expression = this.node.textContent;\n\t\t\t}\n\n\n\t\t\tthis.parsed = o.template? o.template.parsed : this.syntax.tokenize(this.expression);\n\t\t}\n\n\t\tthis.oldValue = this.value = this.parsed.map(x => x instanceof Mavo.Expression? x.expression : x);\n\n\t\tthis.mavo.treeBuilt.then(() => {\n\t\t\tif (!this.template) {\n\t\t\t\t// Only collection items and groups can have their own expressions arrays\n\t\t\t\tthis.item = Mavo.Node.get(this.element.closest(Mavo.selectors.multiple + \", \" + Mavo.selectors.group));\n\t\t\t\tthis.item.expressions = [...(this.item.expressions || []), this];\n\t\t\t}\n\n\t\t\tMavo.hooks.run(\"domexpression-init-treebuilt\", this);\n\t\t});\n\n\t\tMavo.hooks.run(\"domexpression-init-end\", this);\n\n\t\t_.elements.set(this.element, [...(_.elements.get(this.element) || []), this]);\n\t},\n\n\tchangedBy: function(evt) {\n\t\treturn !this.parsed.every(expr => !(expr instanceof Mavo.Expression) || !expr.changedBy(evt));\n\t},\n\n\tupdate: function(data = this.data, event) {\n\t\tvar env = {context: this, ret: {}, event};\n\t\tvar parentEnv = env;\n\n\t\tthis.data = data;\n\n\t\tenv.ret = {};\n\n\t\tMavo.hooks.run(\"domexpression-update-start\", env);\n\n\t\tthis.oldValue = this.value;\n\n\t\tenv.ret.value = this.value = this.parsed.map((expr, i) => {\n\t\t\tif (expr instanceof Mavo.Expression) {\n\t\t\t\tif (expr.changedBy(parentEnv.event)) {\n\t\t\t\t\tvar env = {context: this, expr, parentEnv};\n\n\t\t\t\t\tMavo.hooks.run(\"domexpression-update-beforeeval\", env);\n\n\t\t\t\t\tenv.value = env.expr.eval(data);\n\n\t\t\t\t\tMavo.hooks.run(\"domexpression-update-aftereval\", env);\n\n\t\t\t\t\tif (env.value instanceof Error) {\n\t\t\t\t\t\treturn this.fallback !== undefined? this.fallback : env.expr.expression;\n\t\t\t\t\t}\n\t\t\t\t\tif (env.value === undefined || env.value === null) {\n\t\t\t\t\t\t// Don’t print things like \"undefined\" or \"null\"\n\t\t\t\t\t\treturn \"\";\n\t\t\t\t\t}\n\n\t\t\t\t\treturn env.value;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\treturn this.oldValue[i];\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn expr;\n\t\t});\n\n\t\tif (!this.attribute) {\n\t\t\t// Separate presentational & actual values only apply when content is variable\n\t\t\tenv.ret.presentational = this.value.map(value => {\n\t\t\t\tif (Array.isArray(value)) {\n\t\t\t\t\treturn value.join(\", \");\n\t\t\t\t}\n\n\t\t\t\tif (typeof value == \"number\") {\n\t\t\t\t\treturn Mavo.Primitive.formatNumber(value);\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t});\n\n\t\t\tenv.ret.presentational = env.ret.presentational.length === 1? env.ret.presentational[0] : env.ret.presentational.join(\"\");\n\t\t}\n\n\t\tenv.ret.value = env.ret.value.length === 1? env.ret.value[0] : env.ret.value.join(\"\");\n\n\t\tif (this.primitive && this.parsed.length === 1) {\n\t\t\tif (typeof env.ret.value === \"number\") {\n\t\t\t\tthis.primitive.datatype = \"number\";\n\t\t\t}\n\t\t\telse if (typeof env.ret.value === \"boolean\") {\n\t\t\t\tthis.primitive.datatype = \"boolean\";\n\t\t\t}\n\t\t}\n\n\t\tif (env.ret.presentational === env.ret.value) {\n\t\t\tret = env.ret.value;\n\t\t}\n\n\t\tthis.output(env.ret);\n\n\t\tMavo.hooks.run(\"domexpression-update-end\", env);\n\t},\n\n\toutput: function(value) {\n\t\tif (this.primitive) {\n\t\t\tthis.primitive.value = value;\n\t\t}\n\t\telse {\n\t\t\tvalue = value.presentational || value;\n\t\t\tMavo.Primitive.setValue(this.node, value, {attribute: this.attribute});\n\t\t}\n\t},\n\n\tstatic: {\n\t\telements: new WeakMap(),\n\n\t\t/**\n\t\t * Search for Mavo.DOMExpression object(s) associated with a given element\n\t\t * and optionally an attribute.\n\t\t *\n\t\t * @return If one argument, array of matching DOMExpression objects.\n\t\t *         If two arguments, the matching DOMExpression object or null\n\t\t */\n\t\tsearch: function(element, attribute) {\n\t\t\tvar all = _.elements.get(element) || [];\n\n\t\t\tif (arguments.length > 1) {\n\t\t\t\tif (!all.length) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\treturn all.filter(et => et.attribute === attribute)[0] || null;\n\t\t\t}\n\n\t\t\treturn all;\n\t\t}\n\t}\n});\n\n})(Bliss);\n"]}