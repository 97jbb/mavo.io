{"version":3,"sources":["primitive.js"],"names":["$","$$","_","Mavo","Primitive","Class","extends","Node","nodeType","constructor","element","mavo","o","fromTemplate","config","getConfig","attribute","datatype","modes","setAttribute","hooks","run","expressionText","DOMExpression","search","mavoNode","primitive","storage","init","call","changeEvents","events","evt","target","value","getValue","editor","children","filter","el","matches","selectors","formControl","property","textContent","editorValue","remove","hasAttribute","original","getAttribute","is","cloneNode","template","Observer","copies","setValue","force","silent","templateValue","_default","default","undefined","defaultObserver","initialValue","emptyValue","observer","editing","postInit","getEditorValue","output","setEditorValue","editorDefaults","destroy","super","getData","env","context","options","data","live","inPath","length","subset","sneak","callback","save","savedValue","unsavedChanges","initEdit","Elements","defaultEditors","string","create","type","select","stopPropagation","fire","placeholder","label","dataInput","attributes","forEach","test","name","replace","popup","Popup","classList","add","edit","prevTabindex","tabIndex","addEventListener","preventDefault","preEdit","defer","resolve","reject","empty","timer","clearTimeout","setTimeout","then","unbind","show","parentNode","appendChild","done","close","removeAttribute","clear","dataRender","Symbol","toPrimitive","Object","keys","push","closestCollection","find","lazy","Functions","readable","presentational","safeCast","_value","document","activeElement","humanReadable","selectedOptions","dataOnly","saved","dataChanged","action","hide","toggle","static","all","WeakMap","getValueAttribute","ret","existingType","cast","useProperty","e","toggleAttribute","formatNumber","indexOf","namespaceURI","numberFormat","Intl","NumberFormat","maximumFractionDigits","Infinity","format","className","hidden","contents","keyup","keyCode","contains","focus","size","Math","min","shown","hideCallback","position","bounds","getBoundingClientRect","x","left","y","bottom","style","top","body","requestAnimationFrame","window","removeEventListener","parseFloat","getComputedStyle","transitionDuration","proxy","Bliss"],"mappings":"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","file":"../mavo.es5.js","sourcesContent":["(function($, $$) {\n\nvar _ = Mavo.Primitive = $.Class({\n\textends: Mavo.Node,\n\tnodeType: \"Primitive\",\n\tconstructor: function (element, mavo, o) {\n\t\tif (!this.fromTemplate(\"config\", \"attribute\", \"templateValue\")) {\n\t\t\tthis.config = _.getConfig(element);\n\n\t\t\t// Which attribute holds the data, if any?\n\t\t\t// \"null\" or null for none (i.e. data is in content).\n\t\t\tthis.attribute = this.config.attribute;\n\t\t}\n\n\t\tthis.datatype = this.config.datatype;\n\n\t\tif (\"modes\" in this.config) {\n\t\t\t// If modes are related to element type, this overrides everything\n\t\t\t// because it means the other mode makes no sense for that element\n\t\t\tthis.modes = this.config.modes;\n\t\t\tthis.element.setAttribute(\"mv-mode\", this.config.modes);\n\t\t}\n\n\t\tMavo.hooks.run(\"primitive-init-start\", this);\n\n\t\t// Link primitive with its expressionText object\n\t\t// We need to do this before any editing UI is generated\n\t\tthis.expressionText = Mavo.DOMExpression.search(this.element, this.attribute);\n\n\t\tif (this.expressionText && !this.expressionText.mavoNode) {\n\t\t\tthis.expressionText.primitive = this;\n\t\t\tthis.storage = this.storage || \"none\";\n\t\t\tthis.modes = \"read\";\n\t\t}\n\n\t\tif (this.config.init) {\n\t\t\tthis.config.init.call(this, this.element);\n\t\t}\n\n\t\tif (this.config.changeEvents) {\n\t\t\t$.events(this.element, this.config.changeEvents, evt => {\n\t\t\t\tif (evt.target === this.element) {\n\t\t\t\t\tthis.value = this.getValue();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * Set up input widget\n\t\t */\n\n\t\t// Nested widgets\n\t\tif (!this.editor && !this.attribute) {\n\t\t\tthis.editor = $$(this.element.children).filter(function (el) {\n\t\t\t    return el.matches(Mavo.selectors.formControl) && !el.matches(Mavo.selectors.property);\n\t\t\t})[0];\n\n\t\t\tif (this.editor) {\n\t\t\t\tthis.element.textContent = this.editorValue;\n\t\t\t\t$.remove(this.editor);\n\t\t\t}\n\t\t}\n\n\t\t// Linked widgets\n\t\tif (!this.editor && this.element.hasAttribute(\"mv-edit\")) {\n\t\t\tvar original = $(this.element.getAttribute(\"mv-edit\"));\n\n\t\t\tif (original && Mavo.is(\"formControl\", original)) {\n\t\t\t\tthis.editor = original.cloneNode(true);\n\n\t\t\t\t// Update editor if original mutates\n\t\t\t\tif (!this.template) {\n\t\t\t\t\tnew Mavo.Observer(original, \"all\", records => {\n\t\t\t\t\t\tfor (let primitive of this.copies) {\n\t\t\t\t\t\t\tprimitive.editor = original.cloneNode(true);\n\t\t\t\t\t\t\tprimitive.setValue(primitive.value, {force: true, silent: true});\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis.templateValue = this.getValue();\n\n\t\tthis._default = this.element.getAttribute(\"mv-default\");\n\n\t\tif (this.default === null) { // no mv-default\n\t\t\tthis._default = this.modes === \"read\"? this.templateValue : (this.editor? this.editorValue : undefined);\n\t\t}\n\t\telse if (this.default === \"\") { // mv-default exists, no value, default is template value\n\t\t\tthis._default = this.templateValue;\n\t\t}\n\t\telse { // mv-default with value\n\t\t\tthis.defaultObserver = new Mavo.Observer(this.element, \"mv-default\", record => {\n\t\t\t\tthis.default = this.element.getAttribute(\"mv-default\");\n\t\t\t});\n\t\t}\n\n\t\tthis.initialValue = (!this.template && this.default === undefined? this.templateValue : this.default) || this.emptyValue;\n\n\t\tthis.setValue(this.initialValue, {silent: true});\n\n\t\t// Observe future mutations to this property, if possible\n\t\t// Properties like input.checked or input.value cannot be observed that way\n\t\t// so we cannot depend on mutation observers for everything :(\n\t\tthis.observer = new Mavo.Observer(this.element, this.attribute, records => {\n\t\t\tif (this.attribute || !this.editing) {\n\t\t\t\tthis.value = this.getValue();\n\t\t\t}\n\t\t});\n\n\t\tthis.postInit();\n\n\t\tMavo.hooks.run(\"primitive-init-end\", this);\n\t},\n\n\tget editorValue() {\n\t\tif (this.config.getEditorValue) {\n\t\t\treturn this.config.getEditorValue.call(this);\n\t\t}\n\n\t\tif (this.editor) {\n\t\t\tif (this.editor.matches(Mavo.selectors.formControl)) {\n\t\t\t\treturn _.getValue(this.editor, {datatype: this.datatype});\n\t\t\t}\n\n\t\t\t// if we're here, this.editor is an entire HTML structure\n\t\t\tvar output = $(Mavo.selectors.output + \", \" + Mavo.selectors.formControl, this.editor);\n\n\t\t\tif (output) {\n\t\t\t\treturn _.getValue(output);\n\t\t\t}\n\t\t}\n\t},\n\n\tset editorValue(value) {\n\t\tif (this.config.setEditorValue) {\n\t\t\treturn this.config.setEditorValue.call(this, value);\n\t\t}\n\n\t\tif (this.editor) {\n\t\t\tif (this.editor.matches(Mavo.selectors.formControl)) {\n\t\t\t\t_.setValue(this.editor, value, {config: this.editorDefaults});\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// if we're here, this.editor is an entire HTML structure\n\t\t\t\tvar output = $(Mavo.selectors.output + \", \" + Mavo.selectors.formControl, this.editor);\n\n\t\t\t\tif (output) {\n\t\t\t\t\t_.setValue(output, value);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tdestroy: function() {\n\t\tthis.super.destroy.call(this);\n\n\t\tthis.defaultObserver && this.defaultObserver.destroy();\n\t\tthis.observer && this.observer.destroy();\n\t},\n\n\tgetData: function(o = {}) {\n\t\tvar env = {\n\t\t\tcontext: this,\n\t\t\toptions: o,\n\t\t\tdata: this.super.getData.call(this, o)\n\t\t};\n\n\t\tif (env.data !== undefined) {\n\t\t\treturn env.data;\n\t\t}\n\n\t\tenv.data = this.value;\n\n\t\tif (env.data === \"\") {\n\t\t\tenv.data = null;\n\t\t}\n\n\t\tif (!o.live && this.inPath.length) {\n\t\t\tenv.data = Mavo.subset(this.data, this.inPath, env.data);\n\t\t}\n\n\t\tMavo.hooks.run(\"node-getdata-end\", env);\n\n\t\treturn env.data;\n\t},\n\n\tsneak: function(callback) {\n\t\treturn Mavo.Observer.sneak(this.observer, callback);\n\t},\n\n\tsave: function() {\n\t\tthis.savedValue = this.value;\n\t\tthis.unsavedChanges = false;\n\t},\n\n\t// Called only the first time this primitive is edited\n\tinitEdit: function () {\n\t\tif (!this.editor) {\n\t\t\t// No editor provided, use default for element type\n\t\t\t// Find default editor for datatype\n\t\t\tvar editor = this.config.editor || Mavo.Elements.defaultEditors[this.datatype] || Mavo.Elements.defaultEditors.string;\n\n\t\t\tthis.editor = $.create($.type(editor) === \"function\"? editor.call(this) : editor);\n\t\t\tthis.editorValue = this.value;\n\t\t}\n\n\t\t$.events(this.editor, {\n\t\t\t\"input change\": evt => {\n\t\t\t\tthis.value = this.editorValue;\n\t\t\t},\n\t\t\t\"focus\": evt => {\n\t\t\t\tthis.editor.select && this.editor.select();\n\t\t\t},\n\t\t\t\"mavo:datachange\": evt => {\n\t\t\t\tif (evt.property === \"output\") {\n\t\t\t\t\tevt.stopPropagation();\n\t\t\t\t\t$.fire(this.editor, \"input\");\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tif (\"placeholder\" in this.editor) {\n\t\t\tthis.editor.placeholder = \"(\" + this.label + \")\";\n\t\t}\n\n\t\t// Copy any data-input-* attributes from the element to the editor\n\t\tvar dataInput = /^mv-edit-/i;\n\t\t$$(this.element.attributes).forEach(function (attribute) {\n\t\t\tif (dataInput.test(attribute.name)) {\n\t\t\t\tthis.editor.setAttribute(attribute.name.replace(dataInput, \"\"), attribute.value);\n\t\t\t}\n\t\t}, this);\n\n\t\tif (this.attribute || this.config.popup) {\n\t\t\tthis.popup = new _.Popup(this);\n\t\t}\n\n\t\tif (!this.popup) {\n\t\t\tthis.editor.classList.add(\"mv-editor\");\n\t\t}\n\n\t\tthis.initEdit = null;\n\t},\n\n\tedit: function () {\n\t\tif (this.super.edit.call(this) === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// Make element focusable, so it can actually receive focus\n\t\tthis.element._.data.prevTabindex = this.element.getAttribute(\"tabindex\");\n\t\tthis.element.tabIndex = 0;\n\n\t\t// Prevent default actions while editing\n\t\t// e.g. following links etc\n\t\tthis.element.addEventListener(\"click.mavo:edit\", evt => evt.preventDefault());\n\n\t\tthis.preEdit = Mavo.defer((resolve, reject) => {\n\t\t\t// Empty properties should become editable immediately\n\t\t\t// otherwise they could be invisible!\n\t\t\tif (this.empty && !this.attribute) {\n\t\t\t\treturn resolve();\n\t\t\t}\n\n\t\t\tvar timer;\n\n\t\t\t$.events(this.element, {\n\t\t\t\t\"click.mavo:preedit\": resolve,\n\t\t\t\t\"focus.mavo:preedit\": resolve\n\t\t\t});\n\n\t\t\tif (!this.attribute) {\n\t\t\t\t// Hovering over the element for over 150ms will trigger edit\n\t\t\t\t$.events(this.element, {\n\t\t\t\t\t\"mouseenter.mavo:preedit\": e => {\n\t\t\t\t\t\tclearTimeout(timer);\n\t\t\t\t\t\ttimer = setTimeout(resolve, 150);\n\t\t\t\t\t},\n\t\t\t\t\t\"mouseleave.mavo:preedit\": e => {\n\t\t\t\t\t\tclearTimeout(timer);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t}).then(() => $.unbind(this.element, \".mavo:preedit\"));\n\n\t\tif (this.config.edit) {\n\t\t\tthis.config.edit.call(this);\n\t\t\treturn;\n\t\t}\n\n\t\tthis.preEdit.then(() => {\n\t\t\t// Actual edit\n\t\t\tif (this.initEdit) {\n\t\t\t\tthis.initEdit();\n\t\t\t}\n\n\t\t\tif (this.popup) {\n\t\t\t\tthis.popup.show();\n\t\t\t}\n\n\t\t\tif (!this.attribute && !this.popup) {\n\t\t\t\tif (this.editor.parentNode != this.element) {\n\t\t\t\t\tthis.editorValue = this.value;\n\t\t\t\t\tthis.element.textContent = \"\";\n\n\t\t\t\t\tthis.element.appendChild(this.editor);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}, // edit\n\n\tdone: function () {\n\t\tif (this.super.done.call(this) === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (\"preEdit\" in this) {\n\t\t\t$.unbind(this.element, \".mavo:preedit .mavo:edit\");\n\t\t}\n\n\t\tthis.sneak(() => {\n\t\t\tif (this.config.done) {\n\t\t\t\tthis.config.done.call(this);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (this.popup) {\n\t\t\t\tthis.popup.close();\n\t\t\t}\n\t\t\telse if (!this.attribute && this.editor) {\n\t\t\t\t$.remove(this.editor);\n\t\t\t\tthis.element.textContent = this.editorValue;\n\t\t\t}\n\t\t});\n\n\t\t// Revert tabIndex\n\t\tif (this.element._.data.prevTabindex !== null) {\n\t\t\tthis.element.tabIndex = this.element._.data.prevTabindex;\n\t\t}\n\t\telse {\n\t\t\tthis.element.removeAttribute(\"tabindex\");\n\t\t}\n\t},\n\n\tclear: function() {\n\t\tthis.value = this.templateValue;\n\t},\n\n\tdataRender: function(data) {\n\t\tif (data && typeof data === \"object\") {\n\t\t\tif (Symbol.toPrimitive in data) {\n\t\t\t\tdata = data[Symbol.toPrimitive]();\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Candidate properties to get a value from\n\t\t\t\tfor (let property of [this.property, \"value\", ...Object.keys(data)]) {\n\t\t\t\t\tif (property in data) {\n\t\t\t\t\t\tdata = data[property];\n\t\t\t\t\t\tthis.inPath.push(property);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (data === undefined) {\n\t\t\t// New property has been added to the schema and nobody has saved since\n\t\t\tif (this.modes != \"read\") {\n\t\t\t\tthis.value = this.closestCollection? this.default : this.templateValue;\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tthis.value = data;\n\t\t}\n\t},\n\n\tfind: function(property) {\n\t\tif (this.property == property) {\n\t\t\treturn this;\n\t\t}\n\t},\n\n\t/**\n\t * Get value from the DOM\n\t */\n\tgetValue: function(o) {\n\t\treturn _.getValue(this.element, {\n\t\t\tconfig: this.config,\n\t\t\tattribute: this.attribute,\n\t\t\tdatatype: this.datatype\n\t\t});\n\t},\n\n\tlazy: {\n\t\tlabel: function() {\n\t\t\treturn Mavo.Functions.readable(this.property);\n\t\t},\n\n\t\temptyValue: function() {\n\t\t\tswitch (this.datatype) {\n\t\t\t\tcase \"boolean\":\n\t\t\t\t\treturn false;\n\t\t\t\tcase \"number\":\n\t\t\t\t\treturn 0;\n\t\t\t}\n\n\t\t\treturn \"\";\n\t\t},\n\n\t\teditorDefaults: function() {\n\t\t\treturn this.editor && _.getConfig(this.editor);\n\t\t}\n\t},\n\n\tsetValue: function (value, o = {}) {\n\t\tthis.sneak(() => {\n\t\t\tif ($.type(value) == \"object\" && \"value\" in value) {\n\t\t\t\tvar presentational = value.presentational;\n\t\t\t\tvalue = value.value;\n\t\t\t}\n\n\t\t\t// Convert nulls and undefineds to empty string\n\t\t\tvalue = value || value === 0? value : \"\";\n\n\t\t\t// If there's no datatype, adopt that of the value\n\t\t\tif (!this.datatype && (typeof value == \"number\" || typeof value == \"boolean\")) {\n\t\t\t\tthis.datatype = typeof value;\n\t\t\t}\n\n\t\t\tvalue = _.safeCast(value, this.datatype);\n\n\t\t\tif (value == this._value && !o.force) {\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\tif (this.editor && document.activeElement != this.editor) {\n\t\t\t\tthis.editorValue = value;\n\t\t\t}\n\n\t\t\tif (this.config.humanReadable && this.attribute) {\n\t\t\t\tpresentational = this.config.humanReadable.call(this, value);\n\t\t\t}\n\n\t\t\tif (!this.editing || this.popup || !this.editor) {\n\t\t\t\tif (this.config.setValue) {\n\t\t\t\t\tthis.config.setValue.call(this, this.element, value);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tif (this.editor && this.editor.matches(\"select\") && this.editor.selectedOptions[0]) {\n\t\t\t\t\t\tpresentational = this.editor.selectedOptions[0].textContent;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!o.dataOnly) {\n\t\t\t\t\t\t_.setValue(this.element, {value, presentational}, {\n\t\t\t\t\t\t\tconfig: this.config,\n\t\t\t\t\t\t\tattribute: this.attribute,\n\t\t\t\t\t\t\tdatatype: this.datatype\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.empty = value === \"\";\n\n\t\t\tthis._value = value;\n\n\t\t\tif (!o.silent) {\n\t\t\t\tif (this.saved) {\n\t\t\t\t\tthis.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t\t\t}\n\n\t\t\t\tthis.dataChanged(\"propertychange\", {value});\n\t\t\t}\n\t\t});\n\n\t\treturn value;\n\t},\n\n\tdataChanged: function(action = \"propertychange\", o) {\n\t\treturn this.super.dataChanged.call(this, action, o);\n\t},\n\n\tlive: {\n\t\tdefault: function (value) {\n\t\t\tif (this.value == this._default) {\n\n\t\t\t\tthis.value = value;\n\t\t\t}\n\t\t},\n\n\t\tvalue: function (value) {\n\t\t\treturn this.setValue(value);\n\t\t},\n\n\t\tempty: function (value) {\n\t\t\tvar hide = value && // is empty\n\t\t\t           !this.modes && // and supports both modes\n\t\t\t\t\t   this.config.default && // and using the default settings\n\t\t\t           !(this.attribute && $(Mavo.selectors.property, this.element)); // and has no property inside\n\n\t\t\tthis.element.classList.toggle(\"mv-empty\", !!hide);\n\t\t}\n\t},\n\n\tstatic: {\n\t\tall: new WeakMap(),\n\n\t\tgetValueAttribute: function (element, config = Mavo.Elements.search(element)) {\n\t\t\tvar ret = element.getAttribute(\"mv-attribute\") || config.attribute;\n\n\t\t\tif (!ret || ret === \"null\") {\n\t\t\t\tret = null;\n\t\t\t}\n\n\t\t\treturn ret;\n\t\t},\n\n\t\t/**\n\t\t * Only cast if conversion is lossless\n\t\t */\n\t\tsafeCast: function(value, datatype) {\n\t\t\tvar existingType = typeof value;\n\t\t\tvar cast = _.cast(value, datatype);\n\n\t\t\tif (value === null || value === undefined) {\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\tif (datatype == \"boolean\") {\n\t\t\t\tif (value === \"false\" || value === 0 || value === \"\") {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tif (value === \"true\" || value > 0) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\tif (datatype == \"number\") {\n\t\t\t\tif (/^[-+]?[0-9.e]+$/i.test(value + \"\")) {\n\t\t\t\t\treturn cast;\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\treturn cast;\n\t\t},\n\n\t\t/**\n\t\t * Cast to a different primitive datatype\n\t\t */\n\t\tcast: function(value, datatype) {\n\t\t\tswitch (datatype) {\n\t\t\t\tcase \"number\": return +value;\n\t\t\t\tcase \"boolean\": return !!value;\n\t\t\t\tcase \"string\": return value + \"\";\n\t\t\t}\n\n\t\t\treturn value;\n\t\t},\n\n\t\tgetValue: function (element, { config, attribute, datatype }) {\n\t\t\tif (!config) {\n\t\t\t\tconfig = _.getConfig(element, attribute);\n\t\t\t}\n\n\t\t\tattribute = config.attribute;\n\t\t\tdatatype = config.datatype;\n\n\t\t\tif (config.getValue && attribute == config.attribute) {\n\t\t\t\treturn config.getValue(element);\n\t\t\t}\n\n\t\t\tvar ret;\n\n\t\t\tif (attribute in element && _.useProperty(element, attribute)) {\n\t\t\t\t// Returning properties (if they exist) instead of attributes\n\t\t\t\t// is needed for dynamic elements such as checkboxes, sliders etc\n\t\t\t\tret = element[attribute];\n\t\t\t}\n\t\t\telse if (attribute) {\n\t\t\t\tret = element.getAttribute(attribute);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tret = element.getAttribute(\"content\") || element.textContent || null;\n\t\t\t}\n\n\t\t\treturn _.safeCast(ret, datatype);\n\t\t},\n\n\t\tgetConfig: function(element, attribute) {\n\t\t\tif (attribute === undefined) {\n\t\t\t\tattribute = element.getAttribute(\"mv-attribute\") || undefined;\n\t\t\t}\n\n\t\t\tif (attribute == \"null\" || attribute == \"none\") {\n\t\t\t\tattribute = null;\n\t\t\t}\n\n\t\t\tvar config = Mavo.Elements.search(element, attribute);\n\n\t\t\tif (config.attribute === undefined) {\n\t\t\t\tconfig.attribute = attribute || null;\n\t\t\t}\n\n\t\t\treturn config;\n\t\t},\n\n\t\tsetValue: function (element, value, {config, attribute, datatype}) {\n\t\t\tif ($.type(value) == \"object\" && \"value\" in value) {\n\t\t\t\tvar presentational = value.presentational;\n\t\t\t\tvalue = value.value;\n\t\t\t}\n\n\t\t\tif (element.nodeType === 1) {\n\t\t\t\tif (!config) {\n\t\t\t\t\tconfig = _.getConfig(element, attribute);\n\t\t\t\t}\n\n\t\t\t\tattribute = config.attribute;\n\n\t\t\t\tdatatype = datatype !== undefined? datatype : config.datatype;\n\n\t\t\t\tif (config.setValue && attribute == config.attribute) {\n\t\t\t\t\treturn config.setValue(element, value);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (attribute) {\n\t\t\t\tif (attribute in element && _.useProperty(element, attribute) && element[attribute] !== value) {\n\t\t\t\t\t// Setting properties (if they exist) instead of attributes\n\t\t\t\t\t// is needed for dynamic elements such as checkboxes, sliders etc\n\t\t\t\t\ttry {\n\t\t\t\t\t\telement[attribute] = value;\n\t\t\t\t\t}\n\t\t\t\t\tcatch (e) {}\n\t\t\t\t}\n\n\t\t\t\t// Set attribute anyway, even if we set a property because when\n\t\t\t\t// they're not in sync it gets really fucking confusing.\n\t\t\t\tif (datatype == \"boolean\") {\n\t\t\t\t\tif (value != element.hasAttribute(attribute)) {\n\t\t\t\t\t\t$.toggleAttribute(element, attribute, value, value);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse if (element.getAttribute(attribute) != value) {  // intentionally non-strict, e.g. \"3.\" !== 3\n\t\t\t\t\telement.setAttribute(attribute, value);\n\n\t\t\t\t\tif (presentational) {\n\t\t\t\t\t\telement.textContent = presentational;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif (datatype === \"number\" && !presentational) {\n\t\t\t\t\tpresentational = _.formatNumber(value);\n\t\t\t\t}\n\n\t\t\t\telement.textContent = presentational || value;\n\n\t\t\t\tif (presentational && element.setAttribute) {\n\t\t\t\t\telement.setAttribute(\"content\", value);\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\n\t\t/**\n\t\t *  Set/get a property or an attribute?\n\t\t * @return {Boolean} true to use a property, false to use the attribute\n\t\t */\n\t\tuseProperty: function(element, attribute) {\n\t\t\tif ([\"href\", \"src\"].indexOf(attribute) > -1) {\n\t\t\t\t// URL properties resolve \"\" as location.href, fucking up emptiness checks\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tif (element.namespaceURI == \"http://www.w3.org/2000/svg\") {\n\t\t\t\t// SVG has a fucked up DOM, do not use these properties\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn true;\n\t\t},\n\n\t\tlazy: {\n\t\t\tformatNumber: () => {\n\t\t\t\tvar numberFormat = new Intl.NumberFormat(\"en-US\", {maximumFractionDigits:2});\n\n\t\t\t\treturn function(value) {\n\t\t\t\t\tif (value === Infinity || value === -Infinity) {\n\t\t\t\t\t\t// Pretty print infinity\n\t\t\t\t\t\treturn value < 0? \"-∞\" : \"∞\";\n\t\t\t\t\t}\n\n\t\t\t\t\treturn numberFormat.format(value);\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t}\n});\n\n_.Popup = $.Class({\n\tconstructor: function(primitive) {\n\t\tthis.primitive = primitive;\n\n\t\tthis.popup = $.create(\"div\", {\n\t\t\tclassName: \"mv-popup\",\n\t\t\thidden: true,\n\t\t\tcontents: [\n\t\t\t\tthis.primitive.label + \":\",\n\t\t\t\tthis.editor\n\t\t\t],\n\t\t\tevents: {\n\t\t\t\tkeyup: evt => {\n\t\t\t\t\tif (evt.keyCode == 13 || evt.keyCode == 27) {\n\t\t\t\t\t\tif (this.popup.contains(document.activeElement)) {\n\t\t\t\t\t\t\tthis.element.focus();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tevt.stopPropagation();\n\t\t\t\t\t\tthis.hide();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\t// No point in having a dropdown in a popup\n\t\tif (this.editor.matches(\"select\")) {\n\t\t\tthis.editor.size = Math.min(10, this.editor.children.length);\n\t\t}\n\t},\n\n\tshow: function() {\n\t\t$.unbind([this.element, this.popup], \".mavo:showpopup\");\n\n\t\tthis.shown = true;\n\n\t\tthis.hideCallback = evt => {\n\t\t\tif (!this.popup.contains(evt.target) && !this.element.contains(evt.target)) {\n\t\t\t\tthis.hide();\n\t\t\t}\n\t\t};\n\n\t\tthis.position = evt => {\n\t\t\tvar bounds = this.element.getBoundingClientRect();\n\t\t\tvar x = bounds.left;\n\t\t\tvar y = bounds.bottom;\n\n\t\t\t // TODO what if it doesn’t fit?\n\t\t\t$.style(this.popup, { top:  `${y}px`, left: `${x}px` });\n\t\t};\n\n\t\tthis.position();\n\n\t\tdocument.body.appendChild(this.popup);\n\n\t\trequestAnimationFrame(e => this.popup.removeAttribute(\"hidden\")); // trigger transition\n\n\t\t$.events(document, \"focus click\", this.hideCallback, true);\n\t\twindow.addEventListener(\"scroll\", this.position);\n\t},\n\n\thide: function() {\n\t\t$.unbind(document, \"focus click\", this.hideCallback, true);\n\t\twindow.removeEventListener(\"scroll\", this.position);\n\t\tthis.popup.setAttribute(\"hidden\", \"\"); // trigger transition\n\t\tthis.shown = false;\n\n\t\tsetTimeout(() => {\n\t\t\t$.remove(this.popup);\n\t\t}, parseFloat(getComputedStyle(this.popup).transitionDuration) * 1000 || 400); // TODO transition-duration could override this\n\n\t\t$.events(this.element, {\n\t\t\t\"click.mavo:showpopup\": evt => {\n\t\t\t\tthis.show();\n\t\t\t},\n\t\t\t\"keyup.mavo:showpopup\": evt => {\n\t\t\t\tif ([13, 113].indexOf(evt.keyCode) > -1) { // Enter or F2\n\t\t\t\t\tthis.show();\n\t\t\t\t\tthis.editor.focus();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t},\n\n\tclose: function() {\n\t\tthis.hide();\n\t\t$.unbind(this.element, \".mavo:edit .mavo:preedit .mavo:showpopup\");\n\t},\n\n\tproxy: {\n\t\t\"editor\": \"primitive\",\n\t\t\"element\": \"primitive\"\n\t}\n});\n\n})(Bliss, Bliss.$);\n"]}