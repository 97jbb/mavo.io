$primitive: "[itemprop]:not([itemscope]), [property]:not([typeof])";
$property: "[itemprop], [property]";

/// Mixin to prefix several properties at once
/// @author Hugo Giraudel
/// @param {Map} $declarations - Declarations to prefix
/// @param {List} $prefixes (()) - List of prefixes to print
@mixin prefix($declarations, $prefixes: ()) {
	@each $property, $value in $declarations {
	@each $prefix in $prefixes {
		#{'-' + $prefix + '-' + $property}: $value;
	}

	// Output standard non-prefixed declaration
	#{$property}: $value;
	}
}

[data-store] {
	// Unprocessed items
	display: none;
}

.wysie-item-controls {
	all: initial;
	position: absolute;
	bottom: 100%;
	bottom: calc(100% - 1.1em);
	right: .1em;
	z-index: 10;
	@include prefix((filter: drop-shadow(0 .1em .1em rgba(0,0,0,.2))), webkit);
	opacity: 0;
	pointer-events: none;
	border: solid transparent;
	border-width: .4em .5em .8em .5em;
	border-radius: 1em;

	.wysie-item:hover:not(.has-hovered-item) > &,
	.wysie-item:focus > &,
	.wysie-item.focus-within:not(:hover) > &,
	&:hover,
	.wysie-item:not(:hover) > &:focus,
	.wysie-item:not(:hover) > &.focus-within {
		transition: .4s opacity;
		opacity: 1;
		pointer-events: auto;
	}

	button {
		all: unset;
		display: inline-block;
		vertical-align: middle;
		padding: .2em .3em;
		min-width: 1em;
		min-height: 1em;
		border: 1px solid rgba(0,0,0, .1);
		cursor: pointer;
		background: #eee no-repeat center;
		line-height: 1;
		font-size: 120%;
		text-align: center;

		&:not(:hover):not(:focus) {
			box-shadow: 0 .4em 1em white inset;
		}

		$radius: .3em;

		&:first-child {
			border-top-left-radius: $radius;
			border-bottom-left-radius: $radius;
		}

		&:last-child {
			border-top-right-radius: $radius;
			border-bottom-right-radius: $radius;
		}

		&:not(:first-child) {
			border-left: 0;
		}
	}

	.delete {
		$color: rgb(200,0,0);
		color: $color;

		&::before {
			content: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 100 125" fill="rgb(200,0,0)">
				<path d="M65,15.437V8c0-3.86-3.141-7-7-7H42c-3.86,0-7,3.14-7,7v7.437C14.017,16.816,14,21,14,21v10h72V21 C86,21,85.982,16.816,65,15.437z M43,9h14v6.086C54.828,15.032,52.51,15,50,15c-2.51,0-4.828,0.032-7,0.086V9z"/>
				<path d="M19,37l6,62h50l6-62H19z M35.167,88.995C35.11,88.998,35.053,89,34.998,89c-1.581,0-2.904-1.236-2.993-2.834l-2-36  c-0.092-1.654,1.175-3.07,2.829-3.162c1.663-0.089,3.07,1.175,3.162,2.829l2,36C38.087,87.488,36.821,88.903,35.167,88.995z M53,86
						 c0,1.657-1.343,3-3,3c-1.657,0-3-1.343-3-3V50c0-1.657,1.343-3,3-3c1.657,0,3,1.343,3,3V86z M67.995,86.166  C67.906,87.764,66.583,89,65.003,89c-0.057,0-0.112-0.002-0.169-0.005c-1.654-0.092-2.921-1.507-2.829-3.161l2-36
						 c0.093-1.655,1.533-2.906,3.161-2.829c1.654,0.092,2.921,1.508,2.829,3.162L67.995,86.166z"/>
			</svg>');
			display: block;
			height: 1em;
		}

		&:hover {
			background-color: $color;
			color: white;

			&::before {
				@include prefix((filter: saturate(0) brightness(600%)), webkit);
			}
		}
	}

	.add {
		$color: hsl(80, 80%, 40%);

		color: $color;

		&::before {
			content: "âœš";
		}

		&:hover {
			background-color: $color;
			color: white;
		}
	}

	.wysie-wrapper:not(.can-delete) & .delete,
	.wysie-wrapper:not(.can-add) & .add {
		display: none;
	}
}

.wysie-item {
	position: relative;

	&.delete-hover { // basically &:has(> .delete:hover)
		box-shadow: 0 0 0 50vmax hsla(0,100%,50%,.1) inset !important;
		border-radius: .1em;
	}

	&.deleted {
		display: none;
	}
}

.wysie-wrapper {


	button.add {
		display: inline-block;
		//margin-left: .5em;
		vertical-align: middle;
	}

	&:not(.can-add) button.add {
		display: none;
	}

	.wysie-popup {
		all: initial;
		position: absolute;
		z-index: 2;
		padding: 1em;
		border: 1px solid rgba(0,0,0,.3);
		border-radius: .4em;
		margin: .3em 0 0 -.5em;
		box-shadow: 0 .1em .3em rgba(0,0,0,.3);
		background: white;
		transform-origin: -1.4em -0.45em; // Magic numbers. No idea why.
		transition: .3s transform;

		&::before {
			content: "";
			position: absolute;
			top: -.36em;
			left: 1em;
			padding: .3em;
			border: inherit;
			border-right-width: 0;
			border-bottom-width: 0;
			background: inherit;
			transform: rotate(45deg)
		}

		&[hidden] {
			display: block;
			transform: scale(0);
		}

		input, select {
			display: block;
			font: inherit;
			min-width: 100%;
		}

		select[size] {
			border: 1px solid rgba(0,0,0,.2);
		}

		.image-popup {
			.image-preview {
				position: relative;
				display: inline-block;

				progress {
					position: absolute;
					left: 0;
					right: 0;
					bottom: 1em;
					width: 100%;

					&[value="0"],
					&[value="100"] {
						display: none;
					}
				}

				img {
 					display: block;
					max-width: 100%;
				}
			}

			.upload {
				display: block;
				margin: .8em 0;
			}

			.tip {
				font-size: 70%;
				color: gray;
			}
		}
	}

	&:not(.can-edit) {
		.edit, [data-editing], .add {
			display: none;
		}
	}

	.progress {
		margin-top: .5em;
		font-size: 80%;

		&::before {
			content: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 40 40">\
				<style>\
					@keyframes dasharray { 50% { stroke-dasharray: 0 100 100 } to { stroke-dasharray: 100 100 100 } } \
					circle { \
						fill: none; \
						stroke: currentColor; stroke-width: 8; stroke-opacity: .6; stroke-dasharray: 0 0 100; \
						animation: dasharray 2s infinite; \
					} \
				</style>\
				<circle r="16" cx="50%" cy="50%" transform="rotate(-90, 20, 20)" /></svg>');
			display: inline-block;
			vertical-align: middle;
			margin-right: .2em;
		}
	}

	&:not([data-editing]) {
		.empty,
		.wysie-item-controls,
		button.add,
		.save,
		.cancel {
			display: none;
		}
	}

	&[data-editing] {
		.edit {
			display: none;
		}

		.empty {
			opacity: .5;
		}

		// Temporary, good for debugging keyboard usability
		#{$property},
		.wysie-editor,
		.wysie-popup,
		.wysie-item,
		.wysie-item-controls * {
			&:focus {
				outline: 3px solid #f06 !important;
			}
		}

		// Primitives
		#{$primitive} {
			&:hover {
				$color: hsla(58, 100%, 50%, .2);

				box-shadow: 0 0 0 2px $color, 0 0 0 99em $color inset;
			}

			&:focus,
			.wysie-editor:focus {
				outline: 1px dashed hsla(200,50%,40%,.6);
				outline-offset: 1px;
			}

			input.wysie-editor,
			select.wysie-editor,
			textarea.wysie-editor {
				all: initial;
				font: inherit;
				color: inherit;
				text-decoration: inherit;
				text-align: inherit;
			}

			textarea.wysie-editor {
				box-sizing: border-box;
				width: 100%;
			}

			input.wysie-editor {
				max-width: 100%;
			}
		}
	}
}

.wysie-bar {
	all: initial;
	position: fixed;
	z-index: 99999; // this is wrong, but must override other wrong things :(
	color: white;
	font-family: inherit;
	font-size: 1rem;

	// Bar fixed at the top of the screen
	.wysie-wrapper.can-logout &,
	.wysie-wrapper[data-editing] & {
		top: 0;
		left: 0;
		right: 0;
		display: flex;
		padding: 0 .5em 0 6em;
		background: black;
		background: url("logo-small.svg") .5em .15em / auto 100% no-repeat, linear-gradient(hsla(0,0%,10%,.9), black);
	}

	// Floating bar, intended for when there is only 1 button
	.wysie-wrapper.can-login:not([data-editing]) &,
	.wysie-wrapper.can-edit:not(.can-login):not(.can-logout):not([data-editing]) & {
		top: 1em;
		right: 1em;

		&:not(:hover):not(:focus) {
			opacity: .6;
		}

		button, .button {
			border-radius: .3em;
			border: 1px solid black;
			background: rgba(0,0,0,.8);
		}

		.status {
			display: none;
		}
	}

	button, .button {
		padding: .3em .6em .4em;
		border: 0;
		background: transparent;
		font: inherit;
		font-weight: bold;
		color: inherit;
		cursor: pointer;

		&:hover {
			background: hsla(0,0%,100%,.2);
		}

		.icon {
			color: hsla(0,0%,100%,.5);
		}
	}

	a.button {
		text-decoration: none;
	}

	.edit:hover {

	}

	.save:hover {
		background: hsl(80, 80%, 40%);
	}

	.cancel:hover {
		background: #c00;
	}

	.status {
		flex: 1;
		line-height: 1.8;
	}

	.logout {
		margin-left: .6em;
	}

	.status:empty {
		content: "Not logged in";
	}
}
