"use strict";function safeval(expr,vars){for(var variable in vars)eval("var "+variable+" = "+JSON.stringify(vars[variable]));try{return eval(expr)}catch(e){return"ERROR!"}}!function(){function e(e,t){return e instanceof Node||e instanceof Window?[e]:[].slice.call("string"==typeof e?(t||document).querySelectorAll(e):e||[])}if(self.Element&&(Element.prototype.matches||(Element.prototype.matches=Element.prototype.webkitMatchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||null),Element.prototype.matches)){var t=self.Stretchy={selectors:{base:'textarea, select:not([size]), input:not([type]), input[type="'+"text url email tel".split(" ").join('"], input[type="')+'"]',filter:"*"},script:document.currentScript||e("script").pop(),resize:function(e){if(t.resizes(e)){var i=getComputedStyle(e),s=0;if(!e.value&&e.placeholder){var n=!0;e.value=e.placeholder}var r=e.nodeName.toLowerCase();if("textarea"==r)e.style.height="0","border-box"==i.boxSizing?s=e.offsetHeight:"content-box"==i.boxSizing&&(s=-e.clientHeight),
e.style.height=e.scrollHeight+s+"px";else if("input"==r){e.style.width="0","border-box"==i.boxSizing?s=e.offsetWidth:"padding-box"==i.boxSizing&&(s=e.clientWidth),e.scrollLeft=1e10;var o=Math.max(e.scrollLeft+s,e.scrollWidth-e.clientWidth);e.style.width=o+"px"}else if("select"==r){var a=document.createElement("_");a.textContent=e.options[e.selectedIndex].textContent,e.parentNode.insertBefore(a,e.nextSibling);var c;for(var u in i)/^(width|webkitLogicalWidth)$/.test(u)||(a.style[u]=i[u],/appearance$/i.test(u)&&(c=u));a.style.width="",a.offsetWidth>0&&(e.style.width=a.offsetWidth+"px",i[c]&&"none"===i[c]||(e.style.width="calc("+e.style.width+" + 2em)")),a.parentNode.removeChild(a),a=null}n&&(e.value="")}},resizeAll:function(i){e(i||t.selectors.base).forEach(function(e){t.resize(e)})},active:!0,resizes:function(e){return e&&e.parentNode&&e.matches&&e.matches(t.selectors.base)&&e.matches(t.selectors.filter)},init:function(){t.selectors.filter=t.script.getAttribute("data-filter")||(e("[data-stretchy-filter]").pop()||document.body).getAttribute("data-stretchy-filter")||Stretchy.selectors.filter||"*",
t.resizeAll()},$$:e};"loading"!==document.readyState?t.init():document.addEventListener("DOMContentLoaded",t.init);var i=function(e){t.active&&t.resize(e.target)};document.body.addEventListener("input",i),document.body.addEventListener("change",i),self.MutationObserver&&new MutationObserver(function(e){t.active&&e.forEach(function(e){"childList"==e.type&&Stretchy.resizeAll(e.addedNodes)})}).observe(document.body,{childList:!0,subtree:!0})}}(),function(e,t){var i=self.Wysie=e.Class({constructor:function(s){var n=this;i.all.push(this);var r=s.getAttribute("data-store")||"none";if(this.store="none"===r?null:new URL(r||this.id,location),this.id=s.id||"wysie-"+i.all.length,this.element=i.is("scope",s)?s:e(i.selectors.scope,s),this.element||(s.setAttribute("typeof",s.getAttribute("property")||""),s.removeAttribute("property"),this.element=s),this.element.classList.add("wysie-root"),t(i.selectors.property+", "+i.selectors.scope).concat([this.element]).forEach(function(e){i.is("autoMultiple",e)&&!e.hasAttribute("data-multiple")&&e.setAttribute("data-multiple","");
}),this.wrapper=s.closest(".wysie-wrapper")||s,this.wrapper===this.element&&i.is("multiple",s)){var o=this.element;this.element.matches("li, option")?o=o.parentNode:this.element.matches("td, tr, tbody, thead, tfoot")&&(o=o.closest("table")),this.wrapper=e.create({around:o})}this.wrapper.classList.add("wysie-wrapper"),s.removeAttribute("data-store"),this.root=new(i.is("multiple",this.element)?i.Collection:i.Scope)(this.element,this),this.permissions=new Wysie.Permissions(null,this),this.bar=e(".wysie-bar",this.wrapper)||e.create({className:"wysie-bar",start:this.wrapper,contents:{tag:"span",className:"status"}}),this.permissions.can(["edit","add","delete"],function(){e.contents(n.bar,[{tag:"button",className:"edit",innerHTML:"<span class='icon'>✎</span> Edit",onclick:function(e){return n.edit()}},{tag:"button",innerHTML:"<span class='icon'>✓</span> Save",className:"save",onclick:function(e){return n.save()}},{tag:"button",innerHTML:"<span class='icon'>✘</span> Cancel",className:"cancel",
onclick:function(e){return n.cancel()}}])},function(){t(".edit, .save, .cancel",n.bar)._.remove()}),this.store&&this.store.href?(this.storage=i.Storage.create(this),this.permissions.can("read",function(){return n.storage.load()})):this.wrapper._.fire("wysie:load")},get data(){return this.getData()},getData:function(e){return this.root.getData(e)},toJSON:function(){return JSON.stringify(this.data,null,"	")},render:function(e){this.root.render(e.data||e)},edit:function(){this.editing=!0,this.root.edit()},save:function(){this.root.save(),this.editing=!1,this.storage&&this.storage.save()},cancel:function(){this.editing=!1,this.root.cancel()},live:{readonly:function(e){this.wrapper.classList[e?"add":"remove"]("readonly")},editing:{set:function(e){e?this.wrapper.setAttribute("data-editing",""):this.wrapper.removeAttribute("data-editing")}}},"static":{all:[],readable:function(e){return e&&e.replace(/([a-z])([A-Z][a-z])/g,function(e,t,i){return t+" "+i.toLowerCase()}).replace(/([a-z])[_\/-](?=[a-z])/g,"$1 ").replace(/^[a-z]/,function(e){
return e.toUpperCase()})},identifier:function(e){return e&&e.replace(/\s+/g,"-").replace(/[^\w-]/g,"").toLowerCase()},queryJSON:function(e,t){if(!t||!e)return e;t=t.split("/");for(var i,s=0;i=t[s++];){if(!e)return null;e=e[i]}return e},timed:function(e,t){return function(){console.time(e),t.apply(this,arguments),console.timeEnd(e)}},selectors:{property:"[property], [itemprop]",specificProperty:function(e){return"[property="+e+"], [itemprop="+e+"]"},output:"[property=output], [itemprop=output], .output, .value",primitive:"[property]:not([typeof]), [itemprop]:not([itemscope])",scope:"[typeof], [itemscope], [itemtype], .scope",multiple:"[multiple], [data-multiple], .multiple",autoMultiple:["li","tr","option"].map(function(e){return e+":only-of-type"}).join(", "),required:"[required], [data-required], .required",formControl:"input, select, textarea",computed:".computed"},is:function(e,t){return t.matches&&t.matches(i.selectors[e])},hooks:new e.Hooks}});e.add("toggleClass",function(e,t){this.classList[t?"add":"remove"](e);
}),e.ready().then(function(e){t("[data-store]").forEach(function(e){new Wysie(e)})}),i.prototype.render=i.timed("render",i.prototype.render)}(Bliss,Bliss.$),self.Promise&&!Promise.prototype.done&&(Promise.prototype.done=function(e){return this.then(e,e)}),function(e){var t=Wysie.Permissions=e.Class({constructor:function(e,t){this.triggers=[],this.wysie=t,this.set(e)},set:function(e){for(var t in e)this[t]=e[t]},on:function(e){var t=this;return e=Array.isArray(e)?e:[e],e.forEach(function(e){return t[e]=!0}),this},off:function(e){var t=this;return e=Array.isArray(e)?e:[e],e.forEach(function(e){return t[e]=!1}),this},can:function(e,t,i){this.observe(e,!0,t),i&&this.observe(e,!1,i)},observe:function(e,t,i){e=Array.isArray(e)?e:[e],this.is(e,t)&&i(),this.triggers.push({actions:e,value:t,callback:i,active:!0})},is:function(e,t){var i=this,s=e.map(function(e){return!!i[e]}).reduce(function(e,t){return e||t});return t?s:!s},changed:function(e,t,i){var s=this;i=!!i,t=!!t,t!=i&&(this.wysie.wrapper._.toggleClass("can-"+e,t),
this["_"+e]=t,this.triggers.forEach(function(t){var i=s.is(t.actions,t.value);t.active&&t.actions.indexOf(e)>-1&&i?(t.active=!1,t.callback()):i||(t.active=!0)}))},"static":{actions:[],register:function(i,s){return Array.isArray(i)?void i.forEach(function(e){return t.register(e,s)}):(e.live(t.prototype,i,function(e,t){s&&s.call(this,e,t),this.changed(i,e,t)}),void t.actions.push(i))}}});t.register("read"),t.register("login",function(e){e&&this.logout&&(this.logout=!1)}),t.register("logout",function(e){e&&this.login&&(this.login=!1)}),t.register("edit",function(e){e&&(this.add=this["delete"]=!0)}),t.register(["add","delete"],function(e){e||(this.edit=!1)})}(Bliss),function(e){var t=Wysie.Storage=e.Class({"abstract":!0,constructor:function(t){var i=this;this.wysie=t,this.originalHref=new URL(this.href,location),this.loaded=new Promise(function(e,t){i.wysie.wrapper.addEventListener("wysie:load",e)}),this.authControls={},this.permissions.can("login",function(){i.loginHash="#login"+(Wysie.all[0]===i.wysie?"":"-"+i.wysie.id),
i.authControls.login=e.create({tag:"a",href:i.loginHash,textContent:"Login",className:"login button",events:{click:function(e){e.preventDefault(),i.login()}},after:e(".status",i.wysie.bar)});var t;(t=function(){location.hash===i.loginHash&&(history.replaceState(null,document.title,new URL("",location)+""),i.login())})(),window.addEventListener("hashchange.wysie",t)},function(){e.remove(i.authControls.login),i.wysie.wrapper._.unbind("hashchange.wysie")}),this.permissions.can("logout",function(){i.authControls.logout=e.create({tag:"button",textContent:"Logout",className:"logout",events:{click:i.logout.bind(i)},after:e(".status",i.wysie.bar)})},function(){e.remove(i.authControls.logout)}),this.wysie.wrapper.addEventListener("wysie:login.wysie",function(t){e(".status",i.wysie.bar).innerHTML="Logged in to "+i.id+" as <strong>"+t.name+"</strong>"}),this.wysie.wrapper.addEventListener("wysie:logout.wysie",function(t){e(".status",i.wysie.bar).textContent=""})},get url(){return this.wysie.store},
get permissions(){return this.wysie.permissions},get href(){return this.url.href},get backup(){return JSON.parse(localStorage[this.originalHref]||null)},set backup(e){localStorage[this.originalHref]=JSON.stringify(e,null,"	")},ready:Promise.resolve(),load:function(){var t=this,i=this.ready,s=this.backup;return this.inProgress="Loading",s&&s.synced===!1?i.then(function(){return t.wysie.render(s),t.inProgress=!1,t.wysie.wrapper._.fire("wysie:load"),t.save()}):(i=this.url.origin!==location.origin||this.url.pathname!==location.pathname?i.then(function(){return t.backendLoad?t.backendLoad():e.fetch(t.href,{responseType:"json"})}).then(function(e){if(t.inProgress=!1,t.wysie.wrapper._.fire("wysie:load"),e.response){var i=Wysie.queryJSON(e.response,t.url.hash.slice(1));t.wysie.render(i)}t.backup={synced:!0,data:t.wysie.data}}):i.done(function(){return Promise.reject()}),i["catch"](function(e){t.inProgress=!1,e&&(console.error(e),console.log(e.stack)),s&&t.wysie.render(s),t.wysie.wrapper._.fire("wysie:load");
}))},save:function(){var e=this;return this.backup={synced:!this._save,data:this.wysie.data},this.backendSave?this.login().then(function(){return e.inProgress="Saving",e.backendSave().then(function(){var t=e.backup;t.synced=!0,e.backup=t,e.wysie.wrapper._.fire("wysie:save")}).done(function(){e.inProgress=!1})}):void 0},login:function(){return Promise.resolve()},logout:function(){return Promise.resolve()},param:function(e){if(this.params=this.params||{},!(e in this.params)){var t="data-store-"+e;this.params[e]=this.wysie.wrapper.getAttribute(t)||this.wysie.element.getAttribute(t),this.wysie.wrapper.removeAttribute(t),this.wysie.element.removeAttribute(t)}return this.params[e]},live:{inProgress:function(t){if(t){e.create("div",{textContent:t+"…",className:"progress",inside:this.wysie.wrapper})}else e.remove(e(".progress",this.wysie.wrapper))}},"static":{create:function(e){var i,s=-1;for(var n in t){var r=t[n];r&&r["super"]===t&&r.test(e.store)&&(r.priority=r.priority||0,s<=r.priority&&(i=n,
s=r.priority))}if(i){var o=new t[i](e);return o.id=i,o}return new t.Default(e)}}});t.Default=e.Class({"extends":t,constructor:function(){this.permissions.set({read:!0,edit:this.url.origin===location.origin&&this.url.pathname===location.pathname,login:!1,logout:!1})},"static":{test:function(){return!1}}})}(Bliss),function(e,t){var i=Wysie.Unit=e.Class({"abstract":!0,constructor:function(e,t,s){if(!e||!t)throw new Error("Wysie.Unit constructor requires an element argument and a wysie object");this.wysie=t,this.element=e,this.element._.data.unit=this,this.property=i.normalizeProperty(this.element),this.collection=s,this.computed=this.element.matches(Wysie.selectors.computed),this.required=this.element.matches("[required], [data-required]")},toJSON:Wysie.prototype.toJSON,get data(){return this.getData()},live:{deleted:function(e){this.element._.toggleClass("deleted",e)}},"static":{create:function(e,i,s){if(!e||!i)throw new TypeError("Wysie.Unit.create() requires an element argument and a wysie object");
Wysie.is("scope",e)||t(Wysie.selectors.property,e).length&&(Wysie.is("multiple",e)||!e.matches("[data-attribute], [href], [src], time[datetime]"));return new(Wysie[Wysie.Scope.is(e)?"Scope":"Primitive"])(e,i,s)},normalizeProperty:function(e){var t=e.getAttribute("property")||e.getAttribute("itemprop");return!t&&e.hasAttribute("property")&&(t=e.name||e.id||e.classList[0]),t&&e.setAttribute("property",t),t}}})}(Bliss,Bliss.$),function(e,t){var i=Wysie.Scope=e.Class({"extends":Wysie.Unit,constructor:function(e,s,n){var r=this,o=this;this.type=i.normalize(this.element),this.properties={},t(Wysie.selectors.property,this.element).filter(function(e){return r.contains(e)}).forEach(function(e){if(Wysie.is("multiple",e))var t=new Wysie.Collection(e,o.wysie);else t=i["super"].create(e,r.wysie),t.scope=t instanceof i?t:r;t.parentScope=r,r.properties[t.property]=t}),this.cacheReferences(),this.element.addEventListener("wysie:propertychange",function(e){e.stopPropagation(),r.updateReferences()}),this.updateReferences();
},get isRoot(){return!this.property},get propertyNames(){return Object.keys(this.properties)},getData:function(t){if(t=t||{},this.editing&&!this.everSaved&&!t.dirty||this.computed&&!t.computed)return null;var i={};return e.each(this.properties,function(e,s){if((!s.computed||t.computed)&&!(s.property in i)){var n=s.getData(t);null!==n&&(i[e]=n)}}),e.extend(i,this.unhandled),i},edit:function(){this.editing=!0,e.each(this.properties,function(e,t){t instanceof Wysie.Collection?t.edit():t[t instanceof i?"edit":"preEdit"]()})},save:function(){this.editing=!1,e.each(this.properties,function(e,t){t.save()}),e.unbind(this.element,".wysie:edit"),this.everSaved=!0},cancel:function(){this.editing=!1,e.each(this.properties,function(e,t){t.cancel()}),e.unbind(this.element,".wysie:edit")},render:function(t){var i=this;t&&(this.unhandled=Object.keys(t).filter(function(e){return!(e in i.properties)}),e.each(this.properties,function(e,i){var s=Wysie.queryJSON(t,e);(s||0===s)&&i.render(s)}),this.everSaved=!0);
},cacheReferences:function(){var i=this,s=this.propertyNames.join("|");this.refRegex=RegExp("{(?:"+s+")}|\\${.+?}","gi"),this.references=[];var n=function(t,s){var n=s?s.value:t.textContent,r=n.match(i.refRegex),o=e.value(t._.data.unit,"attribute");r&&i.references.push({element:t,attribute:s&&s.name,text:n,expressions:r.map(function(e){return{isSimple:0!==e.indexOf("$"),expression:e.replace(/^\$?{|}$/g,""),isProperty:Wysie.is("property",t)&&s.name==o}})})};(function r(e){this.refRegex.lastIndex=0,this.refRegex.test(e.outerHTML||e.textContent)&&(t(e.attributes).forEach(function(t){n(e,t)}),t(e.childNodes).forEach(r,this),3===e.nodeType&&n(e,null))}).call(this,this.element),this.updateReferences()},getRelativeData:function(){for(var t=this,i={};t;){t.property;i=e.extend(t.getData({dirty:!0,computed:!0}),i);var s=t.parentScope;t=s}return function n(t){e.each(t,function(t,s){t in i||(i[t]=s),"object"===e.type(s)&&n(s)})}.call(this,i),i},updateReferences:function(){this.references.length&&(data=this.getRelativeData(),
t(this.references).forEach(function(e){var i=e.text;t(e.expressions).forEach(function(t){var s=t.isSimple?data[t.expression]:safeval(t.expression,data);t.isSimple&&/^(class|id)$/i.test(e.attribute)&&(s=Wysie.identifier(s)),i=i.replace((t.isSimple?"{":"${")+t.expression+"}",s||"")}),e.attribute?e.element.setAttribute(e.attribute,i):e.element.textContent=i}))},contains:function(e){return e instanceof Wysie.Unit?e.parentScope===this:this.element===e.parentNode.closest(Wysie.selectors.scope)},"static":{is:function(e){var i=Wysie.is("scope",e);return i||t(Wysie.selectors.property,e).length&&(i=Wysie.is("multiple",e)||null===Wysie.Primitive.getValueAttribute(e)),i},normalize:function(e){var t=e.getAttribute("typeof")||e.getAttribute("itemtype");return!t&&i.is(e)&&(t="Item"),t&&e.setAttribute("typeof",t),t}}})}(Bliss,Bliss.$),function(e,t){var i=!1,s=Wysie.Primitive=e.Class({"extends":Wysie.Unit,constructor:function(i,n,r){var o=this;this.attribute=s.getValueAttribute(this.element),this.datatype=s.getDatatype(this.element,this.attribute),
Wysie.is("formControl",this.element)?(this.editor=this.element,this.exposed&&(this.element.addEventListener("change",function(e){o.wysie.editing||e.target!==o.editor||!o.scope.everSaved&&o.scope.collection||o.wysie.save()}),this.edit())):this.editor||(this.editor=t(this.element.children).filter(function(e){return e.matches(Wysie.selectors.formControl)&&!e.matches(Wysie.selectors.property)})[0],e.remove(this.editor)),this["default"]=this.editor?this.editorValue:this.value,this.update(this.value),this.attribute?Wysie.is("formControl",this.element)||(this.observer=new MutationObserver(function(e){o.update(o.value)}),this.observer.observe(this.element,{attributes:!0,attributeFilter:[this.attribute]})):(this.observer=new MutationObserver(function(e){o.editing||o.update(o.value)}),this.observer.observe(this.element,{characterData:!0,childList:!0,subtree:!0}))},get value(){return this.editing?this.editorValue:s.getValue(this.element,this.attribute,this.datatype)},set value(e){this.editing&&(this.editorValue=e),
s.setValue(this.element,e,this.attribute,this.datatype),(Wysie.is("formControl",this.element)||!this.attribute)&&this.update(e)},get editorValue(){if(this.editor){if(this.editor.matches(Wysie.selectors.formControl))return s.getValue(this.editor,void 0,this.datatype);var t=e(Wysie.selectors.output+", "+Wysie.selectors.formControl,this.editor);if(t)return t._.data.unit?t._.data.unit.value:s.getValue(t)}},set editorValue(t){if(this.editor)if(this.editor.matches(Wysie.selectors.formControl))s.setValue(this.editor,t);else{var i=e(Wysie.selectors.output+", "+Wysie.selectors.formControl,this.editor);i&&(i._.data.unit?i._.data.unit.value=t:s.setValue(i,t))}},get exposed(){return this.editor===this.element},getData:function(e){if(e=e||{},this.computed&&!e.computed)return null;var t=!this.editing||e.dirty||this.exposed?this.value:this.savedValue;return e.dirty||""!==t||t!==this["default"]?t:null},update:function(e){this.empty=""===e||null===e,e=e||0===e?e:"",this.humanReadable&&this.attribute&&(this.element.textContent=this.humanReadable(e)),
this.element._.fire("wysie:propertychange",{property:this.property,value:e,wysie:this.wysie,unit:this,dirty:this.editing})},save:function(){this.popup?this.hidePopup():this.attribute||this.exposed||!this.editing||(this.element.textContent=this.editorValue,e.remove(this.editor)),this.exposed||(this.editing=!1),null!==this.element._.data.prevTabindex?this.element.tabIndex=this.element._.data.prevTabindex:this.element.removeAttribute("tabindex"),this.element._.unbind(".wysie:edit .wysie:preedit .wysie:showpopup"),this.element._.fire("wysie:propertysave",{unit:this})},cancel:function(){void 0!==this.savedValue&&(this.value=this.savedValue),this.save()},preEdit:function(){var e=this;return this.empty&&!this.attribute?void this.edit():(this.element._.events({"mousedown.wysie:preedit click.wysie:preedit":function(t){return e.edit()},"focus.wysie:preedit":function(t){e.edit(),e.popup||e.editor.focus()},"click.wysie:edit":function(t){e.exposed||t.preventDefault()}}),this.element._.data.prevTabindex=this.element.getAttribute("tabindex"),
void(this.element.tabIndex=0))},edit:function(){var i=this;if(!this.editing){if(this.element._.unbind(".wysie:preedit"),void 0===this.savedValue){if(this.element.hasAttribute("data-input")){var n=this.element.getAttribute("data-input");n&&(this.editor=e.clone(e(n)),Wysie.is("formControl",this.editor)||(e(Wysie.selectors.output,this.editor)?(this.editor.setAttribute("data-store","none"),new Wysie(this.editor)):this.editor=null))}if(!this.editor){var r=s.getMatch(this.element,s.editors);r.create&&e.extend(this,r,function(e){return"create"!=e});var o=r.create||r;this.editor=e.create("function"===e.type(o)?o.call(this):o),this.editorValue=this.value}if(this.editor._.events({input:function(e){i.attribute&&i.element.setAttribute(i.attribute,i.editorValue),(i.exposed||!i.attribute)&&i.update(i.editorValue)},focus:function(e){i.editor.select&&i.editor.select()},keyup:function(e){(i.popup&&13==e.keyCode||27==e.keyCode)&&(i.popup.contains(document.activeElement)&&i.element.focus(),e.stopPropagation(),
i.hidePopup())},"wysie:propertychange":function(t){"output"===t.property&&(t.stopPropagation(),e.fire(i.editor,"input"))}}),"placeholder"in this.editor&&(this.editor.placeholder="("+this.label+")"),!this.exposed){var a=/^data-input-/i;if(t(this.element.attributes).forEach(function(e){a.test(e.name)&&this.editor.setAttribute(e.name.replace(a,""),e.value)},this),this.attribute){this.element.classList.add("using-popup"),this.popup=this.popup||e.create("div",{className:"wysie-popup",hidden:!0,contents:[this.label+":",this.editor]}),this.editor.matches("select")&&(this.editor.size=Math.min(10,this.editor.children.length));var c=function(e){i.popup.contains(e.target)||i.element.contains(e.target)||i.hidePopup()};this.showPopup=function(){e.unbind([this.element,this.popup],".wysie:showpopup"),this.popup._.after(this.element),this.popup._.style({top:this.element.offsetTop+this.element.offsetHeight+"px",left:this.element.offsetLeft+"px"}),this.popup._.removeAttribute("hidden"),e.events(document,"focus click",c,!0);
},this.hidePopup=function(){var t=this;e.unbind(document,"focus click",c,!0),this.popup.setAttribute("hidden",""),setTimeout(function(){e.remove(t.popup)},400),e.events(this.element,"focus.wysie:showpopup click.wysie:showpopup",function(e){t.showPopup()},!0)}}}this.popup||this.editor.classList.add("wysie-editor")}this.popup&&this.showPopup(),this.savedValue=this.value,this.editing=!0,this.attribute||this.editor.parentNode==this.element||this.exposed||(this.editorValue=this.element.textContent,this.element.textContent="",this.exposed||this.element.appendChild(this.editor))}},render:function(e){this.value=this.savedValue=e},lazy:{label:function(){return Wysie.readable(this.property)}},live:{empty:function(t){!t||this.attribute&&e(Wysie.selectors.property,this.element)?this.element.classList.remove("empty"):this.element.classList.add("empty")},editing:function(e){this.element.classList[e?"add":"remove"]("editing")}},"static":{getMatch:function(e,t){var i=null;for(var s in t)e.matches(s)&&(i=t[s]);
return i},getValueAttribute:function n(e){var t=(n.cache=n.cache||new WeakMap).get(e);return(void 0===t||i)&&(t=e.getAttribute("data-attribute")||s.getMatch(e,s.attributes),t&&(t.humanReadable&&e._.data.unit instanceof s&&(e._.data.unit.humanReadable=t.humanReadable),t=t.value||t),t&&"null"!==t||(t=null),n.cache.set(e,t)),t},getDatatype:function r(e,t){var n=(r.cache=r.cache||new WeakMap).get(e);if(void 0===n||i){if(n=e.getAttribute("datatype"),!n)for(var o in s.datatypes)e.matches(o)&&(n=s.datatypes[o][t]);n=n||"string",r.cache.set(e,n)}return n},getValue:function o(e,t,n){var r=(o.cache=o.cache||new WeakMap).get(e);return(!r||i)&&(t=t||null===t?t:s.getValueAttribute(e),n=n||s.getDatatype(e,t),r=function(){var i;switch(i=t in e?e[t]:t?e.getAttribute(t):e.getAttribute("content")||e.textContent||null,n){case"number":return+i;case"boolean":return!!i;default:return i}},o.cache.set(e,r)),r()},setValue:function(e,t,i){i=i||s.getValueAttribute(e),i in e?e[i]=t:i?e.setAttribute(i,t):e.textContent=t;
}}});s.attributes={"img, video, audio":"src","a, link":"href","select, input, textarea":"value","input[type=checkbox]":"checked",time:{value:"datetime",humanReadable:function(e){var t=new Date(e);if(!e||isNaN(t))return"("+this.label+")";var i="Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" ");return t.getDate()+" "+i[t.getMonth()]+" "+t.getFullYear()}},meta:"content"},s.datatypes={"input[type=checkbox]":{checked:"boolean"},"input[type=range], input[type=number]":{value:"number"}},s.editors={"*":{tag:"input"},".number":{tag:"input",type:"number"},".boolean":{tag:"input",type:"checkbox"},"a, img, video, audio, .url":{tag:"input",type:"url",placeholder:"http://"},"p, div, .multiline":{create:{tag:"textarea"},get editorValue(){return this.editor&&this.editor.value},set editorValue(e){this.editor&&(this.editor.value=e.replace(/\r?\n/g,""))}},"time, .date":function(){var t={date:/^[Y\d]{4}-[M\d]{2}-[D\d]{2}$/i,month:/^[Y\d]{4}-[M\d]{2}$/i,time:/^[H\d]{2}:[M\d]{2}/i,week:/[Y\d]{4}-W[W\d]{2}$/i,
"datetime-local":/^[Y\d]{4}-[M\d]{2}-[D\d]{2} [H\d]{2}:[M\d]{2}/i},i=this.element.getAttribute("datetime")||"YYYY-MM-DD";for(var s in t)if(t[s].test(i))break;return e.create("input",{type:s})}},Stretchy.selectors.filter=".wysie-editor"}(Bliss,Bliss.$),function(e,t){var i=Wysie.Collection=function(i,s){var n=this;if(!i||!s)throw new TypeError("No template and/or Wysie object");this.template=i,this.wysie=s,this.items=[],this.property=Wysie.Unit.normalizeProperty(this.template),this.type=Wysie.Scope.normalize(this.template),this.required=this.template.matches(Wysie.selectors.required);var r=this.template.parentNode.closest(".wysie-item");this.addButton=t("button.add-"+this.property+", .wysie-add, button.add",r).filter(function(e){return!n.template.contains(e)})[0],this.addButton=this.addButton||document.createElement("button")._.set({className:"add",textContent:"Add "+this.name.replace(/s$/i,"")}),this.addButton.addEventListener("click",function(e){e.preventDefault(),n.add().edit()}),this.template.hasAttribute("data-bottomup")?this.bottomUp=!0:this.addButton.parentNode?this.bottomUp=!!(this.addButton.compareDocumentPosition(this.template)&Node.DOCUMENT_POSITION_FOLLOWING):this.bottomUp=!1,
this.marker=e.create("div",{hidden:!0,className:"wysie-marker",after:this.template}),this.template.classList.add("wysie-item"),this.template.remove(),this.addButton.parentNode||(this.bottomUp?this.addButton._.before(e.value(this.items[0],"element")||this.marker):this.addButton._.after(this.marker))};i.prototype={get name(){return Wysie.readable(this.property||this.type).toLowerCase()},get selector(){return".wysie-item"+(this.property?'[property="'+this.property+'"]':"")+(this.type?'[typeof="'+this.type+'"]':"")},get length(){return this.items.length},get data(){return this.getData()},getData:function(e){return e=e||{},this.items.map(function(t){return t.getData(e)}).filter(function(e){return null!==e})},toJSON:Wysie.prototype.toJSON,createItem:function(){var t=this,i=this.template.cloneNode(!0),s=Wysie.Unit.create(i,this.wysie,this);s.parentScope=this.parentScope,s.scope=s.scope||this.parentScope;e.create({tag:"menu",type:"toolbar",className:"wysie-item-controls",contents:[{tag:"button",
title:"Delete this "+this.name.replace(/s$/i,""),className:"delete",events:{click:function(e){confirm("Are you sure you want to "+e.target.title.toLowerCase()+"?")&&t["delete"](s)},"mouseenter mouseleave":function(e){i.classList["mouseenter"==e.type?"add":"remove"]("delete-hover")}}},{tag:"button",title:"Add new "+this.name.replace(/s$/i,""),textContent:"✚",className:"add",events:{click:function(e){var n=t.items.indexOf(s);if(n>-1){var r=t.createItem();t.items.splice(n,0,r),r.element._.after(i),r.edit()}}}}],inside:i});return s},add:function(){var e=this.createItem();return e.element._.before(this.bottomUp&&this.items.length>0?this.items[0].element:this.marker),this.items.push(e),e},edit:function(){0===this.length&&this.required&&this.add(),this.items.forEach(function(e){e.preEdit?e.preEdit():e.edit(),e.element._.events({"mouseover.wysie:edit":function(t){if(e.editing){var i=t.target.closest(".wysie-item")===e.element;e.element._.toggleClass("wysie-item-hovered",i),t.stopPropagation()}},
"mouseout.wysie:edit":function(t){e.editing&&e.element.classList.remove("wysie-item-hovered")}})})},"delete":function(t){return e.transition(t.element,{opacity:0}).then(function(){t.deleted=!0,t.element.style.opacity=""})},save:function(){var t=this;this.items.forEach(function(i){i.deleted?(e.remove(i.element),t.items.splice(t.items.indexOf(i),1)):(i.save(),i.element.classList.remove("wysie-item-hovered"))})},cancel:function(){var t=this;this.items.forEach(function(i,s){i.deleted=!1,i.cancel(),i.element.classList.remove("wysie-item-hovered"),i instanceof Wysie.Scope&&!i.everSaved&&(t.items.splice(s,1),e.remove(i.element))})},render:function(e){if(e){e&&!Array.isArray(e)&&(e=[e]);var t=document.createDocumentFragment();e.forEach(function(e){var i=this.createItem();i.render(e),this.items.push(i),t.appendChild(i.element)},this),this.marker.parentNode.insertBefore(t,this.marker)}}}}(Bliss,Bliss.$),function(e){if(self.Wysie){var t="//cdnjs.cloudflare.com/ajax/libs/dropbox.js/0.10.2/dropbox.min.js";
Wysie.Storage.Dropbox=e.Class({"extends":Wysie.Storage,constructor:function(){var i=this;"dropbox:"!=this.wysie.store.protocol&&(this.wysie.store.hostname="dl.dropboxusercontent.com",this.wysie.store.search=this.wysie.store.search.replace(/\bdl=0|^$/,"raw=1"),this.permissions.read=!0),this.permissions.login=!0,this.ready=e.include(self.Dropbox,t).then(function(){var t=new URL(document.referrer,location);return"www.dropbox.com"===t.hostname&&0===location.hash.indexOf("#access_token=")?(Dropbox.AuthDriver.Popup.oauthReceiver(),e.fire(window,"load"),void close()):(i.filename=(i.param("path")||"")+new URL(i.wysie.store).pathname.match(/[^\/]*$/)[0],void(i.client=new Dropbox.Client({key:i.param("key")})))}).then(function(){i.login(!0)})},backendSave:function(){return this.put({name:this.filename,data:this.wysie.toJSON()})},put:function(e){var t=this;return new Promise(function(i,s){t.client.writeFile(e.name,e.data,function(e,t){return e?s(Error(e)):(console.log("File saved as revision "+t.versionTag),
void i(t))})})},login:function(e){var t=this;return this.ready.then(function(){return t.client.isAuthenticated()?Promise.resolve():new Promise(function(i,s){t.client.authDriver(new Dropbox.AuthDriver.Popup({receiverUrl:new URL(location)+""})),t.client.authenticate({interactive:!e},function(e,n){e&&s(Error(e)),t.client.isAuthenticated()?(t.permissions.on(["logout","edit"]),i()):(t.permissions.off(["logout","edit","add","delete"]),s())})})}).then(function(){t.client.getAccountInfo(function(e,i){e||t.wysie.wrapper._.fire("wysie:login",i)})})["catch"](function(){})},logout:function(){var e=this;return this.client.isAuthenticated()?new Promise(function(t,i){e.client.signOut(null,function(){e.permissions.off(["edit","add","delete"]).on("login"),e.wysie.wrapper._.fire("wysie:logout"),t()})}):Promise.resolve()},"static":{test:function(e){return/dropbox.com/.test(e.host)||"dropbox:"===e.protocol}}})}}(Bliss);